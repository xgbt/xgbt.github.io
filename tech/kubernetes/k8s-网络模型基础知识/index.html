<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>K8s ç½‘ç»œæ¨¡å‹åŸºç¡€çŸ¥è¯† | xgbt&#39;s Blog</title>
<meta name="keywords" content="Kubernetes">
<meta name="description" content="Kubernetes ç½‘ç»œçš„åŠŸèƒ½ï¼š

é«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« Pods å’ŒÂ localhostÂ é€šä¿¡è§£å†³äº†ã€‚
Pod é—´é€šä¿¡ï¼›
Pod å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›
å¤–éƒ¨å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›

Kubernetes æœ¬èº«çš„ç½‘ç»œæœåŠ¡è‡ªå¸¦äº†ä¸€ä¸‹åŠŸèƒ½ï¼š">
<meta name="author" content="">
<link rel="canonical" href="/tech/kubernetes/k8s-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.4b0be15b6b891613a91dad3a5279f108f18aa855a6dcb49a1e5ff9fade239870.css" integrity="sha256-SwvhW2uJFhOpHa06UnnxCPGKqFWm3LSaHl/5&#43;t4jmHA=" rel="preload stylesheet" as="style">
<link rel="icon" href="/assets/apple-icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="/tech/kubernetes/k8s-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><style>
@import url('https://fonts.cdnfonts.com/css/code-new-roman');
</style>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=LXGW+WenKai+TC&display=swap"
    rel="stylesheet"><meta property="og:title" content="K8s ç½‘ç»œæ¨¡å‹åŸºç¡€çŸ¥è¯†" />
<meta property="og:description" content="Kubernetes ç½‘ç»œçš„åŠŸèƒ½ï¼š

é«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« Pods å’ŒÂ localhostÂ é€šä¿¡è§£å†³äº†ã€‚
Pod é—´é€šä¿¡ï¼›
Pod å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›
å¤–éƒ¨å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›

Kubernetes æœ¬èº«çš„ç½‘ç»œæœåŠ¡è‡ªå¸¦äº†ä¸€ä¸‹åŠŸèƒ½ï¼š" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/tech/kubernetes/k8s-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" /><meta property="article:section" content="tech" />
<meta property="article:published_time" content="2024-08-24T16:09:19+08:00" />
<meta property="article:modified_time" content="2024-08-24T16:09:19+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K8s ç½‘ç»œæ¨¡å‹åŸºç¡€çŸ¥è¯†"/>
<meta name="twitter:description" content="Kubernetes ç½‘ç»œçš„åŠŸèƒ½ï¼š

é«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« Pods å’ŒÂ localhostÂ é€šä¿¡è§£å†³äº†ã€‚
Pod é—´é€šä¿¡ï¼›
Pod å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›
å¤–éƒ¨å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›

Kubernetes æœ¬èº«çš„ç½‘ç»œæœåŠ¡è‡ªå¸¦äº†ä¸€ä¸‹åŠŸèƒ½ï¼š"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Tech",
      "item": "/tech/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "K8s ç½‘ç»œæ¨¡å‹åŸºç¡€çŸ¥è¯†",
      "item": "/tech/kubernetes/k8s-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "K8s ç½‘ç»œæ¨¡å‹åŸºç¡€çŸ¥è¯†",
  "name": "K8s ç½‘ç»œæ¨¡å‹åŸºç¡€çŸ¥è¯†",
  "description": "Kubernetes ç½‘ç»œçš„åŠŸèƒ½ï¼š\né«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« Pods å’ŒÂ localhostÂ é€šä¿¡è§£å†³äº†ã€‚ Pod é—´é€šä¿¡ï¼› Pod å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼› å¤–éƒ¨å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼› Kubernetes æœ¬èº«çš„ç½‘ç»œæœåŠ¡è‡ªå¸¦äº†ä¸€ä¸‹åŠŸèƒ½ï¼š\n",
  "keywords": [
    "Kubernetes"
  ],
  "articleBody": "Kubernetes ç½‘ç»œçš„åŠŸèƒ½ï¼š\né«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« Pods å’ŒÂ localhostÂ é€šä¿¡è§£å†³äº†ã€‚ Pod é—´é€šä¿¡ï¼› Pod å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼› å¤–éƒ¨å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼› Kubernetes æœ¬èº«çš„ç½‘ç»œæœåŠ¡è‡ªå¸¦äº†ä¸€ä¸‹åŠŸèƒ½ï¼š\nNAT: ç½‘ç»œåœ°å€è½¬æ¢ Source NAT: æ›¿æ¢æ•°æ®åŒ…çš„æº IP, é€šå¸¸ä¸ºèŠ‚ç‚¹çš„ IP Destination NAT: æ›¿æ¢æ•°æ®åŒ…çš„ç›®çš„ IP, é€šå¸¸ä¸º Pod çš„ IP VIP: ä¸€ä¸ªè™šæ‹Ÿ IP, ä¾‹å¦‚åˆ†é…ç»™æ¯ä¸ª Kubernetes Service çš„ IP Kube-proxy: ä¸€ä¸ªç½‘ç»œå®ˆæŠ¤ç¨‹åºï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåè°ƒ Service VIP ç®¡ç† å¯å‚è€ƒÂ https://kubernetes.io/zh/docs/tutorials/services/source-ip/\n1. Pod IP å¯¹äº Docker ä¸­çš„ container ç½‘ç»œã€‚å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªå®¹å™¨çš„ç½‘ç»œæ¥å£ï¼Œå®ç°å¤šä¸ªå®¹å™¨å…±äº«ç½‘ç»œã€åŒä¸€ä¸ª IPã€åŒä¸€ä¸ª hostnameã€‚\nK8S ä¸­ Pod å†…å¤šå®¹å™¨å…±äº«ç½‘ç»œå°±æ˜¯è¿™æ ·åˆ›å»ºçš„ï¼ŒPod çš„ IP æ˜¯ Docker åˆ›å»ºå’Œåˆ†é…çš„å®¹å™¨ IPï¼Œè¿™ä¸ª IP æ˜¯å¸¦è™šæ‹Ÿç½‘å¡çš„ï¼Œå› æ­¤è¿™ä¸ª IP æ˜¯å¯ä»¥è¢« ping çš„ï¼Œä½†æ˜¯è¯¥ IP åªèƒ½åœ¨å½“å‰èŠ‚ç‚¹ä¸­è¢«è®¿é—®ã€‚\né¦–å…ˆï¼Œåˆ›å»º Pod æ—¶ï¼ŒPod ä¼šå¯åŠ¨ä¸€ä¸ª pause å®¹å™¨ï¼Œè¯¥å®¹å™¨åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå¹¶è¢« Docker åˆ†é… IPï¼Œæ¥ç€ Pod çš„å®¹å™¨ä¼šä½¿ç”¨ container ç½‘ç»œæ¨¡å¼è¿æ¥åˆ°è¿™ä¸ª pause å®¹å™¨ä¸­ï¼Œpause å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸè·Ÿ Pod çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ã€‚\nåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šä½¿ç”¨Â docker ps -a | grep pauseÂ å‘½ä»¤æŸ¥çœ‹ pause å®¹å™¨ï¼š\n1[root@test-60g ~]# minikube ssh 2docker@minikube:~$ docker ps -a |grep pause 367461274c207 registry.k8s.io/pause:3.9 \"/pause\" 25 hours ago Up 25 hours k8s_POD_nginx-7cf478bb58-h6zq9_default_4df3bc0f-7efa-4ef1-9d46-e6b300143eeb_2 4... ä¸è¿‡ï¼ŒDocker ä¸­çš„å®¹å™¨ IP æ˜¯ 172.17.0.0 åœ°å€æ®µï¼Œè€Œ Pod IP çš„åœ°å€æ®µä¸€èˆ¬æ˜¯ 10.x.x.x ç½‘ç»œï¼Œå…¶ä¸­ç”¨æˆ·è‡ªå®šä¹‰ Pod æ˜¯ 10.32.0.0 åœ°å€æ®µã€‚\nPod çš„ IP æ˜¯ Docker åˆ†é…çš„ï¼Œä¸ºä»€ä¹ˆå…¶åœ°å€ä¸æ˜¯ 172.17.0.0 åœ°å€æ®µï¼Ÿ\né¦–å…ˆï¼Œåœ¨éƒ¨ç½²äº† Docker çš„æœºå™¨ä¸Šï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªåä¸º docker0 çš„ç½‘æ¡¥ã€‚\n1docker0: flags=4163 mtu 1500 2 inet 172.17.0.1 netmask 255.255.0.0 broadcast 172.17.255.255 3 inet6 fe80::42:2aff:fe00:6577 prefixlen 64 scopeid 0x20 4 ether 02:42:2a:00:65:77 txqueuelen 0 (Ethernet) 5 RX packets 4404 bytes 155753 (152.1 KiB) 6 RX errors 0 dropped 0 overruns 0 frame 0 7 TX packets 3340 bytes 158865 (155.1 KiB) 8 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 docker çš„é»˜è®¤ç½‘æ¡¥å« docker0ï¼Œè¿™ä¸ªç½‘æ¡¥çš„ IP æ˜¯ 172.17.0.1ï¼ŒåŸºäºè¿™ä¸ªç½‘æ¡¥åˆ›å»ºçš„å®¹å™¨çš„è™šæ‹Ÿç½‘å¡è‡ªç„¶æ˜¯ 172.17.0.0 åœ°å€æ®µã€‚\nè€Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ weava ç½‘ç»œæ’ä»¶éƒ¨ç½²é›†ç¾¤ï¼Œé‚£ä¹ˆä½¿ç”¨ ifconfig å‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ª weava çš„è‡ªå®šä¹‰ç½‘æ¡¥ï¼š\n1weave: flags=4163 mtu 1376 2 inet 10.32.0.1 netmask 255.240.0.0 broadcast 10.47.255.255 3 inet6 fe80::ac45:ebff:fe0a:31ae prefixlen 64 scopeid 0x20 4 ether ae:45:eb:0a:31:ae txqueuelen 1000 (Ethernet) 5 RX packets 2905588 bytes 391313728 (391.3 MB) 6 RX errors 0 dropped 0 overruns 0 frame 0 7 TX packets 3179102 bytes 640814125 (640.8 MB) 8 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 é€šè¿‡ Kubernetes åˆ›å»ºçš„è‡ªå®šä¹‰ Podï¼Œä¼šä½¿ç”¨è¿™ä¸ªç½‘æ¡¥åˆ›å»º IPï¼Œå…¶ IP åœ°å€è·Ÿç½‘ç»œæ’ä»¶åˆ›å»ºçš„ç½‘æ¡¥æœ‰å…³ã€‚\næ›´å¤šçš„ Docker ç½‘ç»œçŸ¥è¯†:Â https://docs.docker.com/network/bridge/\nè·¨èŠ‚ç‚¹è®¿é—® Pod æ—¢ç„¶ Pod çš„ IP æ˜¯ Docker åˆ›å»ºçš„ï¼Œè€Œ Docker åˆ›å»ºçš„ IP åªèƒ½åœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šè®¿é—®ï¼Œé‚£ä¹ˆæ€ä¹ˆæ‰èƒ½åœ¨åˆ«çš„èŠ‚ç‚¹ä¸Šè®¿é—®è¿™ä¸ª Pod IPï¼Ÿ\nç½‘ç»œæ’ä»¶ï¼Œé™¤äº† weave ï¼Œè¿˜æœ‰å¾ˆå¤šç½‘ç»œæ’ä»¶å¯ä»¥ä½¿ç”¨ï¼Œå¦‚ calicoã€flannelã€‚Kubernetes ç½‘ç»œæ¨¡å‹ä¸­æœ‰ä¸ªå« CNI çš„æ ‡å‡†æ¥å£ï¼Œåªè¦å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œç”¨å•¥ç½‘ç»œæ’ä»¶éƒ½æ²¡é—®é¢˜ï¼Œä½¿ç”¨è€…ä¸éœ€è¦å…³å¿ƒæ’ä»¶æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\nCNI çš„ä¸»è¦åŠŸèƒ½ï¼š\nèŠ‚ç‚¹ä¸Šçš„ Pod å¯ä»¥ä¸é€šè¿‡ NAT å’Œå…¶ä»–ä»»ä½•èŠ‚ç‚¹ä¸Šçš„ Pod é€šä¿¡(ç§°ä¸ºæ‰å¹³åŒ–ç½‘ç»œ)ï¼Œå³èŠ‚ç‚¹é—´ Pod çš„äº’ç›¸è®¿é—®ï¼› èŠ‚ç‚¹ä¸Šçš„ä»£ç†ï¼ˆæ¯”å¦‚ï¼šç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ã€kubeletï¼‰å¯ä»¥å’ŒèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Pod é€šä¿¡ï¼Œå³ç³»ç»Ÿç»„ä»¶è®¿é—® Podï¼› 2. Service Service æ˜¯ Kubernetes çš„å¯¹è±¡ï¼Œå®ƒè·Ÿç½‘ç»œæœ‰å…³ï¼Œ Service ä¸æ˜¯æœåŠ¡æä¾›è€…ï¼Œä¹Ÿä¸æ˜¯åº”ç”¨ç¨‹åºæ¥å£ã€‚\nService æ˜¯å°†è¿è¡Œåœ¨ä¸€ç»„ Pods ä¸Šçš„åº”ç”¨ç¨‹åºï¼Œå…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æŠ½è±¡æ–¹æ³•ã€‚\nå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Deployment ã€Daemon ç­‰éƒ¨ç½² Podï¼Œåˆ™å¯ä¸ºæ­¤æ§åˆ¶å™¨åˆ›å»º Serviceï¼ŒService ä¼šç›‘æ§æ­¤ Deployment ä¸Šå¢åŠ æˆ–ç§»é™¤ Pod çš„æ“ä½œï¼Œè‡ªåŠ¨ä¸ºæ‰€æœ‰ Pod æä¾›ç½‘ç»œæœåŠ¡ã€‚å½“ç„¶ï¼ŒService å¹¶ä¸æ˜¯æŒ‡å‘ Deploymentã€Daemon çš„ï¼Œè€Œæ˜¯é€šè¿‡ Label æŒ‡å‘ç›¸å…³çš„ Podã€‚\n2.1 Service çš„å®šä¹‰å’Œåˆ›å»º æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Deployment å¯¹è±¡ï¼ŒåŒ…å«ä¸‰ä¸ª Pod å®ä¾‹ã€‚\n1kubectl create deployment nginx --image=nginx:latest --replicas=3 æ¥ç€ï¼Œä¸ºè¿™äº› Pod åˆ›å»ºä¸€ä¸ª Serviceã€‚\n1kubectl expose deployment nginx --type=ClusterIP --port=6666 --target-port=80 æŸ¥çœ‹åˆ›å»ºçš„ Serviceï¼š\n1[root@zqf-master1 ~]# k get svc -o wide 2NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR 3kubernetes ClusterIP 10.96.0.1 443/TCP 17m 4nginx ClusterIP 10.101.6.208 6666/TCP 7s app=nginx å¯ä»¥çœ‹åˆ°ï¼ŒService ä¼šç”Ÿæˆä¸€ä¸ªéšæœº IPÂ 10.101.6.208ï¼Œæˆ‘ä»¬ä¸º Pod æ˜ å°„äº†ä¸€ä¸ªæ–°çš„ç«¯å£ä¸º 6666ï¼Œæ­¤ç«¯å£æ˜ å°„åˆ°äº† Pod çš„ 80 ç«¯å£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•è¿™ä¸ª IP å’Œ ç«¯å£æ˜¯å¦å¯ç”¨ï¼š\n1[root@zqf-master1 ~]# curl 10.101.6.208:6666 2\u003c!DOCTYPE html\u003e 3 4 5Welcome to nginx! 6 11 12 13Welcome to nginx! 14If you see this page, the nginx web server is successfully installed and 15working. Further configuration is required.\n16 17For online documentation and support please refer to 18",
  "wordCount" : "3979",
  "inLanguage": "zh",
  "datePublished": "2024-08-24T16:09:19+08:00",
  "dateModified": "2024-08-24T16:09:19+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/tech/kubernetes/k8s-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "xgbt's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/assets/apple-icon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="xgbt&#39;s Blog (Alt + H)">xgbt&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="/search" title="ğŸ”æœç´¢">
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="/tags" title="ğŸ·ï¸æ ‡ç­¾">
                    <span>ğŸ·ï¸æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="/archives" title="ğŸ“¦å½’æ¡£">
                    <span>ğŸ“¦å½’æ¡£</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="/tech/">Tech</a></div>
    <h1 class="post-title entry-hint-parent">
      K8s ç½‘ç»œæ¨¡å‹åŸºç¡€çŸ¥è¯†
    </h1>
    <div class="post-meta"><span title='2024-08-24 16:09:19 +0800 CST'>å…«æœˆ 24, 2024</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
        <div class="toc">
            <details  open>
                <summary accesskey="c" title="(Alt + C)">
                    <span class="details">ç›®å½•</span>
                </summary>

                <div class="inner"><ul>
                        <li>
                            <a href="#1-pod-ip" aria-label="1. Pod IP">1. Pod IP</a><ul>
                                    
                        <li>
                            <a href="#%e8%b7%a8%e8%8a%82%e7%82%b9%e8%ae%bf%e9%97%ae-pod" aria-label="è·¨èŠ‚ç‚¹è®¿é—® Pod">è·¨èŠ‚ç‚¹è®¿é—® Pod</a></li></ul>
                        </li>
                        <li>
                            <a href="#2-service" aria-label="2. Service">2. Service</a><ul>
                                    
                        <li>
                            <a href="#21-service-%e7%9a%84%e5%ae%9a%e4%b9%89%e5%92%8c%e5%88%9b%e5%bb%ba" aria-label="2.1 Service çš„å®šä¹‰å’Œåˆ›å»º">2.1 Service çš„å®šä¹‰å’Œåˆ›å»º</a></li>
                        <li>
                            <a href="#22-service-%e5%a4%96%e9%83%a8%e6%9c%8d%e5%8a%a1%e7%b1%bb%e5%9e%8b" aria-label="2.2 Service å¤–éƒ¨æœåŠ¡ç±»å‹">2.2 Service å¤–éƒ¨æœåŠ¡ç±»å‹</a><ul>
                                    
                        <li>
                            <a href="#221-nodeport" aria-label="2.2.1 NodePort">2.2.1 NodePort</a></li>
                        <li>
                            <a href="#222-loadbalancer" aria-label="2.2.2 LoadBalancer">2.2.2 LoadBalancer</a></li></ul>
                        </li>
                        <li>
                            <a href="#23-service-%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9-pod" aria-label="2.3 Service å¦‚ä½•é€‰æ‹© Pod">2.3 Service å¦‚ä½•é€‰æ‹© Pod</a></li>
                        <li>
                            <a href="#24-kube-proxy-%e4%b8%89%e7%a7%8d%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" aria-label="2.4 kube-proxy ä¸‰ç§ä»£ç†æ¨¡å¼">2.4 kube-proxy ä¸‰ç§ä»£ç†æ¨¡å¼</a><ul>
                                    
                        <li>
                            <a href="#241-userspace-%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" aria-label="2.4.1 userspace ä»£ç†æ¨¡å¼">2.4.1 userspace ä»£ç†æ¨¡å¼</a></li>
                        <li>
                            <a href="#242-iptables-%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" aria-label="2.4.2 iptables ä»£ç†æ¨¡å¼">2.4.2 iptables ä»£ç†æ¨¡å¼</a></li>
                        <li>
                            <a href="#243-ipvs-%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" aria-label="2.4.3 IPVS ä»£ç†æ¨¡å¼">2.4.3 IPVS ä»£ç†æ¨¡å¼</a>
                        </li>
                    </ul>
                    </li>
                    </ul>
                    </li>
                    </ul>
                </div>
            </details>
        </div>
    </aside>
    <script>
        let activeElement;
        let elements;

        document.addEventListener('DOMContentLoaded', function (event) {
            checkTocPosition();

            elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
            if (elements.length > 0) {
                
                activeElement = elements[0];
                const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            }

            
            const topLink = document.getElementById('top-link');
            if (topLink) {
                topLink.addEventListener('click', (event) => {
                    
                    event.preventDefault();

                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
        }, false);

        window.addEventListener('resize', function (event) {
            checkTocPosition();
        }, false);

        window.addEventListener('scroll', () => {
            
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;

            
            if (scrollPosition === 0) {
                return;
            }

            
            if (elements && elements.length > 0) {
                
                activeElement = Array.from(elements).find((element) => {
                    if ((getOffsetTop(element) - scrollPosition) > 0 &&
                        (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                        return element;
                    }
                }) || activeElement;

                elements.forEach(element => {
                    const id = encodeURI(element.getAttribute('id')).toLowerCase();
                    const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                    if (element === activeElement) {
                        tocLink.classList.add('active');

                        
                        const tocContainer = document.querySelector('.toc .inner');
                        const linkOffsetTop = tocLink.offsetTop;
                        const containerHeight = tocContainer.clientHeight;
                        const linkHeight = tocLink.clientHeight;

                        
                        const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                        tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                    } else {
                        tocLink.classList.remove('active');
                    }
                });
            }
        }, false);

        const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
        const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
        const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

        function checkTocPosition() {
            const width = document.body.scrollWidth;

            if (width - main - (toc * 2) - (gap * 4) > 0) {
                document.getElementById("toc-container").classList.add("wide");
            } else {
                document.getElementById("toc-container").classList.remove("wide");
            }
        }

        function getOffsetTop(element) {
            if (!element.getClientRects().length) {
                return 0;
            }
            let rect = element.getBoundingClientRect();
            let win = element.ownerDocument.defaultView;
            return rect.top + win.pageYOffset;
        }

    </script>
  <div class="post-content"><p>Kubernetes ç½‘ç»œçš„åŠŸèƒ½ï¼š</p>
<ol>
<li>é«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« Pods å’ŒÂ <code>localhost</code>Â é€šä¿¡è§£å†³äº†ã€‚</li>
<li>Pod é—´é€šä¿¡ï¼›</li>
<li>Pod å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›</li>
<li>å¤–éƒ¨å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›</li>
</ol>
<p>Kubernetes æœ¬èº«çš„ç½‘ç»œæœåŠ¡è‡ªå¸¦äº†ä¸€ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>NAT: ç½‘ç»œåœ°å€è½¬æ¢</li>
<li>Source NAT: æ›¿æ¢æ•°æ®åŒ…çš„æº IP, é€šå¸¸ä¸ºèŠ‚ç‚¹çš„ IP</li>
<li>Destination NAT: æ›¿æ¢æ•°æ®åŒ…çš„ç›®çš„ IP, é€šå¸¸ä¸º Pod çš„ IP</li>
<li>VIP: ä¸€ä¸ªè™šæ‹Ÿ IP, ä¾‹å¦‚åˆ†é…ç»™æ¯ä¸ª Kubernetes Service çš„ IP</li>
<li>Kube-proxy: ä¸€ä¸ªç½‘ç»œå®ˆæŠ¤ç¨‹åºï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåè°ƒ Service VIP ç®¡ç†</li>
</ul>
<blockquote>
<p>å¯å‚è€ƒÂ <a href="https://kubernetes.io/zh/docs/tutorials/services/source-ip/">https://kubernetes.io/zh/docs/tutorials/services/source-ip/</a></p>
</blockquote>
<h1 id="1-pod-ip">1. Pod IP<a hidden class="anchor" aria-hidden="true" href="#1-pod-ip">#</a></h1>
<p>å¯¹äº Docker ä¸­çš„ container ç½‘ç»œã€‚å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªå®¹å™¨çš„ç½‘ç»œæ¥å£ï¼Œå®ç°å¤šä¸ªå®¹å™¨å…±äº«ç½‘ç»œã€åŒä¸€ä¸ª IPã€åŒä¸€ä¸ª hostnameã€‚</p>
<p>K8S ä¸­ Pod å†…å¤šå®¹å™¨å…±äº«ç½‘ç»œå°±æ˜¯è¿™æ ·åˆ›å»ºçš„ï¼ŒPod çš„ IP æ˜¯ Docker åˆ›å»ºå’Œåˆ†é…çš„å®¹å™¨ IPï¼Œè¿™ä¸ª IP æ˜¯å¸¦è™šæ‹Ÿç½‘å¡çš„ï¼Œå› æ­¤è¿™ä¸ª IP æ˜¯å¯ä»¥è¢« ping çš„ï¼Œä½†æ˜¯è¯¥ IP åªèƒ½åœ¨å½“å‰èŠ‚ç‚¹ä¸­è¢«è®¿é—®ã€‚</p>
<p>é¦–å…ˆï¼Œ<strong>åˆ›å»º Pod æ—¶ï¼ŒPod ä¼šå¯åŠ¨ä¸€ä¸ª pause å®¹å™¨ï¼Œè¯¥å®¹å™¨åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå¹¶è¢« Docker åˆ†é… IPï¼Œæ¥ç€ Pod çš„å®¹å™¨ä¼šä½¿ç”¨ container ç½‘ç»œæ¨¡å¼è¿æ¥åˆ°è¿™ä¸ª pause å®¹å™¨ä¸­ï¼Œpause å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸè·Ÿ Pod çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ã€‚</strong></p>
<p>åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šä½¿ç”¨Â <code>docker ps -a | grep pause</code>Â å‘½ä»¤æŸ¥çœ‹ pause å®¹å™¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>root@test-60g ~<span class="o">]</span><span class="c1"># minikube ssh</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">docker@minikube:~$ docker ps -a <span class="p">|</span>grep pause
</span></span><span class="line"><span class="ln">3</span><span class="cl">67461274c207   registry.k8s.io/pause:3.9   <span class="s2">&#34;/pause&#34;</span>                 <span class="m">25</span> hours ago   Up <span class="m">25</span> hours                           k8s_POD_nginx-7cf478bb58-h6zq9_default_4df3bc0f-7efa-4ef1-9d46-e6b300143eeb_2
</span></span><span class="line"><span class="ln">4</span><span class="cl">...
</span></span></code></pre></div><p>ä¸è¿‡ï¼ŒDocker ä¸­çš„å®¹å™¨ IP æ˜¯ 172.17.0.0 åœ°å€æ®µï¼Œè€Œ Pod IP çš„åœ°å€æ®µä¸€èˆ¬æ˜¯ 10.x.x.x ç½‘ç»œï¼Œå…¶ä¸­ç”¨æˆ·è‡ªå®šä¹‰ Pod æ˜¯ 10.32.0.0 åœ°å€æ®µã€‚</p>
<blockquote>
<p>Pod çš„ IP æ˜¯ Docker åˆ†é…çš„ï¼Œä¸ºä»€ä¹ˆå…¶åœ°å€ä¸æ˜¯ 172.17.0.0 åœ°å€æ®µï¼Ÿ</p>
</blockquote>
<p>é¦–å…ˆï¼Œåœ¨éƒ¨ç½²äº† Docker çš„æœºå™¨ä¸Šï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªåä¸º <code>docker0</code> çš„<strong>ç½‘æ¡¥</strong>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span></span><span class="line"><span class="ln">2</span><span class="cl">        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
</span></span><span class="line"><span class="ln">3</span><span class="cl">        inet6 fe80::42:2aff:fe00:6577  prefixlen 64  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">        ether 02:42:2a:00:65:77  txqueuelen 0  (Ethernet)
</span></span><span class="line"><span class="ln">5</span><span class="cl">        RX packets 4404  bytes 155753 (152.1 KiB)
</span></span><span class="line"><span class="ln">6</span><span class="cl">        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span class="line"><span class="ln">7</span><span class="cl">        TX packets 3340  bytes 158865 (155.1 KiB)
</span></span><span class="line"><span class="ln">8</span><span class="cl">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span></code></pre></div><p>docker çš„é»˜è®¤ç½‘æ¡¥å« <code>docker0</code>ï¼Œè¿™ä¸ªç½‘æ¡¥çš„ IP æ˜¯ 172.17.0.1ï¼ŒåŸºäºè¿™ä¸ªç½‘æ¡¥åˆ›å»ºçš„å®¹å™¨çš„è™šæ‹Ÿç½‘å¡è‡ªç„¶æ˜¯ 172.17.0.0 åœ°å€æ®µã€‚</p>
<p>è€Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ <code>weava</code> ç½‘ç»œæ’ä»¶éƒ¨ç½²é›†ç¾¤ï¼Œé‚£ä¹ˆä½¿ç”¨ <code>ifconfig</code> å‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ª <code>weava</code> çš„è‡ªå®šä¹‰ç½‘æ¡¥ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">weave: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1376
</span></span><span class="line"><span class="ln">2</span><span class="cl">        inet 10.32.0.1  netmask 255.240.0.0  broadcast 10.47.255.255
</span></span><span class="line"><span class="ln">3</span><span class="cl">        inet6 fe80::ac45:ebff:fe0a:31ae  prefixlen 64  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">        ether ae:45:eb:0a:31:ae  txqueuelen 1000  (Ethernet)
</span></span><span class="line"><span class="ln">5</span><span class="cl">        RX packets 2905588  bytes 391313728 (391.3 MB)
</span></span><span class="line"><span class="ln">6</span><span class="cl">        RX errors 0  dropped 0  overruns 0  frame 0
</span></span><span class="line"><span class="ln">7</span><span class="cl">        TX packets 3179102  bytes 640814125 (640.8 MB)
</span></span><span class="line"><span class="ln">8</span><span class="cl">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span></code></pre></div><p>é€šè¿‡ Kubernetes åˆ›å»ºçš„è‡ªå®šä¹‰ Podï¼Œä¼šä½¿ç”¨è¿™ä¸ªç½‘æ¡¥åˆ›å»º IPï¼Œ<strong>å…¶ IP åœ°å€è·Ÿç½‘ç»œæ’ä»¶åˆ›å»ºçš„ç½‘æ¡¥æœ‰å…³ã€‚</strong></p>
<blockquote>
<p>æ›´å¤šçš„ Docker ç½‘ç»œçŸ¥è¯†:Â <a href="https://docs.docker.com/network/bridge/">https://docs.docker.com/network/bridge/</a></p>
</blockquote>
<h2 id="è·¨èŠ‚ç‚¹è®¿é—®-pod">è·¨èŠ‚ç‚¹è®¿é—® Pod<a hidden class="anchor" aria-hidden="true" href="#è·¨èŠ‚ç‚¹è®¿é—®-pod">#</a></h2>
<p>æ—¢ç„¶ Pod çš„ IP æ˜¯ Docker åˆ›å»ºçš„ï¼Œè€Œ Docker åˆ›å»ºçš„ IP åªèƒ½åœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šè®¿é—®ï¼Œé‚£ä¹ˆæ€ä¹ˆæ‰èƒ½åœ¨åˆ«çš„èŠ‚ç‚¹ä¸Šè®¿é—®è¿™ä¸ª Pod IPï¼Ÿ</p>
<p><strong>ç½‘ç»œæ’ä»¶</strong>ï¼Œé™¤äº† weave ï¼Œè¿˜æœ‰å¾ˆå¤šç½‘ç»œæ’ä»¶å¯ä»¥ä½¿ç”¨ï¼Œå¦‚ calicoã€flannelã€‚Kubernetes ç½‘ç»œæ¨¡å‹ä¸­æœ‰ä¸ªå« <code>CNI</code> çš„æ ‡å‡†æ¥å£ï¼Œåªè¦å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œç”¨å•¥ç½‘ç»œæ’ä»¶éƒ½æ²¡é—®é¢˜ï¼Œä½¿ç”¨è€…ä¸éœ€è¦å…³å¿ƒæ’ä»¶æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<p>CNI çš„ä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li>èŠ‚ç‚¹ä¸Šçš„ Pod å¯ä»¥ä¸é€šè¿‡ NAT å’Œå…¶ä»–ä»»ä½•èŠ‚ç‚¹ä¸Šçš„ Pod é€šä¿¡(ç§°ä¸ºæ‰å¹³åŒ–ç½‘ç»œ)ï¼Œå³<strong>èŠ‚ç‚¹é—´ Pod çš„äº’ç›¸è®¿é—®</strong>ï¼›</li>
<li>èŠ‚ç‚¹ä¸Šçš„ä»£ç†ï¼ˆæ¯”å¦‚ï¼šç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ã€kubeletï¼‰å¯ä»¥å’ŒèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Pod é€šä¿¡ï¼Œå³<strong>ç³»ç»Ÿç»„ä»¶è®¿é—® Pod</strong>ï¼›</li>
</ul>
<h1 id="2-service">2. Service<a hidden class="anchor" aria-hidden="true" href="#2-service">#</a></h1>
<p>Service æ˜¯ Kubernetes çš„å¯¹è±¡ï¼Œå®ƒè·Ÿç½‘ç»œæœ‰å…³ï¼Œ Service ä¸æ˜¯æœåŠ¡æä¾›è€…ï¼Œä¹Ÿä¸æ˜¯åº”ç”¨ç¨‹åºæ¥å£ã€‚</p>
<p>Service æ˜¯å°†è¿è¡Œåœ¨ä¸€ç»„ Pods ä¸Šçš„åº”ç”¨ç¨‹åºï¼Œå…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æŠ½è±¡æ–¹æ³•ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ Deployment ã€Daemon ç­‰éƒ¨ç½² Podï¼Œåˆ™å¯ä¸ºæ­¤æ§åˆ¶å™¨åˆ›å»º Serviceï¼ŒService ä¼šç›‘æ§æ­¤ Deployment ä¸Šå¢åŠ æˆ–ç§»é™¤ Pod çš„æ“ä½œï¼Œè‡ªåŠ¨ä¸ºæ‰€æœ‰ Pod æä¾›ç½‘ç»œæœåŠ¡ã€‚å½“ç„¶ï¼ŒService å¹¶ä¸æ˜¯æŒ‡å‘ Deploymentã€Daemon çš„ï¼Œè€Œæ˜¯é€šè¿‡ Label æŒ‡å‘ç›¸å…³çš„ Podã€‚</p>
<h2 id="21-service-çš„å®šä¹‰å’Œåˆ›å»º">2.1 Service çš„å®šä¹‰å’Œåˆ›å»º<a hidden class="anchor" aria-hidden="true" href="#21-service-çš„å®šä¹‰å’Œåˆ›å»º">#</a></h2>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Deployment å¯¹è±¡ï¼ŒåŒ…å«ä¸‰ä¸ª Pod å®ä¾‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubectl create deployment nginx --image<span class="o">=</span>nginx:latest --replicas<span class="o">=</span><span class="m">3</span>
</span></span></code></pre></div><p>æ¥ç€ï¼Œä¸ºè¿™äº› Pod åˆ›å»ºä¸€ä¸ª Serviceã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubectl expose deployment nginx --type<span class="o">=</span>ClusterIP --port<span class="o">=</span><span class="m">6666</span> --target-port<span class="o">=</span><span class="m">80</span>
</span></span></code></pre></div><p>æŸ¥çœ‹åˆ›å»ºçš„ Serviceï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>root@zqf-master1 ~<span class="o">]</span><span class="c1"># k get svc -o wide</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE   SELECTOR
</span></span><span class="line"><span class="ln">3</span><span class="cl">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP    17m   &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">nginx        ClusterIP   10.101.6.208   &lt;none&gt;        6666/TCP   7s    <span class="nv">app</span><span class="o">=</span>nginx
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼ŒService ä¼šç”Ÿæˆä¸€ä¸ªéšæœº IPÂ <code>10.101.6.208</code>ï¼Œæˆ‘ä»¬ä¸º Pod æ˜ å°„äº†ä¸€ä¸ªæ–°çš„ç«¯å£ä¸º 6666ï¼Œæ­¤ç«¯å£æ˜ å°„åˆ°äº† Pod çš„ 80 ç«¯å£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•è¿™ä¸ª IP å’Œ ç«¯å£æ˜¯å¦å¯ç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>root@zqf-master1 ~<span class="o">]</span><span class="c1"># curl 10.101.6.208:6666</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="ln">11</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">12</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">13</span><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="ln">14</span><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="ln">15</span><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="ln">18</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="ln">19</span><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="ln">20</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="ln">23</span><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="ln">24</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><blockquote>
<p>åœ¨æ²¡æœ‰å®‰è£…ç½‘ç»œæ’ä»¶çš„å‰æä¸‹ï¼Œå‡å¦‚æœ‰ masterã€slave ä¸¤ä¸ªèŠ‚ç‚¹ï¼ŒPod éƒ½è¢«éƒ¨ç½²åˆ° slave èŠ‚ç‚¹ä¸Šï¼Œè€Œ master èŠ‚ç‚¹æ²¡æœ‰éƒ¨ç½²æ­¤ Pod çš„è¯ï¼Œmaster æ˜¯è®¿é—®ä¸äº†æ­¤ Serviceçš„ã€‚</p>
</blockquote>
<p>ä¸ºäº†éªŒè¯è¿™æ ·æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æ¶ˆå» master çš„æ±¡ç‚¹ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«éƒ¨ç½²ç”¨æˆ·è‡ªå®šä¹‰çš„ Podã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">kubectl taint node zqf-master1 node-role.kubernetes.io/control-plane:NoSchedule-
</span></span></code></pre></div><p>ç„¶åé‡æ–°éƒ¨ç½² Deploymentï¼Œä½†æ˜¯ä¸éœ€è¦é‡æ–°éƒ¨ç½² Serviceã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">kubectl delete deployyment nginx
</span></span><span class="line"><span class="ln">2</span><span class="cl">kubectl create deployment nginx --image=nginx:latest --replicas=3
</span></span></code></pre></div><p>æŸ¥çœ‹è¿™äº› Pod éƒ½è¢«éƒ¨ç½²åˆ°å“ªé‡Œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">[root@zqf-master1 ~]# k get po -o wide
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                     READY   STATUS              RESTARTS   AGE   IP       NODE          NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">3</span><span class="cl">nginx-56fcf95486-lg4bf   0/1     ContainerCreating   0          5s    &lt;none&gt;   zqf-slave1    &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">nginx-56fcf95486-m5v5b   0/1     ContainerCreating   0          5s    &lt;none&gt;   zqf-master1   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">5</span><span class="cl">nginx-56fcf95486-vjk2p   0/1     ContainerCreating   0          5s    &lt;none&gt;   zqf-slave1    &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>ç°åœ¨ï¼Œmasterã€slave éƒ½éƒ¨ç½²äº† Podï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ master èŠ‚ç‚¹ä¸Šè®¿é—®æ­¤ Serviceï¼Œå¯ä»¥æ­£å¸¸è®¿é—®ã€‚</p>
<hr>
<p>åœ¨ Deployment å¯¹è±¡ä¸Šåˆ›å»º Serviceï¼Œä¼šç›´æ¥å…³è”ä¸€ä¸ª Deployment ä¸­çš„æ‰€æœ‰ Podï¼Œå¹¶ç›‘æ§æ˜¯å¦æœ‰æ–°å»ºæˆ–ç§»é™¤ Pod ï¼Œæ— è®º Pod çš„æ•°é‡æœ‰å¤šå°‘ï¼ŒService éƒ½å¯ä»¥ä»£ç†è¿™äº› Podã€‚</p>
<p>å¦‚æœæˆ‘ä»¬é€šè¿‡ YAML å®šä¹‰ Serviceï¼Œå…¶æ¨¡æ¿å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">MyApp</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6666</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>ç”±äº Service çš„ IP æ˜¯è™šæ‹Ÿçš„ï¼Œå› æ­¤æ­¤ IP æ˜¯æ— æ³• Ping é€šçš„ã€‚</p>
</blockquote>
<h2 id="22-service-å¤–éƒ¨æœåŠ¡ç±»å‹">2.2 Service å¤–éƒ¨æœåŠ¡ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#22-service-å¤–éƒ¨æœåŠ¡ç±»å‹">#</a></h2>
<p>è™½ç„¶åˆ›å»ºäº† Service åï¼Œæ‰€æœ‰çš„ Pod å¯ä»¥è¢«ä¸€ä¸ª IP åœ°å€è®¿é—®ï¼Œä½†æ˜¯è¿™ä¸ª IP åªèƒ½åœ¨è¢«éƒ¨ç½²äº† Pod çš„èŠ‚ç‚¹ä¸­è®¿é—®ï¼Œ ä¸èƒ½è¢«é›†ç¾¤å¤–è®¿é—®ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åˆ›å»º Service çš„æ—¶å€™ï¼Œä½¿ç”¨äº† ClusterIP ç±»å‹ï¼Œ<strong>å¦‚æœæ˜¯ NodePort ç±»å‹ï¼Œåˆ™å¯ä»¥è¢«å¤–ç•Œè®¿é—®åˆ°ã€‚</strong></p>
<p>Kubernetes Service æœ‰ä¸ª ServiceType ï¼Œå…è®¸æˆ‘ä»¬æŒ‡å®šå¦‚ä½•æš´éœ²æœåŠ¡ï¼Œå¯ä»¥å°†ä¸€ä¸ª Service æš´éœ²åˆ°é›†ç¾¤å¤–éƒ¨ï¼Œå¤–ç•Œå¯ä»¥é€šè¿‡ IP è®¿é—®è¿™ä¸ª Serviceã€‚</p>
<p>Type æœ‰å››ç§ç±»å‹ï¼Œå…¶å–å€¼è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>ClusterIP</strong>ï¼šé€šè¿‡é›†ç¾¤å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼ŒClusterIP æ˜¯ ServiceType çš„é»˜è®¤å€¼ã€‚</li>
<li><strong>NodePort</strong>ï¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ IP å’Œé™æ€ç«¯å£ï¼ˆ<code>NodePort</code>ï¼‰æš´éœ²æœåŠ¡ã€‚ç”±äºå…¶æ˜¯èŠ‚ç‚¹ä¸Šçš„ ï¼Œæ‰€ä»¥å…·æœ‰é€šè¿‡èŠ‚ç‚¹çš„å…¬ç½‘ IP è®¿é—®è¿™ä¸ªæœåŠ¡ã€‚</li>
<li><strong>LoadBalancer</strong>ï¼šä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„Â <code>NodePort</code>Â æœåŠ¡å’ŒÂ <code>ClusterIP</code>Â æœåŠ¡ä¸Šã€‚éœ€è¦äº‘å¹³å°æœåŠ¡æä¾›å•†çš„æ”¯æŒï¼Œåˆ†é…å…¬ç½‘ IP æ‰èƒ½ä½¿ç”¨ã€‚</li>
<li><strong>ExternalName</strong>ï¼šé€šè¿‡è¿”å›Â <code>CNAME</code>Â å’Œå¯¹åº”å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ°Â <code>externalName</code>Â å­—æ®µçš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œ<code>foo.bar.example.com</code>ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>éœ€è¦ä½¿ç”¨ kube-dns 1.7 åŠä»¥ä¸Šç‰ˆæœ¬æˆ–è€… CoreDNS 0.0.8 åŠä»¥ä¸Šç‰ˆæœ¬æ‰èƒ½ä½¿ç”¨Â <code>ExternalName</code>Â ç±»å‹ã€‚</p>
</blockquote>
<p>ClusterIPã€NodePortã€LoadBalancer ä¸‰è€…æ˜¯æœ‰å…³ç³»çš„ï¼Œå‰è€…æ˜¯åè€…çš„åŸºç¡€ã€‚åˆ›å»ºä¸€ä¸ª NodePort ç±»å‹çš„ Serviceï¼Œå¿…å®šå¸¦æœ‰ä¸€ä¸ª ClusterIPï¼›åˆ›å»ºä¸€ä¸ª LoadBalancerï¼Œå¿…å®šå¸¦æœ‰ ClusterIPã€NodePortã€‚</p>
<h3 id="221-nodeport">2.2.1 NodePort<a hidden class="anchor" aria-hidden="true" href="#221-nodeport">#</a></h3>
<p>å°†å‰é¢åˆ›å»ºçš„ Service ä¿®æ”¹ä¸º NodePort ç±»å‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">kubectl edit service nginx
</span></span></code></pre></div><p>ç„¶åæŸ¥çœ‹ Service åˆ—è¡¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>root@zqf-master1 ~<span class="o">]</span><span class="c1"># k get svc -o wide</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE   SELECTOR
</span></span><span class="line"><span class="ln">3</span><span class="cl">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP          33m   &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">nginx        NodePort    10.101.6.208   &lt;none&gt;        6666:31292/TCP   16m   <span class="nv">app</span><span class="o">=</span>nginx
</span></span></code></pre></div><p>æ­¤æ—¶ Service ä¼šåˆ›å»ºä¸€ä¸ª éšæœºç«¯å£ï¼Œè¿™ä¸ªç«¯å£æ˜ å°„åˆ°æ¯ä¸ªéƒ¨ç½²äº† Pod çš„èŠ‚ç‚¹ä¸Šï¼Œæ ·ä¾‹ä¸­æ˜¯31292ï¼Œæ­¤æ—¶å¤–ç•Œå¯ä»¥é€šè¿‡ä½¿ç”¨èŠ‚ç‚¹ IP è®¿é—®æ­¤ Serviceã€‚</p>
<p>æ­¤æ—¶ï¼Œå¯ä»¥åœ¨é›†ç¾¤å…¶ä»–æœºå™¨è®¿é—®ä¸¤å°èŠ‚ç‚¹ IP  <code>http://10.101.5.219:31292/</code> å’Œ <code>http://10.101.5.220:31292/</code> å¯ä»¥æ­£å¸¸è¿”å› nginx ç½‘é¡µã€‚</p>
<h3 id="222-loadbalancer">2.2.2 LoadBalancer<a hidden class="anchor" aria-hidden="true" href="#222-loadbalancer">#</a></h3>
<p>ç°åœ¨ Pod è´Ÿè½½å‡è¡¡äº†ï¼Œä½†ä¸èƒ½åªè®¿é—®ä¸€ä¸ªèŠ‚ç‚¹ï¼ŸèŠ‚ç‚¹çš„ç½‘ç»œä¹Ÿéœ€è¦è´Ÿè½½å‡è¡¡ï¼Œè€Œä¸”èŠ‚ç‚¹ IP è¿™ä¹ˆå¤šï¼Œç”¨æˆ·æ€»ä¸èƒ½è®°ä½è¿™ä¹ˆå¤š IP ï¼Ÿå°±ç®—ä½¿ç”¨åŸŸåï¼ŒåŸŸåä¹Ÿä¸èƒ½ç»‘å®šè¿™ä¹ˆå¤š IP å‘€ï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨ LoadBalancer ã€‚</p>
<hr>
<p>åˆ é™¤ä¹‹å‰çš„ service ï¼Œé‡æ–°åˆ›å»ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubectl expose deployment nginx --type<span class="o">=</span>LoadBalancer  --port<span class="o">=</span><span class="m">6666</span> --target-port<span class="o">=</span><span class="m">80</span>
</span></span></code></pre></div><blockquote>
<p>å¦‚æœåªå¡«å†™ &ndash;port ï¼Œæ­¤æ—¶æ˜ å°„çš„ç«¯å£è·Ÿ Pod ç«¯å£ä¸€è‡´</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>root@zqf-master1 ~<span class="o">]</span><span class="c1"># k get svc</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME         TYPE           CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">kubernetes   ClusterIP      10.96.0.1      &lt;none&gt;        443/TCP          54m
</span></span><span class="line"><span class="ln">4</span><span class="cl">nginx        LoadBalancer   10.106.1.221   &lt;pending&gt;     6666:31960/TCP   19s
</span></span></code></pre></div><p>å½“ä½¿ç”¨ LoadBalancer æš´éœ²æœåŠ¡åˆ°é›†ç¾¤å¤–éƒ¨ç½‘ç»œæ—¶ï¼Œäº‘åŸºç¡€è®¾æ–½éœ€è¦æ—¶é—´æ¥åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨å¹¶è·å–æœåŠ¡ä¸­çš„ IP åœ°å€ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯Â <code>minikube</code>ã€<code>kubeadm</code>Â ç­‰åˆ›å»ºçš„è‡ªå®šä¹‰ Kubernetes é›†ç¾¤ï¼Œæ²¡æœ‰é›†æˆ LoadBalancer ï¼Œåˆ™ä¼šä¸€ç›´å¤„äºÂ <code>&lt;Pending&gt;</code>Â çŠ¶æ€ã€‚</p>
<h2 id="23-service-å¦‚ä½•é€‰æ‹©-pod">2.3 Service å¦‚ä½•é€‰æ‹© Pod<a hidden class="anchor" aria-hidden="true" href="#23-service-å¦‚ä½•é€‰æ‹©-pod">#</a></h2>
<p>é€šè¿‡å‘½ä»¤æŸ¥çœ‹ iptables é…ç½®ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">iptables-save
</span></span></code></pre></div><p>åœ¨ç»ˆç«¯æ§åˆ¶å°ä¸­æŸ¥æ‰¾Â <code>random</code>Â å…³é”®å­—ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">-A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment <span class="s2">&#34;default/nginx -&gt; 172.16.41.201:80&#34;</span> -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-KVETUJWAGOYJMI5D
</span></span><span class="line"><span class="ln">2</span><span class="cl">-A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment <span class="s2">&#34;default/nginx -&gt; 172.16.41.202:80&#34;</span> -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-OGCI3CVDD3KXHXYJ
</span></span><span class="line"><span class="ln">3</span><span class="cl">-A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment <span class="s2">&#34;default/nginx -&gt; 172.16.41.203:80&#34;</span> -j KUBE-SEP-PEONUJMSH5W46AFI
</span></span></code></pre></div><p>æœ‰ä¸‰ä¸ªÂ <code>default/nginx</code>ï¼Œ ç¬¬ä¸€ä¸ª pod è¢«è®¿é—®çš„æœºä¼šæ˜¯Â <code>0.33333...</code>ã€‚åœ¨å‰©ä¸‹çš„ 2/3 çš„æ¦‚ç‡ä¸­ï¼Œæœ‰ 0.5 çš„æ¦‚ç‡é€‰æ‹©ç¬¬äºŒä¸ª Podï¼Œå‰©ä¸‹çš„ 1/3 æ¦‚ç‡é€‰æ‹©ç¬¬ä¸‰ä¸ª Podã€‚è¿™ç§éšæœºé€‰æ‹©çš„æ¨¡å¼ç§°ä¸º <code>iptables</code> ä»£ç†æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ kube-proxy çš„é»˜è®¤æ¨¡å¼ã€‚</p>
<h2 id="24-kube-proxy-ä¸‰ç§ä»£ç†æ¨¡å¼">2.4 kube-proxy ä¸‰ç§ä»£ç†æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#24-kube-proxy-ä¸‰ç§ä»£ç†æ¨¡å¼">#</a></h2>
<p>å½“æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤åˆ›å»ºä¸€ä¸ª Service æ—¶ï¼Œå¯çœ‹åˆ°æ¯ä¸ª Service éƒ½æœ‰ä¸€ä¸ª IP åœ°å€ï¼Œè¿™æ˜¯ç”± kube-proxy è´Ÿè´£ä¸º Service å®ç°çš„ä¸€ç§è™šæ‹Ÿ IP ï¼Œå³Â <code>ClusterIP</code>ã€‚</p>
<p>kube-proxy å¯ä»¥ä¸ºå¤šä¸ª Pod åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„ä»£ç†ï¼Œåœ¨è®¿é—® Service æ—¶ï¼Œè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ª Pod æä¾›æœåŠ¡ï¼Œè‡³äºå¦‚ä½•é€‰æ‹© Podï¼Œkube-proxy æœ‰ä¸‰ç§æ¨¡å¼ã€‚</p>
<ul>
<li><code>userspace</code> ä»£ç†æ¨¡å¼</li>
<li><code>iptables</code> ä»£ç†æ¨¡å¼(é»˜è®¤)</li>
<li><code>IPVS</code> ä»£ç†æ¨¡å¼ï¼ˆKubernetes v1.11 ï¼Œå¦‚æœè¦ä½¿ç”¨ IPVSï¼Œéœ€è¦ä¿®æ”¹é…ç½®æ¿€æ´»ï¼‰</li>
</ul>
<p>åœ¨è¿™äº›ä»£ç†æ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸äº†è§£ Kubernetes æœåŠ¡æˆ– Pod çš„ä»»ä½•ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œå°† Port ä»£ç†åˆ°é€‚å½“çš„åç«¯ã€‚</p>
<h3 id="241-userspace-ä»£ç†æ¨¡å¼">2.4.1 userspace ä»£ç†æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#241-userspace-ä»£ç†æ¨¡å¼">#</a></h3>
<p>userspace æ¨¡å¼ä¸‹ï¼Œ kube-proxy é€šè¿‡<strong>è½®è½¬ç®—æ³•</strong>é€‰æ‹© podã€‚</p>
<p>å¯¹æ¯ä¸ª Serviceï¼Œå®ƒä¼šåœ¨æœ¬åœ° Node ä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£(ç«¯å£å·å¤§äº 30000)ã€‚ ä»»ä½•è¿æ¥åˆ°æ­¤ç«¯å£çš„è¯·æ±‚ï¼Œéƒ½ä¼šè¢«ä»£ç†åˆ° Service åç«¯çš„æŸä¸ªÂ <code>Pod</code>Â ä¸Šã€‚ ä½¿ç”¨å“ªä¸ªåç«¯ Podï¼Œæ˜¯ kube-proxy åŸºäº YAML çš„Â <code>SessionAffinity</code>Â ç»ˆç«¯æ¥ç¡®å®šçš„ã€‚</p>
<p>æœ€åï¼Œé…ç½® iptables è§„åˆ™ï¼Œæ•è·åˆ°è¾¾è¯¥ Service çš„Â <code>clusterIP</code>Â å’ŒÂ <code>Port</code>Â çš„è¯·æ±‚ï¼Œå¹¶é‡å®šå‘åˆ°ä»£ç†ç«¯å£ï¼Œä»£ç†ç«¯å£å†ä»£ç†è¯·æ±‚åˆ°åç«¯ Podã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">è®¿é—® -&gt; clusterIP -&gt; ä»£ç† -&gt; ä»»ä¸€ Pod
</span></span></code></pre></div><h3 id="242-iptables-ä»£ç†æ¨¡å¼">2.4.2 iptables ä»£ç†æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#242-iptables-ä»£ç†æ¨¡å¼">#</a></h3>
<p><strong>kube-proxy é»˜è®¤æ¨¡å¼</strong>ã€‚iptables ä»£ç†æ¨¡å¼çš„ç­–ç•¥<strong>éšæœºé€‰æ‹©ä¸€ä¸ª Pod</strong>ã€‚</p>
<p>å®ƒä¼šä¸ºæ¯ä¸ª Service é…ç½® iptables è§„åˆ™ï¼Œæ•è·æ‰€æœ‰è®¿é—®æ­¤ Service <code>clusterIP</code> çš„è¯·æ±‚ï¼Œè¿›è€Œå°†è¯·æ±‚é‡å®šå‘åˆ° Service çš„ä¸€ç»„åç«¯ä¸­çš„æŸä¸ª Pod ä¸Šé¢ã€‚ å¯¹äºæ¯ä¸ª Endpoints å¯¹è±¡ï¼Œå®ƒä¹Ÿä¼šé…ç½® iptables è§„åˆ™ï¼Œè¿™ä¸ªè§„åˆ™ä¼šé€‰æ‹©ä¸€ä¸ªåç«¯ç»„åˆã€‚</p>
<p>ä½¿ç”¨ iptables å¤„ç†æµé‡å…·æœ‰è¾ƒä½çš„ç³»ç»Ÿå¼€é”€ï¼Œå› ä¸ºæµé‡ç”± Linux netfilter å¤„ç†ï¼Œ è€Œæ— éœ€åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´åˆ‡æ¢ï¼Œ è¿™ç§æ–¹æ³•ä¹Ÿå¯èƒ½æ›´å¯é ã€‚</p>
<p>å¦‚æœ kube-proxy åœ¨ iptables æ¨¡å¼ä¸‹è¿è¡Œï¼Œå¦‚æœéšæœºæ‰€é€‰çš„ç¬¬ä¸€ä¸ª Pod æ²¡æœ‰å“åº”ï¼Œ åˆ™è¿æ¥ä¼šå¤±è´¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨å…¶ä»–åç«¯ Pod é‡è¯• ã€‚</p>
<h3 id="243-ipvs-ä»£ç†æ¨¡å¼">2.4.3 IPVS ä»£ç†æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#243-ipvs-ä»£ç†æ¨¡å¼">#</a></h3>
<p>ä¸å…¶ä»–ä»£ç†æ¨¡å¼ç›¸æ¯”ï¼ŒIPVS æ¨¡å¼æ”¯æŒæ›´é«˜çš„ç½‘ç»œæµé‡ååé‡ã€‚ä¸ iptables æ¨¡å¼ä¸‹çš„ kube-proxy ç›¸æ¯”ï¼ŒIPVS æ¨¡å¼ä¸‹çš„ kube-proxy é‡å®šå‘é€šä¿¡çš„å»¶è¿Ÿè¦çŸ­ï¼Œå¹¶ä¸”åœ¨åŒæ­¥ä»£ç†è§„åˆ™æ—¶å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p>IPVS æä¾›äº†æ›´å¤šé€‰é¡¹æ¥å¹³è¡¡åç«¯ Pod çš„æµé‡ã€‚ è¿™äº›æ˜¯ï¼š</p>
<ul>
<li><code>rr</code>ï¼šè½®æ›¿ï¼ˆRound-Robinï¼‰</li>
<li><code>lc</code>ï¼šæœ€å°‘é“¾æ¥ï¼ˆLeast Connectionï¼‰ï¼Œå³æ‰“å¼€é“¾æ¥æ•°é‡æœ€å°‘è€…ä¼˜å…ˆ</li>
<li><code>dh</code>ï¼šç›®æ ‡åœ°å€å“ˆå¸Œï¼ˆDestination Hashingï¼‰</li>
<li><code>sh</code>ï¼šæºåœ°å€å“ˆå¸Œï¼ˆSource Hashingï¼‰</li>
<li><code>sed</code>ï¼šæœ€çŸ­é¢„æœŸå»¶è¿Ÿï¼ˆShortest Expected Delayï¼‰</li>
<li><code>nq</code>ï¼šä»ä¸æ’é˜Ÿï¼ˆNever Queueï¼‰</li>
</ul>
<blockquote>
<p>Service æš´éœ²å¤šç«¯å£</p>
</blockquote>
<p>å¦‚æœè¦åœ¨ Service ä¸­æš´éœ²å¤šä¸ªç«¯å£ï¼Œåˆ™æ¯ä¸ªç«¯å£éƒ½éœ€è¦è®¾ç½®ä¸€ä¸ªåå­—ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">    ports:
</span></span><span class="line"><span class="ln">2</span><span class="cl">    - name: p1
</span></span><span class="line"><span class="ln">3</span><span class="cl">      port: 2323
</span></span><span class="line"><span class="ln">4</span><span class="cl">      protocol: TCP
</span></span><span class="line"><span class="ln">5</span><span class="cl">      targetPort: 81
</span></span><span class="line"><span class="ln">6</span><span class="cl">    - name: p2
</span></span><span class="line"><span class="ln">7</span><span class="cl">      port: 6666
</span></span><span class="line"><span class="ln">8</span><span class="cl">      protocol: TCP
</span></span><span class="line"><span class="ln">9</span><span class="cl">      targetPort: 82
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/kubernetes/">Kubernetes</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/tech/kubernetes/%E5%9F%BA%E4%BA%8E-imagepullsecret-%E4%B8%8B%E8%BD%BD%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%88%B6%E5%93%81/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>åŸºäº imagePullSecret ä¸‹è½½ç§æœ‰é•œåƒä»“åº“åˆ¶å“</span>
  </a>
  <a class="next" href="/tech/kubernetes/%E4%BD%BF%E7%94%A8-nfs-%E4%BD%9C%E4%B8%BA-k8s-%E5%AD%98%E5%82%A8%E6%8F%92%E4%BB%B6/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ä½¿ç”¨ NFS ä½œä¸º K8s å­˜å‚¨æ’ä»¶</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="/">xgbt&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
