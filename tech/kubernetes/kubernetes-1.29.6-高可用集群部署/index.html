<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kubernetes 1.29.6 é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½² | xgbt&#39;s Blog</title>
<meta name="keywords" content="Kubernetes">
<meta name="description" content="æ¶æ„è®¾è®¡
OS: AlmaLinux 9.1

  
      
          èŠ‚ç‚¹å
          IP åœ°å€
      
  
  
      
          zqf-Master01
          10.101.5.110
      
      
          zqf-Master02
          10.101.5.111
      
      
          zqf-Master03
          10.101.5.112
      
      
          zqf-Worker01
          10.101.5.113
      
      
          zqf-Worker02
          10.101.5.114
      
      
          zqf-Worker03
          10.101.5.115
      
      
          zqf-Worker04
          10.101.5.116
      
  

1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ
1.1 åŸºç¡€é…ç½®
1.1.1 é…ç½®é•œåƒæº
1sed -e &#39;s|^mirrorlist=|#mirrorlist=|g&#39; \
2    -e &#39;s|^#\s*baseurl=https://repo.almalinux.org/almalinux|baseurl=https://mirrors.zju.edu.cn/almalinux|g&#39; \
3    -i.bak \
4    /etc/yum.repos.d/almalinux-*.repo
1dnf makecache
1.1.2 é…ç½®ä¸»æœºå
1hostnamectlÂ set-hostname &lt;ä¸»æœºå&gt;
æ·»åŠ è§£æè®°å½•ï¼Œä½¿èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ä¸»æœºåè®¿é—®é€šä¿¡">
<meta name="author" content="">
<link rel="canonical" href="/tech/kubernetes/kubernetes-1.29.6-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.4b0be15b6b891613a91dad3a5279f108f18aa855a6dcb49a1e5ff9fade239870.css" integrity="sha256-SwvhW2uJFhOpHa06UnnxCPGKqFWm3LSaHl/5&#43;t4jmHA=" rel="preload stylesheet" as="style">
<link rel="icon" href="/assets/apple-icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="/tech/kubernetes/kubernetes-1.29.6-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><style>
@import url('https://fonts.cdnfonts.com/css/code-new-roman');
</style>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=LXGW+WenKai+TC&display=swap"
    rel="stylesheet"><meta property="og:title" content="Kubernetes 1.29.6 é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²" />
<meta property="og:description" content="æ¶æ„è®¾è®¡
OS: AlmaLinux 9.1

  
      
          èŠ‚ç‚¹å
          IP åœ°å€
      
  
  
      
          zqf-Master01
          10.101.5.110
      
      
          zqf-Master02
          10.101.5.111
      
      
          zqf-Master03
          10.101.5.112
      
      
          zqf-Worker01
          10.101.5.113
      
      
          zqf-Worker02
          10.101.5.114
      
      
          zqf-Worker03
          10.101.5.115
      
      
          zqf-Worker04
          10.101.5.116
      
  

1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ
1.1 åŸºç¡€é…ç½®
1.1.1 é…ç½®é•œåƒæº
1sed -e &#39;s|^mirrorlist=|#mirrorlist=|g&#39; \
2    -e &#39;s|^#\s*baseurl=https://repo.almalinux.org/almalinux|baseurl=https://mirrors.zju.edu.cn/almalinux|g&#39; \
3    -i.bak \
4    /etc/yum.repos.d/almalinux-*.repo
1dnf makecache
1.1.2 é…ç½®ä¸»æœºå
1hostnamectlÂ set-hostname &lt;ä¸»æœºå&gt;
æ·»åŠ è§£æè®°å½•ï¼Œä½¿èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ä¸»æœºåè®¿é—®é€šä¿¡" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/tech/kubernetes/kubernetes-1.29.6-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/" /><meta property="article:section" content="tech" />
<meta property="article:published_time" content="2024-11-13T01:09:19+08:00" />
<meta property="article:modified_time" content="2024-11-13T01:09:19+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes 1.29.6 é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²"/>
<meta name="twitter:description" content="æ¶æ„è®¾è®¡
OS: AlmaLinux 9.1

  
      
          èŠ‚ç‚¹å
          IP åœ°å€
      
  
  
      
          zqf-Master01
          10.101.5.110
      
      
          zqf-Master02
          10.101.5.111
      
      
          zqf-Master03
          10.101.5.112
      
      
          zqf-Worker01
          10.101.5.113
      
      
          zqf-Worker02
          10.101.5.114
      
      
          zqf-Worker03
          10.101.5.115
      
      
          zqf-Worker04
          10.101.5.116
      
  

1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ
1.1 åŸºç¡€é…ç½®
1.1.1 é…ç½®é•œåƒæº
1sed -e &#39;s|^mirrorlist=|#mirrorlist=|g&#39; \
2    -e &#39;s|^#\s*baseurl=https://repo.almalinux.org/almalinux|baseurl=https://mirrors.zju.edu.cn/almalinux|g&#39; \
3    -i.bak \
4    /etc/yum.repos.d/almalinux-*.repo
1dnf makecache
1.1.2 é…ç½®ä¸»æœºå
1hostnamectlÂ set-hostname &lt;ä¸»æœºå&gt;
æ·»åŠ è§£æè®°å½•ï¼Œä½¿èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ä¸»æœºåè®¿é—®é€šä¿¡"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Tech",
      "item": "/tech/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Kubernetes 1.29.6 é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²",
      "item": "/tech/kubernetes/kubernetes-1.29.6-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetes 1.29.6 é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²",
  "name": "Kubernetes 1.29.6 é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²",
  "description": "æ¶æ„è®¾è®¡ OS: AlmaLinux 9.1\nèŠ‚ç‚¹å IP åœ°å€ zqf-Master01 10.101.5.110 zqf-Master02 10.101.5.111 zqf-Master03 10.101.5.112 zqf-Worker01 10.101.5.113 zqf-Worker02 10.101.5.114 zqf-Worker03 10.101.5.115 zqf-Worker04 10.101.5.116 1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ 1.1 åŸºç¡€é…ç½® 1.1.1 é…ç½®é•œåƒæº 1sed -e \u0026#39;s|^mirrorlist=|#mirrorlist=|g\u0026#39; \\ 2 -e \u0026#39;s|^#\\s*baseurl=https://repo.almalinux.org/almalinux|baseurl=https://mirrors.zju.edu.cn/almalinux|g\u0026#39; \\ 3 -i.bak \\ 4 /etc/yum.repos.d/almalinux-*.repo 1dnf makecache 1.1.2 é…ç½®ä¸»æœºå 1hostnamectlÂ set-hostname \u0026lt;ä¸»æœºå\u0026gt; æ·»åŠ è§£æè®°å½•ï¼Œä½¿èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ä¸»æœºåè®¿é—®é€šä¿¡\n",
  "keywords": [
    "Kubernetes"
  ],
  "articleBody": "æ¶æ„è®¾è®¡ OS: AlmaLinux 9.1\nèŠ‚ç‚¹å IP åœ°å€ zqf-Master01 10.101.5.110 zqf-Master02 10.101.5.111 zqf-Master03 10.101.5.112 zqf-Worker01 10.101.5.113 zqf-Worker02 10.101.5.114 zqf-Worker03 10.101.5.115 zqf-Worker04 10.101.5.116 1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ 1.1 åŸºç¡€é…ç½® 1.1.1 é…ç½®é•œåƒæº 1sed -e 's|^mirrorlist=|#mirrorlist=|g' \\ 2 -e 's|^#\\s*baseurl=https://repo.almalinux.org/almalinux|baseurl=https://mirrors.zju.edu.cn/almalinux|g' \\ 3 -i.bak \\ 4 /etc/yum.repos.d/almalinux-*.repo 1dnf makecache 1.1.2 é…ç½®ä¸»æœºå 1hostnamectlÂ set-hostname \u003cä¸»æœºå\u003e æ·»åŠ è§£æè®°å½•ï¼Œä½¿èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ä¸»æœºåè®¿é—®é€šä¿¡\n1cat \u003c\u003c EOF \u003e\u003e /etc/hosts 210.101.5.110 zqf-Master01 310.101.5.111 zqf-Master02 410.101.5.112 zqf-Master03 510.101.5.113 zqf-Worker01 610.101.5.114 zqf-Worker02 710.101.5.115 zqf-Worker03 810.101.5.116 zqf-Worker04 9EOF 1.1.3 å…å¯†ç™»å½•é…ç½®ï¼ˆæ–°å¢/å¯é€‰ï¼‰ 1ssh-keygen -t rsa -b 2048 1ssh-copy-idÂ root@ç›®æ ‡èŠ‚ç‚¹IP 1.1.4 ç¦ç”¨é˜²ç«å¢™ 1systemctl stop firewalld \u0026\u0026 systemctl disable firewalld 2systemctl disable --now dnsmasq 1.1.5 ç¦ç”¨ SELINUX ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä½¿ SELINUX=disabled æ³¨æ„ï¼Œæ˜¯ disabled ï¼Œä¸æ˜¯ disable\n1vim /etc/selinux/config æˆ–è€…ï¼Œç›´æ¥æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ 1sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/sysconfig/selinux 2sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config æŸ¥çœ‹ç³»ç»Ÿ SELinux è¿è¡ŒçŠ¶æ€ 1sestatus 1.1.6 ç¦ç”¨ Swap åˆ†åŒº Swap æ˜¯äº¤æ¢åˆ†åŒºï¼Œå¦‚æœæœºå™¨å†…å­˜ä¸å¤Ÿï¼Œä¼šä½¿ç”¨swapåˆ†åŒºã€‚\nä½†æ˜¯ï¼Œswapåˆ†åŒºæ€§èƒ½è¾ƒä½ï¼Œk8s é»˜è®¤ä¸å…è®¸ä½¿ç”¨äº¤æ¢åˆ†åŒºã€‚\nkubeadm åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ£€æµ‹ swap çŠ¶æ€ï¼Œæœªå…³é—­ swap ä¼šå¯¼è‡´åˆå§‹åŒ–å¤±è´¥ã€‚\n1swapoff -a \u0026\u0026 sysctl -w vm.swappiness=0 2sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab è‹¥ swap ä¸º 0ï¼Œ è¯´æ˜ swap å…³é—­æˆåŠŸ\n1free -mh 1.1.7 æ—¶é—´åŒæ­¥ï¼ˆæ–°å¢ï¼‰ æ‰€æœ‰èŠ‚ç‚¹å®‰è£… chrony 1dnf -y install chrony æŒ‘ä¸€ä¸ªèŠ‚ç‚¹ (10.101.5.110) ä¿®æ”¹é…ç½® 1# é…ç½®chronyæœåŠ¡ 2vimÂ /etc/chrony.conf 3 4# æŒ‡å®šä½¿ç”¨çš„ä¸Šæ¸¸æ—¶é—´æœåŠ¡å™¨åœ°å€ 5poolÂ ntp.aliyun.comÂ iburst 6 7# å…è®¸è®¿é—®çš„æœåŠ¡å™¨ 8allowÂ 192.168.10.0/24 å…¶ä»–èŠ‚ç‚¹ä¿®æ”¹ä¸Šæ¸¸æœåŠ¡å™¨å³å¯ 1# é…ç½®chronyæœåŠ¡ 2vimÂ /etc/chrony.conf 3 4# æŒ‡å®š 10.101.5.110 ä¸ºä¸Šæ¸¸æœåŠ¡å™¨ 5pool 10.101.5.110 iburst å¯ç”¨æœåŠ¡ 1systemctl restart chronyd 2systemctl enable chronyd 5. æŸ¥çœ‹åŒæ­¥çŠ¶æ€\n1chronycÂ sources 1.1.8 é…ç½®ç³»ç»Ÿèµ„æºé™åˆ¶ 1vim /etc/security/limits.conf æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ŒåŒ…æ‹¬æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€æœ€å¤§è¿›ç¨‹æ•°é‡å’Œå†…å­˜é”å®šé™åˆ¶\n1* soft nofile 65536 2* hard nofile 131072 3* soft nproc 65535 4* hard nproc 655350 5* soft memlock unlimited 6* hard memlock unlimited 1.1.9 é…ç½®å†…æ ¸å‚æ•° 1sysctl net.core.bpf_jit_limit=452534528 é…ç½® K8S æ‰€éœ€å†…æ ¸å‚æ•°ã€‚\n1cat \u003c /etc/sysctl.d/k8s.conf 2net.ipv4.ip_forward = 1 3net.bridge.bridge-nf-call-iptables = 1 4net.bridge.bridge-nf-call-ip6tables = 1 5fs.may_detach_mounts = 1 6vm.overcommit_memory=1 7vm.panic_on_oom=0 8fs.inotify.max_user_watches=89100 9fs.file-max=52706963 10fs.nr_open=52706963 11net.netfilter.nf_conntrack_max=2310720 12net.ipv4.tcp_keepalive_time = 600 13net.ipv4.tcp_keepalive_probes = 3 14net.ipv4.tcp_keepalive_intvl =15 15net.ipv4.tcp_max_tw_buckets = 36000 16net.ipv4.tcp_tw_reuse = 1 17net.ipv4.tcp_max_orphans = 327680 18net.ipv4.tcp_orphan_retries = 3 19net.ipv4.tcp_syncookies = 1 20net.ipv4.tcp_max_syn_backlog = 16384 21net.ipv4.ip_conntrack_max = 65536 22net.ipv4.tcp_max_syn_backlog = 16384 23net.ipv4.tcp_timestamps = 0 24net.core.somaxconn = 16384 25vm.swappiness=0 26EOF å…¶ä¸­ï¼Œ\n1net.ipv4.ip_forward = 1 2net.bridge.bridge-nf-call-iptables = 1 3net.bridge.bridge-nf-call-ip6tables = 1 ä¹Ÿæ˜¯ Containerd CRI æ‰€éœ€çš„å†…æ ¸å‚æ•°ã€‚\nåŠ è½½ä¸Šè¿°å†…æ ¸å‚æ•°ç”Ÿæ•ˆæ‰€éœ€è¦çš„æ¨¡å—ï¼Œå¹¶åŠ è½½ç”Ÿæ•ˆ\n1modprobe --Â overlay 2modprobeÂ -- br_netfilter 3sysctl --system 1.3 é…ç½® IPVS K8S é›†ç¾¤å°†ä½¿ç”¨ ipvs æ¨¡å¼ï¼Œå› æ­¤è¿™é‡Œäº‹å…ˆå®‰è£… ipvs ç›¸å…³ç»„ä»¶ã€‚\nå®‰è£… ipvs ç›¸å…³è½¯ä»¶åŒ… 1dnf install -y ipvsadm ipset sysstat conntrack libseccomp è½½å…¥æ¨¡å— 1modprobe -- ip_vs 2modprobe -- ip_vs_rr 3modprobe -- ip_vs_wrr 4modprobe -- ip_vs_sh 5modprobe -- nf_conntrack åˆ›å»ºipvs.confï¼Œè®¾ç½®å†…æ ¸æ¨¡å—çš„è‡ªåŠ¨è½½å…¥ 1cat \u003c /etc/modules-load.d/ipvs.conf 2ip_vs 3ip_vs_lc 4ip_vs_wlc 5ip_vs_rr 6ip_vs_wrr 7ip_vs_lblc 8ip_vs_lblcr 9ip_vs_dh 10ip_vs_sh 11ip_vs_fo 12ip_vs_nq 13ip_vs_sed 14ip_vs_ftp 15ip_vs_sh 16nf_conntrack 17ip_tables 18ip_set 19xt_set 20ipt_set 21ipt_rpfilter 22ipt_REJECT 23ipip 24EOF 1systemctl enable --now systemd-modules-load.service 1.4 å®‰è£… Containerd å®‰è£… Containerd 1dnf install containerd -y 1ctr -v 2ctr containerd.io 1.7.18 ç”Ÿæˆ containerd é…ç½®æ–‡ä»¶ 1mkdir -p /etc/containerd 2containerd config default | sudo tee /etc/containerd/config.toml ä¿®æ”¹ Containerd ä½¿ç”¨çš„ cgroup ä¸º systemdÂ cgroupÂ driver 1[plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc] 2Â ... 3Â [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options] 4Â SystemdCgroupÂ =Â true ä¿®æ”¹ Containerd ä½¿ç”¨çš„ sandbox_image ä¿®æ”¹ sandbox çš„é•œåƒåœ°å€\n1sandbox_imageÂ =Â \"registry.aliyuncs.com/google_containers/pause:3.9\" é…ç½® Containerd ç§æœåœ°å€è·³è¿‡ https éªŒè¯ 1[plugins.\"io.containerd.grpc.v1.cri\".registry.configs] 2 [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"10.101.7.108\".tls] 3 insecure_skip_verify = true 4 [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"szharbor.hithium.cn\".tls] 5 insecure_skip_verify = true 6 7[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"docker.io\".tls] 8 insecure_skip_verify = true é…ç½® docker.io é•œåƒ 1 [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors] 2 [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"] 3 endpoint = [\"https://docker.1panel.live\"][plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"10.101.7.108:80\"] 4 endpoint = [\"http://10.101.7.108\"] ä½¿é…ç½®ç”Ÿæ•ˆ 1systemctl daemon-reload 2systemctl restart containerd.service 3systemctl enable containerd.service 1.5 å®‰è£… K8S ç›¸å…³ç»„ä»¶ https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/\n1cat \u003c /etc/yum.repos.d/kubernetes.repo 2[kubernetes] 3name=Kubernetes 4baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/ 5enabled=1 6gpgcheck=1 7gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/repodata/repomd.xml.key 8EOF 1dnf -y install kubectl kubelet kubeadm 2. ä¸»èŠ‚ç‚¹é…ç½® 2.1 é«˜å¯ç”¨é…ç½® 2.1.1 å®‰è£…ç›¸å…³ç»„ä»¶ å®‰è£…keepalived, haproxy\n1dnf -y install keepalived haproxy 2.1.2 é…ç½®æ£€æµ‹è„šæœ¬æ–‡ä»¶ è¯¥è„šæœ¬æ£€æµ‹æœ¬åœ° 8443 ç«¯å£(haproxyæœåŠ¡)æ˜¯å¦æ­£å¸¸ï¼Œè‹¥ä¸æ­£å¸¸ï¼Œåˆ™åœæ­¢æœ¬åœ°çš„ Keepalived æœåŠ¡ï¼ŒVIPé£˜é€¸åˆ°å…¶å®ƒ haproxy å¯ç”¨çš„èŠ‚ç‚¹ï¼Œç»§ç»­æä¾›æœåŠ¡ã€‚\n1vimÂ /etc/keepalived/check_apiserver.sh 1#!/bin/sh 2curlÂ -sfkÂ --max-timeÂ 2Â https://localhost:8443/healthzÂ -oÂ /dev/null 3ifÂ [Â $?Â -nqÂ 0] 4then 5Â echoÂ \"***Â ErrorÂ GETÂ https://localhost:8443/healthz\"Â 1\u003e\u00262 6Â systemctlÂ stopÂ keepalived 7fi ç»™è„šæœ¬æ–‡ä»¶æ‰§è¡Œæƒé™\n1chmodÂ +xÂ /etc/keepalived/check_apiserver.sh 2.1.3 é…ç½® keepalived.conf VIP è®°å¾—ä½¿ç”¨èŠ‚ç‚¹æ‰€åœ¨ç½‘æ®µï¼Œä½†ä¸ä½¿ç”¨çš„ IP åœ°å€\n1vim /etc/keepalived/keepalived.conf 1! Configuration File for keepalived 2global_defs { 3 router_id LVS_DEVEL 4} 5 6# æŒ‡å®šæ£€æµ‹è„šæœ¬: 7# script: è„šæœ¬è·¯å¾„; 8# interval: è„šæœ¬æ‰§è¡Œæ—¶é—´; 9# weight: æƒé‡; 10# fall: è¿ç»­æ£€æµ‹å¤±è´¥å¤šå°‘æ¬¡ä¹‹åè®¤å®šèŠ‚ç‚¹ä¸å¯ç”¨; 11# rise: è¿ç»­æ£€æµ‹æˆåŠŸå¤šå°‘æ¬¡è®¤ä¸ºèŠ‚ç‚¹æ¢å¤æ­£å¸¸ã€‚ 12vrrp_script check_apiserver { 13 script \"/etc/keepalived/check_apiserver.sh\" 14 interval 3 15 weight -2 16 fall 10 17 rise 2 18} 19 20# state: æŒ‡å®šMASTERèº«ä»½, å¦å¤–ä¸¤å°Keepalivedè®¾ç½®æˆBACKUP 21# interface: æŒ‡å®šç½‘å¡; 22# virtual_router_id: VRRPè™šæ‹Ÿè·¯ç”±id, åŒä¸€é›†ç¾¤çš„KeepalivedèŠ‚ç‚¹è¦ç›¸åŒ, ç”¨æ¥è¯†åˆ«å½¼æ­¤ 23# priority: ä¼˜å…ˆçº§, å¦å¤–ä¸¤å°Keepalivedåˆ†åˆ«è®¾ç½®æˆ90 70 24# auth_type: VRRPç»„èŠ‚ç‚¹ä¹‹é—´è®¤è¯æ–¹å¼ä¸ºPASSé“­æ–‡ 25# auth_pass: VRRPç»„èŠ‚ç‚¹ä¹‹é—´ç”¨æ¥è®¤è¯é€šä¿¡çš„å¯†ç  26# virtual_ipaddress: VIP 27# track_script: æŒ‡å®šä½¿ç”¨çš„æ£€æµ‹è„šæœ¬åç§° 28 29vrrp_instance VI_1 { 30 state MASTER 31 interface ens192 32 virtual_router_id 51 33 priority 100 34 authentication { 35 auth_type PASS 36 auth_pass 1111 37 } 38 virtual_ipaddress { 39 10.101.5.2 40 } 41 track_script { 42 check_apiserver 43 } 44} 2.1.4 é…ç½® haproxy.cfg 1vimÂ /etc/haproxy/haproxy.cfg 1#--------------------------------------------------------------------- 2#Â GlobalÂ settings 3#--------------------------------------------------------------------- 4global 5 log\tstdout\tformat\traw\tlocal0 6 chroot\t/var/lib/haproxy 7 pidfile\t/var/run/haproxy.pid 8 maxconn\t4000 9 user\thaproxy 10 group\thaproxy 11 12 13#--------------------------------------------------------------------- 14#Â commonÂ defaultsÂ thatÂ allÂ theÂ 'listen'Â andÂ 'backend'Â sectionsÂ will 15#Â useÂ ifÂ notÂ designatedÂ inÂ theirÂ block 16#--------------------------------------------------------------------- 17defaults 18 log\tglobal 19 option\thttplog 20 option\tdontlognull 21 timeout\tconnect\t5s 22 timeout\tclient\t35s 23 timeout\tserver\t35s 24 25 26#--------------------------------------------------------------------- 27#Â apiserverÂ frontendÂ whichÂ proxysÂ toÂ theÂ controlÂ planeÂ nodes 28#--------------------------------------------------------------------- 29#Â ä¸»è¦æ˜¯è¿™é‡Œçš„bind:Â å®šä¹‰haproxyçš„ä»£ç†ç«¯å£ä¸º8443ã€‚ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒã€‚ 30frontend\tapiserver 31\tbind\t*:8443 32\tmode\ttcp 33\toption\ttcplog 34\tdefault_backend\tapiserverbackend 35 36 37#--------------------------------------------------------------------- 38#Â roundÂ robinÂ balancingÂ forÂ apiserver 39#--------------------------------------------------------------------- 40#Â ä»¥ä¸‹æ˜¯åç«¯ç›¸å…³é…ç½®,Â å…³é”®å‚æ•°è§£é‡Šå¦‚ä¸‹ 41#Â modeÂ tcp:Â è®¾ç½®ä¸åç«¯æœåŠ¡é€šä¿¡çš„æ¨¡å¼ä¸ºTCP 42#Â balanceÂ roundrobin:Â è½®è¯¢æ–¹å¼ 43#Â inter 10s:Â æ£€æŸ¥é—´éš”ä¸º10ç§’ã€‚ 44#Â downinter 5s:Â å½“æœåŠ¡è¢«æ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æ¢å¤ã€‚ 45#Â rise 2:Â åœ¨å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸Šçº¿ä¹‹å‰ï¼ŒæœåŠ¡å™¨å¿…é¡»è¿ç»­2æ¬¡æˆåŠŸå“åº”æ£€æŸ¥ã€‚ 46#Â fall 2:Â åœ¨å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸‹çº¿ä¹‹å‰ï¼ŒæœåŠ¡å™¨å¿…é¡»è¿ç»­2æ¬¡å¤±è´¥å“åº”æ£€æŸ¥ã€‚ 47#Â slowstart 60s:Â æ…¢å¯åŠ¨æ—¶é—´ä¸º60ç§’ï¼Œç”¨äºæ§åˆ¶æ–°æœåŠ¡å™¨ä¸Šçº¿åé€æ¸å¢åŠ å…¶æƒé‡ã€‚ 48#Â maxconn 250:Â æ¯ä¸ªæœåŠ¡å™¨çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°ä¸º250ã€‚ 49#Â maxqueue 256:Â åç«¯é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ä¸º256ã€‚ 50#Â weight 100:Â æœåŠ¡å™¨çš„é»˜è®¤æƒé‡ä¸º100ã€‚ 51#Â server å®šä¹‰åç«¯çš„æœåŠ¡å™¨åˆ—è¡¨ã€‚ 52 53 54backend\tapiserverbackend 55\toption\ttcplog 56\toption\ttcp-check 57\tmode\ttcp 58\tbalance\troundrobin 59\tdefault-server interÂ 10sÂ downinterÂ 5sÂ riseÂ 2Â fallÂ 2Â slowstartÂ 60sÂ maxconnÂ 250Â maxqueueÂ 256Â weightÂ 100 60\tserver\tzqf-Master01\t10.101.5.110:6443\tcheck 61\tserver\tzqf-Master02\t10.101.5.111:6443\tcheck 62\tserver\tzqf-Master03\t10.101.5.112:6443\tcheck 2.1.5 å¯åŠ¨æœåŠ¡å¹¶éªŒè¯ å¯åŠ¨æœåŠ¡ 1systemctlÂ enableÂ --nowÂ keepalived 2systemctlÂ enableÂ --nowÂ haproxy éªŒè¯ åœæ­¢ master01 ä¸Šçš„ keepalived æœåŠ¡åï¼Œ è™šæ‹Ÿ IP 192.168.10.240/32 ä¼šç§»åŠ¨åˆ° moster02ã€‚ æ¢å¤ master01 ä¸Šçš„ keepalived æœåŠ¡åï¼Œ è™šæ‹Ÿ IP 192.168.10.240/32 ä¼šç§»åŠ¨å› moster01ã€‚\n1[root@zqf-Master01 ~]# ip a | grep ens 22: ens192: mtu 1500 qdisc mq state UP group default qlen 1000 3 inet 10.101.5.110/24 brd 10.101.5.255 scope global noprefixroute ens192 4 inet 192.168.10.240/32 scope global ens192 5 6[root@zqf-Master02 keepalived]# ip a | grep ens 72: ens192: mtu 1500 qdisc mq state UP group default qlen 1000 8 inet 10.101.5.111/24 brd 10.101.5.255 scope global noprefixroute ens192 2.2 åŸºäº kubeadm å®‰è£…é›†ç¾¤ 2.2.1 æå‰æ‹‰å–é•œåƒ 1kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers 2.2.2 ä¿®æ”¹ kubeadm é…ç½®æ–‡ä»¶ 1kubeadmÂ configÂ printÂ init-defaultsÂ \u003eÂ kubeadm-init.yaml é…ç½®é¡¹ æè¿° advertiseAddress æŒ‡å®šæœ¬æœºåœ°å€ name æŒ‡å®šæœ¬æœºçš„ä¸»æœºå controlPlaneEndpoint æŒ‡å®šæ§åˆ¶é¢çš„é€šä¿¡åœ°å€ï¼Œè¿™é‡Œå†™ VIP åœ°å€ imageRepository æŒ‡å®šä¸‹è½½ Kubernetes ç»„ä»¶çš„é•œåƒä»“åº“åœ°å€, é»˜è®¤è®¿é—®å›½å¤–çš„ä»“åº“, è¿™é‡Œéœ€è¦ä¿®æ”¹ä¸ºå›½å†…çš„é•œåƒä»“åº“æº kubernetesVersion æŒ‡å®šå®‰è£…çš„ kubernetes ç‰ˆæœ¬ serviceSubnet æŒ‡å®š Kubernetes çš„ Service èµ„æºåˆ†é…çš„ç½‘æ®µ, ç½‘æ®µä¸èƒ½ä¸çœŸå®æœºå’Œ Pod çš„ç½‘æ®µå†²çªã€‚ podSubnet æŒ‡å®š Kubernetes çš„ Pod èµ„æºåˆ†é…çš„ç½‘æ®µ, ç½‘æ®µä¸èƒ½ä¸çœŸå®æœºå’Œ Service çš„ç½‘æ®µå†²çªã€‚ éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†åŒ…æ‹¬ï¼š\nlocalAPIEndpoint.advertiseAddressï¼šä¸»èŠ‚ç‚¹ IP åœ°å€ nodeRegistration.nameï¼šä¸»èŠ‚ç‚¹ hostname imageRepositoryï¼šé•œåƒä»“åº“åœ°å€ networking.podSubnet: pod å­ç½‘èŒƒå›´ 1apiVersion: kubeadm.k8s.io/v1beta3 2bootstrapTokens: 3- groups: 4 - system:bootstrappers:kubeadm:default-node-token 5 token: abcdef.0123456789abcdef 6 ttl: 24h0m0s 7 usages: 8 - signing 9 - authentication 10kind: InitConfiguration 11localAPIEndpoint: 12 advertiseAddress: 10.101.5.110 13 bindPort: 6443 14nodeRegistration: 15 criSocket: unix:///var/run/containerd/containerd.sock 16 imagePullPolicy: IfNotPresent 17 name: zqf-Master01 18 taints: null 19--- 20apiServer: 21 timeoutForControlPlane: 4m0s 22apiVersion: kubeadm.k8s.io/v1beta3 23certificatesDir: /etc/kubernetes/pki 24clusterName: kubernetes 25controllerManager: {} 26dns: {} 27controlPlaneEndpoint: \"10.101.5.2:8443\" 28etcd: 29 local: 30 dataDir: /var/lib/etcd 31imageRepository: registry.aliyuncs.com/google_containers 32kind: ClusterConfiguration 33kubernetesVersion: 1.29.6 34networking: 35 dnsDomain: cluster.local 36 serviceSubnet: 10.96.0.0/12 37 podSubnet: 192.168.0.0/16 38scheduler: {} 39 40# è¡¥å…… 41--- 42apiVersion: kubeproxy.config.k8s.io/v1alpha1 43kind: KubeProxyConfiguration 44mode: ipvs 45--- 46apiVersion: kubelet.config.k8s.io/v1beta1 47kind: KubeletConfiguration 48cgroupDriver: systemd 2.2.3 åˆå§‹åŒ– K8S é›†ç¾¤ 1kubeadm init --config=kubeadm-init.yaml --upload-certs å…¶ä¸­ï¼Œ --upload-certs ä¼šè‡ªåŠ¨å°†è¯ä¹¦ä»ä¸»æ§åˆ¶å¹³é¢èŠ‚ç‚¹å¤åˆ¶åˆ°å°†è¦åŠ å…¥çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šã€‚\nç„¶åï¼Œæ ¹æ®æç¤ºå°†å„ä¸ªèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚\n1# æ·»åŠ masterèŠ‚ç‚¹çš„å‘½ä»¤ 2kubeadm token create --print-join-command --certificate-key 3 4# æ·»åŠ workerèŠ‚ç‚¹çš„å‘½ä»¤è·å–æ–¹å¼ 5kubeadm token create --print-join-command kubeadm token create â€“print-join-command â€“ttl 0\n2.2.4 é…ç½® kubectl 1mkdir -p $HOME/.kube 2sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config 3sudo chown $(id -u):$(id -g) $HOME/.kube/config 4# å°†ä»¥ä¸‹å‘½ä»¤åŠ åˆ°.bashrc 5export KUBECONFIG=/etc/kubernetes/admin.conf å…¶ä¸­ï¼Œadmin.conf æ˜¯è¿æ¥ Kubernetes çš„è®¤è¯æ–‡ä»¶ï¼Œé€šè¿‡æ­¤æ–‡ä»¶æ‰èƒ½è¿æ¥åˆ° kubernetesï¼Œkubectl ä¹Ÿéœ€è¦è¿™ä¸ªæ–‡ä»¶ï¼›åœ¨ Linux ä¸­ï¼Œä½¿ç”¨ KUBECONFIG ç¯å¢ƒå˜é‡çŸ¥é“è®¤è¯æ–‡ä»¶çš„æ‰€åœ¨ã€‚\nLinux ä¸­æ¯ä¸ªç”¨æˆ·çš„ç¯å¢ƒå˜é‡æ˜¯ä¸åŒçš„ï¼Œå¦‚æœåˆ‡æ¢äº†ç”¨æˆ·ï¼Œåˆ™ä¹Ÿéœ€è¦è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡ï¼›å¦‚æœè¦åœ¨åˆ«çš„èŠ‚ç‚¹ä¸Šè¿æ¥é›†ç¾¤ï¼Œåˆ™å¯ä»¥æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶è¿‡å»ã€‚\næ­¤æ—¶ï¼Œåœ¨ master01 ä¸Šæ‰§è¡Œ kubectl get no åº”æœ‰\n1[root@zqf-Master01 ~]# kubectl get no 2NAME STATUS ROLES AGE VERSION 3zqf-master01 NotReady control-plane 2m23s v1.29.6 4zqf-master02 NotReady control-plane 101s v1.29.6 5zqf-master03 NotReady control-plane 101s v1.29.6 6zqf-worker01 NotReady 67s v1.29.6 7zqf-worker02 NotReady 65s v1.29.6 8zqf-worker03 NotReady 63s v1.29.6 9zqf-worker04 NotReady 60s v1.29.6 2.3 å®‰è£… Calico Calico3.28 ç‰ˆæœ¬æ”¯æŒ: Kubernetesv1.27-v1.30ã€‚\nCalico çš„å®‰è£…æ–¹å¼ç›®å‰æœ‰ä¸¤ç§ï¼š\nåŸºäº Operator æ–¹å¼å®‰è£…ï¼Œèƒ½å¤Ÿç®¡ç† Calico é›†ç¾¤çš„å®‰è£…ï¼Œå‡çº§ï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ï¼Œä½†ä¸æ–¹ä¾¿ç®¡ç†é•œåƒåœ°å€ã€‚ï¼ˆä¼˜å…ˆï¼‰ åŸºäºé™æ€èµ„æºæ¸…å•å®‰è£…ï¼Œæ–¹ä¾¿ï¼Œç®€å•ï¼Œä½†æ— æ³•åƒ Opertaor ä¸€æ ·èƒ½å¤Ÿè‡ªåŠ¨ç®¡ç† Calico çš„ç”Ÿå‘½å‘¨æœŸã€‚ åŸºäºé™æ€èµ„æºæ¸…å•çš„éƒ¨ç½²å¸¸è§çš„ä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼š\ncalico.yamlï¼šå½“ Calico ä½¿ç”¨ Kubernetes API ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œä¸”é›†ç¾¤èŠ‚ç‚¹å°‘äº 50 ä¸ªã€‚ calico-typha.yaml: å½“ Calico ä½¿ç”¨ Kubernetes API ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œä¸”é›†ç¾¤èŠ‚ç‚¹å¤§äº 50 ä¸ªã€‚ https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml\nreplicas:Â å‰¯æœ¬æ•° , å»ºè®®æ¯200ä¸ªèŠ‚ç‚¹1ä¸ªå‰¯æœ¬, ç”Ÿäº§çš„è¯å»ºè®®3ä¸ªå‰¯æœ¬ã€‚\nå…¶ä¸­ï¼Œé•œåƒæ¨èæå‰æ‹‰å–åˆ°ç§æœï¼Œç„¶åä¿®æ”¹ imageurl\nå®‰è£…æˆåŠŸåï¼Œå¦‚ä¸‹æ‰€ç¤º\n1[root@zqf-Master01 ~]# kubectl get po -n kube-system 2NAME READY STATUS RESTARTS AGE 3calico-kube-controllers-7884dfffd6-pdj8v 1/1 Running 0 61s 4calico-node-7q2dp 1/1 Running 0 46s 5calico-node-gdtc4 1/1 Running 0 46s 6calico-node-hndr8 1/1 Running 0 46s 7calico-node-jd9zm 1/1 Running 0 46s 8calico-node-n8z5j 1/1 Running 0 46s 9calico-node-pn4l2 1/1 Running 0 46s 10calico-node-wtqtn 1/1 Running 0 46s 11calico-typha-866db88dc4-8njgj 1/1 Running 0 61s 12calico-typha-866db88dc4-8wd57 1/1 Running 0 61s 13calico-typha-866db88dc4-wnjzh 1/1 Running 0 61s 14coredns-66db75cf8c-96t2p 1/1 Running 0 61s 15coredns-66db75cf8c-xgdf9 1/1 Running 0 61s 16etcd-zqf-master01 1/1 Running 1 53m 17etcd-zqf-master02 1/1 Running 0 52m 18etcd-zqf-master03 1/1 Running 0 52m 19kube-apiserver-zqf-master01 1/1 Running 1 53m 20kube-apiserver-zqf-master02 1/1 Running 0 52m 21kube-apiserver-zqf-master03 1/1 Running 0 52m 22kube-controller-manager-zqf-master01 1/1 Running 1 53m 23kube-controller-manager-zqf-master02 1/1 Running 0 52m 24kube-controller-manager-zqf-master03 1/1 Running 0 52m 25kube-proxy-75sbq 1/1 Running 0 37s 26kube-proxy-g2nqd 1/1 Running 0 45s 27kube-proxy-jqd92 1/1 Running 0 40s 28kube-proxy-kwxcb 1/1 Running 0 44s 29kube-proxy-lhtvl 1/1 Running 0 38s 30kube-proxy-vkv5v 1/1 Running 0 43s 31kube-proxy-ws2fl 1/1 Running 0 41s 32kube-scheduler-zqf-master01 1/1 Running 1 53m 33kube-scheduler-zqf-master02 1/1 Running 0 52m 34kube-scheduler-zqf-master03 1/1 Running 0 52m 1[root@zqf-Master01 ~]# kubectl get node 2NAME STATUS ROLES AGE VERSION 3zqf-master01 Ready control-plane 54m v1.29.6 4zqf-master02 Ready control-plane 53m v1.29.6 5zqf-master03 Ready control-plane 53m v1.29.6 6zqf-worker01 Ready 52m v1.29.6 7zqf-worker02 Ready 52m v1.29.6 8zqf-worker03 Ready 52m v1.29.6 9zqf-worker04 Ready 52m v1.29.6 2.4 é…ç½® kubectl å‘½ä»¤è¡¥å…¨ 1dnf install -y bash-completion 2source /usr/share/bash-completion/bash_completion 3source \u003c(kubectl completion bash) 4echo \"source \u003c(kubectl completion bash)\" \u003e\u003e ~/.bashrc 3. æ¸…é™¤ kubeadm ç¯å¢ƒ 1kubeadm reset cleanup-node 2y 3kubeadm reset 4y 5rm -rf /etc/cni/net.d 6ipvsadm --clear 7rm -rf $HOME/.kube/config ",
  "wordCount" : "3290",
  "inLanguage": "zh",
  "datePublished": "2024-11-13T01:09:19+08:00",
  "dateModified": "2024-11-13T01:09:19+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/tech/kubernetes/kubernetes-1.29.6-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "xgbt's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/assets/apple-icon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="xgbt&#39;s Blog (Alt + H)">xgbt&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="/search" title="ğŸ”æœç´¢">
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="/tags" title="ğŸ·ï¸æ ‡ç­¾">
                    <span>ğŸ·ï¸æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="/archives" title="ğŸ“¦å½’æ¡£">
                    <span>ğŸ“¦å½’æ¡£</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="/tech/">Tech</a></div>
    <h1 class="post-title entry-hint-parent">
      Kubernetes 1.29.6 é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²
    </h1>
    <div class="post-meta"><span title='2024-11-13 01:09:19 +0800 CST'>åä¸€æœˆ 13, 2024</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
        <div class="toc">
            <details  open>
                <summary accesskey="c" title="(Alt + C)">
                    <span class="details">ç›®å½•</span>
                </summary>

                <div class="inner"><ul>
                        <li>
                            <a href="#%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1" aria-label="æ¶æ„è®¾è®¡">æ¶æ„è®¾è®¡</a></li>
                        <li>
                            <a href="#1-%e6%89%80%e6%9c%89%e8%8a%82%e7%82%b9%e6%93%8d%e4%bd%9c" aria-label="1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ">1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ</a><ul>
                                    
                        <li>
                            <a href="#11-%e5%9f%ba%e7%a1%80%e9%85%8d%e7%bd%ae" aria-label="1.1 åŸºç¡€é…ç½®">1.1 åŸºç¡€é…ç½®</a><ul>
                                    
                        <li>
                            <a href="#111-%e9%85%8d%e7%bd%ae%e9%95%9c%e5%83%8f%e6%ba%90" aria-label="1.1.1 é…ç½®é•œåƒæº">1.1.1 é…ç½®é•œåƒæº</a></li>
                        <li>
                            <a href="#112-%e9%85%8d%e7%bd%ae%e4%b8%bb%e6%9c%ba%e5%90%8d" aria-label="1.1.2 é…ç½®ä¸»æœºå">1.1.2 é…ç½®ä¸»æœºå</a></li>
                        <li>
                            <a href="#113-%e5%85%8d%e5%af%86%e7%99%bb%e5%bd%95%e9%85%8d%e7%bd%ae%e6%96%b0%e5%a2%9e%e5%8f%af%e9%80%89" aria-label="1.1.3 å…å¯†ç™»å½•é…ç½®ï¼ˆæ–°å¢/å¯é€‰ï¼‰">1.1.3 å…å¯†ç™»å½•é…ç½®ï¼ˆæ–°å¢/å¯é€‰ï¼‰</a></li>
                        <li>
                            <a href="#114-%e7%a6%81%e7%94%a8%e9%98%b2%e7%81%ab%e5%a2%99" aria-label="1.1.4 ç¦ç”¨é˜²ç«å¢™">1.1.4 ç¦ç”¨é˜²ç«å¢™</a></li>
                        <li>
                            <a href="#115-%e7%a6%81%e7%94%a8-selinux" aria-label="1.1.5 ç¦ç”¨ SELINUX">1.1.5 ç¦ç”¨ SELINUX</a></li>
                        <li>
                            <a href="#116-%e7%a6%81%e7%94%a8-swap-%e5%88%86%e5%8c%ba" aria-label="1.1.6 ç¦ç”¨ Swap åˆ†åŒº">1.1.6 ç¦ç”¨ Swap åˆ†åŒº</a></li>
                        <li>
                            <a href="#117-%e6%97%b6%e9%97%b4%e5%90%8c%e6%ad%a5%e6%96%b0%e5%a2%9e" aria-label="1.1.7 æ—¶é—´åŒæ­¥ï¼ˆæ–°å¢ï¼‰">1.1.7 æ—¶é—´åŒæ­¥ï¼ˆæ–°å¢ï¼‰</a></li>
                        <li>
                            <a href="#118-%e9%85%8d%e7%bd%ae%e7%b3%bb%e7%bb%9f%e8%b5%84%e6%ba%90%e9%99%90%e5%88%b6" aria-label="1.1.8 é…ç½®ç³»ç»Ÿèµ„æºé™åˆ¶">1.1.8 é…ç½®ç³»ç»Ÿèµ„æºé™åˆ¶</a></li>
                        <li>
                            <a href="#119-%e9%85%8d%e7%bd%ae%e5%86%85%e6%a0%b8%e5%8f%82%e6%95%b0" aria-label="1.1.9 é…ç½®å†…æ ¸å‚æ•°">1.1.9 é…ç½®å†…æ ¸å‚æ•°</a></li></ul>
                        </li>
                        <li>
                            <a href="#13-%e9%85%8d%e7%bd%ae-ipvs" aria-label="1.3 é…ç½® IPVS">1.3 é…ç½® IPVS</a></li>
                        <li>
                            <a href="#14-%e5%ae%89%e8%a3%85-containerd" aria-label="1.4 å®‰è£… Containerd">1.4 å®‰è£… Containerd</a></li>
                        <li>
                            <a href="#15-%e5%ae%89%e8%a3%85-k8s-%e7%9b%b8%e5%85%b3%e7%bb%84%e4%bb%b6" aria-label="1.5 å®‰è£… K8S ç›¸å…³ç»„ä»¶">1.5 å®‰è£… K8S ç›¸å…³ç»„ä»¶</a></li></ul>
                        </li>
                        <li>
                            <a href="#2-%e4%b8%bb%e8%8a%82%e7%82%b9%e9%85%8d%e7%bd%ae" aria-label="2. ä¸»èŠ‚ç‚¹é…ç½®">2. ä¸»èŠ‚ç‚¹é…ç½®</a><ul>
                                    
                        <li>
                            <a href="#21-%e9%ab%98%e5%8f%af%e7%94%a8%e9%85%8d%e7%bd%ae" aria-label="2.1 é«˜å¯ç”¨é…ç½®">2.1 é«˜å¯ç”¨é…ç½®</a><ul>
                                    
                        <li>
                            <a href="#211-%e5%ae%89%e8%a3%85%e7%9b%b8%e5%85%b3%e7%bb%84%e4%bb%b6" aria-label="2.1.1 å®‰è£…ç›¸å…³ç»„ä»¶">2.1.1 å®‰è£…ç›¸å…³ç»„ä»¶</a></li>
                        <li>
                            <a href="#212-%e9%85%8d%e7%bd%ae%e6%a3%80%e6%b5%8b%e8%84%9a%e6%9c%ac%e6%96%87%e4%bb%b6" aria-label="2.1.2 é…ç½®æ£€æµ‹è„šæœ¬æ–‡ä»¶">2.1.2 <strong>é…ç½®æ£€æµ‹è„šæœ¬æ–‡ä»¶</strong></a></li>
                        <li>
                            <a href="#213-%e9%85%8d%e7%bd%ae-keepalivedconf" aria-label="2.1.3 é…ç½® keepalived.conf">2.1.3 é…ç½® keepalived.conf</a></li>
                        <li>
                            <a href="#214-%e9%85%8d%e7%bd%ae-haproxycfg" aria-label="2.1.4 é…ç½® haproxy.cfg">2.1.4 é…ç½® haproxy.cfg</a></li>
                        <li>
                            <a href="#215-%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1%e5%b9%b6%e9%aa%8c%e8%af%81" aria-label="2.1.5 å¯åŠ¨æœåŠ¡å¹¶éªŒè¯">2.1.5 å¯åŠ¨æœåŠ¡å¹¶éªŒè¯</a></li></ul>
                        </li>
                        <li>
                            <a href="#22-%e5%9f%ba%e4%ba%8e-kubeadm-%e5%ae%89%e8%a3%85%e9%9b%86%e7%be%a4" aria-label="2.2 åŸºäº kubeadm å®‰è£…é›†ç¾¤">2.2 åŸºäº kubeadm å®‰è£…é›†ç¾¤</a><ul>
                                    
                        <li>
                            <a href="#221-%e6%8f%90%e5%89%8d%e6%8b%89%e5%8f%96%e9%95%9c%e5%83%8f" aria-label="2.2.1 æå‰æ‹‰å–é•œåƒ">2.2.1 æå‰æ‹‰å–é•œåƒ</a></li>
                        <li>
                            <a href="#222-%e4%bf%ae%e6%94%b9-kubeadm-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="2.2.2 ä¿®æ”¹ kubeadm é…ç½®æ–‡ä»¶">2.2.2 ä¿®æ”¹ kubeadm é…ç½®æ–‡ä»¶</a></li>
                        <li>
                            <a href="#223-%e5%88%9d%e5%a7%8b%e5%8c%96-k8s-%e9%9b%86%e7%be%a4" aria-label="2.2.3 åˆå§‹åŒ– K8S é›†ç¾¤">2.2.3 åˆå§‹åŒ– K8S é›†ç¾¤</a></li>
                        <li>
                            <a href="#224-%e9%85%8d%e7%bd%ae-kubectl" aria-label="2.2.4 é…ç½® kubectl">2.2.4 é…ç½® kubectl</a></li></ul>
                        </li>
                        <li>
                            <a href="#23-%e5%ae%89%e8%a3%85-calico" aria-label="2.3 å®‰è£… Calico">2.3 å®‰è£… Calico</a></li>
                        <li>
                            <a href="#24-%e9%85%8d%e7%bd%ae-kubectl-%e5%91%bd%e4%bb%a4%e8%a1%a5%e5%85%a8" aria-label="2.4 é…ç½® kubectl å‘½ä»¤è¡¥å…¨">2.4 é…ç½® kubectl å‘½ä»¤è¡¥å…¨</a></li></ul>
                        </li>
                        <li>
                            <a href="#3-%e6%b8%85%e9%99%a4-kubeadm-%e7%8e%af%e5%a2%83" aria-label="3. æ¸…é™¤ kubeadm ç¯å¢ƒ">3. æ¸…é™¤ kubeadm ç¯å¢ƒ</a>
                        </li>
                    </ul>
                </div>
            </details>
        </div>
    </aside>
    <script>
        let activeElement;
        let elements;

        document.addEventListener('DOMContentLoaded', function (event) {
            checkTocPosition();

            elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
            if (elements.length > 0) {
                
                activeElement = elements[0];
                const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            }

            
            const topLink = document.getElementById('top-link');
            if (topLink) {
                topLink.addEventListener('click', (event) => {
                    
                    event.preventDefault();

                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
        }, false);

        window.addEventListener('resize', function (event) {
            checkTocPosition();
        }, false);

        window.addEventListener('scroll', () => {
            
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;

            
            if (scrollPosition === 0) {
                return;
            }

            
            if (elements && elements.length > 0) {
                
                activeElement = Array.from(elements).find((element) => {
                    if ((getOffsetTop(element) - scrollPosition) > 0 &&
                        (getOffsetTop(element) - scrollPosition) < window.innerHeight / 2) {
                        return element;
                    }
                }) || activeElement;

                elements.forEach(element => {
                    const id = encodeURI(element.getAttribute('id')).toLowerCase();
                    const tocLink = document.querySelector(`.inner ul li a[href="#${id}"]`);
                    if (element === activeElement) {
                        tocLink.classList.add('active');

                        
                        const tocContainer = document.querySelector('.toc .inner');
                        const linkOffsetTop = tocLink.offsetTop;
                        const containerHeight = tocContainer.clientHeight;
                        const linkHeight = tocLink.clientHeight;

                        
                        const scrollPosition = linkOffsetTop - (containerHeight / 2) + (linkHeight / 2);
                        tocContainer.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                    } else {
                        tocLink.classList.remove('active');
                    }
                });
            }
        }, false);

        const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
        const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
        const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

        function checkTocPosition() {
            const width = document.body.scrollWidth;

            if (width - main - (toc * 2) - (gap * 4) > 0) {
                document.getElementById("toc-container").classList.add("wide");
            } else {
                document.getElementById("toc-container").classList.remove("wide");
            }
        }

        function getOffsetTop(element) {
            if (!element.getClientRects().length) {
                return 0;
            }
            let rect = element.getBoundingClientRect();
            let win = element.ownerDocument.defaultView;
            return rect.top + win.pageYOffset;
        }

    </script>
  <div class="post-content"><h1 id="æ¶æ„è®¾è®¡">æ¶æ„è®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#æ¶æ„è®¾è®¡">#</a></h1>
<p>OS: AlmaLinux 9.1</p>
<table>
  <thead>
      <tr>
          <th>èŠ‚ç‚¹å</th>
          <th>IP åœ°å€</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>zqf-Master01</td>
          <td>10.101.5.110</td>
      </tr>
      <tr>
          <td>zqf-Master02</td>
          <td>10.101.5.111</td>
      </tr>
      <tr>
          <td>zqf-Master03</td>
          <td>10.101.5.112</td>
      </tr>
      <tr>
          <td>zqf-Worker01</td>
          <td>10.101.5.113</td>
      </tr>
      <tr>
          <td>zqf-Worker02</td>
          <td>10.101.5.114</td>
      </tr>
      <tr>
          <td>zqf-Worker03</td>
          <td>10.101.5.115</td>
      </tr>
      <tr>
          <td>zqf-Worker04</td>
          <td>10.101.5.116</td>
      </tr>
  </tbody>
</table>
<h1 id="1-æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ">1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#1-æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ">#</a></h1>
<h2 id="11-åŸºç¡€é…ç½®">1.1 åŸºç¡€é…ç½®<a hidden class="anchor" aria-hidden="true" href="#11-åŸºç¡€é…ç½®">#</a></h2>
<h3 id="111-é…ç½®é•œåƒæº">1.1.1 é…ç½®é•œåƒæº<a hidden class="anchor" aria-hidden="true" href="#111-é…ç½®é•œåƒæº">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">sed -e <span class="s1">&#39;s|^mirrorlist=|#mirrorlist=|g&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="se"></span>    -e <span class="s1">&#39;s|^#\s*baseurl=https://repo.almalinux.org/almalinux|baseurl=https://mirrors.zju.edu.cn/almalinux|g&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="se"></span>    -i.bak <span class="se">\
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="se"></span>    /etc/yum.repos.d/almalinux-*.repo
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">dnf makecache
</span></span></code></pre></div><h3 id="112-é…ç½®ä¸»æœºå">1.1.2 é…ç½®ä¸»æœºå<a hidden class="anchor" aria-hidden="true" href="#112-é…ç½®ä¸»æœºå">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">hostnamectlÂ set-hostname &lt;ä¸»æœºå&gt;
</span></span></code></pre></div><p>æ·»åŠ è§£æè®°å½•ï¼Œä½¿èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ä¸»æœºåè®¿é—®é€šä¿¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">cat <span class="s">&lt;&lt; EOF &gt;&gt; /etc/hosts
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="s">10.101.5.110 zqf-Master01
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="s">10.101.5.111 zqf-Master02
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="s">10.101.5.112 zqf-Master03
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="s">10.101.5.113 zqf-Worker01
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="s">10.101.5.114 zqf-Worker02
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="s">10.101.5.115 zqf-Worker03
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="s">10.101.5.116 zqf-Worker04
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><h3 id="113-å…å¯†ç™»å½•é…ç½®æ–°å¢å¯é€‰">1.1.3 å…å¯†ç™»å½•é…ç½®ï¼ˆæ–°å¢/å¯é€‰ï¼‰<a hidden class="anchor" aria-hidden="true" href="#113-å…å¯†ç™»å½•é…ç½®æ–°å¢å¯é€‰">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">ssh-keygen -t rsa -b <span class="m">2048</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">ssh-copy-idÂ root@ç›®æ ‡èŠ‚ç‚¹IP
</span></span></code></pre></div><h3 id="114-ç¦ç”¨é˜²ç«å¢™">1.1.4 ç¦ç”¨é˜²ç«å¢™<a hidden class="anchor" aria-hidden="true" href="#114-ç¦ç”¨é˜²ç«å¢™">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">systemctl stop firewalld <span class="o">&amp;&amp;</span> systemctl disable firewalld
</span></span><span class="line"><span class="ln">2</span><span class="cl">systemctl disable --now dnsmasq
</span></span></code></pre></div><h3 id="115-ç¦ç”¨-selinux">1.1.5 ç¦ç”¨ SELINUX<a hidden class="anchor" aria-hidden="true" href="#115-ç¦ç”¨-selinux">#</a></h3>
<ol>
<li><strong>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä½¿ SELINUX=disabled</strong></li>
</ol>
<p>æ³¨æ„ï¼Œæ˜¯ <code>disabled</code> ï¼Œä¸æ˜¯ <code>disable</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">vim /etc/selinux/config
</span></span></code></pre></div><ol start="2">
<li><strong>æˆ–è€…ï¼Œç›´æ¥æ‰§è¡Œä¸‹åˆ—å‘½ä»¤</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">sed -i <span class="s1">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span> /etc/sysconfig/selinux
</span></span><span class="line"><span class="ln">2</span><span class="cl">sed -i <span class="s1">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span> /etc/selinux/config
</span></span></code></pre></div><ol start="3">
<li><strong>æŸ¥çœ‹ç³»ç»Ÿ SELinux è¿è¡ŒçŠ¶æ€</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">sestatus
</span></span></code></pre></div><h3 id="116-ç¦ç”¨-swap-åˆ†åŒº">1.1.6 ç¦ç”¨ Swap åˆ†åŒº<a hidden class="anchor" aria-hidden="true" href="#116-ç¦ç”¨-swap-åˆ†åŒº">#</a></h3>
<p>Swap æ˜¯äº¤æ¢åˆ†åŒºï¼Œå¦‚æœæœºå™¨å†…å­˜ä¸å¤Ÿï¼Œä¼šä½¿ç”¨swapåˆ†åŒºã€‚</p>
<p>ä½†æ˜¯ï¼Œswapåˆ†åŒºæ€§èƒ½è¾ƒä½ï¼Œk8s é»˜è®¤ä¸å…è®¸ä½¿ç”¨äº¤æ¢åˆ†åŒºã€‚</p>
<p>kubeadm åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ£€æµ‹ swap çŠ¶æ€ï¼Œæœªå…³é—­ swap ä¼šå¯¼è‡´åˆå§‹åŒ–å¤±è´¥ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">swapoff -a <span class="o">&amp;&amp;</span> sysctl -w vm.swappiness<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">sed -ri <span class="s1">&#39;/^[^#]*swap/s@^@#@&#39;</span> /etc/fstab
</span></span></code></pre></div><p>è‹¥ swap ä¸º 0ï¼Œ è¯´æ˜ swap å…³é—­æˆåŠŸ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">free -mh
</span></span></code></pre></div><h3 id="117-æ—¶é—´åŒæ­¥æ–°å¢">1.1.7 æ—¶é—´åŒæ­¥ï¼ˆæ–°å¢ï¼‰<a hidden class="anchor" aria-hidden="true" href="#117-æ—¶é—´åŒæ­¥æ–°å¢">#</a></h3>
<ol>
<li><strong>æ‰€æœ‰èŠ‚ç‚¹å®‰è£… chrony</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">dnf -y install chrony
</span></span></code></pre></div><ol start="2">
<li><strong>æŒ‘ä¸€ä¸ªèŠ‚ç‚¹ (10.101.5.110) ä¿®æ”¹é…ç½®</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># é…ç½®chronyæœåŠ¡</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">vimÂ /etc/chrony.conf
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># æŒ‡å®šä½¿ç”¨çš„ä¸Šæ¸¸æ—¶é—´æœåŠ¡å™¨åœ°å€</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">poolÂ ntp.aliyun.comÂ iburst
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"># å…è®¸è®¿é—®çš„æœåŠ¡å™¨</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">allowÂ 192.168.10.0/24
</span></span></code></pre></div><ol start="3">
<li><strong>å…¶ä»–èŠ‚ç‚¹ä¿®æ”¹ä¸Šæ¸¸æœåŠ¡å™¨å³å¯</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># é…ç½®chronyæœåŠ¡</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">vimÂ /etc/chrony.conf
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># æŒ‡å®š 10.101.5.110 ä¸ºä¸Šæ¸¸æœåŠ¡å™¨</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">pool 10.101.5.110 iburst
</span></span></code></pre></div><ol start="4">
<li><strong>å¯ç”¨æœåŠ¡</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">systemctl restart chronyd
</span></span><span class="line"><span class="ln">2</span><span class="cl">systemctl <span class="nb">enable</span> chronyd
</span></span></code></pre></div><p><br>
5. <strong>æŸ¥çœ‹åŒæ­¥çŠ¶æ€</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">chronycÂ sources
</span></span></code></pre></div><h3 id="118-é…ç½®ç³»ç»Ÿèµ„æºé™åˆ¶">1.1.8 é…ç½®ç³»ç»Ÿèµ„æºé™åˆ¶<a hidden class="anchor" aria-hidden="true" href="#118-é…ç½®ç³»ç»Ÿèµ„æºé™åˆ¶">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">vim /etc/security/limits.conf
</span></span></code></pre></div><p>æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ŒåŒ…æ‹¬æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€æœ€å¤§è¿›ç¨‹æ•°é‡å’Œå†…å­˜é”å®šé™åˆ¶</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="ln">1</span><span class="cl">* soft nofile 65536
</span></span><span class="line"><span class="ln">2</span><span class="cl">* hard nofile 131072
</span></span><span class="line"><span class="ln">3</span><span class="cl">* soft nproc 65535
</span></span><span class="line"><span class="ln">4</span><span class="cl">* hard nproc 655350
</span></span><span class="line"><span class="ln">5</span><span class="cl">* soft memlock unlimited
</span></span><span class="line"><span class="ln">6</span><span class="cl">* hard memlock unlimited
</span></span></code></pre></div><h3 id="119-é…ç½®å†…æ ¸å‚æ•°">1.1.9 é…ç½®å†…æ ¸å‚æ•°<a hidden class="anchor" aria-hidden="true" href="#119-é…ç½®å†…æ ¸å‚æ•°">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">sysctl net.core.bpf_jit_limit<span class="o">=</span><span class="m">452534528</span>
</span></span></code></pre></div><p>é…ç½® K8S æ‰€éœ€å†…æ ¸å‚æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln"> 1</span><span class="cl">cat <span class="s">&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf 
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="s">net.ipv4.ip_forward = 1
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="s">fs.may_detach_mounts = 1
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="s">vm.overcommit_memory=1
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s">vm.panic_on_oom=0
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s">fs.inotify.max_user_watches=89100
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="s">fs.file-max=52706963
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="s">fs.nr_open=52706963
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="s">net.netfilter.nf_conntrack_max=2310720
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="s">net.ipv4.tcp_keepalive_time = 600
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="s">net.ipv4.tcp_keepalive_probes = 3
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="s">net.ipv4.tcp_keepalive_intvl =15
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s">net.ipv4.tcp_max_tw_buckets = 36000
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s">net.ipv4.tcp_tw_reuse = 1
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s">net.ipv4.tcp_max_orphans = 327680
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="s">net.ipv4.tcp_orphan_retries = 3
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="s">net.ipv4.tcp_syncookies = 1
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="s">net.ipv4.tcp_max_syn_backlog = 16384
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="s">net.ipv4.ip_conntrack_max = 65536
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="s">net.ipv4.tcp_max_syn_backlog = 16384
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="s">net.ipv4.tcp_timestamps = 0
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="s">net.core.somaxconn = 16384
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="s">vm.swappiness=0
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">net.ipv4.ip_forward = 1
</span></span><span class="line"><span class="ln">2</span><span class="cl">net.bridge.bridge-nf-call-iptables = 1
</span></span><span class="line"><span class="ln">3</span><span class="cl">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></code></pre></div><p>ä¹Ÿæ˜¯ Containerd CRI æ‰€éœ€çš„å†…æ ¸å‚æ•°ã€‚</p>
<p><strong>åŠ è½½ä¸Šè¿°å†…æ ¸å‚æ•°ç”Ÿæ•ˆæ‰€éœ€è¦çš„æ¨¡å—ï¼Œå¹¶åŠ è½½ç”Ÿæ•ˆ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">modprobe --Â overlay
</span></span><span class="line"><span class="ln">2</span><span class="cl">modprobeÂ -- br_netfilter
</span></span><span class="line"><span class="ln">3</span><span class="cl">sysctl --system
</span></span></code></pre></div><h2 id="13-é…ç½®-ipvs">1.3 é…ç½® IPVS<a hidden class="anchor" aria-hidden="true" href="#13-é…ç½®-ipvs">#</a></h2>
<p>K8S é›†ç¾¤å°†ä½¿ç”¨ ipvs æ¨¡å¼ï¼Œå› æ­¤è¿™é‡Œäº‹å…ˆå®‰è£… ipvs ç›¸å…³ç»„ä»¶ã€‚</p>
<ol>
<li><strong>å®‰è£… ipvs ç›¸å…³è½¯ä»¶åŒ…</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">dnf install -y ipvsadm ipset sysstat conntrack libseccomp
</span></span></code></pre></div><ol start="2">
<li><strong>è½½å…¥æ¨¡å—</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">modprobe -- ip_vs
</span></span><span class="line"><span class="ln">2</span><span class="cl">modprobe -- ip_vs_rr
</span></span><span class="line"><span class="ln">3</span><span class="cl">modprobe -- ip_vs_wrr
</span></span><span class="line"><span class="ln">4</span><span class="cl">modprobe -- ip_vs_sh
</span></span><span class="line"><span class="ln">5</span><span class="cl">modprobe -- nf_conntrack
</span></span></code></pre></div><ol start="3">
<li><strong>åˆ›å»ºipvs.confï¼Œè®¾ç½®å†…æ ¸æ¨¡å—çš„è‡ªåŠ¨è½½å…¥</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln"> 1</span><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /etc/modules-load.d/ipvs.conf 
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="s">ip_vs
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="s">ip_vs_lc
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="s">ip_vs_wlc
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="s">ip_vs_rr
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="s">ip_vs_wrr
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s">ip_vs_lblc
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s">ip_vs_lblcr
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="s">ip_vs_dh
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="s">ip_vs_sh
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="s">ip_vs_fo
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="s">ip_vs_nq
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="s">ip_vs_sed
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="s">ip_vs_ftp
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s">ip_vs_sh
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s">nf_conntrack
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s">ip_tables
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="s">ip_set
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="s">xt_set
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="s">ipt_set
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="s">ipt_rpfilter
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="s">ipt_REJECT
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="s">ipip
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">systemctl <span class="nb">enable</span> --now systemd-modules-load.service
</span></span></code></pre></div><h2 id="14-å®‰è£…-containerd">1.4 å®‰è£… Containerd<a hidden class="anchor" aria-hidden="true" href="#14-å®‰è£…-containerd">#</a></h2>
<ol>
<li><strong>å®‰è£… Containerd</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">dnf install containerd -y 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">ctr -v
</span></span><span class="line"><span class="ln">2</span><span class="cl">ctr containerd.io 1.7.18
</span></span></code></pre></div><ol start="2">
<li><strong>ç”Ÿæˆ containerd é…ç½®æ–‡ä»¶</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">mkdir -p /etc/containerd
</span></span><span class="line"><span class="ln">2</span><span class="cl">containerd config default <span class="p">|</span> sudo tee /etc/containerd/config.toml
</span></span></code></pre></div><ol start="3">
<li><strong>ä¿®æ”¹ Containerd ä½¿ç”¨çš„ cgroup ä¸º systemdÂ cgroupÂ driver</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">[plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc]  
</span></span><span class="line"><span class="ln">2</span><span class="cl">Â Â ...  
</span></span><span class="line"><span class="ln">3</span><span class="cl">Â Â [plugins.&#34;io.containerd.grpc.v1.cri&#34;.containerd.runtimes.runc.options]  
</span></span><span class="line"><span class="ln">4</span><span class="cl">Â Â Â Â SystemdCgroupÂ =Â true
</span></span></code></pre></div><ol start="4">
<li><strong>ä¿®æ”¹ Containerd ä½¿ç”¨çš„ sandbox_image</strong></li>
</ol>
<p>ä¿®æ”¹ sandbox çš„é•œåƒåœ°å€</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">sandbox_imageÂ =Â &#34;registry.aliyuncs.com/google_containers/pause:3.9&#34;
</span></span></code></pre></div><ol start="5">
<li><strong>é…ç½® Containerd ç§æœåœ°å€è·³è¿‡ https éªŒè¯</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs<span class="o">]</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class="s2">&#34;10.101.7.108&#34;</span>.tls<span class="o">]</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">                <span class="nv">insecure_skip_verify</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class="s2">&#34;szharbor.hithium.cn&#34;</span>.tls<span class="o">]</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">                <span class="nv">insecure_skip_verify</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class="s2">&#34;docker.io&#34;</span>.tls<span class="o">]</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">                <span class="nv">insecure_skip_verify</span> <span class="o">=</span> <span class="nb">true</span>
</span></span></code></pre></div><ol start="6">
<li><strong>é…ç½® docker.io é•œåƒ</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">      <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class="o">]</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class="s2">&#34;docker.io&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">                <span class="nv">endpoint</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;https://docker.1panel.live&#34;</span><span class="o">][</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class="s2">&#34;10.101.7.108:80&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">                <span class="nv">endpoint</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;http://10.101.7.108&#34;</span><span class="o">]</span>
</span></span></code></pre></div><ol start="7">
<li><strong>ä½¿é…ç½®ç”Ÿæ•ˆ</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">systemctl daemon-reload
</span></span><span class="line"><span class="ln">2</span><span class="cl">systemctl restart containerd.service
</span></span><span class="line"><span class="ln">3</span><span class="cl">systemctl <span class="nb">enable</span> containerd.service
</span></span></code></pre></div><h2 id="15-å®‰è£…-k8s-ç›¸å…³ç»„ä»¶">1.5 å®‰è£… K8S ç›¸å…³ç»„ä»¶<a hidden class="anchor" aria-hidden="true" href="#15-å®‰è£…-k8s-ç›¸å…³ç»„ä»¶">#</a></h2>
<p><a href="https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/">https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="s">baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="s">gpgcheck=1
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="s">gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/repodata/repomd.xml.key
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">dnf -y install kubectl kubelet kubeadm
</span></span></code></pre></div><h1 id="2-ä¸»èŠ‚ç‚¹é…ç½®">2. ä¸»èŠ‚ç‚¹é…ç½®<a hidden class="anchor" aria-hidden="true" href="#2-ä¸»èŠ‚ç‚¹é…ç½®">#</a></h1>
<h2 id="21-é«˜å¯ç”¨é…ç½®">2.1 é«˜å¯ç”¨é…ç½®<a hidden class="anchor" aria-hidden="true" href="#21-é«˜å¯ç”¨é…ç½®">#</a></h2>
<h3 id="211-å®‰è£…ç›¸å…³ç»„ä»¶">2.1.1 å®‰è£…ç›¸å…³ç»„ä»¶<a hidden class="anchor" aria-hidden="true" href="#211-å®‰è£…ç›¸å…³ç»„ä»¶">#</a></h3>
<p>å®‰è£…keepalived, haproxy</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">dnf -y install keepalived haproxy
</span></span></code></pre></div><h3 id="212-é…ç½®æ£€æµ‹è„šæœ¬æ–‡ä»¶">2.1.2 <strong>é…ç½®æ£€æµ‹è„šæœ¬æ–‡ä»¶</strong><a hidden class="anchor" aria-hidden="true" href="#212-é…ç½®æ£€æµ‹è„šæœ¬æ–‡ä»¶">#</a></h3>
<p>è¯¥è„šæœ¬æ£€æµ‹æœ¬åœ° 8443 ç«¯å£(haproxyæœåŠ¡)æ˜¯å¦æ­£å¸¸ï¼Œè‹¥ä¸æ­£å¸¸ï¼Œåˆ™åœæ­¢æœ¬åœ°çš„ Keepalived æœåŠ¡ï¼ŒVIPé£˜é€¸åˆ°å…¶å®ƒ haproxy å¯ç”¨çš„èŠ‚ç‚¹ï¼Œç»§ç»­æä¾›æœåŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">vimÂ /etc/keepalived/check_apiserver.sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="cp"></span>curlÂ -sfkÂ --max-timeÂ 2Â https://localhost:8443/healthzÂ -oÂ /dev/null  
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="k">if</span>Â <span class="o">[</span>Â <span class="nv">$?</span>Â -nqÂ 0<span class="o">]</span>  
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="k">then</span>  
</span></span><span class="line"><span class="ln">5</span><span class="cl">Â Â Â Â Â Â Â Â <span class="nb">echo</span>Â <span class="s2">&#34;***Â ErrorÂ GETÂ https://localhost:8443/healthz&#34;</span>Â 1&gt;<span class="p">&amp;</span><span class="m">2</span>  
</span></span><span class="line"><span class="ln">6</span><span class="cl">Â Â Â Â Â Â Â Â systemctlÂ stopÂ keepalived  
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p><strong>ç»™è„šæœ¬æ–‡ä»¶æ‰§è¡Œæƒé™</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">chmodÂ +xÂ /etc/keepalived/check_apiserver.sh
</span></span></code></pre></div><h3 id="213-é…ç½®-keepalivedconf">2.1.3 é…ç½® keepalived.conf<a hidden class="anchor" aria-hidden="true" href="#213-é…ç½®-keepalivedconf">#</a></h3>
<p>VIP è®°å¾—ä½¿ç”¨èŠ‚ç‚¹æ‰€åœ¨ç½‘æ®µï¼Œä½†ä¸ä½¿ç”¨çš„ IP åœ°å€</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">vim /etc/keepalived/keepalived.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln"> 1</span><span class="cl">! Configuration File <span class="k">for</span> keepalived
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">global_defs <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    router_id LVS_DEVEL
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"># æŒ‡å®šæ£€æµ‹è„šæœ¬:</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># script: è„šæœ¬è·¯å¾„;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1"># interval: è„šæœ¬æ‰§è¡Œæ—¶é—´;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># weight: æƒé‡;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"># fall: è¿ç»­æ£€æµ‹å¤±è´¥å¤šå°‘æ¬¡ä¹‹åè®¤å®šèŠ‚ç‚¹ä¸å¯ç”¨;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"># rise: è¿ç»­æ£€æµ‹æˆåŠŸå¤šå°‘æ¬¡è®¤ä¸ºèŠ‚ç‚¹æ¢å¤æ­£å¸¸ã€‚</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">vrrp_script check_apiserver <span class="o">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">  script <span class="s2">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  interval <span class="m">3</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  weight -2
</span></span><span class="line"><span class="ln">16</span><span class="cl">  fall <span class="m">10</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">  rise <span class="m">2</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1"># state: æŒ‡å®šMASTERèº«ä»½, å¦å¤–ä¸¤å°Keepalivedè®¾ç½®æˆBACKUP</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="c1"># interface: æŒ‡å®šç½‘å¡;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1"># virtual_router_id: VRRPè™šæ‹Ÿè·¯ç”±id, åŒä¸€é›†ç¾¤çš„KeepalivedèŠ‚ç‚¹è¦ç›¸åŒ, ç”¨æ¥è¯†åˆ«å½¼æ­¤</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"># priority: ä¼˜å…ˆçº§, å¦å¤–ä¸¤å°Keepalivedåˆ†åˆ«è®¾ç½®æˆ90 70</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1"># auth_type: VRRPç»„èŠ‚ç‚¹ä¹‹é—´è®¤è¯æ–¹å¼ä¸ºPASSé“­æ–‡</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="c1"># auth_pass: VRRPç»„èŠ‚ç‚¹ä¹‹é—´ç”¨æ¥è®¤è¯é€šä¿¡çš„å¯†ç </span>
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="c1"># virtual_ipaddress: VIP</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="c1"># track_script: æŒ‡å®šä½¿ç”¨çš„æ£€æµ‹è„šæœ¬åç§°</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">vrrp_instance VI_1 <span class="o">{</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    state MASTER
</span></span><span class="line"><span class="ln">31</span><span class="cl">    interface ens192
</span></span><span class="line"><span class="ln">32</span><span class="cl">    virtual_router_id <span class="m">51</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    priority <span class="m">100</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    authentication <span class="o">{</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        auth_type PASS
</span></span><span class="line"><span class="ln">36</span><span class="cl">        auth_pass <span class="m">1111</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    virtual_ipaddress <span class="o">{</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">        10.101.5.2
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    track_script <span class="o">{</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        check_apiserver
</span></span><span class="line"><span class="ln">43</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="214-é…ç½®-haproxycfg">2.1.4 é…ç½® haproxy.cfg<a hidden class="anchor" aria-hidden="true" href="#214-é…ç½®-haproxycfg">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">vimÂ /etc/haproxy/haproxy.cfg
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">#---------------------------------------------------------------------  </span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1">#Â GlobalÂ settings  </span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1">#---------------------------------------------------------------------  </span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">global
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  log	stdout	format	raw	local0
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  chroot	/var/lib/haproxy
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  pidfile	/var/run/haproxy.pid
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  maxconn	<span class="m">4000</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  user		haproxy
</span></span><span class="line"><span class="ln">10</span><span class="cl">  group		haproxy
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1">#---------------------------------------------------------------------  </span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1">#Â commonÂ defaultsÂ thatÂ allÂ theÂ &#39;listen&#39;Â andÂ &#39;backend&#39;Â sectionsÂ will  </span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1">#Â useÂ ifÂ notÂ designatedÂ inÂ theirÂ block  </span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1">#---------------------------------------------------------------------  </span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">defaults
</span></span><span class="line"><span class="ln">18</span><span class="cl">  log		global
</span></span><span class="line"><span class="ln">19</span><span class="cl">  option	httplog
</span></span><span class="line"><span class="ln">20</span><span class="cl">  option	dontlognull
</span></span><span class="line"><span class="ln">21</span><span class="cl">  timeout	connect		5s
</span></span><span class="line"><span class="ln">22</span><span class="cl">  timeout	client		35s
</span></span><span class="line"><span class="ln">23</span><span class="cl">  timeout	server		35s
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="c1">#---------------------------------------------------------------------  </span>
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="c1">#Â apiserverÂ frontendÂ whichÂ proxysÂ toÂ theÂ controlÂ planeÂ nodes  </span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="c1">#---------------------------------------------------------------------  </span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1">#Â ä¸»è¦æ˜¯è¿™é‡Œçš„bind:Â å®šä¹‰haproxyçš„ä»£ç†ç«¯å£ä¸º8443ã€‚ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒã€‚  </span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">frontend	apiserver
</span></span><span class="line"><span class="ln">31</span><span class="cl">	<span class="nb">bind</span>	*:8443
</span></span><span class="line"><span class="ln">32</span><span class="cl">	mode	tcp
</span></span><span class="line"><span class="ln">33</span><span class="cl">	option	tcplog
</span></span><span class="line"><span class="ln">34</span><span class="cl">	default_backend	apiserverbackend
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="c1">#---------------------------------------------------------------------  </span>
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="c1">#Â roundÂ robinÂ balancingÂ forÂ apiserver  </span>
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="c1">#---------------------------------------------------------------------  </span>
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="c1">#Â ä»¥ä¸‹æ˜¯åç«¯ç›¸å…³é…ç½®,Â å…³é”®å‚æ•°è§£é‡Šå¦‚ä¸‹  </span>
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="c1">#Â modeÂ tcp:Â è®¾ç½®ä¸åç«¯æœåŠ¡é€šä¿¡çš„æ¨¡å¼ä¸ºTCP  </span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="c1">#Â balanceÂ roundrobin:Â è½®è¯¢æ–¹å¼  </span>
</span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="c1">#Â inter 10s:Â æ£€æŸ¥é—´éš”ä¸º10ç§’ã€‚  </span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="c1">#Â downinter 5s:Â å½“æœåŠ¡è¢«æ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æ¢å¤ã€‚  </span>
</span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="c1">#Â rise 2:Â åœ¨å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸Šçº¿ä¹‹å‰ï¼ŒæœåŠ¡å™¨å¿…é¡»è¿ç»­2æ¬¡æˆåŠŸå“åº”æ£€æŸ¥ã€‚  </span>
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="c1">#Â fall 2:Â åœ¨å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸‹çº¿ä¹‹å‰ï¼ŒæœåŠ¡å™¨å¿…é¡»è¿ç»­2æ¬¡å¤±è´¥å“åº”æ£€æŸ¥ã€‚  </span>
</span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="c1">#Â slowstart 60s:Â æ…¢å¯åŠ¨æ—¶é—´ä¸º60ç§’ï¼Œç”¨äºæ§åˆ¶æ–°æœåŠ¡å™¨ä¸Šçº¿åé€æ¸å¢åŠ å…¶æƒé‡ã€‚  </span>
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="c1">#Â maxconn 250:Â æ¯ä¸ªæœåŠ¡å™¨çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°ä¸º250ã€‚  </span>
</span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="c1">#Â maxqueue 256:Â åç«¯é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ä¸º256ã€‚  </span>
</span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="c1">#Â weight 100:Â æœåŠ¡å™¨çš„é»˜è®¤æƒé‡ä¸º100ã€‚  </span>
</span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="c1">#Â server å®šä¹‰åç«¯çš„æœåŠ¡å™¨åˆ—è¡¨ã€‚  </span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">
</span></span><span class="line"><span class="ln">53</span><span class="cl">
</span></span><span class="line"><span class="ln">54</span><span class="cl">backend		apiserverbackend
</span></span><span class="line"><span class="ln">55</span><span class="cl">	option	tcplog
</span></span><span class="line"><span class="ln">56</span><span class="cl">	option	tcp-check
</span></span><span class="line"><span class="ln">57</span><span class="cl">	mode		tcp
</span></span><span class="line"><span class="ln">58</span><span class="cl">	balance	roundrobin
</span></span><span class="line"><span class="ln">59</span><span class="cl">	default-server interÂ 10sÂ downinterÂ 5sÂ riseÂ 2Â fallÂ 2Â slowstartÂ 60sÂ maxconnÂ 250Â maxqueueÂ 256Â weightÂ <span class="m">100</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">	server	zqf-Master01	10.101.5.110:6443	check
</span></span><span class="line"><span class="ln">61</span><span class="cl">	server	zqf-Master02	10.101.5.111:6443	check
</span></span><span class="line"><span class="ln">62</span><span class="cl">	server	zqf-Master03	10.101.5.112:6443	check
</span></span></code></pre></div><h3 id="215-å¯åŠ¨æœåŠ¡å¹¶éªŒè¯">2.1.5 å¯åŠ¨æœåŠ¡å¹¶éªŒè¯<a hidden class="anchor" aria-hidden="true" href="#215-å¯åŠ¨æœåŠ¡å¹¶éªŒè¯">#</a></h3>
<ol>
<li><strong>å¯åŠ¨æœåŠ¡</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">systemctlÂ <span class="nb">enable</span>Â --nowÂ keepalived
</span></span><span class="line"><span class="ln">2</span><span class="cl">systemctlÂ <span class="nb">enable</span>Â --nowÂ haproxy
</span></span></code></pre></div><ol start="2">
<li><strong>éªŒè¯</strong></li>
</ol>
<p>åœæ­¢ master01 ä¸Šçš„ keepalived æœåŠ¡åï¼Œ è™šæ‹Ÿ IP 192.168.10.240/32 ä¼šç§»åŠ¨åˆ° moster02ã€‚
æ¢å¤ master01 ä¸Šçš„ keepalived æœåŠ¡åï¼Œ è™šæ‹Ÿ IP 192.168.10.240/32 ä¼šç§»åŠ¨å› moster01ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>root@zqf-Master01 ~<span class="o">]</span><span class="c1"># ip a | grep ens</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc mq state UP group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    inet 10.101.5.110/24 brd 10.101.5.255 scope global noprefixroute ens192
</span></span><span class="line"><span class="ln">4</span><span class="cl">    inet 192.168.10.240/32 scope global ens192
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="o">[</span>root@zqf-Master02 keepalived<span class="o">]</span><span class="c1"># ip a | grep ens</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc mq state UP group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">    inet 10.101.5.111/24 brd 10.101.5.255 scope global noprefixroute ens192
</span></span></code></pre></div><h2 id="22-åŸºäº-kubeadm-å®‰è£…é›†ç¾¤">2.2 åŸºäº kubeadm å®‰è£…é›†ç¾¤<a hidden class="anchor" aria-hidden="true" href="#22-åŸºäº-kubeadm-å®‰è£…é›†ç¾¤">#</a></h2>
<h3 id="221-æå‰æ‹‰å–é•œåƒ">2.2.1 æå‰æ‹‰å–é•œåƒ<a hidden class="anchor" aria-hidden="true" href="#221-æå‰æ‹‰å–é•œåƒ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers
</span></span></code></pre></div><h3 id="222-ä¿®æ”¹-kubeadm-é…ç½®æ–‡ä»¶">2.2.2 ä¿®æ”¹ kubeadm é…ç½®æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#222-ä¿®æ”¹-kubeadm-é…ç½®æ–‡ä»¶">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubeadmÂ configÂ printÂ init-defaultsÂ &gt;Â Â kubeadm-init.yaml
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>é…ç½®é¡¹</th>
          <th>æè¿°</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>advertiseAddress</td>
          <td>æŒ‡å®šæœ¬æœºåœ°å€</td>
      </tr>
      <tr>
          <td>name</td>
          <td>æŒ‡å®šæœ¬æœºçš„ä¸»æœºå</td>
      </tr>
      <tr>
          <td>controlPlaneEndpoint</td>
          <td>æŒ‡å®šæ§åˆ¶é¢çš„é€šä¿¡åœ°å€ï¼Œè¿™é‡Œå†™ VIP åœ°å€</td>
      </tr>
      <tr>
          <td>imageRepository</td>
          <td>æŒ‡å®šä¸‹è½½ Kubernetes ç»„ä»¶çš„é•œåƒä»“åº“åœ°å€, é»˜è®¤è®¿é—®å›½å¤–çš„ä»“åº“, è¿™é‡Œéœ€è¦ä¿®æ”¹ä¸ºå›½å†…çš„é•œåƒä»“åº“æº</td>
      </tr>
      <tr>
          <td>kubernetesVersion</td>
          <td>æŒ‡å®šå®‰è£…çš„ kubernetes ç‰ˆæœ¬</td>
      </tr>
      <tr>
          <td>serviceSubnet</td>
          <td>æŒ‡å®š Kubernetes çš„ Service èµ„æºåˆ†é…çš„ç½‘æ®µ, ç½‘æ®µä¸èƒ½ä¸çœŸå®æœºå’Œ Pod çš„ç½‘æ®µå†²çªã€‚</td>
      </tr>
      <tr>
          <td>podSubnet</td>
          <td>æŒ‡å®š Kubernetes çš„ Pod èµ„æºåˆ†é…çš„ç½‘æ®µ, ç½‘æ®µä¸èƒ½ä¸çœŸå®æœºå’Œ Service çš„ç½‘æ®µå†²çªã€‚</td>
      </tr>
  </tbody>
</table>
<p>éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>localAPIEndpoint.advertiseAddress</code>ï¼šä¸»èŠ‚ç‚¹ IP åœ°å€</li>
<li><code>nodeRegistration.name</code>ï¼šä¸»èŠ‚ç‚¹ hostname</li>
<li><code>imageRepository</code>ï¼šé•œåƒä»“åº“åœ°å€</li>
<li><code>networking.podSubnet</code>: pod å­ç½‘èŒƒå›´</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">bootstrapTokens</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span>- <span class="nt">groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span>- <span class="l">system:bootstrappers:kubeadm:default-node-token</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">abcdef.0123456789abcdef</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l">24h0m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">usages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span>- <span class="l">signing</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="l">authentication</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">InitConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nt">localAPIEndpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">advertiseAddress</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.5.110</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">bindPort</span><span class="p">:</span><span class="w"> </span><span class="m">6443</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">nodeRegistration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">criSocket</span><span class="p">:</span><span class="w"> </span><span class="l">unix:///var/run/containerd/containerd.sock</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">zqf-Master01</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="nt">taints</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="nt">apiServer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">timeoutForControlPlane</span><span class="p">:</span><span class="w"> </span><span class="l">4m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="nt">certificatesDir</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="nt">controllerManager</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="nt">controlPlaneEndpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.101.5.2:8443&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="nt">dataDir</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/etcd</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="nt">imageRepository</span><span class="p">:</span><span class="w"> </span><span class="l">registry.aliyuncs.com/google_containers</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w"></span><span class="nt">kubernetesVersion</span><span class="p">:</span><span class="w"> </span><span class="m">1.29.6</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span><span class="nt">dnsDomain</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">10.96.0.0</span><span class="l">/12</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">  </span><span class="nt">podSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w"></span><span class="nt">scheduler</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w"></span><span class="c"># è¡¥å……</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeproxy.config.k8s.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeProxyConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">ipvs</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubelet.config.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeletConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w"></span><span class="nt">cgroupDriver</span><span class="p">:</span><span class="w"> </span><span class="l">systemd</span><span class="w">
</span></span></span></code></pre></div><h3 id="223-åˆå§‹åŒ–-k8s-é›†ç¾¤">2.2.3 åˆå§‹åŒ– K8S é›†ç¾¤<a hidden class="anchor" aria-hidden="true" href="#223-åˆå§‹åŒ–-k8s-é›†ç¾¤">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubeadm init --config<span class="o">=</span>kubeadm-init.yaml  --upload-certs
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œ <code>--upload-certs</code> ä¼šè‡ªåŠ¨å°†è¯ä¹¦ä»ä¸»æ§åˆ¶å¹³é¢èŠ‚ç‚¹å¤åˆ¶åˆ°å°†è¦åŠ å…¥çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šã€‚</p>
<p>ç„¶åï¼Œæ ¹æ®æç¤ºå°†å„ä¸ªèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># æ·»åŠ masterèŠ‚ç‚¹çš„å‘½ä»¤</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">kubeadm token create --print-join-command --certificate-key
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># æ·»åŠ workerèŠ‚ç‚¹çš„å‘½ä»¤è·å–æ–¹å¼</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">kubeadm token create --print-join-command
</span></span></code></pre></div><p>kubeadm token create &ndash;print-join-command &ndash;ttl 0</p>
<h3 id="224-é…ç½®-kubectl">2.2.4 é…ç½® kubectl<a hidden class="anchor" aria-hidden="true" href="#224-é…ç½®-kubectl">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="ln">2</span><span class="cl">sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="ln">3</span><span class="cl">sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># å°†ä»¥ä¸‹å‘½ä»¤åŠ åˆ°.bashrc</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œadmin.conf æ˜¯è¿æ¥ Kubernetes çš„è®¤è¯æ–‡ä»¶ï¼Œé€šè¿‡æ­¤æ–‡ä»¶æ‰èƒ½è¿æ¥åˆ° kubernetesï¼Œkubectl ä¹Ÿéœ€è¦è¿™ä¸ªæ–‡ä»¶ï¼›åœ¨ Linux ä¸­ï¼Œä½¿ç”¨ KUBECONFIG ç¯å¢ƒå˜é‡çŸ¥é“è®¤è¯æ–‡ä»¶çš„æ‰€åœ¨ã€‚</p>
<p>Linux ä¸­æ¯ä¸ªç”¨æˆ·çš„ç¯å¢ƒå˜é‡æ˜¯ä¸åŒçš„ï¼Œå¦‚æœåˆ‡æ¢äº†ç”¨æˆ·ï¼Œåˆ™ä¹Ÿéœ€è¦è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡ï¼›å¦‚æœè¦åœ¨åˆ«çš„èŠ‚ç‚¹ä¸Šè¿æ¥é›†ç¾¤ï¼Œåˆ™å¯ä»¥æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶è¿‡å»ã€‚</p>
<p>æ­¤æ—¶ï¼Œåœ¨ master01 ä¸Šæ‰§è¡Œ <code>kubectl get no</code> åº”æœ‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>root@zqf-Master01 ~<span class="o">]</span><span class="c1"># kubectl get no</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME           STATUS     ROLES           AGE     VERSION
</span></span><span class="line"><span class="ln">3</span><span class="cl">zqf-master01   NotReady   control-plane   2m23s   v1.29.6
</span></span><span class="line"><span class="ln">4</span><span class="cl">zqf-master02   NotReady   control-plane   101s    v1.29.6
</span></span><span class="line"><span class="ln">5</span><span class="cl">zqf-master03   NotReady   control-plane   101s    v1.29.6
</span></span><span class="line"><span class="ln">6</span><span class="cl">zqf-worker01   NotReady   &lt;none&gt;          67s     v1.29.6
</span></span><span class="line"><span class="ln">7</span><span class="cl">zqf-worker02   NotReady   &lt;none&gt;          65s     v1.29.6
</span></span><span class="line"><span class="ln">8</span><span class="cl">zqf-worker03   NotReady   &lt;none&gt;          63s     v1.29.6
</span></span><span class="line"><span class="ln">9</span><span class="cl">zqf-worker04   NotReady   &lt;none&gt;          60s     v1.29.6
</span></span></code></pre></div><h2 id="23-å®‰è£…-calico">2.3 å®‰è£… Calico<a hidden class="anchor" aria-hidden="true" href="#23-å®‰è£…-calico">#</a></h2>
<p>Calico3.28 ç‰ˆæœ¬æ”¯æŒ: Kubernetesv1.27-v1.30ã€‚</p>
<p>Calico çš„å®‰è£…æ–¹å¼ç›®å‰æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>åŸºäº Operator æ–¹å¼å®‰è£…ï¼Œèƒ½å¤Ÿç®¡ç† Calico é›†ç¾¤çš„å®‰è£…ï¼Œå‡çº§ï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ï¼Œä½†ä¸æ–¹ä¾¿ç®¡ç†é•œåƒåœ°å€ã€‚ï¼ˆä¼˜å…ˆï¼‰</li>
<li>åŸºäºé™æ€èµ„æºæ¸…å•å®‰è£…ï¼Œæ–¹ä¾¿ï¼Œç®€å•ï¼Œä½†æ— æ³•åƒ Opertaor ä¸€æ ·èƒ½å¤Ÿè‡ªåŠ¨ç®¡ç† Calico çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ul>
<p>åŸºäºé™æ€èµ„æºæ¸…å•çš„éƒ¨ç½²å¸¸è§çš„ä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>calico.yamlï¼šå½“ Calico ä½¿ç”¨ Kubernetes API ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œä¸”é›†ç¾¤èŠ‚ç‚¹å°‘äº 50 ä¸ªã€‚</li>
<li>calico-typha.yaml: å½“ Calico ä½¿ç”¨ Kubernetes API ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œä¸”é›†ç¾¤èŠ‚ç‚¹å¤§äº 50 ä¸ªã€‚</li>
</ul>
<p><a href="https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml">https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml</a></p>
<p>replicas:Â å‰¯æœ¬æ•° , å»ºè®®æ¯200ä¸ªèŠ‚ç‚¹1ä¸ªå‰¯æœ¬, ç”Ÿäº§çš„è¯å»ºè®®3ä¸ªå‰¯æœ¬ã€‚</p>
<p>å…¶ä¸­ï¼Œé•œåƒæ¨èæå‰æ‹‰å–åˆ°ç§æœï¼Œç„¶åä¿®æ”¹ imageurl</p>
<p>å®‰è£…æˆåŠŸåï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>root@zqf-Master01 ~<span class="o">]</span><span class="c1"># kubectl get po -n kube-system</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">calico-kube-controllers-7884dfffd6-pdj8v   1/1     Running   <span class="m">0</span>          61s
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">calico-node-7q2dp                          1/1     Running   <span class="m">0</span>          46s
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">calico-node-gdtc4                          1/1     Running   <span class="m">0</span>          46s
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">calico-node-hndr8                          1/1     Running   <span class="m">0</span>          46s
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">calico-node-jd9zm                          1/1     Running   <span class="m">0</span>          46s
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">calico-node-n8z5j                          1/1     Running   <span class="m">0</span>          46s
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">calico-node-pn4l2                          1/1     Running   <span class="m">0</span>          46s
</span></span><span class="line"><span class="ln">10</span><span class="cl">calico-node-wtqtn                          1/1     Running   <span class="m">0</span>          46s
</span></span><span class="line"><span class="ln">11</span><span class="cl">calico-typha-866db88dc4-8njgj              1/1     Running   <span class="m">0</span>          61s
</span></span><span class="line"><span class="ln">12</span><span class="cl">calico-typha-866db88dc4-8wd57              1/1     Running   <span class="m">0</span>          61s
</span></span><span class="line"><span class="ln">13</span><span class="cl">calico-typha-866db88dc4-wnjzh              1/1     Running   <span class="m">0</span>          61s
</span></span><span class="line"><span class="ln">14</span><span class="cl">coredns-66db75cf8c-96t2p                   1/1     Running   <span class="m">0</span>          61s
</span></span><span class="line"><span class="ln">15</span><span class="cl">coredns-66db75cf8c-xgdf9                   1/1     Running   <span class="m">0</span>          61s
</span></span><span class="line"><span class="ln">16</span><span class="cl">etcd-zqf-master01                          1/1     Running   <span class="m">1</span>          53m
</span></span><span class="line"><span class="ln">17</span><span class="cl">etcd-zqf-master02                          1/1     Running   <span class="m">0</span>          52m
</span></span><span class="line"><span class="ln">18</span><span class="cl">etcd-zqf-master03                          1/1     Running   <span class="m">0</span>          52m
</span></span><span class="line"><span class="ln">19</span><span class="cl">kube-apiserver-zqf-master01                1/1     Running   <span class="m">1</span>          53m
</span></span><span class="line"><span class="ln">20</span><span class="cl">kube-apiserver-zqf-master02                1/1     Running   <span class="m">0</span>          52m
</span></span><span class="line"><span class="ln">21</span><span class="cl">kube-apiserver-zqf-master03                1/1     Running   <span class="m">0</span>          52m
</span></span><span class="line"><span class="ln">22</span><span class="cl">kube-controller-manager-zqf-master01       1/1     Running   <span class="m">1</span>          53m
</span></span><span class="line"><span class="ln">23</span><span class="cl">kube-controller-manager-zqf-master02       1/1     Running   <span class="m">0</span>          52m
</span></span><span class="line"><span class="ln">24</span><span class="cl">kube-controller-manager-zqf-master03       1/1     Running   <span class="m">0</span>          52m
</span></span><span class="line"><span class="ln">25</span><span class="cl">kube-proxy-75sbq                           1/1     Running   <span class="m">0</span>          37s
</span></span><span class="line"><span class="ln">26</span><span class="cl">kube-proxy-g2nqd                           1/1     Running   <span class="m">0</span>          45s
</span></span><span class="line"><span class="ln">27</span><span class="cl">kube-proxy-jqd92                           1/1     Running   <span class="m">0</span>          40s
</span></span><span class="line"><span class="ln">28</span><span class="cl">kube-proxy-kwxcb                           1/1     Running   <span class="m">0</span>          44s
</span></span><span class="line"><span class="ln">29</span><span class="cl">kube-proxy-lhtvl                           1/1     Running   <span class="m">0</span>          38s
</span></span><span class="line"><span class="ln">30</span><span class="cl">kube-proxy-vkv5v                           1/1     Running   <span class="m">0</span>          43s
</span></span><span class="line"><span class="ln">31</span><span class="cl">kube-proxy-ws2fl                           1/1     Running   <span class="m">0</span>          41s
</span></span><span class="line"><span class="ln">32</span><span class="cl">kube-scheduler-zqf-master01                1/1     Running   <span class="m">1</span>          53m
</span></span><span class="line"><span class="ln">33</span><span class="cl">kube-scheduler-zqf-master02                1/1     Running   <span class="m">0</span>          52m
</span></span><span class="line"><span class="ln">34</span><span class="cl">kube-scheduler-zqf-master03                1/1     Running   <span class="m">0</span>          52m
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>root@zqf-Master01 ~<span class="o">]</span><span class="c1"># kubectl get node</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME           STATUS   ROLES           AGE   VERSION
</span></span><span class="line"><span class="ln">3</span><span class="cl">zqf-master01   Ready    control-plane   54m   v1.29.6
</span></span><span class="line"><span class="ln">4</span><span class="cl">zqf-master02   Ready    control-plane   53m   v1.29.6
</span></span><span class="line"><span class="ln">5</span><span class="cl">zqf-master03   Ready    control-plane   53m   v1.29.6
</span></span><span class="line"><span class="ln">6</span><span class="cl">zqf-worker01   Ready    &lt;none&gt;          52m   v1.29.6
</span></span><span class="line"><span class="ln">7</span><span class="cl">zqf-worker02   Ready    &lt;none&gt;          52m   v1.29.6
</span></span><span class="line"><span class="ln">8</span><span class="cl">zqf-worker03   Ready    &lt;none&gt;          52m   v1.29.6
</span></span><span class="line"><span class="ln">9</span><span class="cl">zqf-worker04   Ready    &lt;none&gt;          52m   v1.29.6
</span></span></code></pre></div><h2 id="24-é…ç½®-kubectl-å‘½ä»¤è¡¥å…¨">2.4 é…ç½® kubectl å‘½ä»¤è¡¥å…¨<a hidden class="anchor" aria-hidden="true" href="#24-é…ç½®-kubectl-å‘½ä»¤è¡¥å…¨">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">dnf install -y bash-completion 
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nb">source</span> /usr/share/bash-completion/bash_completion
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="nb">source</span> &lt;<span class="o">(</span>kubectl completion bash<span class="o">)</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;source &lt;(kubectl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></div><h1 id="3-æ¸…é™¤-kubeadm-ç¯å¢ƒ">3. æ¸…é™¤ kubeadm ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#3-æ¸…é™¤-kubeadm-ç¯å¢ƒ">#</a></h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubeadm reset cleanup-node
</span></span><span class="line"><span class="ln">2</span><span class="cl">y
</span></span><span class="line"><span class="ln">3</span><span class="cl">kubeadm reset
</span></span><span class="line"><span class="ln">4</span><span class="cl">y
</span></span><span class="line"><span class="ln">5</span><span class="cl">rm -rf /etc/cni/net.d
</span></span><span class="line"><span class="ln">6</span><span class="cl">ipvsadm --clear
</span></span><span class="line"><span class="ln">7</span><span class="cl">rm -rf <span class="nv">$HOME</span>/.kube/config
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/kubernetes/">Kubernetes</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/tech/tools/charles-%E5%AE%89%E5%8D%93%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Charles å®‰å“æŠ“åŒ…é…ç½®</span>
  </a>
  <a class="next" href="/tech/kubernetes/%E5%9F%BA%E4%BA%8E-kubeadm-%E6%89%8B%E5%8A%A8%E6%9B%B4%E6%96%B0%E8%AF%81%E4%B9%A6/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>åŸºäº Kubeadm æ‰‹åŠ¨æ›´æ–°è¯ä¹¦</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="/">xgbt&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
