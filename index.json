[{"content":"é—®é¢˜ åœ¨ Elasticsearch ä¸­ä½¿ç”¨Â SearchAfterÂ è¿›è¡Œæ·±åº¦åˆ†é¡µæ—¶ï¼ŒSearchAfterÂ ä¼šæ’é™¤æ‰æ’åºå­—æ®µå€¼ä¸Â SearchAfterÂ å‚æ•°å€¼å®Œå…¨ç›¸åŒçš„æ–‡æ¡£ã€‚\nå½“ä½ è·å–æœ€åä¸€ä¸ªæ–‡æ¡£çš„Â SortÂ å€¼ä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„Â SearchAfterÂ å‚æ•°æ—¶ï¼Œå¦‚æœæœ€åä¸€ä¸ªæ–‡æ¡£çš„æ’åºå­—æ®µå€¼ä¸å…¶ä»–æ–‡æ¡£ç›¸åŒï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡æŸ¥è¯¢å°±ä¼šæ’é™¤æ‰è¿™äº›æ’åºå­—æ®µå€¼ç›¸åŒçš„æ–‡æ¡£ï¼Œä»è€Œå¯¼è‡´ç¬¬äºŒé¡µå°‘ä¸€ä¸ªæˆ–å¤šä¸ªè®°å½•ã€‚\nè§£å†³ ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è·å–Â lastSortÂ æ—¶ï¼Œéœ€è¦ç¡®ä¿å®ƒæ˜¯å”¯ä¸€çš„ï¼Œä¾‹å¦‚Â _idï¼Œä»¥ä¿è¯æ’åºçš„å”¯ä¸€æ€§ã€‚é¿å…ä½¿ç”¨ created_at è¿™ç§æœ‰å¯èƒ½å‡ºç°é‡å¤çš„å€¼ä½œä¸ºæ’é¡¹ï¼Œè€Œæ˜¯ç”¨ id ä½œä¸ºæ’åºé¡¹\n1ess := es.Search().Timeout(\u0026#34;10s\u0026#34;). 2 Index(it.indexName). 3 Sort(\u0026#34;created_at\u0026#34;, false). 4 Query(boolQuery). 5 Size(int(req.Size)) 1ess := es.Search().Timeout(\u0026#34;10s\u0026#34;). 2 Index(it.indexName). 3 Sort(\u0026#34;_id\u0026#34;, false). // ä½¿ç”¨ _id æ’åºï¼Œç¡®ä¿æ’åºçš„å”¯ä¸€æ€§ 4 Query(boolQuery). 5 Size(int(req.Size)) ","permalink":"/tech/elasticsearch-%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E8%AE%B0%E5%BD%95%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/","summary":"\u003ch1 id=\"é—®é¢˜\"\u003eé—®é¢˜\u003c/h1\u003e\n\u003cp\u003eåœ¨ Elasticsearch ä¸­ä½¿ç”¨Â \u003ccode\u003eSearchAfter\u003c/code\u003eÂ è¿›è¡Œæ·±åº¦åˆ†é¡µæ—¶ï¼Œ\u003ccode\u003eSearchAfter\u003c/code\u003eÂ ä¼šæ’é™¤æ‰æ’åºå­—æ®µå€¼ä¸Â \u003ccode\u003eSearchAfter\u003c/code\u003eÂ å‚æ•°å€¼å®Œå…¨ç›¸åŒçš„æ–‡æ¡£ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ä½ è·å–æœ€åä¸€ä¸ªæ–‡æ¡£çš„Â \u003ccode\u003eSort\u003c/code\u003eÂ å€¼ä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„Â \u003ccode\u003eSearchAfter\u003c/code\u003eÂ å‚æ•°æ—¶ï¼Œå¦‚æœæœ€åä¸€ä¸ªæ–‡æ¡£çš„æ’åºå­—æ®µå€¼ä¸å…¶ä»–æ–‡æ¡£ç›¸åŒï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡æŸ¥è¯¢å°±ä¼šæ’é™¤æ‰è¿™äº›æ’åºå­—æ®µå€¼ç›¸åŒçš„æ–‡æ¡£ï¼Œä»è€Œå¯¼è‡´ç¬¬äºŒé¡µå°‘ä¸€ä¸ªæˆ–å¤šä¸ªè®°å½•ã€‚\u003c/p\u003e","title":"ElasticSearch æ·±åº¦åˆ†é¡µè®°å½•ä¸¢å¤±é—®é¢˜"},{"content":"é—®é¢˜ 1æ— æ³•æ‰“å¼€â€œXXXâ€ï¼Œå› ä¸ºAppleæ— æ³•æ£€æŸ¥å…¶æ˜¯å¦åŒ…å«æ¶æ„è½¯ä»¶ã€‚ è§£å†³æ­¥éª¤ 1sudo spctl --master-disable ã€Œè®¾ç½®ã€-ã€Œéšç§ä¸å®‰å…¨æ€§ã€-ã€Œå®‰å…¨æ€§ã€-ã€Œå…è®¸ä»¥ä¸‹æ¥æºçš„åº”ç”¨ã€ï¼Œé€‰æ‹©ä»»ä½•æ¥æº\nå‚è€ƒèµ„æ–™ https://jo-cruise.github.io/posts/AuthorizeUnknownDeveloper/ ","permalink":"/tech/%E8%A7%A3%E5%86%B3-macos-%E6%97%A0%E6%B3%95%E9%AA%8C%E8%AF%81-app/","summary":"\u003ch1 id=\"é—®é¢˜\"\u003eé—®é¢˜\u003c/h1\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eæ— æ³•æ‰“å¼€â€œXXXâ€ï¼Œå› ä¸ºAppleæ— æ³•æ£€æŸ¥å…¶æ˜¯å¦åŒ…å«æ¶æ„è½¯ä»¶ã€‚\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch1 id=\"è§£å†³æ­¥éª¤\"\u003eè§£å†³æ­¥éª¤\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo spctl --master-disable\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eã€Œè®¾ç½®ã€-ã€Œéšç§ä¸å®‰å…¨æ€§ã€-ã€Œå®‰å…¨æ€§ã€-ã€Œå…è®¸ä»¥ä¸‹æ¥æºçš„åº”ç”¨ã€ï¼Œé€‰æ‹©ä»»ä½•æ¥æº\u003c/p\u003e\n\u003ch1 id=\"å‚è€ƒèµ„æ–™\"\u003eå‚è€ƒèµ„æ–™\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://jo-cruise.github.io/posts/AuthorizeUnknownDeveloper/\"\u003ehttps://jo-cruise.github.io/posts/AuthorizeUnknownDeveloper/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"è§£å†³ macOS æ— æ³•éªŒè¯ App é—®é¢˜"},{"content":" ğŸ’¡ é›¶æ‹·è´æ“ä½œå¯ä»¥é¿å…å¯¹æ•°æ®çš„éå¿…è¦æ‹·è´ï¼Œå½“ç„¶ï¼Œå¹¶éæ˜¯è¯´å®Œå…¨æ²¡æœ‰æ‹·è´ã€‚\nåœ¨ Kafka çš„åœºæ™¯ä¸‹ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ä» page cache æ‹·è´æ•°æ®åˆ° socket bufferï¼Œç›´æ¥ç»•è¿‡ Kafka broker è¿™ä¸ª Java ç¨‹åºã€‚è¿™å¯ä»¥èŠ‚çœä¸€äº›é¢å¤–çš„æ‹·è´ï¼ŒèŠ‚çœä¸€äº›ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ã€‚\nä¼ ç»Ÿæ‹·è´ å¦‚æœåº”ç”¨ç¨‹åºè¦ä»ç£ç›˜è¯»å–æ–‡ä»¶å¹¶é€šè¿‡ç½‘ç»œå‘é€å®ƒï¼Œåˆ™å¯èƒ½ä¼šè¿›è¡Œä¸€å †ä¸å¿…è¦çš„æ‹·è´ä»¥åŠç”¨æˆ·æ€/å†…æ ¸æ€çš„åˆ‡æ¢ã€‚\nread buffer: è¯»ç¼“å†²åŒºï¼Œæ“ä½œç³»ç»Ÿçš„ page cache socket buffer: å¥—æ¥å­—ç¼“å†²åŒºï¼ŒOS ç”¨äºç®¡ç†æ•°æ®åŒ…çš„å­—èŠ‚ç¼“å†²åŒº NIC buffer: ç½‘å¡ä¸­çš„å­—èŠ‚ç¼“å†²åŒº DMA copy: DMA æ˜¯ Direct Memory Access çš„ç¼©å†™ï¼Œæ˜¯å†…å­˜æ§åˆ¶å™¨çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥é¿å… CPU çš„å¹²é¢„ï¼Œå…è®¸ç¡¬ä»¶ï¼ˆå›¾å½¢å¡ã€å£°å¡ã€ç½‘å¡ç­‰ï¼‰ç›´æ¥è®¿é—®å†…å­˜ (RAM) é‡Œçš„æŸäº›æ•°æ® åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰ 4 æ¬¡æ¨¡å¼åˆ‡æ¢ï¼ˆç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„åˆ‡æ¢ï¼‰å’Œ 4 æ¬¡æ•°æ®æ‹·è´ã€‚\nKafka åˆ©ç”¨ DMA copy ä»ç£ç›˜ load æ•°æ®åˆ° read bufferï¼ˆç”¨æˆ·æ€-\u0026gt;å†…æ ¸æ€ï¼‰ read buffer åˆ° Kafka ç¼“å­˜åŒºï¼ˆå†…æ ¸æ€-\u0026gt;ç”¨æˆ·æ€ï¼‰ Kafka è¦å‘æ•°æ®åˆ°ç½‘ç»œä¸Šï¼Œå®é™…æ˜¯å…ˆå†™åˆ° socket bufferï¼ˆç”¨æˆ·æ€-\u0026gt;å†…æ ¸æ€ï¼‰ socket buffer åˆ° NIC bufferï¼ˆå“åº”æ•°æ®å†™å®Œä¹‹åï¼Œç”±å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€ï¼‰ é›¶æ‹·è´ ä¸ºäº†å‡å°‘æ‹·è´ï¼Œç›´æ¥æŠŠæ•°æ®ä»ç£ç›˜å‘å‘ç½‘ç»œï¼Œé‚£ Kafka åœ¨å­˜å‚¨æ•°æ®çš„æ—¶å€™ï¼Œå°±è¦ä¿è¯å­˜å‚¨çš„æ•°æ®æ ¼å¼å’Œå°†è¦å‘å‡ºçš„ response æ ¼å¼ä¸€è‡´ã€‚\nåœ¨ä¼ ç»Ÿæ‹·è´æ¨¡å¼ä¸‹ï¼Œç¬¬äºŒæ­¥ã€ç¬¬ä¸‰æ­¥å…¶å®æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸º Kafka æ²¡æœ‰å¯¹æ•°æ®åšé¢å¤–å¤„ç†ï¼Œåªæ˜¯ç®€å•è½¬å‘ã€‚é‚£èƒ½å¦ä»ç£ç›˜ç›´æ¥å‘å‘ç½‘ç»œå‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚é€šè¿‡é›¶æ‹·è´æŠ€æœ¯ï¼Œç£ç›˜ä¸Šçš„æ•°æ®è¿˜æ˜¯è¦å…ˆè¿›å…¥ read bufferï¼Œç„¶åä¸ç”¨å†æ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„ç¼“å­˜åŒºï¼Œè€Œæ˜¯ç›´æ¥æ‹·è´åˆ° NIC bufferã€‚\nå›¾ä¸Šçš„æ­¥éª¤ 2ï¼šAppends just file descriptorsï¼Œåªæ˜¯æŠŠæ–‡ä»¶æè¿°ç¬¦äº¤ç»™äº† Socket bufferï¼Œå®é™…æ•°æ®å¹¶æ²¡æœ‰æ‹·è´ç»™ Socket bufferã€‚\nè¿™å°±æ˜¯æ‰€è°“çš„ scatter-gather æ“ä½œï¼ˆä¹Ÿç§°ä¸º Vectorized I/Oï¼‰ï¼Œscatter-gather æ˜¯ä»…å°† read buffer æ•°æ®æŒ‡é’ˆå­˜å‚¨åœ¨ socket buffer ä¸­ï¼Œå¹¶è®© DMA ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®çš„è¡Œä¸ºã€‚\næœ€ç»ˆï¼š\n4 æ¬¡æ¨¡å¼åˆ‡æ¢å˜æˆäº† 2 æ¬¡ 2 æ¬¡ DMA æ‹·è´ï¼Œä»ç„¶æ˜¯ 2 æ¬¡ 1 æ¬¡å¾®å°çš„æŒ‡é’ˆæ‹·è´ é›¶æ‹·è´æŠ€æœ¯ ä¸ Kafka ä½ å¯èƒ½å¬è¿‡ Kafka å› ä¸ºé›¶æ‹·è´å®ç°äº†é«˜æ€§èƒ½ï¼Œä½†æ˜¯ç†æƒ³å¾ˆä¸°æ»¡ç°å®å¾ˆéª¨æ„Ÿï¼Œé›¶æ‹·è´æŠ€æœ¯åœ¨å¤§éƒ¨åˆ† Kafka é›†ç¾¤ä¸­å¹¶æ²¡æœ‰é‚£ä¹ˆå¤§çš„å½±å“åŠ›ã€‚\nCPU å¾ˆå°‘æˆä¸ºç“¶é¢ˆã€‚ç½‘ç»œé¥±å’Œçš„é€Ÿåº¦è¦å¿«å¾—å¤šï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸­å‰¯æœ¬çš„ç¼ºå¤±å¹¶ä¸ä¼šå¸¦æ¥å¤šå¤§çš„å½±å“ã€‚ å¯ç”¨åŠ å¯†å’Œ SSL/TLS å°†ç¦æ­¢ Kafka ä½¿ç”¨é›¶æ‹·è´ å‚è€ƒèµ„æ–™ https://mp.weixin.qq.com/s/XnfvZNBvamgu32PEEBhk4g https://blog.2minutestreaming.com/p/apache-kafka-zero-copy-operating-system-optimization ","permalink":"/tech/kafka-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF/","summary":"\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ é›¶æ‹·è´æ“ä½œå¯ä»¥é¿å…å¯¹æ•°æ®çš„éå¿…è¦æ‹·è´ï¼Œå½“ç„¶ï¼Œå¹¶éæ˜¯è¯´å®Œå…¨æ²¡æœ‰æ‹·è´ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eåœ¨ Kafka çš„åœºæ™¯ä¸‹ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ä» page cache æ‹·è´æ•°æ®åˆ° socket bufferï¼Œç›´æ¥ç»•è¿‡ Kafka broker è¿™ä¸ª Java ç¨‹åºã€‚è¿™å¯ä»¥èŠ‚çœä¸€äº›é¢å¤–çš„æ‹·è´ï¼ŒèŠ‚çœä¸€äº›ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ã€‚\u003c/p\u003e","title":"Kafka é›¶æ‹·è´æŠ€æœ¯"},{"content":"charles æŠ“åŒ…å·¥å…·åŸºäº HTTP è¯·æ±‚ä¸­é—´äººä»£ç†ï¼Œé€šè¿‡å’ŒæœåŠ¡ç«¯ã€å®¢æˆ·ç«¯å»ºç«‹é€šä¿¡å°†å®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®å‘é€æœåŠ¡å™¨ï¼Œå¹¶å°†å“åº”æ•°æ®ä¼ è¾“ç»™å®¢æˆ·ç«¯ï¼Œå®ç°æŠ“åŒ…è®°å½•ã€‚\nä»£ç†é…ç½® ã€ŒProxyã€-\u0026gt;ã€ŒProxy Settingsã€ é…ç½®ç›‘å¬ç«¯å£å·ï¼Œä¾‹å¦‚ 9999ï¼Œå¹¶å‹¾é€‰ ã€ŒEnable transparent HTTP proxyingã€\nã€ŒProxyã€-\u0026gt;ã€ŒSSL Proxying Settingsã€-\u0026gt;ã€ŒSSL Proxyingã€ å‹¾é€‰ ã€ŒEnable SSL Proxyingã€ï¼Œå¹¶æ·»åŠ  *:443\næœ¬åœ°è¯ä¹¦å®‰è£… ã€ŒHelpã€-\u0026gt;ã€ŒSSL Proxyingã€-\u0026gt;ã€ŒInsatall Charles Root Certificateã€\næ ¹æ®æç¤ºå®‰è£…è¯ä¹¦ï¼Œæ³¨æ„ï¼Œéœ€è¦å°†è¯ä¹¦å­˜å‚¨è‡³ã€Œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ã€ ã€‚\næ‰‹æœºé…ç½®ä»£ç†åœ°å€ åœ¨ Charles ä¸Šç‚¹å‡» ã€ŒHelpã€-\u0026gt;ã€ŒSSL Proxyingã€-\u0026gt;ã€ŒInstall Charles Root on a Mobile Device or Remote Browserã€\nå¯ä»¥è·å–ç”µè„‘ IP åœ°å€å’Œ Charles ç›‘å¬ç«¯å£ã€‚\nåœ¨æ‰‹æœºä¸ç”µè„‘è¿æ¥åŒä¸€ä¸ª Wifi åï¼Œåœ¨ Wifi é…ç½®æ·»åŠ ä»£ç†é…ç½®ï¼Œå¡«å†™åˆšåˆšè·å–çš„ä»£ç†åœ°å€ã€‚\næ­¤æ—¶ï¼Œç”µè„‘ä¼šè·³å‡ºæ˜¯å¦å…è®¸ä»£ç†çš„æç¤ºï¼Œç‚¹å‡» Allow å³å¯ã€‚\næ‰‹æœºè¯ä¹¦å®‰è£… æœ‰ä¸¤ç§æ–¹å¼\næ‰‹æœºè®¿é—® chls.pro/ssl ï¼Œç„¶åä¸‹è½½è¯ä¹¦ã€‚ ç”µè„‘ç«¯ ã€ŒHelpã€-\u0026gt;ã€ŒSSL Proxyingã€-\u0026gt;ã€ŒSave Charles Root Certificate\u0026hellip;ã€ï¼Œç„¶åå‘é€åˆ°æ‰‹æœºä¸Šç›´æ¥å®‰è£…ã€‚ æŠ“åŒ…éªŒè¯ ä»¥ä¸Šæ­¥éª¤é…ç½®å®Œæ¯•åï¼Œåœ¨æ‰‹æœºä¸Šç‚¹å‡»åº”ç”¨ï¼Œå³å¯åœ¨ Charles ä¸ŠæŸ¥çœ‹å¯¹åº”è¯·æ±‚ã€‚\nå‚è€ƒèµ„æ–™ https://blog.csdn.net/qq_45564088/article/details/121864553 https://blog.usword.cn/frontend/debug-skill/charles.html#%E6%8A%93%E5%8C%85%E8%AF%A6%E6%83%85 ","permalink":"/tech/tools/charles-%E5%AE%89%E5%8D%93%E6%8A%93%E5%8C%85%E9%85%8D%E7%BD%AE/","summary":"\u003cp\u003e\u003ca href=\"https://www.charlesproxy.com/\"\u003echarles\u003c/a\u003e æŠ“åŒ…å·¥å…·åŸºäº HTTP è¯·æ±‚ä¸­é—´äººä»£ç†ï¼Œé€šè¿‡å’ŒæœåŠ¡ç«¯ã€å®¢æˆ·ç«¯å»ºç«‹é€šä¿¡å°†å®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®å‘é€æœåŠ¡å™¨ï¼Œå¹¶å°†å“åº”æ•°æ®ä¼ è¾“ç»™å®¢æˆ·ç«¯ï¼Œå®ç°æŠ“åŒ…è®°å½•ã€‚\u003c/p\u003e\n\u003ch1 id=\"ä»£ç†é…ç½®\"\u003eä»£ç†é…ç½®\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003eã€ŒProxyã€-\u0026gt;ã€ŒProxy Settingsã€\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eé…ç½®ç›‘å¬ç«¯å£å·ï¼Œä¾‹å¦‚ 9999ï¼Œå¹¶å‹¾é€‰ ã€ŒEnable transparent HTTP proxyingã€\u003c/p\u003e","title":"Charles å®‰å“æŠ“åŒ…é…ç½®"},{"content":"æ¶æ„è®¾è®¡ OS: AlmaLinux 9.1\nèŠ‚ç‚¹å IP åœ°å€ zqf-Master01 10.101.5.110 zqf-Master02 10.101.5.111 zqf-Master03 10.101.5.112 zqf-Worker01 10.101.5.113 zqf-Worker02 10.101.5.114 zqf-Worker03 10.101.5.115 zqf-Worker04 10.101.5.116 1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ 1.1 åŸºç¡€é…ç½® 1.1.1 é…ç½®é•œåƒæº 1sed -e \u0026#39;s|^mirrorlist=|#mirrorlist=|g\u0026#39; \\ 2 -e \u0026#39;s|^#\\s*baseurl=https://repo.almalinux.org/almalinux|baseurl=https://mirrors.zju.edu.cn/almalinux|g\u0026#39; \\ 3 -i.bak \\ 4 /etc/yum.repos.d/almalinux-*.repo 1dnf makecache 1.1.2 é…ç½®ä¸»æœºå 1hostnamectlÂ set-hostname \u0026lt;ä¸»æœºå\u0026gt; æ·»åŠ è§£æè®°å½•ï¼Œä½¿èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ä¸»æœºåè®¿é—®é€šä¿¡\n1cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/hosts 210.101.5.110 zqf-Master01 310.101.5.111 zqf-Master02 410.101.5.112 zqf-Master03 510.101.5.113 zqf-Worker01 610.101.5.114 zqf-Worker02 710.101.5.115 zqf-Worker03 810.101.5.116 zqf-Worker04 9EOF 1.1.3 å…å¯†ç™»å½•é…ç½®ï¼ˆæ–°å¢/å¯é€‰ï¼‰ 1ssh-keygen -t rsa -b 2048 1ssh-copy-idÂ root@ç›®æ ‡èŠ‚ç‚¹IP 1.1.4 ç¦ç”¨é˜²ç«å¢™ 1systemctl stop firewalld \u0026amp;\u0026amp; systemctl disable firewalld 2systemctl disable --now dnsmasq 1.1.5 ç¦ç”¨ SELINUX ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä½¿ SELINUX=disabled æ³¨æ„ï¼Œæ˜¯ disabled ï¼Œä¸æ˜¯ disable\n1vim /etc/selinux/config æˆ–è€…ï¼Œç›´æ¥æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ 1sed -i \u0026#39;s#SELINUX=enforcing#SELINUX=disabled#g\u0026#39; /etc/sysconfig/selinux 2sed -i \u0026#39;s#SELINUX=enforcing#SELINUX=disabled#g\u0026#39; /etc/selinux/config æŸ¥çœ‹ç³»ç»Ÿ SELinux è¿è¡ŒçŠ¶æ€ 1sestatus 1.1.6 ç¦ç”¨ Swap åˆ†åŒº Swap æ˜¯äº¤æ¢åˆ†åŒºï¼Œå¦‚æœæœºå™¨å†…å­˜ä¸å¤Ÿï¼Œä¼šä½¿ç”¨swapåˆ†åŒºã€‚\nä½†æ˜¯ï¼Œswapåˆ†åŒºæ€§èƒ½è¾ƒä½ï¼Œk8s é»˜è®¤ä¸å…è®¸ä½¿ç”¨äº¤æ¢åˆ†åŒºã€‚\nkubeadm åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ£€æµ‹ swap çŠ¶æ€ï¼Œæœªå…³é—­ swap ä¼šå¯¼è‡´åˆå§‹åŒ–å¤±è´¥ã€‚\n1swapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0 2sed -ri \u0026#39;/^[^#]*swap/s@^@#@\u0026#39; /etc/fstab è‹¥ swap ä¸º 0ï¼Œ è¯´æ˜ swap å…³é—­æˆåŠŸ\n1free -mh 1.1.7 æ—¶é—´åŒæ­¥ï¼ˆæ–°å¢ï¼‰ æ‰€æœ‰èŠ‚ç‚¹å®‰è£… chrony 1dnf -y install chrony æŒ‘ä¸€ä¸ªèŠ‚ç‚¹ (10.101.5.110) ä¿®æ”¹é…ç½® 1# é…ç½®chronyæœåŠ¡ 2vimÂ /etc/chrony.conf 3 4# æŒ‡å®šä½¿ç”¨çš„ä¸Šæ¸¸æ—¶é—´æœåŠ¡å™¨åœ°å€ 5poolÂ ntp.aliyun.comÂ iburst 6 7# å…è®¸è®¿é—®çš„æœåŠ¡å™¨ 8allowÂ 192.168.10.0/24 å…¶ä»–èŠ‚ç‚¹ä¿®æ”¹ä¸Šæ¸¸æœåŠ¡å™¨å³å¯ 1# é…ç½®chronyæœåŠ¡ 2vimÂ /etc/chrony.conf 3 4# æŒ‡å®š 10.101.5.110 ä¸ºä¸Šæ¸¸æœåŠ¡å™¨ 5pool 10.101.5.110 iburst å¯ç”¨æœåŠ¡ 1systemctl restart chronyd 2systemctl enable chronyd 5. æŸ¥çœ‹åŒæ­¥çŠ¶æ€\n1chronycÂ sources 1.1.8 é…ç½®ç³»ç»Ÿèµ„æºé™åˆ¶ 1vim /etc/security/limits.conf æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ŒåŒ…æ‹¬æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡ã€æœ€å¤§è¿›ç¨‹æ•°é‡å’Œå†…å­˜é”å®šé™åˆ¶\n1* soft nofile 65536 2* hard nofile 131072 3* soft nproc 65535 4* hard nproc 655350 5* soft memlock unlimited 6* hard memlock unlimited 1.1.9 é…ç½®å†…æ ¸å‚æ•° 1sysctl net.core.bpf_jit_limit=452534528 é…ç½® K8S æ‰€éœ€å†…æ ¸å‚æ•°ã€‚\n1cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysctl.d/k8s.conf 2net.ipv4.ip_forward = 1 3net.bridge.bridge-nf-call-iptables = 1 4net.bridge.bridge-nf-call-ip6tables = 1 5fs.may_detach_mounts = 1 6vm.overcommit_memory=1 7vm.panic_on_oom=0 8fs.inotify.max_user_watches=89100 9fs.file-max=52706963 10fs.nr_open=52706963 11net.netfilter.nf_conntrack_max=2310720 12net.ipv4.tcp_keepalive_time = 600 13net.ipv4.tcp_keepalive_probes = 3 14net.ipv4.tcp_keepalive_intvl =15 15net.ipv4.tcp_max_tw_buckets = 36000 16net.ipv4.tcp_tw_reuse = 1 17net.ipv4.tcp_max_orphans = 327680 18net.ipv4.tcp_orphan_retries = 3 19net.ipv4.tcp_syncookies = 1 20net.ipv4.tcp_max_syn_backlog = 16384 21net.ipv4.ip_conntrack_max = 65536 22net.ipv4.tcp_max_syn_backlog = 16384 23net.ipv4.tcp_timestamps = 0 24net.core.somaxconn = 16384 25vm.swappiness=0 26EOF å…¶ä¸­ï¼Œ\n1net.ipv4.ip_forward = 1 2net.bridge.bridge-nf-call-iptables = 1 3net.bridge.bridge-nf-call-ip6tables = 1 ä¹Ÿæ˜¯ Containerd CRI æ‰€éœ€çš„å†…æ ¸å‚æ•°ã€‚\nåŠ è½½ä¸Šè¿°å†…æ ¸å‚æ•°ç”Ÿæ•ˆæ‰€éœ€è¦çš„æ¨¡å—ï¼Œå¹¶åŠ è½½ç”Ÿæ•ˆ\n1modprobe --Â overlay 2modprobeÂ -- br_netfilter 3sysctl --system 1.3 é…ç½® IPVS K8S é›†ç¾¤å°†ä½¿ç”¨ ipvs æ¨¡å¼ï¼Œå› æ­¤è¿™é‡Œäº‹å…ˆå®‰è£… ipvs ç›¸å…³ç»„ä»¶ã€‚\nå®‰è£… ipvs ç›¸å…³è½¯ä»¶åŒ… 1dnf install -y ipvsadm ipset sysstat conntrack libseccomp è½½å…¥æ¨¡å— 1modprobe -- ip_vs 2modprobe -- ip_vs_rr 3modprobe -- ip_vs_wrr 4modprobe -- ip_vs_sh 5modprobe -- nf_conntrack åˆ›å»ºipvs.confï¼Œè®¾ç½®å†…æ ¸æ¨¡å—çš„è‡ªåŠ¨è½½å…¥ 1cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/modules-load.d/ipvs.conf 2ip_vs 3ip_vs_lc 4ip_vs_wlc 5ip_vs_rr 6ip_vs_wrr 7ip_vs_lblc 8ip_vs_lblcr 9ip_vs_dh 10ip_vs_sh 11ip_vs_fo 12ip_vs_nq 13ip_vs_sed 14ip_vs_ftp 15ip_vs_sh 16nf_conntrack 17ip_tables 18ip_set 19xt_set 20ipt_set 21ipt_rpfilter 22ipt_REJECT 23ipip 24EOF 1systemctl enable --now systemd-modules-load.service 1.4 å®‰è£… Containerd å®‰è£… Containerd 1dnf install containerd -y 1ctr -v 2ctr containerd.io 1.7.18 ç”Ÿæˆ containerd é…ç½®æ–‡ä»¶ 1mkdir -p /etc/containerd 2containerd config default | sudo tee /etc/containerd/config.toml ä¿®æ”¹ Containerd ä½¿ç”¨çš„ cgroup ä¸º systemdÂ cgroupÂ driver 1[plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.containerd.runtimes.runc] 2Â ... 3Â [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.containerd.runtimes.runc.options] 4Â SystemdCgroupÂ =Â true ä¿®æ”¹ Containerd ä½¿ç”¨çš„ sandbox_image ä¿®æ”¹ sandbox çš„é•œåƒåœ°å€\n1sandbox_imageÂ =Â \u0026#34;registry.aliyuncs.com/google_containers/pause:3.9\u0026#34; é…ç½® Containerd ç§æœåœ°å€è·³è¿‡ https éªŒè¯ 1[plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.registry.configs] 2 [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.registry.configs.\u0026#34;10.101.7.108\u0026#34;.tls] 3 insecure_skip_verify = true 4 [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.registry.configs.\u0026#34;szharbor.hithium.cn\u0026#34;.tls] 5 insecure_skip_verify = true 6 7[plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.registry.configs.\u0026#34;docker.io\u0026#34;.tls] 8 insecure_skip_verify = true é…ç½® docker.io é•œåƒ 1 [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.registry.mirrors] 2 [plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.registry.mirrors.\u0026#34;docker.io\u0026#34;] 3 endpoint = [\u0026#34;https://docker.1panel.live\u0026#34;][plugins.\u0026#34;io.containerd.grpc.v1.cri\u0026#34;.registry.mirrors.\u0026#34;10.101.7.108:80\u0026#34;] 4 endpoint = [\u0026#34;http://10.101.7.108\u0026#34;] ä½¿é…ç½®ç”Ÿæ•ˆ 1systemctl daemon-reload 2systemctl restart containerd.service 3systemctl enable containerd.service 1.5 å®‰è£… K8S ç›¸å…³ç»„ä»¶ https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/\n1cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/yum.repos.d/kubernetes.repo 2[kubernetes] 3name=Kubernetes 4baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/ 5enabled=1 6gpgcheck=1 7gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/repodata/repomd.xml.key 8EOF 1dnf -y install kubectl kubelet kubeadm 2. ä¸»èŠ‚ç‚¹é…ç½® 2.1 é«˜å¯ç”¨é…ç½® 2.1.1 å®‰è£…ç›¸å…³ç»„ä»¶ å®‰è£…keepalived, haproxy\n1dnf -y install keepalived haproxy 2.1.2 é…ç½®æ£€æµ‹è„šæœ¬æ–‡ä»¶ è¯¥è„šæœ¬æ£€æµ‹æœ¬åœ° 8443 ç«¯å£(haproxyæœåŠ¡)æ˜¯å¦æ­£å¸¸ï¼Œè‹¥ä¸æ­£å¸¸ï¼Œåˆ™åœæ­¢æœ¬åœ°çš„ Keepalived æœåŠ¡ï¼ŒVIPé£˜é€¸åˆ°å…¶å®ƒ haproxy å¯ç”¨çš„èŠ‚ç‚¹ï¼Œç»§ç»­æä¾›æœåŠ¡ã€‚\n1vimÂ /etc/keepalived/check_apiserver.sh 1#!/bin/sh 2curlÂ -sfkÂ --max-timeÂ 2Â https://localhost:8443/healthzÂ -oÂ /dev/null 3ifÂ [Â $?Â -nqÂ 0] 4then 5Â echoÂ \u0026#34;***Â ErrorÂ GETÂ https://localhost:8443/healthz\u0026#34;Â 1\u0026gt;\u0026amp;2 6Â systemctlÂ stopÂ keepalived 7fi ç»™è„šæœ¬æ–‡ä»¶æ‰§è¡Œæƒé™\n1chmodÂ +xÂ /etc/keepalived/check_apiserver.sh 2.1.3 é…ç½® keepalived.conf VIP è®°å¾—ä½¿ç”¨èŠ‚ç‚¹æ‰€åœ¨ç½‘æ®µï¼Œä½†ä¸ä½¿ç”¨çš„ IP åœ°å€\n1vim /etc/keepalived/keepalived.conf 1! Configuration File for keepalived 2global_defs { 3 router_id LVS_DEVEL 4} 5 6# æŒ‡å®šæ£€æµ‹è„šæœ¬: 7# script: è„šæœ¬è·¯å¾„; 8# interval: è„šæœ¬æ‰§è¡Œæ—¶é—´; 9# weight: æƒé‡; 10# fall: è¿ç»­æ£€æµ‹å¤±è´¥å¤šå°‘æ¬¡ä¹‹åè®¤å®šèŠ‚ç‚¹ä¸å¯ç”¨; 11# rise: è¿ç»­æ£€æµ‹æˆåŠŸå¤šå°‘æ¬¡è®¤ä¸ºèŠ‚ç‚¹æ¢å¤æ­£å¸¸ã€‚ 12vrrp_script check_apiserver { 13 script \u0026#34;/etc/keepalived/check_apiserver.sh\u0026#34; 14 interval 3 15 weight -2 16 fall 10 17 rise 2 18} 19 20# state: æŒ‡å®šMASTERèº«ä»½, å¦å¤–ä¸¤å°Keepalivedè®¾ç½®æˆBACKUP 21# interface: æŒ‡å®šç½‘å¡; 22# virtual_router_id: VRRPè™šæ‹Ÿè·¯ç”±id, åŒä¸€é›†ç¾¤çš„KeepalivedèŠ‚ç‚¹è¦ç›¸åŒ, ç”¨æ¥è¯†åˆ«å½¼æ­¤ 23# priority: ä¼˜å…ˆçº§, å¦å¤–ä¸¤å°Keepalivedåˆ†åˆ«è®¾ç½®æˆ90 70 24# auth_type: VRRPç»„èŠ‚ç‚¹ä¹‹é—´è®¤è¯æ–¹å¼ä¸ºPASSé“­æ–‡ 25# auth_pass: VRRPç»„èŠ‚ç‚¹ä¹‹é—´ç”¨æ¥è®¤è¯é€šä¿¡çš„å¯†ç  26# virtual_ipaddress: VIP 27# track_script: æŒ‡å®šä½¿ç”¨çš„æ£€æµ‹è„šæœ¬åç§° 28 29vrrp_instance VI_1 { 30 state MASTER 31 interface ens192 32 virtual_router_id 51 33 priority 100 34 authentication { 35 auth_type PASS 36 auth_pass 1111 37 } 38 virtual_ipaddress { 39 10.101.5.2 40 } 41 track_script { 42 check_apiserver 43 } 44} 2.1.4 é…ç½® haproxy.cfg 1vimÂ /etc/haproxy/haproxy.cfg 1#--------------------------------------------------------------------- 2#Â GlobalÂ settings 3#--------------------------------------------------------------------- 4global 5 log\tstdout\tformat\traw\tlocal0 6 chroot\t/var/lib/haproxy 7 pidfile\t/var/run/haproxy.pid 8 maxconn\t4000 9 user\thaproxy 10 group\thaproxy 11 12 13#--------------------------------------------------------------------- 14#Â commonÂ defaultsÂ thatÂ allÂ theÂ \u0026#39;listen\u0026#39;Â andÂ \u0026#39;backend\u0026#39;Â sectionsÂ will 15#Â useÂ ifÂ notÂ designatedÂ inÂ theirÂ block 16#--------------------------------------------------------------------- 17defaults 18 log\tglobal 19 option\thttplog 20 option\tdontlognull 21 timeout\tconnect\t5s 22 timeout\tclient\t35s 23 timeout\tserver\t35s 24 25 26#--------------------------------------------------------------------- 27#Â apiserverÂ frontendÂ whichÂ proxysÂ toÂ theÂ controlÂ planeÂ nodes 28#--------------------------------------------------------------------- 29#Â ä¸»è¦æ˜¯è¿™é‡Œçš„bind:Â å®šä¹‰haproxyçš„ä»£ç†ç«¯å£ä¸º8443ã€‚ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒã€‚ 30frontend\tapiserver 31\tbind\t*:8443 32\tmode\ttcp 33\toption\ttcplog 34\tdefault_backend\tapiserverbackend 35 36 37#--------------------------------------------------------------------- 38#Â roundÂ robinÂ balancingÂ forÂ apiserver 39#--------------------------------------------------------------------- 40#Â ä»¥ä¸‹æ˜¯åç«¯ç›¸å…³é…ç½®,Â å…³é”®å‚æ•°è§£é‡Šå¦‚ä¸‹ 41#Â modeÂ tcp:Â è®¾ç½®ä¸åç«¯æœåŠ¡é€šä¿¡çš„æ¨¡å¼ä¸ºTCP 42#Â balanceÂ roundrobin:Â è½®è¯¢æ–¹å¼ 43#Â inter 10s:Â æ£€æŸ¥é—´éš”ä¸º10ç§’ã€‚ 44#Â downinter 5s:Â å½“æœåŠ¡è¢«æ ‡è®°ä¸ºä¸å¯ç”¨åï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æ¢å¤ã€‚ 45#Â rise 2:Â åœ¨å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸Šçº¿ä¹‹å‰ï¼ŒæœåŠ¡å™¨å¿…é¡»è¿ç»­2æ¬¡æˆåŠŸå“åº”æ£€æŸ¥ã€‚ 46#Â fall 2:Â åœ¨å°†æœåŠ¡å™¨æ ‡è®°ä¸ºä¸‹çº¿ä¹‹å‰ï¼ŒæœåŠ¡å™¨å¿…é¡»è¿ç»­2æ¬¡å¤±è´¥å“åº”æ£€æŸ¥ã€‚ 47#Â slowstart 60s:Â æ…¢å¯åŠ¨æ—¶é—´ä¸º60ç§’ï¼Œç”¨äºæ§åˆ¶æ–°æœåŠ¡å™¨ä¸Šçº¿åé€æ¸å¢åŠ å…¶æƒé‡ã€‚ 48#Â maxconn 250:Â æ¯ä¸ªæœåŠ¡å™¨çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°ä¸º250ã€‚ 49#Â maxqueue 256:Â åç«¯é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ä¸º256ã€‚ 50#Â weight 100:Â æœåŠ¡å™¨çš„é»˜è®¤æƒé‡ä¸º100ã€‚ 51#Â server å®šä¹‰åç«¯çš„æœåŠ¡å™¨åˆ—è¡¨ã€‚ 52 53 54backend\tapiserverbackend 55\toption\ttcplog 56\toption\ttcp-check 57\tmode\ttcp 58\tbalance\troundrobin 59\tdefault-server interÂ 10sÂ downinterÂ 5sÂ riseÂ 2Â fallÂ 2Â slowstartÂ 60sÂ maxconnÂ 250Â maxqueueÂ 256Â weightÂ 100 60\tserver\tzqf-Master01\t10.101.5.110:6443\tcheck 61\tserver\tzqf-Master02\t10.101.5.111:6443\tcheck 62\tserver\tzqf-Master03\t10.101.5.112:6443\tcheck 2.1.5 å¯åŠ¨æœåŠ¡å¹¶éªŒè¯ å¯åŠ¨æœåŠ¡ 1systemctlÂ enableÂ --nowÂ keepalived 2systemctlÂ enableÂ --nowÂ haproxy éªŒè¯ åœæ­¢ master01 ä¸Šçš„ keepalived æœåŠ¡åï¼Œ è™šæ‹Ÿ IP 192.168.10.240/32 ä¼šç§»åŠ¨åˆ° moster02ã€‚ æ¢å¤ master01 ä¸Šçš„ keepalived æœåŠ¡åï¼Œ è™šæ‹Ÿ IP 192.168.10.240/32 ä¼šç§»åŠ¨å› moster01ã€‚\n1[root@zqf-Master01 ~]# ip a | grep ens 22: ens192: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc mq state UP group default qlen 1000 3 inet 10.101.5.110/24 brd 10.101.5.255 scope global noprefixroute ens192 4 inet 192.168.10.240/32 scope global ens192 5 6[root@zqf-Master02 keepalived]# ip a | grep ens 72: ens192: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc mq state UP group default qlen 1000 8 inet 10.101.5.111/24 brd 10.101.5.255 scope global noprefixroute ens192 2.2 åŸºäº kubeadm å®‰è£…é›†ç¾¤ 2.2.1 æå‰æ‹‰å–é•œåƒ 1kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers 2.2.2 ä¿®æ”¹ kubeadm é…ç½®æ–‡ä»¶ 1kubeadmÂ configÂ printÂ init-defaultsÂ \u0026gt;Â kubeadm-init.yaml é…ç½®é¡¹ æè¿° advertiseAddress æŒ‡å®šæœ¬æœºåœ°å€ name æŒ‡å®šæœ¬æœºçš„ä¸»æœºå controlPlaneEndpoint æŒ‡å®šæ§åˆ¶é¢çš„é€šä¿¡åœ°å€ï¼Œè¿™é‡Œå†™ VIP åœ°å€ imageRepository æŒ‡å®šä¸‹è½½ Kubernetes ç»„ä»¶çš„é•œåƒä»“åº“åœ°å€, é»˜è®¤è®¿é—®å›½å¤–çš„ä»“åº“, è¿™é‡Œéœ€è¦ä¿®æ”¹ä¸ºå›½å†…çš„é•œåƒä»“åº“æº kubernetesVersion æŒ‡å®šå®‰è£…çš„ kubernetes ç‰ˆæœ¬ serviceSubnet æŒ‡å®š Kubernetes çš„ Service èµ„æºåˆ†é…çš„ç½‘æ®µ, ç½‘æ®µä¸èƒ½ä¸çœŸå®æœºå’Œ Pod çš„ç½‘æ®µå†²çªã€‚ podSubnet æŒ‡å®š Kubernetes çš„ Pod èµ„æºåˆ†é…çš„ç½‘æ®µ, ç½‘æ®µä¸èƒ½ä¸çœŸå®æœºå’Œ Service çš„ç½‘æ®µå†²çªã€‚ éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†åŒ…æ‹¬ï¼š\nlocalAPIEndpoint.advertiseAddressï¼šä¸»èŠ‚ç‚¹ IP åœ°å€ nodeRegistration.nameï¼šä¸»èŠ‚ç‚¹ hostname imageRepositoryï¼šé•œåƒä»“åº“åœ°å€ networking.podSubnet: pod å­ç½‘èŒƒå›´ 1apiVersion: kubeadm.k8s.io/v1beta3 2bootstrapTokens: 3- groups: 4 - system:bootstrappers:kubeadm:default-node-token 5 token: abcdef.0123456789abcdef 6 ttl: 24h0m0s 7 usages: 8 - signing 9 - authentication 10kind: InitConfiguration 11localAPIEndpoint: 12 advertiseAddress: 10.101.5.110 13 bindPort: 6443 14nodeRegistration: 15 criSocket: unix:///var/run/containerd/containerd.sock 16 imagePullPolicy: IfNotPresent 17 name: zqf-Master01 18 taints: null 19--- 20apiServer: 21 timeoutForControlPlane: 4m0s 22apiVersion: kubeadm.k8s.io/v1beta3 23certificatesDir: /etc/kubernetes/pki 24clusterName: kubernetes 25controllerManager: {} 26dns: {} 27controlPlaneEndpoint: \u0026#34;10.101.5.2:8443\u0026#34; 28etcd: 29 local: 30 dataDir: /var/lib/etcd 31imageRepository: registry.aliyuncs.com/google_containers 32kind: ClusterConfiguration 33kubernetesVersion: 1.29.6 34networking: 35 dnsDomain: cluster.local 36 serviceSubnet: 10.96.0.0/12 37 podSubnet: 192.168.0.0/16 38scheduler: {} 39 40# è¡¥å…… 41--- 42apiVersion: kubeproxy.config.k8s.io/v1alpha1 43kind: KubeProxyConfiguration 44mode: ipvs 45--- 46apiVersion: kubelet.config.k8s.io/v1beta1 47kind: KubeletConfiguration 48cgroupDriver: systemd 2.2.3 åˆå§‹åŒ– K8S é›†ç¾¤ 1kubeadm init --config=kubeadm-init.yaml --upload-certs å…¶ä¸­ï¼Œ --upload-certs ä¼šè‡ªåŠ¨å°†è¯ä¹¦ä»ä¸»æ§åˆ¶å¹³é¢èŠ‚ç‚¹å¤åˆ¶åˆ°å°†è¦åŠ å…¥çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šã€‚\nç„¶åï¼Œæ ¹æ®æç¤ºå°†å„ä¸ªèŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚\n1# æ·»åŠ masterèŠ‚ç‚¹çš„å‘½ä»¤ 2kubeadm token create --print-join-command --certificate-key 3 4# æ·»åŠ workerèŠ‚ç‚¹çš„å‘½ä»¤è·å–æ–¹å¼ 5kubeadm token create --print-join-command kubeadm token create \u0026ndash;print-join-command \u0026ndash;ttl 0\n2.2.4 é…ç½® kubectl 1mkdir -p $HOME/.kube 2sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config 3sudo chown $(id -u):$(id -g) $HOME/.kube/config 4# å°†ä»¥ä¸‹å‘½ä»¤åŠ åˆ°.bashrc 5export KUBECONFIG=/etc/kubernetes/admin.conf å…¶ä¸­ï¼Œadmin.conf æ˜¯è¿æ¥ Kubernetes çš„è®¤è¯æ–‡ä»¶ï¼Œé€šè¿‡æ­¤æ–‡ä»¶æ‰èƒ½è¿æ¥åˆ° kubernetesï¼Œkubectl ä¹Ÿéœ€è¦è¿™ä¸ªæ–‡ä»¶ï¼›åœ¨ Linux ä¸­ï¼Œä½¿ç”¨ KUBECONFIG ç¯å¢ƒå˜é‡çŸ¥é“è®¤è¯æ–‡ä»¶çš„æ‰€åœ¨ã€‚\nLinux ä¸­æ¯ä¸ªç”¨æˆ·çš„ç¯å¢ƒå˜é‡æ˜¯ä¸åŒçš„ï¼Œå¦‚æœåˆ‡æ¢äº†ç”¨æˆ·ï¼Œåˆ™ä¹Ÿéœ€è¦è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡ï¼›å¦‚æœè¦åœ¨åˆ«çš„èŠ‚ç‚¹ä¸Šè¿æ¥é›†ç¾¤ï¼Œåˆ™å¯ä»¥æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶è¿‡å»ã€‚\næ­¤æ—¶ï¼Œåœ¨ master01 ä¸Šæ‰§è¡Œ kubectl get no åº”æœ‰\n1[root@zqf-Master01 ~]# kubectl get no 2NAME STATUS ROLES AGE VERSION 3zqf-master01 NotReady control-plane 2m23s v1.29.6 4zqf-master02 NotReady control-plane 101s v1.29.6 5zqf-master03 NotReady control-plane 101s v1.29.6 6zqf-worker01 NotReady \u0026lt;none\u0026gt; 67s v1.29.6 7zqf-worker02 NotReady \u0026lt;none\u0026gt; 65s v1.29.6 8zqf-worker03 NotReady \u0026lt;none\u0026gt; 63s v1.29.6 9zqf-worker04 NotReady \u0026lt;none\u0026gt; 60s v1.29.6 2.3 å®‰è£… Calico Calico3.28 ç‰ˆæœ¬æ”¯æŒ: Kubernetesv1.27-v1.30ã€‚\nCalico çš„å®‰è£…æ–¹å¼ç›®å‰æœ‰ä¸¤ç§ï¼š\nåŸºäº Operator æ–¹å¼å®‰è£…ï¼Œèƒ½å¤Ÿç®¡ç† Calico é›†ç¾¤çš„å®‰è£…ï¼Œå‡çº§ï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ï¼Œä½†ä¸æ–¹ä¾¿ç®¡ç†é•œåƒåœ°å€ã€‚ï¼ˆä¼˜å…ˆï¼‰ åŸºäºé™æ€èµ„æºæ¸…å•å®‰è£…ï¼Œæ–¹ä¾¿ï¼Œç®€å•ï¼Œä½†æ— æ³•åƒ Opertaor ä¸€æ ·èƒ½å¤Ÿè‡ªåŠ¨ç®¡ç† Calico çš„ç”Ÿå‘½å‘¨æœŸã€‚ åŸºäºé™æ€èµ„æºæ¸…å•çš„éƒ¨ç½²å¸¸è§çš„ä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼š\ncalico.yamlï¼šå½“ Calico ä½¿ç”¨ Kubernetes API ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œä¸”é›†ç¾¤èŠ‚ç‚¹å°‘äº 50 ä¸ªã€‚ calico-typha.yaml: å½“ Calico ä½¿ç”¨ Kubernetes API ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œä¸”é›†ç¾¤èŠ‚ç‚¹å¤§äº 50 ä¸ªã€‚ https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml\nreplicas:Â å‰¯æœ¬æ•° , å»ºè®®æ¯200ä¸ªèŠ‚ç‚¹1ä¸ªå‰¯æœ¬, ç”Ÿäº§çš„è¯å»ºè®®3ä¸ªå‰¯æœ¬ã€‚\nå…¶ä¸­ï¼Œé•œåƒæ¨èæå‰æ‹‰å–åˆ°ç§æœï¼Œç„¶åä¿®æ”¹ imageurl\nå®‰è£…æˆåŠŸåï¼Œå¦‚ä¸‹æ‰€ç¤º\n1[root@zqf-Master01 ~]# kubectl get po -n kube-system 2NAME READY STATUS RESTARTS AGE 3calico-kube-controllers-7884dfffd6-pdj8v 1/1 Running 0 61s 4calico-node-7q2dp 1/1 Running 0 46s 5calico-node-gdtc4 1/1 Running 0 46s 6calico-node-hndr8 1/1 Running 0 46s 7calico-node-jd9zm 1/1 Running 0 46s 8calico-node-n8z5j 1/1 Running 0 46s 9calico-node-pn4l2 1/1 Running 0 46s 10calico-node-wtqtn 1/1 Running 0 46s 11calico-typha-866db88dc4-8njgj 1/1 Running 0 61s 12calico-typha-866db88dc4-8wd57 1/1 Running 0 61s 13calico-typha-866db88dc4-wnjzh 1/1 Running 0 61s 14coredns-66db75cf8c-96t2p 1/1 Running 0 61s 15coredns-66db75cf8c-xgdf9 1/1 Running 0 61s 16etcd-zqf-master01 1/1 Running 1 53m 17etcd-zqf-master02 1/1 Running 0 52m 18etcd-zqf-master03 1/1 Running 0 52m 19kube-apiserver-zqf-master01 1/1 Running 1 53m 20kube-apiserver-zqf-master02 1/1 Running 0 52m 21kube-apiserver-zqf-master03 1/1 Running 0 52m 22kube-controller-manager-zqf-master01 1/1 Running 1 53m 23kube-controller-manager-zqf-master02 1/1 Running 0 52m 24kube-controller-manager-zqf-master03 1/1 Running 0 52m 25kube-proxy-75sbq 1/1 Running 0 37s 26kube-proxy-g2nqd 1/1 Running 0 45s 27kube-proxy-jqd92 1/1 Running 0 40s 28kube-proxy-kwxcb 1/1 Running 0 44s 29kube-proxy-lhtvl 1/1 Running 0 38s 30kube-proxy-vkv5v 1/1 Running 0 43s 31kube-proxy-ws2fl 1/1 Running 0 41s 32kube-scheduler-zqf-master01 1/1 Running 1 53m 33kube-scheduler-zqf-master02 1/1 Running 0 52m 34kube-scheduler-zqf-master03 1/1 Running 0 52m 1[root@zqf-Master01 ~]# kubectl get node 2NAME STATUS ROLES AGE VERSION 3zqf-master01 Ready control-plane 54m v1.29.6 4zqf-master02 Ready control-plane 53m v1.29.6 5zqf-master03 Ready control-plane 53m v1.29.6 6zqf-worker01 Ready \u0026lt;none\u0026gt; 52m v1.29.6 7zqf-worker02 Ready \u0026lt;none\u0026gt; 52m v1.29.6 8zqf-worker03 Ready \u0026lt;none\u0026gt; 52m v1.29.6 9zqf-worker04 Ready \u0026lt;none\u0026gt; 52m v1.29.6 2.4 é…ç½® kubectl å‘½ä»¤è¡¥å…¨ 1dnf install -y bash-completion 2source /usr/share/bash-completion/bash_completion 3source \u0026lt;(kubectl completion bash) 4echo \u0026#34;source \u0026lt;(kubectl completion bash)\u0026#34; \u0026gt;\u0026gt; ~/.bashrc 3. æ¸…é™¤ kubeadm ç¯å¢ƒ 1kubeadm reset cleanup-node 2y 3kubeadm reset 4y 5rm -rf /etc/cni/net.d 6ipvsadm --clear 7rm -rf $HOME/.kube/config ","permalink":"/tech/kubernetes/kubernetes-1.29.6-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","summary":"\u003ch1 id=\"æ¶æ„è®¾è®¡\"\u003eæ¶æ„è®¾è®¡\u003c/h1\u003e\n\u003cp\u003eOS: AlmaLinux 9.1\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eèŠ‚ç‚¹å\u003c/th\u003e\n          \u003cth\u003eIP åœ°å€\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ezqf-Master01\u003c/td\u003e\n          \u003ctd\u003e10.101.5.110\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ezqf-Master02\u003c/td\u003e\n          \u003ctd\u003e10.101.5.111\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ezqf-Master03\u003c/td\u003e\n          \u003ctd\u003e10.101.5.112\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ezqf-Worker01\u003c/td\u003e\n          \u003ctd\u003e10.101.5.113\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ezqf-Worker02\u003c/td\u003e\n          \u003ctd\u003e10.101.5.114\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ezqf-Worker03\u003c/td\u003e\n          \u003ctd\u003e10.101.5.115\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003ezqf-Worker04\u003c/td\u003e\n          \u003ctd\u003e10.101.5.116\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch1 id=\"1-æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ\"\u003e1. æ‰€æœ‰èŠ‚ç‚¹æ“ä½œ\u003c/h1\u003e\n\u003ch2 id=\"11-åŸºç¡€é…ç½®\"\u003e1.1 åŸºç¡€é…ç½®\u003c/h2\u003e\n\u003ch3 id=\"111-é…ç½®é•œåƒæº\"\u003e1.1.1 é…ç½®é•œåƒæº\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esed -e \u003cspan class=\"s1\"\u003e\u0026#39;s|^mirrorlist=|#mirrorlist=|g\u0026#39;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    -e \u003cspan class=\"s1\"\u003e\u0026#39;s|^#\\s*baseurl=https://repo.almalinux.org/almalinux|baseurl=https://mirrors.zju.edu.cn/almalinux|g\u0026#39;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    -i.bak \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    /etc/yum.repos.d/almalinux-*.repo\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003ednf makecache\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"112-é…ç½®ä¸»æœºå\"\u003e1.1.2 é…ç½®ä¸»æœºå\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003ehostnamectlÂ set-hostname \u0026lt;ä¸»æœºå\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ·»åŠ è§£æè®°å½•ï¼Œä½¿èŠ‚ç‚¹ç›´æ¥ä½¿ç”¨ä¸»æœºåè®¿é—®é€šä¿¡\u003c/p\u003e","title":"Kubernetes 1.29.6 é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²"},{"content":"é—®é¢˜å¯¼å‘\u0026amp;æ’æŸ¥ ç½‘ç»œè¯Šæ–­ è¿é€šæ€§æµ‹è¯•ï¼šä½¿ç”¨Â pingã€ncã€telnetÂ ç­‰å·¥å…·æµ‹è¯• Pod é—´çš„ç½‘ç»œè¿é€šæ€§ï¼Œæˆ–é€šè¿‡Â curlÂ æ£€æŸ¥æœåŠ¡ç«¯å£æ˜¯å¦å¯è¾¾ã€‚ NetworkPolicy æ£€æŸ¥ï¼šç¡®è®¤ NetworkPolicy è§„åˆ™æ˜¯å¦è¿‡äºä¸¥æ ¼å¯¼è‡´é€šä¿¡é˜»æ–­ï¼Œä½¿ç”¨Â kubectl get netpolÂ æŸ¥çœ‹å¹¶åˆ†æç°æœ‰ç­–ç•¥ã€‚ CNI æ’ä»¶æ’æŸ¥ï¼šæ£€æŸ¥ CNI æ’ä»¶ï¼ˆå¦‚ Calicoã€Flannel ç­‰ï¼‰çš„æ—¥å¿—ï¼Œæ’æŸ¥ç½‘ç»œé…ç½®æˆ–æ’ä»¶è‡ªèº«é—®é¢˜ã€‚ å­˜å‚¨é—®é¢˜æ’æŸ¥ PVC/PV çŠ¶æ€æ£€æŸ¥ï¼šä½¿ç”¨Â kubectl get pvc,pvÂ æŸ¥çœ‹ PersistentVolumeClaim å’Œ PersistentVolume çš„ç»‘å®šçŠ¶æ€ä¸å®¹é‡ï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨æœªç»‘å®šã€å®¹é‡ä¸è¶³ç­‰é—®é¢˜ã€‚ å­˜å‚¨æ—¥å¿—ä¸äº‹ä»¶ï¼šæ£€æŸ¥å­˜å‚¨æ’ä»¶ï¼ˆå¦‚ Local Volumeã€CSI Driver ç­‰ï¼‰æ—¥å¿—ï¼Œä»¥åŠ PVC/PV çš„äº‹ä»¶ä¿¡æ¯ï¼ŒæŸ¥æ‰¾å­˜å‚¨è®¿é—®å¼‚å¸¸ã€‚ æ•°æ®å®Œæ•´æ€§éªŒè¯ï¼šå¿…è¦æ—¶ï¼Œç›´æ¥åœ¨å®¿ä¸»æœºä¸ŠæŒ‚è½½å­˜å‚¨å·ï¼Œæ£€æŸ¥æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚ èµ„æºè°ƒåº¦ä¸äº²å’Œæ€§é—®é¢˜ èŠ‚ç‚¹èµ„æºåˆ†æï¼šä½¿ç”¨Â kubectl top nodesÂ æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨èµ„æºç“¶é¢ˆã€‚ è°ƒåº¦ç­–ç•¥æ£€æŸ¥ï¼šç¡®è®¤ Deploymentsã€StatefulSets ç­‰èµ„æºçš„Â .spec.template.spec.nodeSelectorã€.spec.affinityã€.spec.tolerationsÂ ç­‰è°ƒåº¦ç›¸å…³å­—æ®µé…ç½®ï¼Œçœ‹æ˜¯å¦é™åˆ¶äº† Pod çš„è°ƒåº¦èŒƒå›´ã€‚ kube-scheduler æ—¥å¿—ï¼šåˆ†æ kube-scheduler æ—¥å¿—ï¼Œäº†è§£è°ƒåº¦å†³ç­–è¿‡ç¨‹ï¼Œæ‰¾å‡ºå½±å“è°ƒåº¦çš„å› ç´ ã€‚ è®¤è¯æˆæƒä¸è®¿é—®æ§åˆ¶ RBAC è§„åˆ™å®¡æŸ¥ï¼šä½¿ç”¨Â kubectl get rolebindings,clusterrolebindingsÂ æ£€æŸ¥è§’è‰²ç»‘å®šå…³ç³»ï¼Œç¡®ä¿ç”¨æˆ·æˆ–æœåŠ¡è´¦æˆ·å…·æœ‰æ­£ç¡®çš„ API è®¿é—®æƒé™ã€‚ API Server è®¿é—®æ—¥å¿—ï¼šåˆ†æÂ kube-apiserver-audit.logï¼Œè·Ÿè¸ªç‰¹å®šç”¨æˆ·æˆ–è´¦æˆ·çš„ API è¯·æ±‚ä¸å“åº”ï¼Œæ’æŸ¥æˆæƒé—®é¢˜ã€‚ ç½‘ç»œä»£ç†ä¸è®¤è¯é…ç½®ï¼šæ£€æŸ¥ kubeconfig æ–‡ä»¶ã€API Server é…ç½®åŠç½‘ç»œä»£ç†ï¼ˆå¦‚ kube-proxyã€ingress-nginx ç­‰ï¼‰çš„è®¤è¯è®¾ç½®ï¼Œç¡®ä¿è®¿é—®è·¯å¾„æ— è¯¯ã€‚ ä¸ç®¡æ˜¯å¦åˆå­¦è€…ï¼Œå¤§å®¶ä¸€èˆ¬éƒ½å¯ä»¥ä»ç°è±¡è¯†åˆ«åˆ°é—®é¢˜å®šä½ï¼Œå†åˆ°æ·±å…¥æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆåˆ¶å®šï¼Œå½¢æˆä¸€å¥—å®Œæ•´çš„é—®é¢˜è§£å†³é—­ç¯ã€‚éšç€å®è·µç»éªŒçš„ç§¯ç´¯ï¼Œæ’æŸ¥æ•ˆç‡ä¸è§£å†³é—®é¢˜çš„èƒ½åŠ›å°†ä¸æ–­æå‡ã€‚\nK8s å¸¸è§æ•…éšœæ¡ˆä¾‹ ä¸‹é¢å†ç»™å¤§å®¶æ¥äº›ç»å…¸çš„æ•…éšœæ¡ˆä¾‹åŠå…¶æ’æŸ¥æ–¹æ³•ï¼š\næ•…éšœæ¡ˆä¾‹ 1ï¼šæœåŠ¡é—´ç½‘ç»œé€šä¿¡å¼‚å¸¸ï¼Œè¡¨ç°ä¸ºè¶…æ—¶æˆ–è¿æ¥å¤±è´¥ é—®é¢˜ç‚¹ï¼šÂ Kubernetes é›†ç¾¤å†…ä¸åŒæœåŠ¡ä¹‹é—´çš„ç½‘ç»œé€šä¿¡å‡ºç°å¼‚å¸¸ï¼Œè¡¨ç°ä¸ºè¯·æ±‚è¶…æ—¶ã€è¿æ¥å¤±è´¥æˆ–å“åº”ç¼“æ…¢ã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šæœåŠ¡é—´ä¾èµ–å…³ç³»ä¸­æ–­ï¼Œå¯¼è‡´ä¾èµ–æœåŠ¡çš„åŠŸèƒ½ä¸å¯ç”¨æˆ–æ€§èƒ½ä¸‹é™ã€‚é—´æ¥å½±å“ï¼šå¯èƒ½æ³¢åŠæ•´ä¸ªå¾®æœåŠ¡æ¶æ„ï¼Œå¼•å‘è¿é”ååº”ï¼Œé€ æˆç³»ç»Ÿæ•´ä½“ä¸ç¨³å®šã€‚\næ’æŸ¥æ–¹æ³•ï¼š\néªŒè¯æœåŠ¡çŠ¶æ€ï¼šÂ ä½¿ç”¨ kubectl get svc å’Œ kubectl get po ç¡®è®¤æ¶‰åŠçš„æœåŠ¡å’Œ Pod æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚ æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼šÂ åœ¨å‡ºç°é—®é¢˜çš„ Pod å†…ä½¿ç”¨ pingã€nc æˆ– curl ç­‰å·¥å…·æµ‹è¯•ä¸ç›®æ ‡æœåŠ¡çš„ç½‘ç»œè¿é€šæ€§ï¼ŒåŒ…æ‹¬ ClusterIPã€NodePort æˆ– Headless Service çš„ DNS è§£æã€‚ æ£€æŸ¥ NetworkPolicy è§„åˆ™ï¼šÂ ä½¿ç”¨ kubectl get netpol æŸ¥çœ‹æ˜¯å¦æœ‰ NetworkPolicy è§„åˆ™é™åˆ¶äº†æœåŠ¡é—´çš„é€šä¿¡ã€‚ æ£€æŸ¥ç½‘ç»œæ’ä»¶æ—¥å¿—ï¼šÂ æ£€æŸ¥ç½‘ç»œæ’ä»¶ï¼ˆå¦‚ Calicoã€Flannel ç­‰ï¼‰çš„æ—¥å¿—ï¼Œå¯»æ‰¾å¯èƒ½çš„ç½‘ç»œå¼‚å¸¸æˆ–é…ç½®é—®é¢˜ã€‚ æ’æŸ¥ DNS è§£æé—®é¢˜ï¼šÂ å¦‚æœé€šè¿‡æœåŠ¡åè®¿é—®å‡ºç°é—®é¢˜ï¼Œæ£€æŸ¥å†…éƒ¨ DNS æœåŠ¡ï¼ˆå¦‚ CoreDNSï¼‰æ—¥å¿—ï¼Œç¡®è®¤æœåŠ¡ DNS è®°å½•æ˜¯å¦æ­£ç¡®ã€‚ æ•…éšœæ¡ˆä¾‹ 2ï¼šPod æ— æ³•å¯åŠ¨ï¼ŒçŠ¶æ€æŒç»­ä¸º ImagePullBackOff é—®é¢˜ç‚¹ï¼šÂ Pod åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­æ— æ³•æˆåŠŸæ‹‰å–æŒ‡å®šçš„å®¹å™¨é•œåƒï¼ŒçŠ¶æ€æŒç»­æ˜¾ç¤ºä¸º ImagePullBackOffã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šè¯¥ Pod æ— æ³•å¯åŠ¨ï¼Œå¯¹åº”çš„æœåŠ¡æˆ–åº”ç”¨æ— æ³•æ­£å¸¸è¿è¡Œã€‚ æ’æŸ¥æ–¹æ³•ï¼š\næŸ¥çœ‹ Pod äº‹ä»¶ï¼šÂ ä½¿ç”¨Â kubectl describe pod \u0026lt;pod-name\u0026gt;Â æŸ¥çœ‹ Pod çš„è¯¦ç»†çŠ¶æ€å’Œäº‹ä»¶åˆ—è¡¨ï¼Œå®šä½åˆ°ä¸é•œåƒæ‹‰å–ç›¸å…³çš„äº‹ä»¶ï¼Œé€šå¸¸ä¼šåŒ…å«å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚ éªŒè¯é•œåƒåç§°ä¸ä»“åº“ï¼šÂ ç¡®è®¤æäº¤çš„ Pod å®šä¹‰ï¼ˆå¦‚ Deploymentã€StatefulSet ç­‰ï¼‰ä¸­ä½¿ç”¨çš„é•œåƒåç§°ã€æ ‡ç­¾å’Œä»“åº“åœ°å€æ˜¯å¦æ­£ç¡®æ— è¯¯ï¼Œä¸”ä¸å®é™…å­˜åœ¨çš„é•œåƒåŒ¹é…ã€‚ æ£€æŸ¥ç§æœ‰ä»“åº“è®¿é—®ï¼šÂ å¦‚æœé•œåƒä½äºç§æœ‰ä»“åº“ï¼Œç¡®è®¤ Deployment çš„ imagePullSecrets æ˜¯å¦å·²æ­£ç¡®é…ç½®äº†ä»“åº“è®¿é—®å‡­æ®ï¼Œä»¥åŠç½‘ç»œæ˜¯å¦å…è®¸ Pod è®¿é—®ä»“åº“ã€‚ æµ‹è¯•é•œåƒæ‹‰å–ï¼šÂ åœ¨é›†ç¾¤å†…å…¶ä»–èŠ‚ç‚¹æˆ–åŒä¸€èŠ‚ç‚¹ä¸Šçš„å¦ä¸€ä¸ªå®¹å™¨ä¸­å°è¯•æ‰‹åŠ¨æ‹‰å–é•œåƒï¼Œä»¥æ’é™¤ç½‘ç»œæˆ–ä»“åº“ä¸´æ—¶é—®é¢˜ã€‚ æ£€æŸ¥é•œåƒä»“åº“çŠ¶æ€ï¼šÂ å¦‚æœé•œåƒä»“åº“ä½äºå¤–éƒ¨ï¼Œæ£€æŸ¥ä»“åº“æœåŠ¡çš„è¿è¡ŒçŠ¶æ€å’Œæ—¥å¿—ï¼Œç¡®ä¿æœåŠ¡æ­£å¸¸ä¸”é•œåƒå¯ä¾›ä¸‹è½½ã€‚ æ•…éšœæ¡ˆä¾‹ 3ï¼šèŠ‚ç‚¹èµ„æºå‹åŠ›å‘Šè­¦ï¼Œè§¦å‘ MemoryPressure æˆ– DiskPressure é—®é¢˜ç‚¹ï¼šÂ Kubernetes èŠ‚ç‚¹æŠ¥å‘Šå†…å­˜æˆ–ç£ç›˜èµ„æºå‹åŠ›ï¼Œæ ‡è®°èŠ‚ç‚¹çŠ¶æ€ä¸ºÂ NotReadyÂ æˆ–åº”ç”¨Â MemoryPressureã€DiskPressureÂ æ±¡ç‚¹ï¼Œå¯¼è‡´è°ƒåº¦å™¨ä¸å†å°†æ–° Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šèŠ‚ç‚¹ä¸Šçš„ç°æœ‰ Pod å¯èƒ½å› èµ„æºä¸è¶³è€Œæ€§èƒ½ä¸‹é™æˆ–è¢«ç³»ç»Ÿå¼ºåˆ¶ç»ˆæ­¢ã€‚ é—´æ¥å½±å“ï¼šé›†ç¾¤çš„æ•´ä½“èµ„æºåˆ©ç”¨ç‡é™ä½ï¼Œæ–°éƒ¨ç½²æˆ–æ‰©ç¼©å®¹çš„æ“ä½œå—é˜»ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å®¹é‡ä¸è¶³æˆ–å“åº”å»¶è¿Ÿã€‚ æ’æŸ¥æ–¹æ³•ï¼š\næŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼šÂ ä½¿ç”¨Â kubectl get nodeÂ æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ï¼Œé‡ç‚¹å…³æ³¨Â ConditionsÂ åˆ—ä¸­çš„Â MemoryPressureÂ å’ŒÂ DiskPressureÂ çŠ¶æ€ã€‚ æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µï¼šÂ ä½¿ç”¨Â kubectl top nodesÂ æŸ¥çœ‹èŠ‚ç‚¹çš„å®æ—¶èµ„æºä½¿ç”¨ç‡ï¼Œå¯¹æ¯”èŠ‚ç‚¹çš„æ€»èµ„æºå®¹é‡ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿‡åº¦æ¶ˆè€—ã€‚ åˆ†æèµ„æºæ¶ˆè€—å¤§æˆ·ï¼šÂ ä½¿ç”¨Â kubectl top pods --all-namespaces --sort-by=memoryÂ æˆ– ``\u0026ndash;sort-by=cpu` æŸ¥æ‰¾å ç”¨èµ„æºæœ€å¤šçš„ Podï¼Œåˆ†æå…¶èµ„æºä½¿ç”¨åˆç†æ€§ã€‚ æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µï¼šÂ å¯¹äºÂ DiskPressureï¼Œä½¿ç”¨Â df -hÂ æˆ–Â du -sh /*ï¼ˆåœ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼‰æŸ¥çœ‹ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µï¼Œå®šä½å ç”¨ç©ºé—´å¤§çš„ç›®å½•ã€‚ æ¸…ç†èµ„æºæˆ–è°ƒæ•´ç­–ç•¥ï¼šÂ æ ¹æ®åˆ†æç»“æœï¼Œå¯èƒ½éœ€è¦æ¸…ç†æ— ç”¨æ•°æ®ã€ä¼˜åŒ– Pod èµ„æºè¯·æ±‚/é™åˆ¶ã€è°ƒæ•´æ—¥å¿—ç•™å­˜ç­–ç•¥ã€è¿ç§»éƒ¨åˆ†å·¥ä½œè´Ÿè½½åˆ°å…¶ä»–èŠ‚ç‚¹ç­‰ã€‚ æ•…éšœæ¡ˆä¾‹ 4ï¼šIngress èµ„æºæ›´æ–°åï¼Œå¤–éƒ¨è®¿é—®æœªæŒ‰é¢„æœŸç”Ÿæ•ˆ é—®é¢˜ç‚¹ï¼šÂ ä¿®æ”¹æˆ–æ–°å¢ Ingress èµ„æºåï¼Œå¤–éƒ¨å®¢æˆ·ç«¯é€šè¿‡ Ingress çš„åŸŸåè®¿é—®æœåŠ¡æ—¶ï¼Œè·¯ç”±è§„åˆ™ã€TLS é…ç½®ç­‰æœªæŒ‰é¢„æœŸæ›´æ–°ã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šå¤–éƒ¨å®¢æˆ·ç«¯æ— æ³•è®¿é—®åˆ°æœ€æ–°éƒ¨ç½²çš„æœåŠ¡ï¼Œæˆ–è®¿é—®è¡Œä¸ºä¸ç¬¦åˆæ›´æ–°åçš„ Ingress è§„åˆ™ã€‚ é—´æ¥å½±å“ï¼šå¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒã€ä¸šåŠ¡æµç¨‹æˆ–æ•°æ®ä¸€è‡´æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿›è¡Œç‰ˆæœ¬å‡çº§ã€åŠŸèƒ½åˆ‡æ¢ç­‰é‡è¦å˜æ›´æ—¶ã€‚ æ’æŸ¥æ–¹æ³•ï¼š\nç¡®è®¤ Ingress æ›´æ–°çŠ¶æ€ï¼šÂ ä½¿ç”¨Â kubectl get ingress \u0026lt;ingress-name\u0026gt; -o yamlÂ æŸ¥çœ‹ Ingress èµ„æºçš„æœ€æ–°é…ç½®ï¼Œç¡®è®¤æ›´æ–°å·²ç”Ÿæ•ˆã€‚ æ£€æŸ¥ Ingress Controller æ—¥å¿—ï¼šÂ æŸ¥çœ‹è´Ÿè´£å¤„ç† Ingress çš„æ§åˆ¶å™¨ï¼ˆå¦‚ Nginx Ingress Controllerã€Traefik ç­‰ï¼‰çš„æ—¥å¿—ï¼ŒæŸ¥æ‰¾ä¸ Ingress æ›´æ–°ç›¸å…³çš„äº‹ä»¶å’Œé”™è¯¯ã€‚ æµ‹è¯•å†…éƒ¨æœåŠ¡è®¿é—®ï¼šÂ ä½¿ç”¨Â kubectl execÂ è¿›å…¥é›†ç¾¤å†…å…¶ä»– Podï¼Œé€šè¿‡ ClusterIP æˆ– NodePort ç›´æ¥è®¿é—®æœåŠ¡ï¼ŒéªŒè¯æœåŠ¡æœ¬èº«æ˜¯å¦æ­£å¸¸ã€‚ æ¸…ç†ç¼“å­˜æˆ–ç­‰å¾…ä¼ æ’­ï¼šÂ å¦‚æœæ¶‰åŠ DNS ç¼“å­˜é—®é¢˜ï¼Œå¯èƒ½éœ€è¦ç­‰å¾… DNS è®°å½•åœ¨å…¨çƒèŒƒå›´å†…æ›´æ–°ï¼Œæˆ–è€…åœ¨å®¢æˆ·ç«¯æ‰‹åŠ¨æ¸…ç† DNS ç¼“å­˜åå†è¯•ã€‚ æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨é…ç½®ï¼šÂ å¯¹äºäº‘æœåŠ¡å•†æ‰˜ç®¡çš„ LoadBalancer ç±»å‹ Ingressï¼Œæ£€æŸ¥äº‘å¹³å°æ§åˆ¶å°ä¸­è´Ÿè½½å‡è¡¡å™¨çš„é…ç½®æ˜¯å¦å·²åŒæ­¥æ›´æ–°ã€‚ æ•…éšœæ¡ˆä¾‹ 5ï¼šKubernetes API æœåŠ¡å™¨å“åº”å˜æ…¢æˆ–ä¸å¯ç”¨ é—®é¢˜ç‚¹ï¼šÂ Kubernetes API æœåŠ¡å™¨å“åº”æ—¶é—´æ˜æ˜¾å¢åŠ ï¼Œæˆ–å‡ºç°æ— æ³•è¿æ¥ã€è¯·æ±‚è¶…æ—¶ã€è¿”å›é”™è¯¯ç­‰æƒ…å†µã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šæ‰€æœ‰ä¾èµ– Kubernetes API çš„æ“ä½œï¼ˆå¦‚ kubectl å‘½ä»¤ã€CI/CD æµç¨‹ã€é›†ç¾¤è‡ªåŠ¨åŒ–ç®¡ç†ç­‰ï¼‰éƒ½å°†å—åˆ°å½±å“ã€‚ é—´æ¥å½±å“ï¼šå¯èƒ½å¯¼è‡´é›†ç¾¤ç®¡ç†å›°éš¾ã€åº”ç”¨éƒ¨ç½²å»¶è¿Ÿã€ç›‘æ§æ•°æ®ä¸¢å¤±ã€æ•…éšœå“åº”ä¸åŠæ—¶ç­‰é—®é¢˜ï¼Œä¸¥é‡æ—¶å¯èƒ½å½±å“æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šè¿è¡Œã€‚ æ’æŸ¥æ–¹æ³•ï¼š\næ£€æŸ¥ API æœåŠ¡å™¨æ—¥å¿—ï¼šÂ æŸ¥çœ‹ API æœåŠ¡å™¨ï¼ˆkube-apiserverï¼‰çš„æ—¥å¿—ï¼ŒæŸ¥æ‰¾å¼‚å¸¸æ¶ˆæ¯ã€é”™è¯¯æˆ–è­¦å‘Šï¼Œå®šä½å¯èƒ½çš„é—®é¢˜æ ¹æºã€‚ ç›‘æ§ API æœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡ï¼šÂ ç›‘è§† API æœåŠ¡å™¨çš„ CPUã€å†…å­˜ä½¿ç”¨ç‡ã€è¯·æ±‚æ•°ã€é”™è¯¯ç‡ç­‰æ€§èƒ½æŒ‡æ ‡ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨èµ„æºç“¶é¢ˆæˆ–å¼‚å¸¸æ³¢åŠ¨ã€‚ æ£€æŸ¥ etcd çŠ¶æ€ï¼šÂ API æœåŠ¡å™¨ä¾èµ–äº etcd å­˜å‚¨é›†ç¾¤çŠ¶æ€ï¼Œä½¿ç”¨Â etcdctlÂ å·¥å…·æ£€æŸ¥ etcd é›†ç¾¤çš„å¥åº·çŠ¶å†µå’Œå“åº”æ—¶é—´ã€‚ æ’æŸ¥ç½‘ç»œé—®é¢˜ï¼šÂ æ£€æŸ¥ API æœåŠ¡å™¨æ‰€åœ¨èŠ‚ç‚¹çš„ç½‘ç»œè¿æ¥ï¼Œç¡®è®¤ä¸å…¶ä»–èŠ‚ç‚¹åŠå®¢æˆ·ç«¯çš„ç½‘ç»œé€šä¿¡æ˜¯å¦æ­£å¸¸ã€‚ å®¡æŸ¥è¿‘æœŸå˜æ›´ï¼šÂ å›é¡¾æœ€è¿‘å¯¹é›†ç¾¤è¿›è¡Œçš„é…ç½®æ›´æ”¹ã€ç‰ˆæœ¬å‡çº§ã€RBAC è§„åˆ™è°ƒæ•´ç­‰æ“ä½œï¼Œåˆ¤æ–­æ˜¯å¦å¼•å…¥äº†å¯¼è‡´ API æ€§èƒ½ä¸‹é™çš„å› ç´ ã€‚ æ•…éšœæ¡ˆä¾‹ 6ï¼šPod é—´ç½‘ç»œé€šä¿¡æ—¶æ–­æ—¶ç»­ é—®é¢˜ç‚¹ï¼šÂ Kubernetes é›†ç¾¤å†…ä¸åŒ Pod ä¹‹é—´çš„ç½‘ç»œé€šä¿¡å‡ºç°é—´æ­‡æ€§ä¸­æ–­æˆ–å»¶è¿Ÿä¸¥é‡ï¼Œæ—¶å¥½æ—¶åï¼Œæ— æ˜æ˜¾è§„å¾‹ã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šä¾èµ–ç½‘ç»œé€šä¿¡çš„æœåŠ¡æˆ–åº”ç”¨å¯èƒ½å‡ºç°çŸ­æš‚ä¸å¯ç”¨ã€æ•°æ®ä¼ è¾“å¤±è´¥ã€è¯·æ±‚è¶…æ—¶ç­‰é—®é¢˜ã€‚ é—´æ¥å½±å“ï¼šå¯èƒ½å¯¼è‡´ä¸šåŠ¡æµç¨‹ä¸­æ–­ã€æ•°æ®ä¸ä¸€è‡´ã€ç”¨æˆ·ä½“éªŒä¸‹é™ï¼Œä¸¥é‡æ—¶å½±å“æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ã€‚ æ’æŸ¥æ–¹æ¡ˆï¼š\nç›‘æ§ç½‘ç»œæµé‡ä¸å»¶è¿Ÿï¼šÂ ä½¿ç”¨ç½‘ç»œç›‘æ§å·¥å…·ï¼ˆå¦‚ Prometheus + Grafanaã€Netdata ç­‰ï¼‰ç›‘æ§ Pod é—´çš„ç½‘ç»œæµé‡ã€ä¸¢åŒ…ç‡å’Œå»¶è¿Ÿï¼Œè§‚å¯Ÿæ˜¯å¦å­˜åœ¨å‘¨æœŸæ€§æ³¢åŠ¨æˆ–å¼‚å¸¸å³°å€¼ã€‚ æ·±å…¥æŠ“åŒ…åˆ†æï¼šÂ åœ¨å—å½±å“çš„ Pod å†…ä½¿ç”¨Â tcpdumpÂ æˆ–Â wiresharkÂ æŠ“å–ç½‘ç»œåŒ…è¿›è¡Œåˆ†æï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨é‡ä¼ ã€ä¹±åºã€RST åŒ…ç­‰å¼‚å¸¸ç°è±¡ã€‚ æ£€æŸ¥ç½‘ç»œæ’ä»¶åŠåº•å±‚ç½‘ç»œè®¾å¤‡ï¼šÂ æŸ¥çœ‹ç½‘ç»œæ’ä»¶ï¼ˆå¦‚ Calicoã€Flannel ç­‰ï¼‰çš„æ—¥å¿—ï¼Œä»¥åŠå®¿ä¸»æœºç½‘ç»œè®¾å¤‡ï¼ˆå¦‚ç½‘å¡ã€äº¤æ¢æœºã€è·¯ç”±å™¨ç­‰ï¼‰çš„çŠ¶æ€å’Œæ—¥å¿—ï¼Œæ’æŸ¥å¯èƒ½çš„ç½‘ç»œè®¾å¤‡æ•…éšœæˆ–é…ç½®é—®é¢˜ã€‚ åˆ†æç½‘ç»œæ‹“æ‰‘ä¸ç­–ç•¥ï¼šÂ ä½¿ç”¨Â kubectl get netpolÂ æŸ¥çœ‹ NetworkPolicy è§„åˆ™ï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨è¿‡äºä¸¥æ ¼çš„ç­–ç•¥å¯¼è‡´ç½‘ç»œä¸­æ–­ã€‚æ£€æŸ¥ç½‘ç»œæ‹“æ‰‘ç»“æ„ï¼Œçœ‹æ˜¯å¦å­˜åœ¨å¯èƒ½å¯¼è‡´è·¯ç”±ä¸ç¨³å®šçš„è®¾è®¡é—®é¢˜ï¼ˆå¦‚å¤šè·¯å¾„ã€æµ®åŠ¨ IP ç­‰ï¼‰ã€‚ æ’æŸ¥å¤–éƒ¨å¹²æ‰°å› ç´ ï¼šÂ è€ƒè™‘æ˜¯å¦å­˜åœ¨å¤–éƒ¨ç½‘ç»œç¯å¢ƒå˜åŒ–ï¼ˆå¦‚äº‘æœåŠ¡å•†ç½‘ç»œè°ƒæ•´ã€DDoS æ”»å‡»ã€ç½‘ç»œç»´æŠ¤ç­‰ï¼‰å½±å“é›†ç¾¤å†…é€šä¿¡ã€‚å¦‚æœå¯èƒ½ï¼Œå°è¯•æ›´æ¢ç½‘ç»œç¯å¢ƒæˆ–æ—¶é—´æ®µè§‚å¯Ÿé—®é¢˜æ˜¯å¦é‡ç°ã€‚ æ•…éšœæ¡ˆä¾‹ 7ï¼šKubernetes æ§åˆ¶å¹³é¢ç»„ä»¶é—´é€šä¿¡å¼‚å¸¸ é—®é¢˜ç‚¹ï¼šÂ Kubernetes æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆå¦‚ API æœåŠ¡å™¨ã€etcdã€æ§åˆ¶å™¨ç®¡ç†å™¨ã€è°ƒåº¦å™¨ç­‰ï¼‰ä¹‹é—´é€šä¿¡å¼‚å¸¸ï¼Œå¯¼è‡´é›†ç¾¤ç®¡ç†åŠŸèƒ½å—é™æˆ–å¤±æ•ˆã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šé›†ç¾¤ç®¡ç†åŠŸèƒ½å—é™ï¼Œå¦‚æ— æ³•åˆ›å»º/æ›´æ–°èµ„æºã€Pod æ— æ³•è°ƒåº¦ã€çŠ¶æ€æ›´æ–°å»¶è¿Ÿç­‰ã€‚ é—´æ¥å½±å“ï¼šå¯èƒ½å¯¼è‡´æ•´ä¸ªé›†ç¾¤çš„ç¨³å®šæ€§ä¸‹é™ï¼Œåº”ç”¨æ— æ³•æ­£å¸¸éƒ¨ç½²ã€æ‰©å±•æˆ–æ¢å¤ï¼Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œä¸¥é‡çš„ç”šè‡³å¯èƒ½å¯¼è‡´é›†ç¾¤å®Œå…¨ä¸å¯ç”¨ã€‚ æ’æŸ¥æ–¹æ¡ˆï¼š\næ£€æŸ¥æ§åˆ¶å¹³é¢ç»„ä»¶çŠ¶æ€ï¼šÂ ä½¿ç”¨Â kubectl get componentstatusesÂ æŸ¥çœ‹æ§åˆ¶å¹³é¢å„ç»„ä»¶çš„çŠ¶æ€ï¼Œå…³æ³¨æ˜¯å¦æœ‰Â UnhealthyÂ æˆ–Â UnknownÂ çš„ç»„ä»¶ã€‚ æŸ¥çœ‹æ§åˆ¶å¹³é¢æ—¥å¿—ï¼šÂ åˆ†åˆ«æ£€æŸ¥ API æœåŠ¡å™¨ã€etcdã€æ§åˆ¶å™¨ç®¡ç†å™¨ã€è°ƒåº¦å™¨ç­‰ç»„ä»¶çš„æ—¥å¿—ï¼ŒæŸ¥æ‰¾ä¸é€šä¿¡å¼‚å¸¸ç›¸å…³çš„é”™è¯¯æˆ–è­¦å‘Šã€‚ æ£€æŸ¥ etcd é›†ç¾¤å¥åº·çŠ¶å†µï¼šÂ ä½¿ç”¨Â etcdctlÂ å·¥å…·æ£€æŸ¥ etcd é›†ç¾¤çš„å¥åº·çŠ¶å†µã€æˆå‘˜åˆ—è¡¨ã€é¢†å¯¼è€…é€‰ä¸¾çŠ¶æ€ç­‰ï¼Œç¡®è®¤å„æˆå‘˜é—´é€šä¿¡æ˜¯å¦æ­£å¸¸ã€‚ æ£€æŸ¥æ§åˆ¶å¹³é¢ç½‘ç»œè¿æ¥ï¼šÂ ä½¿ç”¨Â netstatã€ssÂ æˆ–Â telnetÂ ç­‰å·¥å…·æ£€æŸ¥æ§åˆ¶å¹³é¢ç»„ä»¶ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œç¡®è®¤ç«¯å£æ˜¯å¦å¯è¾¾ã€TCP è¿æ¥æ˜¯å¦æ­£å¸¸ã€‚ å®¡æŸ¥æ§åˆ¶å¹³é¢é…ç½®ï¼šÂ æ£€æŸ¥æ§åˆ¶å¹³é¢ç»„ä»¶çš„é…ç½®æ–‡ä»¶ï¼ˆå¦‚Â /etc/kubernetes/manifestsÂ ä¸‹çš„é™æ€ Pod æ¸…å•ï¼‰ï¼Œç¡®è®¤ API æœåŠ¡å™¨çš„Â --etcd-serversã€æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨çš„Â --masterÂ å‚æ•°ç­‰æ˜¯å¦æ­£ç¡®ã€‚ æ•…éšœæ¡ˆä¾‹ 8ï¼šStatefulSet ä¸­ Pod æ— æ³•å®Œæˆåˆå§‹åŒ–æˆ–æ»šåŠ¨æ›´æ–° é—®é¢˜ç‚¹ï¼šÂ StatefulSet ä¸­çš„ Pod åœ¨åˆ›å»ºæˆ–æ»šåŠ¨æ›´æ–°è¿‡ç¨‹ä¸­æ— æ³•å®Œæˆåˆå§‹åŒ–ï¼Œå§‹ç»ˆå¤„äºÂ PendingÂ æˆ–Â ContainerCreatingÂ çŠ¶æ€ï¼Œæˆ–åå¤é‡å¯ã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šå¯¹åº” StatefulSet çš„æœåŠ¡æ— æ³•æŒ‰é¢„æœŸæä¾›å®Œæ•´åŠŸèƒ½ï¼Œæ•°æ®ä¸€è‡´æ€§æˆ–å¯ç”¨æ€§å¯èƒ½å—åˆ°å½±å“ã€‚ æ’æŸ¥æ–¹æ¡ˆï¼š\næŸ¥çœ‹ Pod äº‹ä»¶ä¸çŠ¶æ€ï¼šÂ ä½¿ç”¨Â kubectl describe pod \u0026lt;pod-name\u0026gt;Â æŸ¥çœ‹ Pod è¯¦ç»†çŠ¶æ€å’Œäº‹ä»¶åˆ—è¡¨ï¼Œå®šä½é—®é¢˜å‘ç”Ÿçš„å…·ä½“é˜¶æ®µå’ŒåŸå› ã€‚ æ£€æŸ¥å­˜å‚¨å·å…³è”ä¸çŠ¶æ€ï¼šÂ ä½¿ç”¨Â kubectl get pvcÂ æŸ¥çœ‹ PersistentVolumeClaimï¼ˆPVCï¼‰çš„çŠ¶æ€ï¼Œç¡®è®¤ PVC æ˜¯å¦å·²ç»‘å®šåˆ°åˆé€‚çš„ PersistentVolumeï¼ˆPVï¼‰ï¼ŒPV æ˜¯å¦æ­£å¸¸ã€‚æ£€æŸ¥ PV çš„è¯¦ç»†ä¿¡æ¯ï¼Œç¡®è®¤å…¶çŠ¶æ€ã€å®¹é‡ã€è®¿é—®æ¨¡å¼ç­‰æ˜¯å¦æ»¡è¶³ StatefulSet çš„è¦æ±‚ã€‚ æ£€æŸ¥å­˜å‚¨æœåŠ¡æ—¥å¿—ä¸çŠ¶æ€ï¼šÂ å¦‚æœä½¿ç”¨çš„æ˜¯äº‘æœåŠ¡å•†æä¾›çš„å­˜å‚¨æœåŠ¡ï¼ˆå¦‚ OSSã€S3ã€Diskã€NAS ç­‰ï¼‰ï¼Œæ£€æŸ¥å…¶æ§åˆ¶å°æˆ–æ—¥å¿—ï¼Œç¡®è®¤å­˜å‚¨æœåŠ¡æœ¬èº«æ— å¼‚å¸¸ã€‚ æ£€æŸ¥åº”ç”¨åˆå§‹åŒ–è„šæœ¬ï¼šÂ å¦‚æœ StatefulSet ä¸­çš„ Pod åœ¨å¯åŠ¨æ—¶æ‰§è¡Œäº†è‡ªå®šä¹‰çš„åˆå§‹åŒ–è„šæœ¬ï¼ˆå¦‚Â initContainersï¼‰ï¼Œæ£€æŸ¥è¿™äº›è„šæœ¬çš„é€»è¾‘å’Œè¾“å‡ºï¼Œç¡®è®¤æ— è¯¯ã€‚ éªŒè¯å­˜å‚¨å·æ•°æ®å®Œæ•´æ€§ï¼šÂ å¦‚æœæ€€ç–‘å­˜å‚¨å·æ•°æ®æŸåæˆ–ä¸ä¸€è‡´å¯¼è‡´é—®é¢˜ï¼Œå°è¯•åœ¨å…¶ä»–èŠ‚ç‚¹ä¸ŠæŒ‚è½½è¯¥ PVï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®ã€‚å¿…è¦æ—¶ï¼Œä»å¤‡ä»½æ¢å¤æ•°æ®ã€‚ æ•…éšœæ¡ˆä¾‹ 9ï¼šHelm å‡çº§åº”ç”¨åéƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸ é—®é¢˜ç‚¹ï¼šÂ ä½¿ç”¨ Helm å‡çº§ Kubernetes åº”ç”¨åï¼Œéƒ¨åˆ†åŠŸèƒ½å‡ºç°å¼‚å¸¸ï¼Œå¦‚æœåŠ¡ä¸å¯ç”¨ã€æ¥å£è¿”å›é”™è¯¯ã€æ•°æ®ä¸ä¸€è‡´ç­‰ã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šå‡çº§åçš„åº”ç”¨æ— æ³•æ­£å¸¸æä¾›å…¨éƒ¨åŠŸèƒ½ï¼Œå¯èƒ½å½±å“ç”¨æˆ·è®¿é—®ã€æ•°æ®å¤„ç†ã€ä¸šåŠ¡æµç¨‹ç­‰ã€‚ é—´æ¥å½±å“ï¼šå¯èƒ½å¯¼è‡´ä¿¡ä»»åº¦ä¸‹é™ã€è¿ç»´å¤æ‚åº¦å¢åŠ ã€å›æ»šæˆæœ¬å¢å¤§ã€‚ æ’æŸ¥æ–¹æ¡ˆï¼š\nå¯¹æ¯”æ—§ç‰ˆä¸æ–°ç‰ˆèµ„æºå®šä¹‰ï¼šÂ ä½¿ç”¨Â helm get values \u0026lt;release-name\u0026gt;Â å’ŒÂ helm get manifest \u0026lt;release-name\u0026gt;Â è·å–å‡çº§å‰åçš„èµ„æºå®šä¹‰å’Œé…ç½®å€¼ï¼Œå¯¹æ¯”å·®å¼‚ï¼Œçœ‹æ˜¯å¦æœ‰è¯¯åˆ ã€è¯¯æ”¹çš„å…³é”®é…ç½®ã€‚ æ£€æŸ¥æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼šÂ ä½¿ç”¨Â helm get all \u0026lt;release-name\u0026gt;Â æŸ¥çœ‹ Helm Release çš„è¯¦ç»†ä¿¡æ¯ï¼Œç¡®è®¤æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼ˆå¦‚Â maxUnavailableã€maxSurgeï¼‰æ˜¯å¦åˆç†ï¼Œæ˜¯å¦å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­ã€‚ æ£€æŸ¥åº”ç”¨æ—¥å¿—ä¸çŠ¶æ€ï¼šÂ ä½¿ç”¨Â kubectl logsÂ å’ŒÂ kubectl describeÂ æŸ¥çœ‹å‡çº§å Pod çš„æ—¥å¿—å’ŒçŠ¶æ€ï¼Œå®šä½å…·ä½“å‡ºé”™çš„æœåŠ¡æˆ–ç»„ä»¶ã€‚ éªŒè¯æ•°æ®è¿ç§»æˆ–è¿ç§»è„šæœ¬ï¼šÂ å¦‚æœå‡çº§æ¶‰åŠæ•°æ®è¿ç§»ï¼Œæ£€æŸ¥è¿ç§»è„šæœ¬æˆ–å·¥å…·çš„æ‰§è¡Œç»“æœï¼Œç¡®è®¤æ•°æ®æ˜¯å¦æ­£ç¡®è¿ç§»ã€‚å¯¹äºæœ‰çŠ¶æ€åº”ç”¨ï¼Œç¡®è®¤æ–°æ—§ç‰ˆæœ¬èƒ½å¦æ­£ç¡®å…±äº«å­˜å‚¨ã€‚ å›æ»šå¹¶é€æ­¥å‡çº§éªŒè¯ï¼šÂ å¦‚æœé—®é¢˜éš¾ä»¥å®šä½ï¼Œå¯å…ˆå›æ»šåˆ°æ—§ç‰ˆæœ¬ï¼Œç„¶åé€æ­¥å‡çº§éƒ¨åˆ†ç»„ä»¶æˆ–åŠŸèƒ½ï¼Œè§‚å¯Ÿé—®é¢˜æ˜¯å¦é‡ç°ï¼Œç¼©å°æ’æŸ¥èŒƒå›´ã€‚ æ•…éšœæ¡ˆä¾‹ 10ï¼šKubernetes é›†ç¾¤é¢‘ç¹å‡ºç°èŠ‚ç‚¹ NotReady é—®é¢˜ç‚¹ï¼šÂ Kubernetes é›†ç¾¤ä¸­çš„èŠ‚ç‚¹é¢‘ç¹å‡ºç°Â NotReadyÂ çŠ¶æ€ï¼Œå³ä½¿è‡ªåŠ¨æ¢å¤åä¸ä¹…åˆå†æ¬¡å˜ä¸º NotReadyã€‚\nå½±å“èŒƒå›´ï¼š\nç›´æ¥å½±å“ï¼šèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pod å¯èƒ½è¢«é©±é€ï¼Œå¯¼è‡´æœåŠ¡ä¸­æ–­ã€æ•°æ®ä¸¢å¤±æˆ–å¤„ç†å»¶è¿Ÿã€‚ é—´æ¥å½±å“ï¼šé¢‘ç¹çš„èŠ‚ç‚¹çŠ¶æ€å˜åŒ–å¯èƒ½å¯¼è‡´è°ƒåº¦å‹åŠ›å¢å¤§ã€èµ„æºåˆ©ç”¨ç‡é™ä½ï¼Œå½±å“é›†ç¾¤æ•´ä½“ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚ æ’æŸ¥æ–¹æ¡ˆï¼š\nç›‘æ§èŠ‚ç‚¹èµ„æºä½¿ç”¨ï¼šÂ ä½¿ç”¨Â kubectl top nodesÂ å’Œç¬¬ä¸‰æ–¹ç›‘æ§å·¥å…·ï¼ˆå¦‚ Prometheus + Grafanaï¼‰æŒç»­ç›‘æ§èŠ‚ç‚¹çš„ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰èµ„æºä½¿ç”¨æƒ…å†µï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰èµ„æºè€—å°½çš„è¿¹è±¡ã€‚ æ£€æŸ¥èŠ‚ç‚¹æ—¥å¿—ä¸ç³»ç»ŸçŠ¶æ€ï¼šÂ ç™»å½•åˆ°é—®é¢˜èŠ‚ç‚¹ï¼Œæ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼ˆå¦‚Â /var/log/messagesã€/var/log/syslogÂ ç­‰ï¼‰ã€Dockerï¼ˆæˆ– Containerdï¼‰æ—¥å¿—ã€kubelet æ—¥å¿—ï¼ŒæŸ¥æ‰¾ä¸èŠ‚ç‚¹çŠ¶æ€å˜åŒ–ç›¸å…³çš„é”™è¯¯æˆ–è­¦å‘Šã€‚ æ’æŸ¥ç¡¬ä»¶æ•…éšœæˆ–ç½‘ç»œé—®é¢˜ï¼šÂ æ£€æŸ¥èŠ‚ç‚¹çš„ç¡¬ä»¶çŠ¶æ€ï¼ˆå¦‚ CPUã€å†…å­˜ã€ç£ç›˜å¥åº·çŠ¶å†µï¼‰ï¼Œä»¥åŠç½‘ç»œè®¾å¤‡ï¼ˆå¦‚ç½‘å¡ã€äº¤æ¢æœºï¼‰çš„çŠ¶æ€å’Œæ—¥å¿—ï¼Œçœ‹æ˜¯å¦å­˜åœ¨ç¡¬ä»¶æ•…éšœæˆ–ç½‘ç»œé—®é¢˜ã€‚ æ£€æŸ¥èŠ‚ç‚¹é…ç½®ä¸æ±¡ç‚¹ï¼šÂ ä½¿ç”¨Â kubectl describe node \u0026lt;node-name\u0026gt;Â æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ï¼Œç¡®è®¤èŠ‚ç‚¹é…ç½®ï¼ˆå¦‚æ ‡ç­¾ã€Taintsï¼‰æ˜¯å¦åˆç†ï¼Œæ˜¯å¦è¢«æ­£ç¡®è°ƒåº¦ã€‚ æ’æŸ¥ç³»ç»Ÿçº§è½¯ä»¶é—®é¢˜ï¼šÂ æ£€æŸ¥èŠ‚ç‚¹çš„æ“ä½œç³»ç»Ÿã€å†…æ ¸ã€kubeletã€Dockerï¼ˆæˆ– Containerdï¼‰ã€CNI æ’ä»¶ç­‰è½¯ä»¶ç‰ˆæœ¬å’Œé…ç½®ï¼Œç¡®è®¤æ— å·²çŸ¥é—®é¢˜æˆ–å†²çªã€‚å¿…è¦æ—¶ï¼Œå‡çº§åˆ°ç¨³å®šç‰ˆæœ¬æˆ–é‡æ–°å®‰è£…ã€‚ å‚è€ƒèµ„æ–™ https://mp.weixin.qq.com/s?__biz=Mzg4NTU0MzEyMg==\u0026amp;mid=2247530144\u0026amp;idx=1\u0026amp;sn=448bc4651b37a1020844c12fdb1c925e\u0026amp;chksm=cfa56f1df8d2e60b55848bb33b47edce1bbc38ef38f6a19354e7323dcf1a7612ec84fa680653\u0026amp;scene=21#wechat_redirect ","permalink":"/tech/kubernetes/kubernetes-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%96%B9%E6%B3%95/","summary":"\u003ch1 id=\"é—®é¢˜å¯¼å‘æ’æŸ¥\"\u003eé—®é¢˜å¯¼å‘\u0026amp;æ’æŸ¥\u003c/h1\u003e\n\u003ch2 id=\"ç½‘ç»œè¯Šæ–­\"\u003eç½‘ç»œè¯Šæ–­\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eè¿é€šæ€§æµ‹è¯•\u003c/strong\u003eï¼šä½¿ç”¨Â \u003ccode\u003eping\u003c/code\u003eã€\u003ccode\u003enc\u003c/code\u003eã€\u003ccode\u003etelnet\u003c/code\u003eÂ ç­‰å·¥å…·æµ‹è¯• Pod é—´çš„ç½‘ç»œè¿é€šæ€§ï¼Œæˆ–é€šè¿‡Â \u003ccode\u003ecurl\u003c/code\u003eÂ æ£€æŸ¥æœåŠ¡ç«¯å£æ˜¯å¦å¯è¾¾ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNetworkPolicy æ£€æŸ¥\u003c/strong\u003eï¼šç¡®è®¤ NetworkPolicy è§„åˆ™æ˜¯å¦è¿‡äºä¸¥æ ¼å¯¼è‡´é€šä¿¡é˜»æ–­ï¼Œä½¿ç”¨Â \u003ccode\u003ekubectl get netpol\u003c/code\u003eÂ æŸ¥çœ‹å¹¶åˆ†æç°æœ‰ç­–ç•¥ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCNI æ’ä»¶æ’æŸ¥\u003c/strong\u003eï¼šæ£€æŸ¥ CNI æ’ä»¶ï¼ˆå¦‚ Calicoã€Flannel ç­‰ï¼‰çš„æ—¥å¿—ï¼Œæ’æŸ¥ç½‘ç»œé…ç½®æˆ–æ’ä»¶è‡ªèº«é—®é¢˜ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"å­˜å‚¨é—®é¢˜æ’æŸ¥\"\u003eå­˜å‚¨é—®é¢˜æ’æŸ¥\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003ePVC/PV çŠ¶æ€æ£€æŸ¥\u003c/strong\u003eï¼šä½¿ç”¨Â \u003ccode\u003ekubectl get pvc,pv\u003c/code\u003eÂ æŸ¥çœ‹ \u003ccode\u003ePersistentVolumeClaim\u003c/code\u003e å’Œ \u003ccode\u003ePersistentVolume\u003c/code\u003e çš„ç»‘å®šçŠ¶æ€ä¸å®¹é‡ï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨æœªç»‘å®šã€å®¹é‡ä¸è¶³ç­‰é—®é¢˜ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå­˜å‚¨æ—¥å¿—ä¸äº‹ä»¶\u003c/strong\u003eï¼šæ£€æŸ¥å­˜å‚¨æ’ä»¶ï¼ˆå¦‚ Local Volumeã€CSI Driver ç­‰ï¼‰æ—¥å¿—ï¼Œä»¥åŠ PVC/PV çš„äº‹ä»¶ä¿¡æ¯ï¼ŒæŸ¥æ‰¾å­˜å‚¨è®¿é—®å¼‚å¸¸ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ•°æ®å®Œæ•´æ€§éªŒè¯\u003c/strong\u003eï¼šå¿…è¦æ—¶ï¼Œç›´æ¥åœ¨å®¿ä¸»æœºä¸ŠæŒ‚è½½å­˜å‚¨å·ï¼Œæ£€æŸ¥æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"èµ„æºè°ƒåº¦ä¸äº²å’Œæ€§é—®é¢˜\"\u003eèµ„æºè°ƒåº¦ä¸äº²å’Œæ€§é—®é¢˜\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eèŠ‚ç‚¹èµ„æºåˆ†æ\u003c/strong\u003eï¼šä½¿ç”¨Â \u003ccode\u003ekubectl top nodes\u003c/code\u003eÂ æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨èµ„æºç“¶é¢ˆã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè°ƒåº¦ç­–ç•¥æ£€æŸ¥\u003c/strong\u003eï¼šç¡®è®¤ Deploymentsã€StatefulSets ç­‰èµ„æºçš„Â \u003ccode\u003e.spec.template.spec.nodeSelector\u003c/code\u003eã€\u003ccode\u003e.spec.affinity\u003c/code\u003eã€\u003ccode\u003e.spec.tolerations\u003c/code\u003eÂ ç­‰è°ƒåº¦ç›¸å…³å­—æ®µé…ç½®ï¼Œçœ‹æ˜¯å¦é™åˆ¶äº† Pod çš„è°ƒåº¦èŒƒå›´ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ekube-scheduler æ—¥å¿—\u003c/strong\u003eï¼šåˆ†æ kube-scheduler æ—¥å¿—ï¼Œäº†è§£è°ƒåº¦å†³ç­–è¿‡ç¨‹ï¼Œæ‰¾å‡ºå½±å“è°ƒåº¦çš„å› ç´ ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"è®¤è¯æˆæƒä¸è®¿é—®æ§åˆ¶\"\u003eè®¤è¯æˆæƒä¸è®¿é—®æ§åˆ¶\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRBAC è§„åˆ™å®¡æŸ¥\u003c/strong\u003eï¼šä½¿ç”¨Â \u003ccode\u003ekubectl get rolebindings,clusterrolebindings\u003c/code\u003eÂ æ£€æŸ¥è§’è‰²ç»‘å®šå…³ç³»ï¼Œç¡®ä¿ç”¨æˆ·æˆ–æœåŠ¡è´¦æˆ·å…·æœ‰æ­£ç¡®çš„ API è®¿é—®æƒé™ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAPI Server è®¿é—®æ—¥å¿—\u003c/strong\u003eï¼šåˆ†æÂ \u003ccode\u003ekube-apiserver-audit.log\u003c/code\u003eï¼Œè·Ÿè¸ªç‰¹å®šç”¨æˆ·æˆ–è´¦æˆ·çš„ API è¯·æ±‚ä¸å“åº”ï¼Œæ’æŸ¥æˆæƒé—®é¢˜ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç½‘ç»œä»£ç†ä¸è®¤è¯é…ç½®\u003c/strong\u003eï¼šæ£€æŸ¥ kubeconfig æ–‡ä»¶ã€API Server é…ç½®åŠç½‘ç»œä»£ç†ï¼ˆå¦‚ kube-proxyã€ingress-nginx ç­‰ï¼‰çš„è®¤è¯è®¾ç½®ï¼Œç¡®ä¿è®¿é—®è·¯å¾„æ— è¯¯ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸ç®¡æ˜¯å¦åˆå­¦è€…ï¼Œå¤§å®¶ä¸€èˆ¬éƒ½å¯ä»¥ä»ç°è±¡è¯†åˆ«åˆ°é—®é¢˜å®šä½ï¼Œå†åˆ°æ·±å…¥æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆåˆ¶å®šï¼Œå½¢æˆä¸€å¥—å®Œæ•´çš„é—®é¢˜è§£å†³é—­ç¯ã€‚éšç€å®è·µç»éªŒçš„ç§¯ç´¯ï¼Œæ’æŸ¥æ•ˆç‡ä¸è§£å†³é—®é¢˜çš„èƒ½åŠ›å°†ä¸æ–­æå‡ã€‚\u003c/p\u003e","title":"Kubernetes æ•…éšœæ’æŸ¥æ–¹æ³•è®º"},{"content":"æ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸ 1kubeadm certs check-expiration è¯¥å‘½ä»¤æ˜¾ç¤ºÂ /etc/kubernetes/pkiÂ æ–‡ä»¶å¤¹ä¸­çš„å®¢æˆ·ç«¯è¯ä¹¦ä»¥åŠ kubeadmï¼ˆadmin.confã€controller-manager.confÂ å’ŒÂ scheduler.confï¼‰ ä½¿ç”¨çš„ kubeconfig æ–‡ä»¶ä¸­åµŒå…¥çš„å®¢æˆ·ç«¯è¯ä¹¦çš„åˆ°æœŸæ—¶é—´/å‰©ä½™æ—¶é—´ã€‚\næ‰‹åŠ¨æ›´æ–°è¯ä¹¦ åœ¨æ‰€æœ‰ Master èŠ‚ç‚¹ä¸Šæ‰§è¡Œè¯ä¹¦æ›´æ–°å‘½ä»¤ 1kubeadm certs renew all æ‰‹åŠ¨é‡å¯ Master èŠ‚ç‚¹ä¸Šçš„ Pod ç”±äºåŠ¨æ€è¯ä¹¦é‡è½½ç›®å‰è¿˜ä¸è¢«æ‰€æœ‰ç»„ä»¶å’Œè¯ä¹¦æ”¯æŒï¼Œæ‰€æœ‰è¿™é¡¹æ“ä½œæ˜¯å¿…é¡»çš„ã€‚é™æ€ Pod ç”±æœ¬åœ° kubelet è€Œä¸æ˜¯ API æœåŠ¡å™¨ç®¡ç†ï¼Œæ‰€ä»¥ kubectl ä¸èƒ½ç”¨æ¥åˆ é™¤æˆ–é‡å¯ä»–ä»¬ã€‚\né¦–å…ˆï¼Œå°†æ¸…å•æ–‡ä»¶ä»Â /etc/kubernetes/manifests/Â ç§»é™¤å¹¶ç­‰å¾… 20 ç§’ ï¼ˆå‚è€ƒ KubeletConfiguration ä¸­çš„Â fileCheckFrequencyÂ å€¼ï¼‰ã€‚å¦‚æœ Pod ä¸åœ¨æ¸…å•ç›®å½•é‡Œï¼Œkubelet å°†ä¼šç»ˆæ­¢å®ƒã€‚ åœ¨å¦ä¸€ä¸ªÂ fileCheckFrequencyÂ å‘¨æœŸä¹‹åå°†æ–‡ä»¶ç§»å›å»ï¼Œkubelet å¯ä»¥å®Œæˆ Pod çš„é‡å»ºï¼Œè€Œç»„ä»¶çš„è¯ä¹¦æ›´æ–°æ“ä½œä¹Ÿå¾—ä»¥å®Œæˆã€‚\nå‚è€ƒèµ„æ–™ https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#check-certificate-expiration ","permalink":"/tech/kubernetes/%E5%9F%BA%E4%BA%8E-kubeadm-%E6%89%8B%E5%8A%A8%E6%9B%B4%E6%96%B0%E8%AF%81%E4%B9%A6/","summary":"\u003ch1 id=\"æ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸ\"\u003eæ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸ\u003c/h1\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003ekubeadm certs check-expiration\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¯¥å‘½ä»¤æ˜¾ç¤ºÂ \u003ccode\u003e/etc/kubernetes/pki\u003c/code\u003eÂ æ–‡ä»¶å¤¹ä¸­çš„å®¢æˆ·ç«¯è¯ä¹¦ä»¥åŠ kubeadmï¼ˆ\u003ccode\u003eadmin.conf\u003c/code\u003eã€\u003ccode\u003econtroller-manager.conf\u003c/code\u003eÂ å’ŒÂ \u003ccode\u003escheduler.conf\u003c/code\u003eï¼‰ ä½¿ç”¨çš„ kubeconfig æ–‡ä»¶ä¸­åµŒå…¥çš„å®¢æˆ·ç«¯è¯ä¹¦çš„åˆ°æœŸæ—¶é—´/å‰©ä½™æ—¶é—´ã€‚\u003c/p\u003e","title":"åŸºäº Kubeadm æ‰‹åŠ¨æ›´æ–°è¯ä¹¦"},{"content":"Velero å®‰è£…æ­¥éª¤ å®¢æˆ·ç«¯ https://github.com/vmware-tanzu/velero/releases\nä¸‹è½½å¹¶å®‰è£…æœ€æ–°ç‰ˆæœ¬äºŒè¿›åˆ¶å®¢æˆ·ç«¯ã€‚\n1cp velero /usr/local/bin \u0026amp;\u0026amp; chmod +x /usr/local/bin/velero 2 3velero version 4Client: 5 Version: v1.13.2 6 Git commit: 4d961fb6fec384ed7f3c1b7c65c818106107f5a6 7\u0026lt;error getting server version: no matches for kind \u0026#34;ServerStatusRequest\u0026#34; in version \u0026#34;velero.io/v1\u0026#34;\u0026gt; æœåŠ¡ç«¯ å‡†å¤‡å¥½ç§˜é’¥æ–‡ä»¶ credentials-velero ï¼Œå³ MinIO çš„ç”¨æˆ·åå¯†ç ã€‚ 1[default] 2aws_access_key_id=\u0026lt;access key id\u0026gt; 3aws_secret_access_key=\u0026lt;secret access key\u0026gt; ä½¿ç”¨ velero install å®‰è£…æœåŠ¡ç«¯ 1velero install \\ 2 --provider aws \\ 3 --image velero/velero:v1.13.2 \\ 4 --plugins velero/velero-plugin-for-aws:v1.9.2 \\ 5 --bucket velero \\ 6 --secret-file ./credentials-velero \\ 7 --use-node-agent \\ 8 --use-volume-snapshots=false \\ 9 --namespace velero \\ 10 --backup-location-config region=minio,s3ForcePathStyle=\u0026#34;true\u0026#34;,s3Url=http://10.101.6.118:9000 \\ 11 --wait 1velero version 2Client: 3 Version: v1.13.2 4 Git commit: 4d961fb6fec384ed7f3c1b7c65c818106107f5a6 5Server: 6 Version: v1.13.2 Velero ä½¿ç”¨ å¤‡ä»½ 1velero create backup NAME [flags] backupé€‰é¡¹ï¼š\n--exclude-namespaces stringArrayÂ : è¦ä»å¤‡ä»½ä¸­æ’é™¤çš„åç§°ç©ºé—´ --exclude-resources stringArray: è¦ä»å¤‡ä»½ä¸­æ’é™¤çš„èµ„æºï¼Œå¦‚storageclasses.storage.k8s.io --include-cluster-resources optionalBool[=true]: åŒ…å«é›†ç¾¤èµ„æºç±»å‹ --include-namespaces stringArray: è¦åŒ…å«åœ¨å¤‡ä»½ä¸­çš„åç§°ç©ºé—´(é»˜è®¤\u0026rsquo;*') --include-resources stringArray: å¤‡ä»½ä¸­è¦åŒ…æ‹¬çš„èµ„æº --labels mapStringString: ç»™è¿™ä¸ªå¤‡ä»½åŠ ä¸Šæ ‡ç­¾ -o, --output string: æŒ‡å®šè¾“å‡ºæ ¼å¼ï¼Œæ”¯æŒ\u0026rsquo;table\u0026rsquo;ã€\u0026lsquo;json\u0026rsquo;å’Œ\u0026rsquo;yaml\u0026rsquo;ï¼› -l, --selector labelSelector: å¯¹æŒ‡å®šæ ‡ç­¾çš„èµ„æºè¿›è¡Œå¤‡ä»½ --snapshot-volumes optionalBool[=true]: å¯¹ PV åˆ›å»ºå¿«ç…§ --storage-location string: æŒ‡å®šå¤‡ä»½çš„ä½ç½® --ttl duration: å¤‡ä»½æ•°æ®å¤šä¹…åˆ æ‰ --volume-snapshot-locations strings: æŒ‡å®šå¿«ç…§çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å“ªä¸€ä¸ªå…¬æœ‰äº‘é©±åŠ¨ é€šå¸¸ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å‘½ä»¤å³å¯ã€‚\n1velero backup create \u0026lt;name\u0026gt; æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨\n1velero backup get å®šæ—¶å¤‡ä»½\n1# åˆ›å»ºå®šæ—¶å¤‡ä»½è®¡åˆ’ 2velero schedule create k8s-daily --schedule=\u0026#34;0 1 * * *\u0026#34; 3 4# æŸ¥çœ‹å®šæ—¶å¤‡ä»½è®¡åˆ’ 5velero schedule get æ¢å¤ velero restore çš„è¡Œä¸ºä¸æ˜¯è¦†ç›–ï¼Œæ˜¯æ¢å¤ï¼Œä¸ä¼šè¦†ç›–å·²æœ‰çš„èµ„æºï¼Œåªæ¢å¤å½“å‰é›†ç¾¤ä¸­ä¸å­˜åœ¨çš„èµ„æºã€‚å·²æœ‰çš„èµ„æºä¸ä¼šå›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå¦‚éœ€è¦å›æ»šï¼Œéœ€åœ¨restoreä¹‹å‰æå‰åˆ é™¤ç°æœ‰çš„èµ„æºã€‚\n1velero restore create --from-backup \u0026lt;name\u0026gt; å…¶ä»–å‘½ä»¤ 1# æŸ¥çœ‹å¤‡ä»½ä½ç½® 2velero get backup-locations 3 4NAME PROVIDER BUCKET/PREFIX PHASE LAST VALIDATED ACCESS MODE DEFAULT 5default aws finley007 Available 2022-03-10 22:23:28 +0800 CST ReadWrite true 6 7# æŸ¥çœ‹å·²æœ‰æ¢å¤ 8velero get restores 9 10# æŸ¥çœ‹ velero æ’ä»¶ 11velero get plugins 12 13# åˆ é™¤ velero å¤‡ä»½ 14velero backup delete nginx-backup 15 16# æŒä¹…å·å¤‡ä»½ 17velero backup create nginx-backup-volume --snapshot-volumes --include-namespaces nginx-example 18 19# æŒä¹…å·æ¢å¤ 20velero restore create --from-backup nginx-backup-volume --restore-volumes 21 22# åˆ›å»ºé›†ç¾¤æ‰€æœ‰namespaceså¤‡ä»½ï¼Œä½†æ’é™¤ velero,metallb-system å‘½åç©ºé—´ 23velero backup create all-ns-backup --snapshot-volumes=false --exclude-namespaces velero,metallb-system 24 25# å‘¨æœŸæ€§å®šæ—¶å¤‡ä»½ 26# æ¯æ—¥3ç‚¹è¿›è¡Œå¤‡ä»½ 27velero schedule create \u0026lt;SCHEDULE NAME\u0026gt; --schedule \u0026#34;0 3 * * *\u0026#34; 28 29# æ¯æ—¥3ç‚¹è¿›è¡Œå¤‡ä»½ï¼Œå¤‡ä»½ä¿ç•™48å°æ—¶ï¼Œé»˜è®¤ä¿ç•™30å¤© 30velero schedule create \u0026lt;SCHEDULE NAME\u0026gt; --schedule \u0026#34;0 3 * * *\u0026#34; --ttl 48 31 32# æ¯6å°æ—¶è¿›è¡Œä¸€æ¬¡å¤‡ä»½ 33velero create schedule \u0026lt;SCHEDULE NAME\u0026gt; --schedule=\u0026#34;@every 6h\u0026#34; 34 35# æ¯æ—¥å¯¹ web namespace è¿›è¡Œä¸€æ¬¡å¤‡ä»½ 36velero create schedule \u0026lt;SCHEDULE NAME\u0026gt; --schedule=\u0026#34;@every 24h\u0026#34; --include-namespaces web è¿ç§» 1# åœ¨é›†ç¾¤1ä¸Šåšä¸€ä¸ªå¤‡ä»½ï¼š 2$ velero backup create \u0026lt;BACKUP-NAME\u0026gt; --snapshot-volumes 3 4# åœ¨é›†ç¾¤2ä¸Šåšä¸€ä¸ªæ¢å¤ï¼š 5$ velero restore create --from-backup \u0026lt;BACKUP-NAME\u0026gt; --restore-volumes 6 7# velero æ¸…ç† 8$ kubectl delete namespace/velero clusterrolebinding/velero 9$ kubectl delete crds -l component=velero å‚è€ƒèµ„æ–™ https://www.cnblogs.com/wubolive/p/17345716.html https://mafeifan.com/DevOps/K8s/k8s-%E5%9F%BA%E7%A1%80-%E4%BD%BF%E7%94%A8Velero%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E9%9B%86%E7%BE%A4.html ","permalink":"/tech/kubernetes/%E5%9F%BA%E4%BA%8E-velero-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D-k8s-%E9%9B%86%E7%BE%A4/","summary":"\u003ch1 id=\"velero-å®‰è£…æ­¥éª¤\"\u003eVelero å®‰è£…æ­¥éª¤\u003c/h1\u003e\n\u003ch2 id=\"å®¢æˆ·ç«¯\"\u003eå®¢æˆ·ç«¯\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/vmware-tanzu/velero/releases\"\u003ehttps://github.com/vmware-tanzu/velero/releases\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eä¸‹è½½å¹¶å®‰è£…æœ€æ–°ç‰ˆæœ¬äºŒè¿›åˆ¶å®¢æˆ·ç«¯ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003ecp velero /usr/local/bin \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e chmod +x /usr/local/bin/velero\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003evelero version\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003eClient:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e        Version: v1.13.2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e        Git commit: 4d961fb6fec384ed7f3c1b7c65c818106107f5a6\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u0026lt;error getting server version: no matches \u003cspan class=\"k\"\u003efor\u003c/span\u003e kind \u003cspan class=\"s2\"\u003e\u0026#34;ServerStatusRequest\u0026#34;\u003c/span\u003e in version \u003cspan class=\"s2\"\u003e\u0026#34;velero.io/v1\u0026#34;\u003c/span\u003e\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"æœåŠ¡ç«¯\"\u003eæœåŠ¡ç«¯\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eå‡†å¤‡å¥½ç§˜é’¥æ–‡ä»¶ \u003ccode\u003ecredentials-velero\u003c/code\u003e ï¼Œå³ MinIO çš„ç”¨æˆ·åå¯†ç ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e[default]\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eaws_access_key_id=\u0026lt;access key id\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003eaws_secret_access_key=\u0026lt;secret access key\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003eä½¿ç”¨ \u003ccode\u003evelero install\u003c/code\u003e å®‰è£…æœåŠ¡ç«¯\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003evelero install \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --provider aws \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --image velero/velero:v1.13.2 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --plugins velero/velero-plugin-for-aws:v1.9.2 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --bucket velero \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --secret-file ./credentials-velero \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --use-node-agent \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --use-volume-snapshots\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003efalse\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --namespace velero \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --backup-location-config \u003cspan class=\"nv\"\u003eregion\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eminio,s3ForcePathStyle\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e,s3Url\u003cspan class=\"o\"\u003e=\u003c/span\u003ehttp://10.101.6.118:9000 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  --wait\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003evelero  version\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003eClient:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e        Version: v1.13.2\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e        Git commit: 4d961fb6fec384ed7f3c1b7c65c818106107f5a6\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003eServer:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e        Version: v1.13.2\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch1 id=\"velero-ä½¿ç”¨\"\u003eVelero ä½¿ç”¨\u003c/h1\u003e\n\u003ch2 id=\"å¤‡ä»½\"\u003eå¤‡ä»½\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003evelero create backup NAME [flags]\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003ebackupé€‰é¡¹ï¼š\u003c/strong\u003e\u003c/p\u003e","title":"åŸºäº Velero å¤‡ä»½ä¸æ¢å¤ K8s é›†ç¾¤"},{"content":"Docker ç™»å½•ç§æœ‰ä»“åº“ é¦–å…ˆé…ç½®ç§æœ‰ä»“åº“å… ssl éªŒè¯ 1{ 2 \u0026#34;insecure-registries\u0026#34;: [\u0026#34;szharbor.xxx.cn\u0026#34;] 3} è¾“å…¥ç”¨æˆ·åå¯†ç å¹¶ç™»å½• 1docker login szharbor.xxx.cn æŸ¥çœ‹ç™»å½•æˆåŠŸåçš„ Docker è®¤è¯æ–‡ä»¶ 1cat ~/.docker/config.json 1{ 2\t\u0026#34;auths\u0026#34;: { 3\t\u0026#34;szharbor.xxx.cn\u0026#34;: { 4\t\u0026#34;auth\u0026#34;: \u0026#34;cm...nVVM=\u0026#34; 5\t} 6\t} 7} å‹ç¼©ï¼Œbase64ç¼–ç  1{\u0026#34;auths\u0026#34;:{\u0026#34;szharbor.xxx.cn\u0026#34;:{\u0026#34;auth\u0026#34;:\u0026#34;cm9ib3QkaGllbXNfZGV2K3ByaXY6Rk1iSXQ5bFI2RXA5bDd6cU9pUU1MYUg5eVdQWnFnVVM=\u0026#34;}}} 1eyJhdXRocyI6eyJzemhhcmJvci5oaXRoaXVtLmNuIjp7ImF1dGgiOiJjbTlpYjNRa2FHbGxiWE5mWkdWMkszQnlhWFk2UmsxaVNYUTViRkkyUlhBNWJEZDZjVTlwVVUxTVlVZzVlVmRRV25GblZWTT0ifX19 harbor\n1eyJhdXRocyI6eyIxMC4xMDEuNy4xMDg6ODAiOnsiYXV0aCI6ImVtaDFZVzVuY1dZNlFFQXhXR2xoYjNOb1lXZDFZUT09In19fQ== åˆ›å»º imagePullSecret 1apiVersion: v1 2kind: Secret 3metadata: 4 name: harbor-secret 5 namespace: szhems 6data: 7 .dockerconfigjson: eyJhdXRocyI6eyJzemhhcmJvci5oaXRoaXVtLmNuIjp7ImF1dGgiOiJjbTlpYjNRa2FHbGxiWE5mWkdWMkszQnlhWFk2UmsxaVNYUTViRkkyUlhBNWJEZDZjVTlwVVUxTVlVZzVlVmRRV25GblZWTT0ifX19 8type: kubernetes.io/dockerconfigjson å°† secret ä¸ account ç»‘å®š\n1apiVersion: v1 2kind: ServiceAccount 3metadata: 4 namespace: szhems 5 name: find-endpoints 6imagePullSecrets: 7 - name: harbor-secret æˆ–è€…ç›´æ¥å°† secret ä¸ deployment è¿›è¡Œç»‘å®š\n1apiVersion: apps/v1 2kind: Deployment 3metadata: 4 name: assets-api 5 namespace: szhems 6 labels: 7 app: assets-api 8spec: 9 selector: 10 matchLabels: 11 app: assets-api 12 template: 13 metadata: 14 labels: 15 app: assets-api 16 spec: 17 serviceAccountName: find-endpoints 18 imagePullSecrets: 19 - name: harbor 20 containers: 21 - name: assets-api 22 image: 10.101.7.108:80/szhems_dev/be_assets_api:0.1.0.210 ","permalink":"/tech/kubernetes/%E5%9F%BA%E4%BA%8E-imagepullsecret-%E4%B8%8B%E8%BD%BD%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%88%B6%E5%93%81/","summary":"\u003ch1 id=\"docker-ç™»å½•ç§æœ‰ä»“åº“\"\u003eDocker ç™»å½•ç§æœ‰ä»“åº“\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé¦–å…ˆé…ç½®ç§æœ‰ä»“åº“å… ssl éªŒè¯\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-json\" data-lang=\"json\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nt\"\u003e\u0026#34;insecure-registries\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;szharbor.xxx.cn\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eè¾“å…¥ç”¨æˆ·åå¯†ç å¹¶ç™»å½•\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker login szharbor.xxx.cn\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003e\u003cstrong\u003eæŸ¥çœ‹ç™»å½•æˆåŠŸåçš„ Docker è®¤è¯æ–‡ä»¶\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003ecat ~/.docker/config.json\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-json\" data-lang=\"json\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nt\"\u003e\u0026#34;auths\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nt\"\u003e\u0026#34;szharbor.xxx.cn\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"nt\"\u003e\u0026#34;auth\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;cm...nVVM=\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"4\"\u003e\n\u003cli\u003e\u003cstrong\u003eå‹ç¼©ï¼Œbase64ç¼–ç \u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e{\u0026#34;auths\u0026#34;:{\u0026#34;szharbor.xxx.cn\u0026#34;:{\u0026#34;auth\u0026#34;:\u0026#34;cm9ib3QkaGllbXNfZGV2K3ByaXY6Rk1iSXQ5bFI2RXA5bDd6cU9pUU1MYUg5eVdQWnFnVVM=\u0026#34;}}}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eeyJhdXRocyI6eyJzemhhcmJvci5oaXRoaXVtLmNuIjp7ImF1dGgiOiJjbTlpYjNRa2FHbGxiWE5mWkdWMkszQnlhWFk2UmsxaVNYUTViRkkyUlhBNWJEZDZjVTlwVVUxTVlVZzVlVmRRV25GblZWTT0ifX19\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eharbor\u003c/p\u003e","title":"åŸºäº imagePullSecret ä¸‹è½½ç§æœ‰é•œåƒä»“åº“åˆ¶å“"},{"content":"Kubernetes ç½‘ç»œçš„åŠŸèƒ½ï¼š\né«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« Pods å’ŒÂ localhostÂ é€šä¿¡è§£å†³äº†ã€‚ Pod é—´é€šä¿¡ï¼› Pod å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼› å¤–éƒ¨å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼› Kubernetes æœ¬èº«çš„ç½‘ç»œæœåŠ¡è‡ªå¸¦äº†ä¸€ä¸‹åŠŸèƒ½ï¼š\nNAT: ç½‘ç»œåœ°å€è½¬æ¢ Source NAT: æ›¿æ¢æ•°æ®åŒ…çš„æº IP, é€šå¸¸ä¸ºèŠ‚ç‚¹çš„ IP Destination NAT: æ›¿æ¢æ•°æ®åŒ…çš„ç›®çš„ IP, é€šå¸¸ä¸º Pod çš„ IP VIP: ä¸€ä¸ªè™šæ‹Ÿ IP, ä¾‹å¦‚åˆ†é…ç»™æ¯ä¸ª Kubernetes Service çš„ IP Kube-proxy: ä¸€ä¸ªç½‘ç»œå®ˆæŠ¤ç¨‹åºï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåè°ƒ Service VIP ç®¡ç† å¯å‚è€ƒÂ https://kubernetes.io/zh/docs/tutorials/services/source-ip/\n1. Pod IP å¯¹äº Docker ä¸­çš„ container ç½‘ç»œã€‚å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªå®¹å™¨çš„ç½‘ç»œæ¥å£ï¼Œå®ç°å¤šä¸ªå®¹å™¨å…±äº«ç½‘ç»œã€åŒä¸€ä¸ª IPã€åŒä¸€ä¸ª hostnameã€‚\nK8S ä¸­ Pod å†…å¤šå®¹å™¨å…±äº«ç½‘ç»œå°±æ˜¯è¿™æ ·åˆ›å»ºçš„ï¼ŒPod çš„ IP æ˜¯ Docker åˆ›å»ºå’Œåˆ†é…çš„å®¹å™¨ IPï¼Œè¿™ä¸ª IP æ˜¯å¸¦è™šæ‹Ÿç½‘å¡çš„ï¼Œå› æ­¤è¿™ä¸ª IP æ˜¯å¯ä»¥è¢« ping çš„ï¼Œä½†æ˜¯è¯¥ IP åªèƒ½åœ¨å½“å‰èŠ‚ç‚¹ä¸­è¢«è®¿é—®ã€‚\né¦–å…ˆï¼Œåˆ›å»º Pod æ—¶ï¼ŒPod ä¼šå¯åŠ¨ä¸€ä¸ª pause å®¹å™¨ï¼Œè¯¥å®¹å™¨åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå¹¶è¢« Docker åˆ†é… IPï¼Œæ¥ç€ Pod çš„å®¹å™¨ä¼šä½¿ç”¨ container ç½‘ç»œæ¨¡å¼è¿æ¥åˆ°è¿™ä¸ª pause å®¹å™¨ä¸­ï¼Œpause å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸè·Ÿ Pod çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ã€‚\nåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šä½¿ç”¨Â docker ps -a | grep pauseÂ å‘½ä»¤æŸ¥çœ‹ pause å®¹å™¨ï¼š\n1[root@test-60g ~]# minikube ssh 2docker@minikube:~$ docker ps -a |grep pause 367461274c207 registry.k8s.io/pause:3.9 \u0026#34;/pause\u0026#34; 25 hours ago Up 25 hours k8s_POD_nginx-7cf478bb58-h6zq9_default_4df3bc0f-7efa-4ef1-9d46-e6b300143eeb_2 4... ä¸è¿‡ï¼ŒDocker ä¸­çš„å®¹å™¨ IP æ˜¯ 172.17.0.0 åœ°å€æ®µï¼Œè€Œ Pod IP çš„åœ°å€æ®µä¸€èˆ¬æ˜¯ 10.x.x.x ç½‘ç»œï¼Œå…¶ä¸­ç”¨æˆ·è‡ªå®šä¹‰ Pod æ˜¯ 10.32.0.0 åœ°å€æ®µã€‚\nPod çš„ IP æ˜¯ Docker åˆ†é…çš„ï¼Œä¸ºä»€ä¹ˆå…¶åœ°å€ä¸æ˜¯ 172.17.0.0 åœ°å€æ®µï¼Ÿ\né¦–å…ˆï¼Œåœ¨éƒ¨ç½²äº† Docker çš„æœºå™¨ä¸Šï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªåä¸º docker0 çš„ç½‘æ¡¥ã€‚\n1docker0: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1500 2 inet 172.17.0.1 netmask 255.255.0.0 broadcast 172.17.255.255 3 inet6 fe80::42:2aff:fe00:6577 prefixlen 64 scopeid 0x20\u0026lt;link\u0026gt; 4 ether 02:42:2a:00:65:77 txqueuelen 0 (Ethernet) 5 RX packets 4404 bytes 155753 (152.1 KiB) 6 RX errors 0 dropped 0 overruns 0 frame 0 7 TX packets 3340 bytes 158865 (155.1 KiB) 8 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 docker çš„é»˜è®¤ç½‘æ¡¥å« docker0ï¼Œè¿™ä¸ªç½‘æ¡¥çš„ IP æ˜¯ 172.17.0.1ï¼ŒåŸºäºè¿™ä¸ªç½‘æ¡¥åˆ›å»ºçš„å®¹å™¨çš„è™šæ‹Ÿç½‘å¡è‡ªç„¶æ˜¯ 172.17.0.0 åœ°å€æ®µã€‚\nè€Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ weava ç½‘ç»œæ’ä»¶éƒ¨ç½²é›†ç¾¤ï¼Œé‚£ä¹ˆä½¿ç”¨ ifconfig å‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ª weava çš„è‡ªå®šä¹‰ç½‘æ¡¥ï¼š\n1weave: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1376 2 inet 10.32.0.1 netmask 255.240.0.0 broadcast 10.47.255.255 3 inet6 fe80::ac45:ebff:fe0a:31ae prefixlen 64 scopeid 0x20\u0026lt;link\u0026gt; 4 ether ae:45:eb:0a:31:ae txqueuelen 1000 (Ethernet) 5 RX packets 2905588 bytes 391313728 (391.3 MB) 6 RX errors 0 dropped 0 overruns 0 frame 0 7 TX packets 3179102 bytes 640814125 (640.8 MB) 8 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 é€šè¿‡ Kubernetes åˆ›å»ºçš„è‡ªå®šä¹‰ Podï¼Œä¼šä½¿ç”¨è¿™ä¸ªç½‘æ¡¥åˆ›å»º IPï¼Œå…¶ IP åœ°å€è·Ÿç½‘ç»œæ’ä»¶åˆ›å»ºçš„ç½‘æ¡¥æœ‰å…³ã€‚\næ›´å¤šçš„ Docker ç½‘ç»œçŸ¥è¯†:Â https://docs.docker.com/network/bridge/\nè·¨èŠ‚ç‚¹è®¿é—® Pod æ—¢ç„¶ Pod çš„ IP æ˜¯ Docker åˆ›å»ºçš„ï¼Œè€Œ Docker åˆ›å»ºçš„ IP åªèƒ½åœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šè®¿é—®ï¼Œé‚£ä¹ˆæ€ä¹ˆæ‰èƒ½åœ¨åˆ«çš„èŠ‚ç‚¹ä¸Šè®¿é—®è¿™ä¸ª Pod IPï¼Ÿ\nç½‘ç»œæ’ä»¶ï¼Œé™¤äº† weave ï¼Œè¿˜æœ‰å¾ˆå¤šç½‘ç»œæ’ä»¶å¯ä»¥ä½¿ç”¨ï¼Œå¦‚ calicoã€flannelã€‚Kubernetes ç½‘ç»œæ¨¡å‹ä¸­æœ‰ä¸ªå« CNI çš„æ ‡å‡†æ¥å£ï¼Œåªè¦å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œç”¨å•¥ç½‘ç»œæ’ä»¶éƒ½æ²¡é—®é¢˜ï¼Œä½¿ç”¨è€…ä¸éœ€è¦å…³å¿ƒæ’ä»¶æ˜¯æ€ä¹ˆå®ç°çš„ã€‚\nCNI çš„ä¸»è¦åŠŸèƒ½ï¼š\nèŠ‚ç‚¹ä¸Šçš„ Pod å¯ä»¥ä¸é€šè¿‡ NAT å’Œå…¶ä»–ä»»ä½•èŠ‚ç‚¹ä¸Šçš„ Pod é€šä¿¡(ç§°ä¸ºæ‰å¹³åŒ–ç½‘ç»œ)ï¼Œå³èŠ‚ç‚¹é—´ Pod çš„äº’ç›¸è®¿é—®ï¼› èŠ‚ç‚¹ä¸Šçš„ä»£ç†ï¼ˆæ¯”å¦‚ï¼šç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ã€kubeletï¼‰å¯ä»¥å’ŒèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Pod é€šä¿¡ï¼Œå³ç³»ç»Ÿç»„ä»¶è®¿é—® Podï¼› 2. Service Service æ˜¯ Kubernetes çš„å¯¹è±¡ï¼Œå®ƒè·Ÿç½‘ç»œæœ‰å…³ï¼Œ Service ä¸æ˜¯æœåŠ¡æä¾›è€…ï¼Œä¹Ÿä¸æ˜¯åº”ç”¨ç¨‹åºæ¥å£ã€‚\nService æ˜¯å°†è¿è¡Œåœ¨ä¸€ç»„ Pods ä¸Šçš„åº”ç”¨ç¨‹åºï¼Œå…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æŠ½è±¡æ–¹æ³•ã€‚\nå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Deployment ã€Daemon ç­‰éƒ¨ç½² Podï¼Œåˆ™å¯ä¸ºæ­¤æ§åˆ¶å™¨åˆ›å»º Serviceï¼ŒService ä¼šç›‘æ§æ­¤ Deployment ä¸Šå¢åŠ æˆ–ç§»é™¤ Pod çš„æ“ä½œï¼Œè‡ªåŠ¨ä¸ºæ‰€æœ‰ Pod æä¾›ç½‘ç»œæœåŠ¡ã€‚å½“ç„¶ï¼ŒService å¹¶ä¸æ˜¯æŒ‡å‘ Deploymentã€Daemon çš„ï¼Œè€Œæ˜¯é€šè¿‡ Label æŒ‡å‘ç›¸å…³çš„ Podã€‚\n2.1 Service çš„å®šä¹‰å’Œåˆ›å»º æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Deployment å¯¹è±¡ï¼ŒåŒ…å«ä¸‰ä¸ª Pod å®ä¾‹ã€‚\n1kubectl create deployment nginx --image=nginx:latest --replicas=3 æ¥ç€ï¼Œä¸ºè¿™äº› Pod åˆ›å»ºä¸€ä¸ª Serviceã€‚\n1kubectl expose deployment nginx --type=ClusterIP --port=6666 --target-port=80 æŸ¥çœ‹åˆ›å»ºçš„ Serviceï¼š\n1[root@zqf-master1 ~]# k get svc -o wide 2NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR 3kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 17m \u0026lt;none\u0026gt; 4nginx ClusterIP 10.101.6.208 \u0026lt;none\u0026gt; 6666/TCP 7s app=nginx å¯ä»¥çœ‹åˆ°ï¼ŒService ä¼šç”Ÿæˆä¸€ä¸ªéšæœº IPÂ 10.101.6.208ï¼Œæˆ‘ä»¬ä¸º Pod æ˜ å°„äº†ä¸€ä¸ªæ–°çš„ç«¯å£ä¸º 6666ï¼Œæ­¤ç«¯å£æ˜ å°„åˆ°äº† Pod çš„ 80 ç«¯å£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•è¿™ä¸ª IP å’Œ ç«¯å£æ˜¯å¦å¯ç”¨ï¼š\n1[root@zqf-master1 ~]# curl 10.101.6.208:6666 2\u0026lt;!DOCTYPE html\u0026gt; 3\u0026lt;html\u0026gt; 4\u0026lt;head\u0026gt; 5\u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; 6\u0026lt;style\u0026gt; 7html { color-scheme: light dark; } 8body { width: 35em; margin: 0 auto; 9font-family: Tahoma, Verdana, Arial, sans-serif; } 10\u0026lt;/style\u0026gt; 11\u0026lt;/head\u0026gt; 12\u0026lt;body\u0026gt; 13\u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; 14\u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and 15working. Further configuration is required.\u0026lt;/p\u0026gt; 16 17\u0026lt;p\u0026gt;For online documentation and support please refer to 18\u0026lt;a href=\u0026#34;http://nginx.org/\u0026#34;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; 19Commercial support is available at 20\u0026lt;a href=\u0026#34;http://nginx.com/\u0026#34;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; 21 22\u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; 23\u0026lt;/body\u0026gt; 24\u0026lt;/html\u0026gt; åœ¨æ²¡æœ‰å®‰è£…ç½‘ç»œæ’ä»¶çš„å‰æä¸‹ï¼Œå‡å¦‚æœ‰ masterã€slave ä¸¤ä¸ªèŠ‚ç‚¹ï¼ŒPod éƒ½è¢«éƒ¨ç½²åˆ° slave èŠ‚ç‚¹ä¸Šï¼Œè€Œ master èŠ‚ç‚¹æ²¡æœ‰éƒ¨ç½²æ­¤ Pod çš„è¯ï¼Œmaster æ˜¯è®¿é—®ä¸äº†æ­¤ Serviceçš„ã€‚\nä¸ºäº†éªŒè¯è¿™æ ·æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æ¶ˆå» master çš„æ±¡ç‚¹ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«éƒ¨ç½²ç”¨æˆ·è‡ªå®šä¹‰çš„ Podã€‚\n1kubectl taint node zqf-master1 node-role.kubernetes.io/control-plane:NoSchedule- ç„¶åé‡æ–°éƒ¨ç½² Deploymentï¼Œä½†æ˜¯ä¸éœ€è¦é‡æ–°éƒ¨ç½² Serviceã€‚\n1kubectl delete deployyment nginx 2kubectl create deployment nginx --image=nginx:latest --replicas=3 æŸ¥çœ‹è¿™äº› Pod éƒ½è¢«éƒ¨ç½²åˆ°å“ªé‡Œï¼š\n1[root@zqf-master1 ~]# k get po -o wide 2NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES 3nginx-56fcf95486-lg4bf 0/1 ContainerCreating 0 5s \u0026lt;none\u0026gt; zqf-slave1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; 4nginx-56fcf95486-m5v5b 0/1 ContainerCreating 0 5s \u0026lt;none\u0026gt; zqf-master1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; 5nginx-56fcf95486-vjk2p 0/1 ContainerCreating 0 5s \u0026lt;none\u0026gt; zqf-slave1 \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; ç°åœ¨ï¼Œmasterã€slave éƒ½éƒ¨ç½²äº† Podï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ master èŠ‚ç‚¹ä¸Šè®¿é—®æ­¤ Serviceï¼Œå¯ä»¥æ­£å¸¸è®¿é—®ã€‚\nåœ¨ Deployment å¯¹è±¡ä¸Šåˆ›å»º Serviceï¼Œä¼šç›´æ¥å…³è”ä¸€ä¸ª Deployment ä¸­çš„æ‰€æœ‰ Podï¼Œå¹¶ç›‘æ§æ˜¯å¦æœ‰æ–°å»ºæˆ–ç§»é™¤ Pod ï¼Œæ— è®º Pod çš„æ•°é‡æœ‰å¤šå°‘ï¼ŒService éƒ½å¯ä»¥ä»£ç†è¿™äº› Podã€‚\nå¦‚æœæˆ‘ä»¬é€šè¿‡ YAML å®šä¹‰ Serviceï¼Œå…¶æ¨¡æ¿å¦‚ä¸‹ï¼š\n1apiVersion: v1 2kind: Service 3metadata: 4 name: my-service 5spec: 6 selector: 7 app: MyApp 8 ports: 9 - protocol: TCP 10 port: 6666 11 targetPort: 80 12 type: ClusterIP ç”±äº Service çš„ IP æ˜¯è™šæ‹Ÿçš„ï¼Œå› æ­¤æ­¤ IP æ˜¯æ— æ³• Ping é€šçš„ã€‚\n2.2 Service å¤–éƒ¨æœåŠ¡ç±»å‹ è™½ç„¶åˆ›å»ºäº† Service åï¼Œæ‰€æœ‰çš„ Pod å¯ä»¥è¢«ä¸€ä¸ª IP åœ°å€è®¿é—®ï¼Œä½†æ˜¯è¿™ä¸ª IP åªèƒ½åœ¨è¢«éƒ¨ç½²äº† Pod çš„èŠ‚ç‚¹ä¸­è®¿é—®ï¼Œ ä¸èƒ½è¢«é›†ç¾¤å¤–è®¿é—®ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åˆ›å»º Service çš„æ—¶å€™ï¼Œä½¿ç”¨äº† ClusterIP ç±»å‹ï¼Œå¦‚æœæ˜¯ NodePort ç±»å‹ï¼Œåˆ™å¯ä»¥è¢«å¤–ç•Œè®¿é—®åˆ°ã€‚\nKubernetes Service æœ‰ä¸ª ServiceType ï¼Œå…è®¸æˆ‘ä»¬æŒ‡å®šå¦‚ä½•æš´éœ²æœåŠ¡ï¼Œå¯ä»¥å°†ä¸€ä¸ª Service æš´éœ²åˆ°é›†ç¾¤å¤–éƒ¨ï¼Œå¤–ç•Œå¯ä»¥é€šè¿‡ IP è®¿é—®è¿™ä¸ª Serviceã€‚\nType æœ‰å››ç§ç±»å‹ï¼Œå…¶å–å€¼è¯´æ˜å¦‚ä¸‹ï¼š\nClusterIPï¼šé€šè¿‡é›†ç¾¤å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼ŒClusterIP æ˜¯ ServiceType çš„é»˜è®¤å€¼ã€‚ NodePortï¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ IP å’Œé™æ€ç«¯å£ï¼ˆNodePortï¼‰æš´éœ²æœåŠ¡ã€‚ç”±äºå…¶æ˜¯èŠ‚ç‚¹ä¸Šçš„ ï¼Œæ‰€ä»¥å…·æœ‰é€šè¿‡èŠ‚ç‚¹çš„å…¬ç½‘ IP è®¿é—®è¿™ä¸ªæœåŠ¡ã€‚ LoadBalancerï¼šä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä»¥å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„Â NodePortÂ æœåŠ¡å’ŒÂ ClusterIPÂ æœåŠ¡ä¸Šã€‚éœ€è¦äº‘å¹³å°æœåŠ¡æä¾›å•†çš„æ”¯æŒï¼Œåˆ†é…å…¬ç½‘ IP æ‰èƒ½ä½¿ç”¨ã€‚ ExternalNameï¼šé€šè¿‡è¿”å›Â CNAMEÂ å’Œå¯¹åº”å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ°Â externalNameÂ å­—æ®µçš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œfoo.bar.example.comï¼‰ã€‚ éœ€è¦ä½¿ç”¨ kube-dns 1.7 åŠä»¥ä¸Šç‰ˆæœ¬æˆ–è€… CoreDNS 0.0.8 åŠä»¥ä¸Šç‰ˆæœ¬æ‰èƒ½ä½¿ç”¨Â ExternalNameÂ ç±»å‹ã€‚\nClusterIPã€NodePortã€LoadBalancer ä¸‰è€…æ˜¯æœ‰å…³ç³»çš„ï¼Œå‰è€…æ˜¯åè€…çš„åŸºç¡€ã€‚åˆ›å»ºä¸€ä¸ª NodePort ç±»å‹çš„ Serviceï¼Œå¿…å®šå¸¦æœ‰ä¸€ä¸ª ClusterIPï¼›åˆ›å»ºä¸€ä¸ª LoadBalancerï¼Œå¿…å®šå¸¦æœ‰ ClusterIPã€NodePortã€‚\n2.2.1 NodePort å°†å‰é¢åˆ›å»ºçš„ Service ä¿®æ”¹ä¸º NodePort ç±»å‹\n1kubectl edit service nginx ç„¶åæŸ¥çœ‹ Service åˆ—è¡¨ï¼š\n1[root@zqf-master1 ~]# k get svc -o wide 2NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR 3kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 33m \u0026lt;none\u0026gt; 4nginx NodePort 10.101.6.208 \u0026lt;none\u0026gt; 6666:31292/TCP 16m app=nginx æ­¤æ—¶ Service ä¼šåˆ›å»ºä¸€ä¸ª éšæœºç«¯å£ï¼Œè¿™ä¸ªç«¯å£æ˜ å°„åˆ°æ¯ä¸ªéƒ¨ç½²äº† Pod çš„èŠ‚ç‚¹ä¸Šï¼Œæ ·ä¾‹ä¸­æ˜¯31292ï¼Œæ­¤æ—¶å¤–ç•Œå¯ä»¥é€šè¿‡ä½¿ç”¨èŠ‚ç‚¹ IP è®¿é—®æ­¤ Serviceã€‚\næ­¤æ—¶ï¼Œå¯ä»¥åœ¨é›†ç¾¤å…¶ä»–æœºå™¨è®¿é—®ä¸¤å°èŠ‚ç‚¹ IP http://10.101.5.219:31292/ å’Œ http://10.101.5.220:31292/ å¯ä»¥æ­£å¸¸è¿”å› nginx ç½‘é¡µã€‚\n2.2.2 LoadBalancer ç°åœ¨ Pod è´Ÿè½½å‡è¡¡äº†ï¼Œä½†ä¸èƒ½åªè®¿é—®ä¸€ä¸ªèŠ‚ç‚¹ï¼ŸèŠ‚ç‚¹çš„ç½‘ç»œä¹Ÿéœ€è¦è´Ÿè½½å‡è¡¡ï¼Œè€Œä¸”èŠ‚ç‚¹ IP è¿™ä¹ˆå¤šï¼Œç”¨æˆ·æ€»ä¸èƒ½è®°ä½è¿™ä¹ˆå¤š IP ï¼Ÿå°±ç®—ä½¿ç”¨åŸŸåï¼ŒåŸŸåä¹Ÿä¸èƒ½ç»‘å®šè¿™ä¹ˆå¤š IP å‘€ï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨ LoadBalancer ã€‚\nåˆ é™¤ä¹‹å‰çš„ service ï¼Œé‡æ–°åˆ›å»ºã€‚\n1kubectl expose deployment nginx --type=LoadBalancer --port=6666 --target-port=80 å¦‚æœåªå¡«å†™ \u0026ndash;port ï¼Œæ­¤æ—¶æ˜ å°„çš„ç«¯å£è·Ÿ Pod ç«¯å£ä¸€è‡´\n1[root@zqf-master1 ~]# k get svc 2NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE 3kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 54m 4nginx LoadBalancer 10.106.1.221 \u0026lt;pending\u0026gt; 6666:31960/TCP 19s å½“ä½¿ç”¨ LoadBalancer æš´éœ²æœåŠ¡åˆ°é›†ç¾¤å¤–éƒ¨ç½‘ç»œæ—¶ï¼Œäº‘åŸºç¡€è®¾æ–½éœ€è¦æ—¶é—´æ¥åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨å¹¶è·å–æœåŠ¡ä¸­çš„ IP åœ°å€ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯Â minikubeã€kubeadmÂ ç­‰åˆ›å»ºçš„è‡ªå®šä¹‰ Kubernetes é›†ç¾¤ï¼Œæ²¡æœ‰é›†æˆ LoadBalancer ï¼Œåˆ™ä¼šä¸€ç›´å¤„äºÂ \u0026lt;Pending\u0026gt;Â çŠ¶æ€ã€‚\n2.3 Service å¦‚ä½•é€‰æ‹© Pod é€šè¿‡å‘½ä»¤æŸ¥çœ‹ iptables é…ç½®ï¼š\n1iptables-save åœ¨ç»ˆç«¯æ§åˆ¶å°ä¸­æŸ¥æ‰¾Â randomÂ å…³é”®å­—ï¼š\n1-A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment \u0026#34;default/nginx -\u0026gt; 172.16.41.201:80\u0026#34; -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-KVETUJWAGOYJMI5D 2-A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment \u0026#34;default/nginx -\u0026gt; 172.16.41.202:80\u0026#34; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-OGCI3CVDD3KXHXYJ 3-A KUBE-SVC-2CMXP7HKUVJN7L6M -m comment --comment \u0026#34;default/nginx -\u0026gt; 172.16.41.203:80\u0026#34; -j KUBE-SEP-PEONUJMSH5W46AFI æœ‰ä¸‰ä¸ªÂ default/nginxï¼Œ ç¬¬ä¸€ä¸ª pod è¢«è®¿é—®çš„æœºä¼šæ˜¯Â 0.33333...ã€‚åœ¨å‰©ä¸‹çš„ 2/3 çš„æ¦‚ç‡ä¸­ï¼Œæœ‰ 0.5 çš„æ¦‚ç‡é€‰æ‹©ç¬¬äºŒä¸ª Podï¼Œå‰©ä¸‹çš„ 1/3 æ¦‚ç‡é€‰æ‹©ç¬¬ä¸‰ä¸ª Podã€‚è¿™ç§éšæœºé€‰æ‹©çš„æ¨¡å¼ç§°ä¸º iptables ä»£ç†æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ kube-proxy çš„é»˜è®¤æ¨¡å¼ã€‚\n2.4 kube-proxy ä¸‰ç§ä»£ç†æ¨¡å¼ å½“æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤åˆ›å»ºä¸€ä¸ª Service æ—¶ï¼Œå¯çœ‹åˆ°æ¯ä¸ª Service éƒ½æœ‰ä¸€ä¸ª IP åœ°å€ï¼Œè¿™æ˜¯ç”± kube-proxy è´Ÿè´£ä¸º Service å®ç°çš„ä¸€ç§è™šæ‹Ÿ IP ï¼Œå³Â ClusterIPã€‚\nkube-proxy å¯ä»¥ä¸ºå¤šä¸ª Pod åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„ä»£ç†ï¼Œåœ¨è®¿é—® Service æ—¶ï¼Œè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ª Pod æä¾›æœåŠ¡ï¼Œè‡³äºå¦‚ä½•é€‰æ‹© Podï¼Œkube-proxy æœ‰ä¸‰ç§æ¨¡å¼ã€‚\nuserspace ä»£ç†æ¨¡å¼ iptables ä»£ç†æ¨¡å¼(é»˜è®¤) IPVS ä»£ç†æ¨¡å¼ï¼ˆKubernetes v1.11 ï¼Œå¦‚æœè¦ä½¿ç”¨ IPVSï¼Œéœ€è¦ä¿®æ”¹é…ç½®æ¿€æ´»ï¼‰ åœ¨è¿™äº›ä»£ç†æ¨¡å¼ä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸äº†è§£ Kubernetes æœåŠ¡æˆ– Pod çš„ä»»ä½•ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œå°† Port ä»£ç†åˆ°é€‚å½“çš„åç«¯ã€‚\n2.4.1 userspace ä»£ç†æ¨¡å¼ userspace æ¨¡å¼ä¸‹ï¼Œ kube-proxy é€šè¿‡è½®è½¬ç®—æ³•é€‰æ‹© podã€‚\nå¯¹æ¯ä¸ª Serviceï¼Œå®ƒä¼šåœ¨æœ¬åœ° Node ä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£(ç«¯å£å·å¤§äº 30000)ã€‚ ä»»ä½•è¿æ¥åˆ°æ­¤ç«¯å£çš„è¯·æ±‚ï¼Œéƒ½ä¼šè¢«ä»£ç†åˆ° Service åç«¯çš„æŸä¸ªÂ PodÂ ä¸Šã€‚ ä½¿ç”¨å“ªä¸ªåç«¯ Podï¼Œæ˜¯ kube-proxy åŸºäº YAML çš„Â SessionAffinityÂ ç»ˆç«¯æ¥ç¡®å®šçš„ã€‚\næœ€åï¼Œé…ç½® iptables è§„åˆ™ï¼Œæ•è·åˆ°è¾¾è¯¥ Service çš„Â clusterIPÂ å’ŒÂ PortÂ çš„è¯·æ±‚ï¼Œå¹¶é‡å®šå‘åˆ°ä»£ç†ç«¯å£ï¼Œä»£ç†ç«¯å£å†ä»£ç†è¯·æ±‚åˆ°åç«¯ Podã€‚\n1è®¿é—® -\u0026gt; clusterIP -\u0026gt; ä»£ç† -\u0026gt; ä»»ä¸€ Pod 2.4.2 iptables ä»£ç†æ¨¡å¼ kube-proxy é»˜è®¤æ¨¡å¼ã€‚iptables ä»£ç†æ¨¡å¼çš„ç­–ç•¥éšæœºé€‰æ‹©ä¸€ä¸ª Podã€‚\nå®ƒä¼šä¸ºæ¯ä¸ª Service é…ç½® iptables è§„åˆ™ï¼Œæ•è·æ‰€æœ‰è®¿é—®æ­¤ Service clusterIP çš„è¯·æ±‚ï¼Œè¿›è€Œå°†è¯·æ±‚é‡å®šå‘åˆ° Service çš„ä¸€ç»„åç«¯ä¸­çš„æŸä¸ª Pod ä¸Šé¢ã€‚ å¯¹äºæ¯ä¸ª Endpoints å¯¹è±¡ï¼Œå®ƒä¹Ÿä¼šé…ç½® iptables è§„åˆ™ï¼Œè¿™ä¸ªè§„åˆ™ä¼šé€‰æ‹©ä¸€ä¸ªåç«¯ç»„åˆã€‚\nä½¿ç”¨ iptables å¤„ç†æµé‡å…·æœ‰è¾ƒä½çš„ç³»ç»Ÿå¼€é”€ï¼Œå› ä¸ºæµé‡ç”± Linux netfilter å¤„ç†ï¼Œ è€Œæ— éœ€åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´åˆ‡æ¢ï¼Œ è¿™ç§æ–¹æ³•ä¹Ÿå¯èƒ½æ›´å¯é ã€‚\nå¦‚æœ kube-proxy åœ¨ iptables æ¨¡å¼ä¸‹è¿è¡Œï¼Œå¦‚æœéšæœºæ‰€é€‰çš„ç¬¬ä¸€ä¸ª Pod æ²¡æœ‰å“åº”ï¼Œ åˆ™è¿æ¥ä¼šå¤±è´¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨å…¶ä»–åç«¯ Pod é‡è¯• ã€‚\n2.4.3 IPVS ä»£ç†æ¨¡å¼ ä¸å…¶ä»–ä»£ç†æ¨¡å¼ç›¸æ¯”ï¼ŒIPVS æ¨¡å¼æ”¯æŒæ›´é«˜çš„ç½‘ç»œæµé‡ååé‡ã€‚ä¸ iptables æ¨¡å¼ä¸‹çš„ kube-proxy ç›¸æ¯”ï¼ŒIPVS æ¨¡å¼ä¸‹çš„ kube-proxy é‡å®šå‘é€šä¿¡çš„å»¶è¿Ÿè¦çŸ­ï¼Œå¹¶ä¸”åœ¨åŒæ­¥ä»£ç†è§„åˆ™æ—¶å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚\nIPVS æä¾›äº†æ›´å¤šé€‰é¡¹æ¥å¹³è¡¡åç«¯ Pod çš„æµé‡ã€‚ è¿™äº›æ˜¯ï¼š\nrrï¼šè½®æ›¿ï¼ˆRound-Robinï¼‰ lcï¼šæœ€å°‘é“¾æ¥ï¼ˆLeast Connectionï¼‰ï¼Œå³æ‰“å¼€é“¾æ¥æ•°é‡æœ€å°‘è€…ä¼˜å…ˆ dhï¼šç›®æ ‡åœ°å€å“ˆå¸Œï¼ˆDestination Hashingï¼‰ shï¼šæºåœ°å€å“ˆå¸Œï¼ˆSource Hashingï¼‰ sedï¼šæœ€çŸ­é¢„æœŸå»¶è¿Ÿï¼ˆShortest Expected Delayï¼‰ nqï¼šä»ä¸æ’é˜Ÿï¼ˆNever Queueï¼‰ Service æš´éœ²å¤šç«¯å£\nå¦‚æœè¦åœ¨ Service ä¸­æš´éœ²å¤šä¸ªç«¯å£ï¼Œåˆ™æ¯ä¸ªç«¯å£éƒ½éœ€è¦è®¾ç½®ä¸€ä¸ªåå­—ã€‚\n1 ports: 2 - name: p1 3 port: 2323 4 protocol: TCP 5 targetPort: 81 6 - name: p2 7 port: 6666 8 protocol: TCP 9 targetPort: 82 ","permalink":"/tech/kubernetes/k8s-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","summary":"\u003cp\u003eKubernetes ç½‘ç»œçš„åŠŸèƒ½ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eé«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« Pods å’ŒÂ \u003ccode\u003elocalhost\u003c/code\u003eÂ é€šä¿¡è§£å†³äº†ã€‚\u003c/li\u003e\n\u003cli\u003ePod é—´é€šä¿¡ï¼›\u003c/li\u003e\n\u003cli\u003ePod å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›\u003c/li\u003e\n\u003cli\u003eå¤–éƒ¨å’Œ Service å¯¹è±¡é—´é€šä¿¡ï¼›\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eKubernetes æœ¬èº«çš„ç½‘ç»œæœåŠ¡è‡ªå¸¦äº†ä¸€ä¸‹åŠŸèƒ½ï¼š\u003c/p\u003e","title":"K8s ç½‘ç»œæ¨¡å‹åŸºç¡€çŸ¥è¯†"},{"content":"1. åŸºç¡€é…ç½® é¦–å…ˆï¼Œåœ¨æ‰€æœ‰ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹ä¸Šå®‰è£… nfs-utils.\n1sudo yum -y install nfs-utils 2systemctl enable nfs-utils 2. NFS Server é…ç½® æœåŠ¡ç«¯å®‰è£… nfs-utils å’Œ rpcbind 1sudo yum -y install nfs-utils rpcbind 2systemctl enable nfs-utils 3systemctl enable rpcbind åˆ›å»ºå…±äº«ç›®å½• 1mkdir /hc-data/nfs **åˆ›å»ºå¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶ é…ç½®æ–‡ä»¶ä¸º /etc/exports\n1sudo vim /etc/exports 2# æ·»åŠ é…ç½® 3/hc-data/nfs 172.24.71.32/24(rw,no_root_squash,no_all_squash,sync) 4/hc-data/nfs 172.24.71.34/24(rw,no_root_squash,no_all_squash,sync) 5/hc-data/nfs 172.24.71.35/24(rw,no_root_squash,no_all_squash,sync) 6/hc-data/nfs 172.24.71.36/24(rw,no_root_squash,no_all_squash,sync) 7/hc-data/nfs 172.24.71.37/24(rw,no_root_squash,no_all_squash,sync) 8/hc-data/nfs 172.24.71.38/24(rw,no_root_squash,no_all_squash,sync) 9/hc-data/nfs 172.24.71.39/24(rw,no_root_squash,no_all_squash,sync) /opt/nfs 10.101.5.111/24(rw,no_root_squash,no_all_squash,sync) /opt/nfs 10.101.5.112/24(rw,no_root_squash,no_all_squash,sync) /opt/nfs 10.101.5.113/24(rw,no_root_squash,no_all_squash,sync) /opt/nfs 10.101.5.114/24(rw,no_root_squash,no_all_squash,sync) /opt/nfs 10.101.5.115/24(rw,no_root_squash,no_all_squash,sync) /opt/nfs 10.101.5.116/24(rw,no_root_squash,no_all_squash,sync) /opt/nfs 10.101.5.117/24(rw,no_root_squash,no_all_squash,sync)\nå¯¹äº /hc-data/nfs 172.24.71.32/24(rw,no_root_squash,no_all_squash,sync) ï¼Œè¡¨ç¤ºæœåŠ¡ç«¯å…è®¸ IP åœ°å€ä¸º 172.24.71.32 çš„ä¸»æœºè¿›è¡Œè®¿é—® /hc-data/nfs ç›®å½•ï¼Œå‚æ•°çš„å«ä¹‰è¡¨ç¤ºå¯è¯»å†™ã€æ•°æ®åŒæ­¥å†™å…¥ç­‰ã€‚\nä¿å­˜åï¼Œä½¿é…ç½®ç”Ÿæ•ˆï¼Œå¹¶é‡å¯æœåŠ¡\n1sudo exportfs -r 2sudo service rpcbind restart 3sudo service nfs-server restart æŸ¥çœ‹æœåŠ¡ç«¯æŒ‚è½½æƒ…å†µ 1showmount -e localhost 1# showmount -e localhost 2Export list for localhost: 3/hc-data/nfs 172.24.71.39/24,172.24.71.38/24,172.24.71.37/24,172.24.71.36/24,172.24.71.35/24,172.24.71.34/24,172.24.71.32/24 3. K8s ä¸»èŠ‚ç‚¹é…ç½® 3.1 K8s NFS æ’ä»¶å®‰è£… ä»“åº“åœ°å€ï¼š https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner\nHelm æ·»åŠ ä»“åº“ 1helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/ å®‰è£… nfs-subdir-external-provisioner helm å®‰è£… 1helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \\ 2--set nfs.server=172.24.71.33 \\ 3--set nfs.path=/hc-data/nfs æœ¬åœ°å®‰è£… ä¸‹è½½ nfs-subdir-external-provisioner åˆ°æœ¬åœ°ç›®å½•å 1helm pull nfs-subdir-external-provisioner/nfs-subdir-external-provisioner ä¿®æ”¹ values.yaml æ–‡ä»¶ ç„¶åæ‰§è¡Œ\n1helm install nfs-client-provisioner . é…ç½®é»˜è®¤ StorageClass é…ç½®é»˜è®¤ StorageClass å‘½ä»¤å¦‚ä¸‹\n1kubectl patch storageclass nfs-client -p \u0026#39;{\u0026#34;metadata\u0026#34;: {\u0026#34;annotations\u0026#34;:{\u0026#34;storageclass.kubernetes.io/is-default-class\u0026#34;:\u0026#34;true\u0026#34;}}}\u0026#39; ç„¶åï¼ŒæŸ¥çœ‹å½“å‰é›†ç¾¤ StorageClass æƒ…å†µï¼Œåä¸º nfs-client çš„ sc å·²ç»æˆåŠŸåˆ›å»ºï¼Œå¹¶å·²è®¾ç½®ä¸ºé»˜è®¤ scã€‚\n1kubectl get sc 2NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE 3nfs-client (default) cluster.local/nfs-client-provisioner-nfs-subdir-external-provisioner Delete Immediate true 30m 3.2 åˆ›å»º PVC PVC çš„ yaml æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\n1apiVersion: v1 2kind: PersistentVolumeClaim 3metadata: 4 name: prometheus-pvc 5 namespace: monitoring 6spec: 7 storageClassName: nfs-client 8 accessModes: 9 - ReadWriteOnce 10 resources: 11 requests: 12 storage: 50Gi # è¯·æ±‚ä¸ PersistentVolume åŒ¹é…çš„å­˜å‚¨å®¹é‡ æ‰§è¡Œ kubectl apply åï¼Œ æŸ¥çœ‹ PVC æ„å»ºæƒ…å†µï¼Œ prometheus-pvc çš„çŠ¶æ€ boundï¼Œ æ„å»ºæˆåŠŸã€‚\n1kubectl get pvc -n monitoring 2NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE 3prometheus-pvc Bound pvc-6003bba1-95f7-43b0-a3f8-5bdce01f2c98 50Gi RWO nfs-client 58m ","permalink":"/tech/kubernetes/%E4%BD%BF%E7%94%A8-nfs-%E4%BD%9C%E4%B8%BA-k8s-%E5%AD%98%E5%82%A8%E6%8F%92%E4%BB%B6/","summary":"\u003ch1 id=\"1-åŸºç¡€é…ç½®\"\u003e1. åŸºç¡€é…ç½®\u003c/h1\u003e\n\u003cp\u003eé¦–å…ˆï¼Œåœ¨æ‰€æœ‰ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹ä¸Šå®‰è£… nfs-utils.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo yum -y install nfs-utils\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e nfs-utils\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch1 id=\"2-nfs-server-é…ç½®\"\u003e2. NFS Server é…ç½®\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæœåŠ¡ç«¯å®‰è£… nfs-utils å’Œ rpcbind\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo yum -y install nfs-utils rpcbind\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e nfs-utils\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e rpcbind\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eåˆ›å»ºå…±äº«ç›®å½•\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003emkdir /hc-data/nfs\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003e**åˆ›å»ºå¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eé…ç½®æ–‡ä»¶ä¸º \u003ccode\u003e/etc/exports\u003c/code\u003e\u003c/p\u003e","title":"ä½¿ç”¨ NFS ä½œä¸º K8s å­˜å‚¨æ’ä»¶"},{"content":"æ ¸å¿ƒå‚æ•°\n1proxy_buffering off; è¯¥æŒ‡ä»¤ä½¿ Nginx ä¸ç¼“å†²æ¥è‡ªä¸Šæ¸¸æœåŠ¡å™¨çš„å“åº”ï¼Œè€Œæ˜¯ç«‹å³å°†å…¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚é€‚åˆéœ€è¦å®æ—¶æˆ–æµå¼ä¼ è¾“æ•°æ®çš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚å®æ—¶èŠå¤©ã€æµåª’ä½“ç­‰ã€‚\n1proxy_buffering off; è¡¨ç¤ºå¯ç”¨ä»£ç†ç¼“å†²ï¼ŒNginx å°†ç¼“å†²æ¥è‡ªåç«¯æœåŠ¡å™¨çš„å“åº”ï¼Œå¹¶åœ¨æ¥æ”¶å®Œæ•´å“åº”åæ‰å°†å…¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚è¿™å¯ä»¥æé«˜æ€§èƒ½å¹¶å‡å°‘å¯¹åç«¯æœåŠ¡å™¨çš„è¯·æ±‚é¢‘ç‡ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´å»¶è¿Ÿã€‚\n","permalink":"/tech/ops/nginx-%E5%AE%9E%E7%8E%B0-gpt-%E6%B5%81%E5%BC%8F%E4%BC%A0%E8%BE%93/","summary":"\u003cp\u003e\u003cstrong\u003eæ ¸å¿ƒå‚æ•°\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eproxy_buffering off;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¯¥æŒ‡ä»¤ä½¿ Nginx ä¸ç¼“å†²æ¥è‡ªä¸Šæ¸¸æœåŠ¡å™¨çš„å“åº”ï¼Œè€Œæ˜¯ç«‹å³å°†å…¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚é€‚åˆéœ€è¦å®æ—¶æˆ–æµå¼ä¼ è¾“æ•°æ®çš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚å®æ—¶èŠå¤©ã€æµåª’ä½“ç­‰ã€‚\u003c/p\u003e","title":"Nginx å®ç° GPT æµå¼ä¼ è¾“"},{"content":"å †å†…å­˜ä¸æ ˆå†…å­˜ Go åœ¨ 2 ä¸ªä½ç½®ä¸ºå˜é‡åˆ†é…å†…å­˜ï¼Œå…¨å±€å †(heap)ç©ºé—´ï¼Œå’Œæ¯ä¸ª goroutine çš„æ ˆ(stack)ç©ºé—´ã€‚\nGo è¯­è¨€å®ç° GC æœºåˆ¶ï¼Œå› æ­¤å¼€å‘è€…ä¸éœ€è¦å…³å¿ƒå†…å­˜åˆ†é…åœ¨æ ˆä¸Šï¼Œè¿˜æ˜¯å †ä¸Šã€‚ä½†æ˜¯ä»æ€§èƒ½çš„è§’åº¦å‡ºå‘ï¼Œåœ¨æ ˆä¸Šåˆ†é…å†…å­˜å’Œåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œæ€§èƒ½å·®å¼‚æ˜¯éå¸¸å¤§çš„ã€‚\nåœ¨å‡½æ•°ä¸­ç”³è¯·ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœåˆ†é…åœ¨æ ˆä¸­ï¼Œå‡½æ•°æ‰§è¡Œç»“æŸæ—¶è‡ªåŠ¨å›æ”¶ï¼›å¦‚æœåˆ†é…åœ¨å †ä¸­ï¼Œåˆ™åœ¨å‡½æ•°ç»“æŸåæŸä¸ªæ—¶é—´ç‚¹è¿›è¡Œåƒåœ¾å›æ”¶ã€‚\nåœ¨æ ˆä¸Šåˆ†é…å’Œå›æ”¶å†…å­˜çš„å¼€é”€å¾ˆä½ï¼Œåªéœ€è¦ 2 ä¸ª CPU æŒ‡ä»¤ï¼šPUSH å’Œ POPï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ ˆä¸Šåˆ†é…å†…å­˜ï¼Œæ¶ˆè€—çš„ä»…æ˜¯å°†æ•°æ®æ‹·è´åˆ°å†…å­˜çš„æ—¶é—´ï¼Œè€Œå†…å­˜çš„ I/O é€šå¸¸èƒ½å¤Ÿè¾¾åˆ° 30GB/sã€‚\nåœ¨å †ä¸Šåˆ†é…å†…å­˜ä¸»è¦çš„å¼€é”€æ˜¯åƒåœ¾å›æ”¶ã€‚Go è¯­è¨€ä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œå¹¶ä¸”åœ¨æ­¤åŸºç¡€ä¸Šä½¿ç”¨äº†ä¸‰è‰²æ ‡è®°æ³•å’Œå†™å±éšœæŠ€æœ¯ï¼Œæé«˜äº†æ•ˆç‡ã€‚\né€ƒé€¸åˆ†æ Go è¯­è¨€ä¸­å †å†…å­˜ç”± GC æœºåˆ¶è‡ªåŠ¨ç®¡ç†çš„ã€‚ç¼–è¯‘å™¨å†³å®šå†…å­˜åˆ†é…ä½ç½®çš„æ–¹å¼ï¼Œå°±ç§°ä¹‹ä¸ºé€ƒé€¸åˆ†æ(escape analysis)ã€‚é€ƒé€¸åˆ†æç”±ç¼–è¯‘å™¨å®Œæˆï¼Œä½œç”¨äºç¼–è¯‘é˜¶æ®µã€‚\næŒ‡é’ˆ å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œè¿”å›äº†è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°è™½ç„¶é€€å‡ºäº†ï¼Œä½†æ˜¯å› ä¸ºæŒ‡é’ˆçš„å­˜åœ¨ï¼Œè¯¥å¯¹è±¡çš„å†…å­˜ä¸èƒ½éšç€å‡½æ•°ç»“æŸè€Œå›æ”¶ï¼Œå› æ­¤åªèƒ½åˆ†é…åœ¨å †ä¸Šã€‚\n1package main 2 3import \u0026#34;fmt\u0026#34; 4 5type Demo struct { 6\tname string 7} 8 9func createDemo(name string) *Demo { 10\td := new(Demo) // å±€éƒ¨å˜é‡ d é€ƒé€¸åˆ°å † 11\td.name = name 12\treturn d 13} 14 15func main() { 16\tdemo := createDemo(\u0026#34;demo\u0026#34;) 17\tfmt.Println(demo) 18} å…¶ä¸­ï¼Œå±€éƒ¨å˜é‡Â dÂ å‘ç”Ÿäº†é€ƒé€¸ã€‚d ä½œä¸ºè¿”å›å€¼åœ¨ main å‡½æ•°ä¸­ç»§ç»­ä½¿ç”¨ï¼Œå› æ­¤ d æŒ‡å‘çš„å†…å­˜ä¸èƒ½å¤Ÿåˆ†é…åœ¨æ ˆä¸Šéšç€å‡½æ•°ç»“æŸè€Œå›æ”¶ï¼Œåªèƒ½åˆ†é…åœ¨å †ä¸Šã€‚\nç¼–è¯‘æ—¶å€ŸåŠ©é€‰é¡¹Â -gcflags=-m å¯ä»¥æŸ¥çœ‹å˜é‡é€ƒé€¸çš„æƒ…å†µï¼š\n1go build -gcflags=-m cmd/main.go 2# command-line-arguments 3cmd/main.go:9:6: can inline createDemo 4cmd/main.go:16:20: inlining call to createDemo 5cmd/main.go:17:13: inlining call to fmt.Println 6cmd/main.go:9:17: leaking param: name 7cmd/main.go:10:10: new(Demo) escapes to heap 8cmd/main.go:16:20: new(Demo) escapes to heap 9cmd/main.go:17:13: ... argument does not escape interface ç©ºæ¥å£å³Â interface{}Â å¯ä»¥è¡¨ç¤ºä»»æ„çš„ç±»å‹ï¼Œå¦‚æœå‡½æ•°å‚æ•°ä¸ºÂ interface{}ï¼Œç¼–è¯‘æœŸé—´å¾ˆéš¾ç¡®å®šå…¶å‚æ•°çš„å…·ä½“ç±»å‹ï¼Œä¹Ÿä¼šå‘ç”Ÿé€ƒé€¸ã€‚\n1func main() { 2\tdemo := createDemo(\u0026#34;demo\u0026#34;) 3\tfmt.Println(demo) 4} demoÂ æ˜¯ main å‡½æ•°ä¸­çš„ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œè¯¥å˜é‡ä½œä¸ºå®å‚ä¼ é€’ç»™Â fmt.Println()ï¼Œä½†æ˜¯å› ä¸ºÂ fmt.Println()Â çš„å‚æ•°ç±»å‹å®šä¹‰ä¸ºÂ interface{}ï¼Œå› æ­¤ä¹Ÿå‘ç”Ÿäº†é€ƒé€¸ã€‚\næ ˆç©ºé—´ä¸è¶³ æ“ä½œç³»ç»Ÿå¯¹å†…æ ¸çº¿ç¨‹ä½¿ç”¨çš„æ ˆç©ºé—´æ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œ64 ä½ç³»ç»Ÿä¸Šé€šå¸¸æ˜¯ 8 MBã€‚\nå¯ä»¥ä½¿ç”¨Â ulimit -aÂ å‘½ä»¤æŸ¥çœ‹æœºå™¨ä¸Šæ ˆå…è®¸å ç”¨çš„å†…å­˜çš„å¤§å°ã€‚\n1# ulimit -a 2real-time non-blocking time (microseconds, -R) unlimited 3core file size (blocks, -c) 0 4data seg size (kbytes, -d) unlimited 5scheduling priority (-e) 0 6file size (blocks, -f) unlimited 7pending signals (-i) 127151 8max locked memory (kbytes, -l) unlimited 9max memory size (kbytes, -m) unlimited 10open files (-n) 131072 11pipe size (512 bytes, -p) 8 12POSIX message queues (bytes, -q) 819200 13real-time priority (-r) 0 14stack size (kbytes, -s) 8192 15cpu time (seconds, -t) unlimited 16max user processes (-u) 65535 17virtual memory (kbytes, -v) unlimited 18file locks (-x) unlimited 1stack size (kbytes, -s) 8192 å› ä¸ºæ ˆç©ºé—´é€šå¸¸æ¯”è¾ƒå°ï¼Œå› æ­¤é€’å½’å‡½æ•°å®ç°ä¸å½“æ—¶ï¼Œå®¹æ˜“å¯¼è‡´æ ˆæº¢å‡ºã€‚\nå¯¹äº Go è¯­è¨€æ¥è¯´ï¼Œè¿è¡Œæ—¶(runtime) å°è¯•åœ¨ goroutine éœ€è¦çš„æ—¶å€™åŠ¨æ€åœ°åˆ†é…æ ˆç©ºé—´ï¼Œgoroutine çš„åˆå§‹æ ˆå¤§å°ä¸º 2 KBã€‚å½“ goroutine è¢«è°ƒåº¦æ—¶ï¼Œä¼šç»‘å®šå†…æ ¸çº¿ç¨‹æ‰§è¡Œï¼Œæ ˆç©ºé—´å¤§å°ä¹Ÿä¸ä¼šè¶…è¿‡æ“ä½œç³»ç»Ÿçš„é™åˆ¶ã€‚\nå¯¹ Go ç¼–è¯‘å™¨è€Œè¨€ï¼Œè¶…è¿‡ä¸€å®šå¤§å°çš„å±€éƒ¨å˜é‡å°†é€ƒé€¸åˆ°å †ä¸Šï¼Œä¸åŒçš„ Go ç‰ˆæœ¬çš„å¤§å°é™åˆ¶å¯èƒ½ä¸ä¸€æ ·ã€‚\n1package main 2 3import \u0026#34;math/rand\u0026#34; 4 5func generate8192() { 6\tnums := make([]int, 8192) // = 64KB 7\tfor i := 0; i \u0026lt; 8192; i++ { 8\tnums[i] = rand.Int() 9\t} 10} 11 12func generate8193() { 13\tnums := make([]int, 8193) // \u0026gt; 64KB 14\tfor i := 0; i \u0026lt; 8193; i++ { 15\tnums[i] = rand.Int() 16\t} 17} 18 19func generate(n int) { 20\tnums := make([]int, n) // ä¸ç¡®å®šå¤§å° 21\tfor i := 0; i \u0026lt; n; i++ { 22\tnums[i] = rand.Int() 23\t} 24} 25 26func main() { 27\tgenerate8192() 28\tgenerate8193() 29\tgenerate(1) 30} 1# go build -gcflags=-m main.go 2# command-line-arguments 3cmd/main.go:6:14: make([]int, 8192) does not escape 4cmd/main.go:13:14: make([]int, 8193) escapes to heap 5cmd/main.go:20:14: make([]int, n) escapes to heap make([]int, 8192)Â æ²¡æœ‰å‘ç”Ÿé€ƒé€¸ï¼Œmake([]int, 8193)Â å’Œmake([]int, n)Â é€ƒé€¸åˆ°å †ä¸Šã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œå½“åˆ‡ç‰‡å ç”¨å†…å­˜è¶…è¿‡ä¸€å®šå¤§å°ï¼Œæˆ–æ— æ³•ç¡®å®šå½“å‰åˆ‡ç‰‡é•¿åº¦æ—¶ï¼Œå¯¹è±¡å ç”¨å†…å­˜å°†åœ¨å †ä¸Šåˆ†é…ã€‚\né—­åŒ… ä¸€ä¸ªå‡½æ•°å’Œå¯¹å…¶å‘¨å›´çŠ¶æ€ï¼ˆlexical environmentï¼Œè¯æ³•ç¯å¢ƒï¼‰çš„å¼•ç”¨æ†ç»‘åœ¨ä¸€èµ·ï¼ˆæˆ–è€…è¯´å‡½æ•°è¢«å¼•ç”¨åŒ…å›´ï¼‰ï¼Œè¿™æ ·çš„ç»„åˆå°±æ˜¯é—­åŒ…ï¼ˆclosureï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé—­åŒ…è®©ä½ å¯ä»¥åœ¨ä¸€ä¸ªå†…å±‚å‡½æ•°ä¸­è®¿é—®åˆ°å…¶å¤–å±‚å‡½æ•°çš„ä½œç”¨åŸŸã€‚\n1func Increase() func() int { 2\tn := 0 3\treturn func() int { 4\tn++ 5\treturn n 6\t} 7} 8 9func main() { 10\tin := Increase() 11\tfmt.Println(in()) // 1 12\tfmt.Println(in()) // 2 13} Increase()Â è¿”å›å€¼æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼Œè¯¥é—­åŒ…å‡½æ•°è®¿é—®äº†å¤–éƒ¨å˜é‡ nï¼Œé‚£å˜é‡ n å°†ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°Â inÂ è¢«é”€æ¯ã€‚å¾ˆæ˜¾ç„¶ï¼Œå˜é‡ n å ç”¨çš„å†…å­˜ä¸èƒ½éšç€å‡½æ•°Â Increase()Â çš„é€€å‡ºè€Œå›æ”¶ï¼Œå› æ­¤å°†ä¼šé€ƒé€¸åˆ°å †ä¸Šã€‚\n1./main.go:6:2: moved to heap: n 2./main.go:7:9: func literal escapes to heap 3./main.go:14:16: func literal does not escape 4./main.go:15:13: ... argument does not escape 5./main.go:15:16: ~R0 escapes to heap 6./main.go:16:13: ... argument does not escape 7./main.go:16:16: ~R0 escapes to heap ä¼ å€¼ VS ä¼ æŒ‡é’ˆ ä¼ å€¼ä¼šæ‹·è´æ•´ä¸ªå¯¹è±¡ï¼Œè€Œä¼ æŒ‡é’ˆåªä¼šæ‹·è´æŒ‡é’ˆåœ°å€ï¼ŒæŒ‡å‘çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªã€‚\nä¼ æŒ‡é’ˆå¯ä»¥å‡å°‘å€¼çš„æ‹·è´ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å†…å­˜åˆ†é…é€ƒé€¸åˆ°å †ä¸­ï¼Œå¢åŠ  GC å¼€é”€ã€‚åœ¨å¯¹è±¡é¢‘ç¹åˆ›å»ºå’Œåˆ é™¤çš„åœºæ™¯ä¸‹ï¼Œä¼ é€’æŒ‡é’ˆå¯¼è‡´çš„ GC å¼€é”€å¯èƒ½ä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹äºéœ€è¦ä¿®æ”¹åŸå¯¹è±¡å€¼ï¼Œæˆ–å ç”¨å†…å­˜æ¯”è¾ƒå¤§çš„ç»“æ„ä½“ï¼Œé€‰æ‹©ä¼ æŒ‡é’ˆã€‚å¯¹äºåªè¯»çš„ã€å ç”¨å†…å­˜è¾ƒå°çš„ç»“æ„ä½“ï¼Œç›´æ¥ä¼ å€¼èƒ½å¤Ÿè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚\n","permalink":"/tech/golang/golang-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/","summary":"\u003ch1 id=\"å †å†…å­˜ä¸æ ˆå†…å­˜\"\u003eå †å†…å­˜ä¸æ ˆå†…å­˜\u003c/h1\u003e\n\u003cp\u003eGo åœ¨ 2 ä¸ªä½ç½®ä¸ºå˜é‡åˆ†é…å†…å­˜ï¼Œå…¨å±€å †(heap)ç©ºé—´ï¼Œå’Œæ¯ä¸ª goroutine çš„æ ˆ(stack)ç©ºé—´ã€‚\u003c/p\u003e\n\u003cp\u003eGo è¯­è¨€å®ç° GC æœºåˆ¶ï¼Œå› æ­¤å¼€å‘è€…ä¸éœ€è¦å…³å¿ƒå†…å­˜åˆ†é…åœ¨æ ˆä¸Šï¼Œè¿˜æ˜¯å †ä¸Šã€‚ä½†æ˜¯ä»æ€§èƒ½çš„è§’åº¦å‡ºå‘ï¼Œåœ¨æ ˆä¸Šåˆ†é…å†…å­˜å’Œåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œæ€§èƒ½å·®å¼‚æ˜¯éå¸¸å¤§çš„ã€‚\u003c/p\u003e","title":"Golang é€ƒé€¸åˆ†æ"},{"content":"åœ¨ Go è¯­è¨€ä¸­ï¼Œç©ºç»“æ„ä½“Â struct{}Â æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„ç±»å‹ï¼Œå®ƒä¸åŒ…å«ä»»ä½•å­—æ®µä¸”ä¸å ç”¨ä»»ä½•å†…å­˜ç©ºé—´ã€‚\nç©ºç»“æ„ä½“ä¸å ç”¨å†…å­˜ç©ºé—´ 1type Empty struct{} 2 3func main() { 4 5\tvar s1 struct{} 6\ts2 := Empty{} 7\ts3 := struct{}{} 8 9\tfmt.Printf(\u0026#34;s1 addr: %p, size: %d\\n\u0026#34;, \u0026amp;s1, unsafe.Sizeof(s1)) 10\tfmt.Printf(\u0026#34;s2 addr: %p, size: %d\\n\u0026#34;, \u0026amp;s2, unsafe.Sizeof(s2)) 11\tfmt.Printf(\u0026#34;s3 addr: %p, size: %d\\n\u0026#34;, \u0026amp;s3, unsafe.Sizeof(s3)) 12\tfmt.Printf(\u0026#34;s1 == s2 == s3: %t\\n\u0026#34;, s1 == s2 \u0026amp;\u0026amp; s2 == s3) 13} å¾—åˆ°è¾“å‡ºå¦‚ä¸‹\n1s1 addr: 0x1048507c0, size: 0 2s2 addr: 0x1048507c0, size: 0 3s3 addr: 0x1048507c0, size: 0 4s1 == s2 == s3: true ç”±ä¸Šå¯å¾—ï¼š\nå¤šä¸ªç©ºç»“æ„ä½“å†…å­˜åœ°å€ç›¸åŒã€‚ ç©ºç»“æ„ä½“å ç”¨å­—èŠ‚æ•°ä¸º 0ï¼Œå³ä¸å ç”¨å†…å­˜ç©ºé—´ã€‚ ç©ºç»“æ„ä½“ä¹‹é—´çš„å€¼ç›¸ç­‰ã€‚ ä½†æ˜¯ï¼Œå¯¹äºç»“è®º 1ï¼Œæœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µã€‚\n1func main() { 2 3\tvar ( 4\ta struct{} 5\tb struct{} 6\tc struct{} 7\td struct{} 8\t) 9 10\tprintln(\u0026#34;\u0026amp;a:\u0026#34;, \u0026amp;a) 11\tprintln(\u0026#34;\u0026amp;b:\u0026#34;, \u0026amp;b) 12\tprintln(\u0026#34;\u0026amp;c:\u0026#34;, \u0026amp;c) 13\tprintln(\u0026#34;\u0026amp;d:\u0026#34;, \u0026amp;d) 14 15\tprintln(\u0026#34;\u0026amp;a == \u0026amp;b:\u0026#34;, \u0026amp;a == \u0026amp;b) 16\tx := \u0026amp;a 17\ty := \u0026amp;b 18\tprintln(\u0026#34;x == y:\u0026#34;, x == y) 19 20\tfmt.Printf(\u0026#34;\u0026amp;c(%p) == \u0026amp;d(%p): %t\\n\u0026#34;, \u0026amp;c, \u0026amp;d, \u0026amp;c == \u0026amp;d) 21} è¿™æ®µä»£ç ä¸­å®šä¹‰äº† 4 ä¸ªç©ºç»“æ„ä½“ï¼Œä¾æ¬¡æ‰“å°å®ƒä»¬çš„å†…å­˜åœ°å€ï¼Œç„¶ååˆåˆ†åˆ«å¯¹æ¯”äº†Â aÂ ä¸Â bÂ çš„å†…å­˜åœ°å€ï¼Œå’ŒÂ cÂ ä¸Â dÂ çš„å†…å­˜åœ°å€ä¸¤ä¸¤æ˜¯å¦ç›¸ç­‰ã€‚è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\n1go run -gcflags=\u0026#39;-m -N -l\u0026#39; main.go ä½¿ç”¨ -gcflags é€‰é¡¹å‘ Go ç¼–è¯‘å™¨ä¼ é€’æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—ä¼šå½±å“ç¼–è¯‘å™¨çš„è¡Œä¸ºã€‚\n-m æ ‡å¿—ç”¨äºå¯åŠ¨ç¼–è¯‘å™¨çš„å†…å­˜é€ƒé€¸åˆ†æã€‚ -N æ ‡å¿—ç”¨äºç¦ç”¨ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚ -l æ ‡å¿—ç”¨äºç¦ç”¨å‡½æ•°å†…è”ã€‚\n1# command-line-arguments 2./main.go:12:3: moved to heap: c 3./main.go:13:3: moved to heap: d 4./main.go:26:12: ... argument does not escape 5./main.go:26:50: \u0026amp;c == \u0026amp;d escapes to heap 6\u0026amp;a: 0x1400011ae84 7\u0026amp;b: 0x1400011ae84 8\u0026amp;c: 0x1048987e0 9\u0026amp;d: 0x1048987e0 10\u0026amp;a == \u0026amp;b: false 11x == y: true 12\u0026amp;c(0x1048987e0) == \u0026amp;d(0x1048987e0): true æ ¹æ®è¾“å‡ºå¯ä»¥å‘ç°ï¼Œå˜é‡ c å’Œ d å‘ç”Ÿäº†å†…å­˜é€ƒé€¸ï¼Œå¹¶ä¸”æœ€ç»ˆäºŒè€…çš„å†…å­˜åœ°å€ç›¸åŒï¼Œç›¸ç­‰æ¯”è¾ƒç»“æœä¸º trueã€‚\nè€Œ a å’Œ b ä¸¤ä¸ªå˜é‡çš„è¾“å‡ºç»“æœå°±æ¯”è¾ƒæœ‰æ„æ€äº†ï¼Œä¸¤ä¸ªå˜é‡æ²¡æœ‰å‘ç”Ÿå†…å­˜é€ƒé€¸ï¼Œå¹¶ä¸”äºŒè€…æ‰“å°å‡ºæ¥çš„å†…å­˜åœ°å€ç›¸åŒï¼Œä½†å†…å­˜åœ°å€ç›¸ç­‰æ¯”è¾ƒç»“æœå´ä¸º falseã€‚\nA struct or array type has size zero if it contains no fields (or elements, respectively) that have a size greater than zero. Two distinct zero-size variables may have the same address in memory. Size and alignment guaranteesÂ¶\nå› æ­¤ï¼Œæ­£ç¡®ç»“è®ºä¸ºï¼šã€Œå¤šä¸ªç©ºç»“æ„ä½“å†…å­˜åœ°å€å¯èƒ½ç›¸åŒã€ã€‚\nç©ºç»“æ„ä½“å½±å“å†…å­˜å¯¹é½ ç©ºç»“æ„ä½“ä¹Ÿå¹¶ä¸æ˜¯ä»€ä¹ˆæ—¶å€™éƒ½ä¸ä¼šå ç”¨å†…å­˜ç©ºé—´ï¼Œæ¯”å¦‚ç©ºç»“æ„ä½“ä½œä¸ºå¦ä¸€ä¸ªç»“æ„ä½“å­—æ®µæ—¶ï¼Œæ ¹æ®ä½ç½®ä¸åŒï¼Œå¯èƒ½å› å†…å­˜å¯¹é½åŸå› ï¼Œå¯¼è‡´å¤–å±‚ç»“æ„ä½“å¤§å°ä¸ä¸€æ ·ï¼š\n1func main() { 2 3\ttype A struct { 4\tx int 5\ty string 6\tz struct{} 7\t} 8 9\ttype B struct { 10\tx int 11\tz struct{} 12\ty string 13\t} 14 15\ttype C struct { 16\tz struct{} 17\tx int 18\ty string 19\t} 20 21\ta := A{} 22\tb := B{} 23\tc := C{} 24\tfmt.Printf(\u0026#34;struct a size: %d\\n\u0026#34;, unsafe.Sizeof(a)) 25\tfmt.Printf(\u0026#34;struct b size: %d\\n\u0026#34;, unsafe.Sizeof(b)) 26\tfmt.Printf(\u0026#34;struct c size: %d\\n\u0026#34;, unsafe.Sizeof(c)) 27} æ‰§è¡Œç¤ºä¾‹ä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\n1struct a size: 32 2struct b size: 24 3struct c size: 24 ç”±ä¸Šå¯å¾—ï¼Œå½“ç©ºç»“æ„ä½“æ”¾åœ¨å¦ä¸€ä¸ªç»“æ„ä½“æœ€åä¸€ä¸ªå­—æ®µæ—¶ï¼Œä¼šè§¦å‘å†…å­˜å¯¹é½ã€‚\næ­¤æ—¶å¤–å±‚ç»“æ„ä½“ä¼šå ç”¨æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å¦‚æœä½ çš„ç¨‹åºå¯¹å†…å­˜è¦æ±‚æ¯”è¾ƒä¸¥æ ¼ï¼Œåˆ™åœ¨ä½¿ç”¨ç©ºç»“æ„ä½“ä½œä¸ºå­—æ®µæ—¶éœ€è¦è€ƒè™‘è¿™ä¸€ç‚¹ã€‚\nç©ºç»“æ„ä½“å¸¸è§ç”¨æ³• å®ç° Set ç»“æ„ä½“æœ€å¸¸ç”¨çš„åœ°æ–¹ï¼Œå°±æ˜¯ç”¨æ¥å®ç° set(é›†åˆ) ç±»å‹ã€‚\nGo è¯­è¨€åœ¨è¯­æ³•å±‚é¢æ²¡æœ‰æä¾› set ç±»å‹ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨ map + struct{} æ¥å®ç° set ç±»å‹ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1// Set åŸºäºç©ºç»“æ„ä½“å®ç° set 2type Set map[string]struct{} 3 4// Add æ·»åŠ å…ƒç´ åˆ° set 5func (s Set) Add(element string) { 6\ts[element] = struct{}{} 7} 8 9// Remove ä» set ä¸­ç§»é™¤å…ƒç´  10func (s Set) Remove(element string) { 11\tdelete(s, element) 12} 13 14// Contains æ£€æŸ¥ set ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´  15func (s Set) Contains(element string) bool { 16\t_, exists := s[element] 17\treturn exists 18} 19 20// Size è¿”å› set å¤§å° 21func (s Set) Size() int { 22\treturn len(s) 23} 24 25// String implements fmt.Stringer 26func (s Set) String() string { 27\tformat := \u0026#34;(\u0026#34; 28\tfor element := range s { 29\tformat += element + \u0026#34; \u0026#34; 30\t} 31\tformat = strings.TrimRight(format, \u0026#34; \u0026#34;) + \u0026#34;)\u0026#34; 32\treturn format 33} ä½¿ç”¨ map å’Œç©ºç»“æ„ä½“ï¼Œå¯ä»¥éå¸¸å®¹æ˜“å®ç° set ç±»å‹ã€‚map çš„ key å®é™…ä¸Šä¸ set ä¸é‡å¤çš„ç‰¹æ€§åˆšå¥½ä¸€è‡´ï¼Œä¸€ä¸ªä¸éœ€è¦å…³å¿ƒ value çš„ map å³ä¸º setã€‚\nç©ºç»“æ„ä½“ç±»å‹æœ€é€‚åˆä½œä¸ºè¿™ä¸ªä¸éœ€è¦å…³å¿ƒçš„ value çš„ map äº†ï¼Œå› ä¸ºå®ƒä¸å ç©ºé—´ï¼Œæ²¡æœ‰è¯­ä¹‰ã€‚\nä¹Ÿè®¸æœ‰äººä¼šè®¤ä¸ºä½¿ç”¨ any ä½œä¸º map çš„ value ä¹Ÿå¯ä»¥å®ç° setã€‚ä½† any æ˜¯ä¼šå ç”¨å†…å­˜ç©ºé—´ã€‚\n1func main() { 2\ts := make(map[string]any) 3\ts[\u0026#34;t1\u0026#34;] = nil 4\ts[\u0026#34;t2\u0026#34;] = struct{}{} 5\tfmt.Printf(\u0026#34;set t1 value: %v, size: %d\\n\u0026#34;, s[\u0026#34;t1\u0026#34;], unsafe.Sizeof(s[\u0026#34;t1\u0026#34;])) 6\tfmt.Printf(\u0026#34;set t2 value: %v, size: %d\\n\u0026#34;, s[\u0026#34;t2\u0026#34;], unsafe.Sizeof(s[\u0026#34;t2\u0026#34;])) 7} æ‰§è¡Œç¤ºä¾‹ä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\n1set t1 value: \u0026lt;nil\u0026gt;, size: 16 2set t2 value: {}, size: 16 å¯ä»¥å‘ç°ï¼ŒanyÂ ç±»å‹çš„Â valueÂ æ˜¯æœ‰å¤§å°çš„ï¼Œæ‰€ä»¥å¹¶ä¸åˆé€‚ã€‚\næ—¥å¸¸ä¸­ï¼Œè¿˜æœ‰å¦ä¸€ç§ set çš„å¸¸è§ç”¨æ³•ï¼š\n1s := map[string]struct{}{ 2 \u0026#34;one\u0026#34;: {}, 3 \u0026#34;two\u0026#34;: {}, 4 \u0026#34;three\u0026#34;: {}, 5} 6for element := range s { 7 fmt.Println(element) 8} è¿™ç§ç”¨æ³•ä¹Ÿæ¯”è¾ƒå¸¸è§ï¼Œæ— éœ€å£°æ˜ä¸€ä¸ª set ç±»å‹ï¼Œç›´æ¥é€šè¿‡å­—é¢é‡å®šä¹‰ä¸€ä¸ª value ä¸ºç©ºç»“æ„ä½“çš„ mapï¼Œéå¸¸æ–¹ä¾¿ã€‚\nä¿¡å·é€šçŸ¥ ç©ºç»“æ„ä½“å¦ä¸€ä¸ªç»å¸¸ä½¿ç”¨çš„æ–¹æ³•æ˜¯ä¸Â channelÂ ç»“åˆï¼Œå½“ä½œä¿¡å·æ¥ä½¿ç”¨ï¼š\n1func main() { 2\tdone := make(chan struct{}) 3 4\tgo func() { 5\ttime.Sleep(1 * time.Second) // æ‰§è¡Œä¸€äº›æ“ä½œ... 6\tfmt.Printf(\u0026#34;goroutine done\\n\u0026#34;) 7\tdone \u0026lt;- struct{}{} // å‘é€å®Œæˆä¿¡å· 8\t}() 9 10\tfmt.Printf(\u0026#34;waiting...\\n\u0026#34;) 11\t\u0026lt;-done // ç­‰å¾…å®Œæˆ 12\tfmt.Printf(\u0026#34;main exit\\n\u0026#34;) 13} è¿™æ®µä»£ç ä¸­å£°æ˜äº†ä¸€ä¸ªé•¿åº¦ä¸ºÂ 0Â çš„Â channelï¼Œå…¶ç±»å‹ä¸ºÂ chan struct{}ã€‚\nç„¶åå¯åŠ¨ä¸€ä¸ªÂ goroutineÂ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œä¸»åç¨‹ç­‰å¾…ä¿¡å·é€€å‡ºï¼ŒäºŒè€…ä½¿ç”¨Â channelÂ è¿›è¡Œé€šä¿¡ã€‚ç”±äºÂ struct{}Â å¹¶ä¸å ç”¨å†…å­˜ï¼Œæ‰€ä»¥å®é™…ä¸ŠÂ channelÂ å†…éƒ¨åªéœ€è¦å°†è®¡æ•°å™¨åŠ ä¸€å³å¯ï¼Œä¸æ¶‰åŠæ•°æ®ä¼ è¾“ï¼Œæ•…æ²¡æœ‰é¢å¤–å†…å­˜å¼€é”€ã€‚\nåœ¨ Go è¯­è¨€Â contextÂ æºç ä¸­ä¹Ÿä½¿ç”¨äº†Â struct{}Â ä½œä¸ºå®Œæˆä¿¡å·ï¼š\n1type Context interface { 2 Deadline() (deadline time.Time, ok bool) 3 // See https://blog.golang.org/pipelines for more examples of how to use 4 // a Done channel for cancellation. 5 Done() \u0026lt;-chan struct{} 6 Err() error 7 Value(key any) any 8} æ¥å£å®ç° ç”¨Â struct{}Â ä½œä¸ºä½œä¸ºæ¥å£çš„å®ç°ã€‚\n1// Discard is a [Writer] on which all Write calls succeed 2// without doing anything. 3var Discard Writer = discard{} 4 5type discard struct{} 6 7func (discard) Write(p []byte) (int, error) { 8 return len(p), nil 9} æ ‡è¯†ç¬¦ Go ä¸­çš„Â sync.Pool å…¶å®šä¹‰å¦‚ä¸‹ï¼š\n1type Pool struct { 2 noCopy noCopy 3 4 local unsafe.Pointer 5 localSize uintptr 6 7 victim unsafe.Pointer 8 victimSize uintptr 9 10 New func() any 11} å…¶ä¸­ï¼ŒÂ noCopyÂ å±æ€§å®šä¹‰å¦‚ä¸‹ï¼š\n1type noCopy struct{} 2 3func (*noCopy) Lock() {} 4func (*noCopy) Unlock() {} noCopyÂ å³ä¸ºä¸€ä¸ªç©ºç»“æ„ä½“ï¼Œå…¶å®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œä»…å®šä¹‰äº†ä¸¤ä¸ªç©ºæ–¹æ³•ã€‚è¯¥å­—æ®µçš„ä¸»è¦ä½œç”¨æ˜¯é˜»æ­¢Â sync.PoolÂ è¢«æ„å¤–å¤åˆ¶ã€‚\nå®ƒé€šè¿‡ç¼–è¯‘å™¨é™æ€åˆ†æï¼Œæ¥é˜²æ­¢ç»“æ„ä½“è¢«ä¸å½“å¤åˆ¶ï¼Œä»¥ç¡®ä¿æ­£ç¡®çš„ä½¿ç”¨å’Œå†…å­˜å®‰å…¨æ€§ã€‚\né€šè¿‡Â go vetÂ å‘½ä»¤æ£€å¯ä»¥æµ‹å‡ºÂ sync.PoolÂ æ˜¯å¦è¢«æ„å¤–å¤åˆ¶ã€‚æ‰€ä»¥ï¼Œæœ‰äº† noCopy è¿™ä¸ªæ ‡è®°ï¼Œå°±ä»£è¡¨ç»“æ„ä½“ä¸å¯å¤åˆ¶ã€‚\n1package main 2 3type noCopy struct{} 4 5func (*noCopy) Lock() {} 6func (*noCopy) Unlock() {} 7 8func main() { 9\ttype A struct { 10\tnoCopy noCopy 11\ta string 12\t} 13 14\ttype B struct { 15\tb string 16\t} 17 18\ta := A{a: \u0026#34;a\u0026#34;} 19\tb := B{b: \u0026#34;b\u0026#34;} 20 21\t_ = a 22\t_ = b 23} ä½¿ç”¨Â go vetÂ å‘½ä»¤æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ„å¤–çš„ç»“æ„ä½“å¤åˆ¶ï¼š\n1go vet main.go 2# command-line-arguments 3# [command-line-arguments] 4./main.go:21:6: assignment copies lock value to _: command-line-arguments.A contains command-line-arguments.noCopy å¯ä»¥å‘ç°ï¼Œgo vetÂ å·²ç»æ£€æµ‹å‡ºæˆ‘ä»¬é€šè¿‡Â _ = aÂ å¤åˆ¶äº†Â noCopyÂ ç»“æ„ä½“Â Aã€‚\nå‚è€ƒèµ„æ–™ https://mp.weixin.qq.com/s/o3-yPO-OfdVlXvEtVPIzRw ","permalink":"/tech/golang/golang-%E7%A9%BA%E7%BB%93%E6%9E%84%E4%BD%93/","summary":"\u003cp\u003eåœ¨ Go è¯­è¨€ä¸­ï¼Œç©ºç»“æ„ä½“Â \u003ccode\u003estruct{}\u003c/code\u003eÂ æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„ç±»å‹ï¼Œå®ƒ\u003cstrong\u003eä¸åŒ…å«ä»»ä½•å­—æ®µ\u003c/strong\u003eä¸”\u003cstrong\u003eä¸å ç”¨ä»»ä½•å†…å­˜ç©ºé—´\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003ch1 id=\"ç©ºç»“æ„ä½“ä¸å ç”¨å†…å­˜ç©ºé—´\"\u003eç©ºç»“æ„ä½“ä¸å ç”¨å†…å­˜ç©ºé—´\u003c/h1\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eEmpty\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003es1\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003es2\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003es3\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{}{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;s1 addr: %p, size: %d\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003es1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eunsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003es1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;s2 addr: %p, size: %d\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003es2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eunsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003es2\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;s3 addr: %p, size: %d\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003es3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eunsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003es3\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;s1 == s2 == s3: %t\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003es1\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003es2\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003es2\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003es3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¾—åˆ°è¾“å‡ºå¦‚ä¸‹\u003c/p\u003e","title":"Golang ç©ºç»“æ„ä½“"},{"content":" å°†èŠ‚ç‚¹è®¾ç½®ä¸ºä¸å¯è°ƒåº¦ï¼Œé˜²æ­¢æ–°çš„Podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚ 1kubectlÂ cordonÂ \u0026lt;èŠ‚ç‚¹å\u0026gt; æ’ç©ºèŠ‚ç‚¹ä¸Šçš„Pod 1 kubectlÂ drainÂ \u0026lt;èŠ‚ç‚¹å\u0026gt;Â --ignore-daemonsetsÂ --delete-emptydir-data \u0026ndash;ignore-daemonsetsï¼šå…è®¸è·³è¿‡DaemonSetç®¡ç†çš„Pod \u0026ndash;delete-emptydir-dataï¼šå…è®¸åˆ é™¤ä½¿ç”¨emptyDirå·çš„Pod å¯ä»¥ç›´æ¥æ‰§è¡Œkubectl drainæ“ä½œï¼Œçœç•¥cordonæ­¥éª¤ã€‚ drainä¼šå…ˆcordonä¹‹åï¼Œå†å°è¯•ä¼˜é›…åœ°ç»ˆæ­¢è¯¥èŠ‚ç‚¹ä¸Šåœ°Podï¼ˆæ’ç©ºï¼‰ã€‚\nç¡®å®šèŠ‚ç‚¹å·²æ’ç©º 1kubectlÂ describeÂ nodeÂ \u0026lt;èŠ‚ç‚¹å\u0026gt; ` å…¶ä¸­ï¼Œ\nUnschedulabelï¼šåº”è¯¥æ˜¾ç¤ºä¸ºtrue Taintsï¼šåŒ…å«node.kubernetes.io/unschedulable:NoSchedule æ±¡ç‚¹ Non-terminated Podsï¼šè¿™é‡Œåº”è¯¥åªåˆ—å‡ºDaemonSetç®¡ç†çš„Podï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œå…¶å®ƒç±»å‹éƒ½å·²é©±é€ã€‚ ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹ 1kubectlÂ deleteÂ nodeÂ \u0026lt;èŠ‚ç‚¹å\u0026gt; ","permalink":"/tech/kubernetes/k8s-%E4%B8%8B%E7%BA%BF%E8%8A%82%E7%82%B9%E6%B5%81%E7%A8%8B/","summary":"\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eå°†èŠ‚ç‚¹è®¾ç½®ä¸ºä¸å¯è°ƒåº¦\u003c/strong\u003eï¼Œé˜²æ­¢æ–°çš„Podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003ekubectlÂ cordonÂ \u0026lt;èŠ‚ç‚¹å\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eæ’ç©ºèŠ‚ç‚¹ä¸Šçš„Pod\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e kubectlÂ drainÂ \u0026lt;èŠ‚ç‚¹å\u0026gt;Â --ignore-daemonsetsÂ --delete-emptydir-data\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\u0026ndash;ignore-daemonsetsï¼šå…è®¸è·³è¿‡DaemonSetç®¡ç†çš„Pod\u003c/li\u003e\n\u003cli\u003e\u0026ndash;delete-emptydir-dataï¼šå…è®¸åˆ é™¤ä½¿ç”¨emptyDirå·çš„Pod\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003eå¯ä»¥ç›´æ¥æ‰§è¡Œkubectl drainæ“ä½œï¼Œçœç•¥cordonæ­¥éª¤ã€‚\ndrainä¼šå…ˆcordonä¹‹åï¼Œå†å°è¯•ä¼˜é›…åœ°ç»ˆæ­¢è¯¥èŠ‚ç‚¹ä¸Šåœ°Podï¼ˆæ’ç©ºï¼‰ã€‚\u003c/p\u003e","title":"K8s ä¸‹çº¿èŠ‚ç‚¹æµç¨‹"},{"content":" å®‰è£… ipvs 1# å®‰è£… ipvs ç›¸å…³è½¯ä»¶åŒ… 2yum install ipvsadm ipset sysstat conntrack libseccomp 3 4# è½½å…¥æ¨¡å— 5modprobe -- ip_vs 6modprobe -- ip_vs_rr 7modprobe -- ip_vs_wrr 8modprobe -- ip_vs_sh 9modprobe -- nf_conntrack 10 11# åˆ›å»ºipvs.confï¼Œè®¾ç½®å†…æ ¸æ¨¡å—çš„è‡ªåŠ¨è½½å…¥ã€‚ 12cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/modules-load.d/ipvs.conf 13ip_vs 14ip_vs_lc 15ip_vs_wlc 16ip_vs_rr 17ip_vs_wrr 18ip_vs_lblc 19ip_vs_lblcr 20ip_vs_dh 21ip_vs_sh 22ip_vs_fo 23ip_vs_nq 24ip_vs_sed 25ip_vs_ftp 26ip_vs_sh 27nf_conntrack 28ip_tables 29ip_set 30xt_set 31ipt_set 32ipt_rpfilter 33ipt_REJECT 34ipip 35EOF 1systemctl enable --now systemd-modules-load.service ä¿®æ”¹ kube-proxy configmap 1# å°† mode æ”¹ä¸º \u0026#39;ipvs\u0026#39; 2kubectl edit cm kube-proxy -n kube-system é‡å¯ kube-proxy 1kubectl -n kube-system rollout restart daemonset kube-proxy æŸ¥çœ‹æ–° Kube-proxy pod çš„æ—¥å¿— ä¼šå‡ºç° Using ipvs Proxier\n1# æ£€æŸ¥ kube-proxy æ¨¡å¼ 2curl 127.0.0.1:10249/proxyMode ","permalink":"/tech/kubernetes/k8s-%E5%90%AF%E7%94%A8-ipvs-%E6%A8%A1%E5%BC%8F/","summary":"\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eå®‰è£… ipvs\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# å®‰è£… ipvs ç›¸å…³è½¯ä»¶åŒ…\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003eyum install ipvsadm ipset sysstat conntrack libseccomp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# è½½å…¥æ¨¡å—\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003emodprobe -- ip_vs\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003emodprobe -- ip_vs_rr\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003emodprobe -- ip_vs_wrr\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003emodprobe -- ip_vs_sh\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003emodprobe -- nf_conntrack\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# åˆ›å»ºipvs.confï¼Œè®¾ç½®å†…æ ¸æ¨¡å—çš„è‡ªåŠ¨è½½å…¥ã€‚\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003ecat \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;EOF \u0026gt; /etc/modules-load.d/ipvs.conf \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_lc\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_wlc\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_rr\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_wrr\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_lblc\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_lblcr\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_dh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_fo\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_nq\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_sed\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_ftp\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_vs_sh\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003enf_conntrack\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_tables\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eip_set\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003ext_set\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eipt_set\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eipt_rpfilter\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eipt_REJECT\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eipip\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e --now systemd-modules-load.service\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eä¿®æ”¹ kube-proxy configmap\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# å°† mode æ”¹ä¸º \u0026#39;ipvs\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003ekubectl edit cm kube-proxy -n kube-system\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003e\u003cstrong\u003eé‡å¯ kube-proxy\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003ekubectl -n kube-system rollout restart daemonset kube-proxy\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"4\"\u003e\n\u003cli\u003e\u003cstrong\u003eæŸ¥çœ‹æ–° Kube-proxy pod çš„æ—¥å¿—\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eä¼šå‡ºç° \u003ccode\u003eUsing ipvs Proxier\u003c/code\u003e\u003c/p\u003e","title":"K8s å¯ç”¨ ipvs æ¨¡å¼"},{"content":"MQTT è¿æ¥è¿‡ç¨‹ MQTT è¿æ¥ç”±å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·ã€‚\nä»»ä½•è¿è¡Œäº† MQTT å®¢æˆ·ç«¯åº“çš„ç¨‹åºæˆ–è®¾å¤‡éƒ½æ˜¯ä¸€ä¸ªÂ MQTT å®¢æˆ·ç«¯ï¼Œè€ŒÂ MQTT æœåŠ¡å™¨ è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥ï¼Œå¹¶å°†å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯è½¬å‘åˆ°å¦å¤–ä¸€äº›ç¬¦åˆæ¡ä»¶çš„å®¢æˆ·ç«¯ã€‚\nå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹ç½‘ç»œè¿æ¥åï¼Œéœ€è¦å…ˆå‘é€ä¸€ä¸ªÂ CONNECTÂ æ•°æ®åŒ…ç»™æœåŠ¡å™¨ã€‚\næœåŠ¡å™¨æ”¶åˆ°Â CONNECTÂ åŒ…åä¼šå›å¤ä¸€ä¸ªÂ CONNACKÂ ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°Â CONNACKÂ åŒ…åè¡¨ç¤º MQTT è¿æ¥å»ºç«‹æˆåŠŸã€‚\nå¦‚æœå®¢æˆ·ç«¯åœ¨è¶…æ—¶æ—¶é—´å†…æœªæ”¶åˆ°æœåŠ¡å™¨çš„Â CONNACKÂ æ•°æ®åŒ…ï¼Œå°±ä¼šä¸»åŠ¨å…³é—­è¿æ¥ã€‚\nå¤§å¤šæ•°åœºæ™¯ä¸‹ï¼ŒMQTT é€šè¿‡ TCP/IP åè®® è¿›è¡Œç½‘ç»œä¼ è¾“ï¼Œä½†æ˜¯ MQTT åŒæ—¶ä¹Ÿæ”¯æŒé€šè¿‡ WebSocket æˆ–è€… UDP è¿›è¡Œç½‘ç»œä¼ è¾“ã€‚\nMQTT over TCP TCP/IP åº”ç”¨å¹¿æ³›ï¼Œæ˜¯ä¸€ç§é¢å‘è¿æ¥çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµçš„ä¼ è¾“å±‚é€šä¿¡åè®®ã€‚å®ƒé€šè¿‡ ACK ç¡®è®¤å’Œé‡ä¼ æœºåˆ¶ï¼Œèƒ½å¤Ÿä¿è¯å‘é€çš„æ‰€æœ‰å­—èŠ‚åœ¨æ¥æ”¶æ—¶æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå¹¶ä¸”å­—èŠ‚é¡ºåºä¹Ÿæ˜¯æ­£ç¡®çš„ã€‚\nMQTT é€šå¸¸åŸºäº TCP è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œå®ƒç»§æ‰¿äº† TCP çš„å¾ˆå¤šä¼˜ç‚¹ï¼Œèƒ½ç¨³å®šè¿è¡Œåœ¨ä½å¸¦å®½ã€é«˜å»¶æ—¶ã€åŠèµ„æºå—é™çš„ç¯å¢ƒä¸‹ã€‚\nMQTT over WebSocket å¾ˆå¤šç‰©è”ç½‘åº”ç”¨éœ€è¦ä»¥ Web çš„æ–¹å¼è¢«ä½¿ç”¨ï¼Œæ¯”å¦‚å¾ˆå¤šè®¾å¤‡ç›‘æ§ç³»ç»Ÿéœ€è¦ä½¿ç”¨æµè§ˆå™¨å®æ—¶æ˜¾ç¤ºè®¾å¤‡æ•°æ®ã€‚ä½†æ˜¯æµè§ˆå™¨æ˜¯åŸºäº HTTP åè®®ä¼ è¾“æ•°æ®çš„ï¼Œä¹Ÿå°±æ— æ³•ä½¿ç”¨ MQTT over TCPã€‚\nMQTT åè®®åœ¨åˆ›å»ºä¹‹åˆä¾¿è€ƒè™‘åˆ°äº† Web åº”ç”¨çš„é‡è¦æ€§ï¼Œå®ƒæ”¯æŒé€šè¿‡ MQTT over WebSocket çš„æ–¹å¼è¿›è¡Œ MQTT é€šä¿¡ã€‚\nMQTT è¿æ¥å‚æ•° è¿æ¥åœ°å€ MQTT çš„è¿æ¥åœ°å€é€šå¸¸åŒ…å« ï¼šæœåŠ¡å™¨ IP æˆ–è€…åŸŸåã€æœåŠ¡å™¨ç«¯å£ã€è¿æ¥åè®®ã€‚\nåŸºäº TCP çš„ MQTT è¿æ¥ mqttÂ æ˜¯æ™®é€šçš„ TCP è¿æ¥ï¼Œç«¯å£ä¸€èˆ¬ä¸º 1883ã€‚\nmqttsÂ æ˜¯åŸºäº TLS/SSL çš„å®‰å…¨è¿æ¥ï¼Œç«¯å£ä¸€èˆ¬ä¸º 8883ã€‚\næ¯”å¦‚Â mqtt://broker.emqx.io:1883Â æ˜¯ä¸€ä¸ªåŸºäºæ™®é€š TCP çš„ MQTT è¿æ¥åœ°å€ã€‚\nåŸºäº WebSocket çš„è¿æ¥ wsÂ æ˜¯æ™®é€šçš„ WebSocket è¿æ¥ï¼Œç«¯å£ä¸€èˆ¬ä¸º 8083ã€‚\nwssÂ æ˜¯åŸºäº WebSocket çš„å®‰å…¨è¿æ¥ï¼Œç«¯å£ä¸€èˆ¬ä¸º 8084ã€‚\nå½“ä½¿ç”¨ WebSocket è¿æ¥æ—¶ï¼Œè¿æ¥åœ°å€è¿˜éœ€è¦åŒ…å« Pathï¼ŒEMQXÂ é»˜è®¤é…ç½®çš„ Path æ˜¯Â /mqttã€‚æ¯”å¦‚Â ws://broker.emqx.io:8083/mqttÂ æ˜¯ä¸€ä¸ªåŸºäº WebSocket çš„ MQTT è¿æ¥åœ°å€ã€‚\nClient ID MQTT æœåŠ¡å™¨ä½¿ç”¨ Client ID è¯†åˆ«å®¢æˆ·ç«¯ï¼Œè¿æ¥åˆ°æœåŠ¡å™¨çš„æ¯ä¸ªå®¢æˆ·ç«¯éƒ½å¿…é¡»è¦æœ‰å”¯ä¸€çš„ Client IDã€‚Client ID çš„é•¿åº¦é€šå¸¸ä¸º 1 è‡³ 23 ä¸ªå­—èŠ‚çš„ UTF-8 å­—ç¬¦ä¸²ã€‚\nå¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨ä¸€ä¸ªé‡å¤çš„ Client ID è¿æ¥è‡³æœåŠ¡å™¨ï¼Œå°†ä¼šæŠŠå·²ä½¿ç”¨è¯¥ Client ID è¿æ¥æˆåŠŸçš„å®¢æˆ·ç«¯è¸¢ä¸‹çº¿ã€‚ g\nUsername \u0026amp; Password MQTT åè®®åŸºäºç”¨æˆ·åå’Œå¯†ç æ¥è¿›è¡Œç›¸å…³çš„è®¤è¯å’Œæˆæƒï¼Œä½†æ˜¯å¦‚æœæ­¤ä¿¡æ¯æœªåŠ å¯†ï¼Œåˆ™ç”¨æˆ·åå’Œå¯†ç å°†ä»¥æ˜æ–‡æ–¹å¼ä¼ è¾“ã€‚å¦‚æœè®¾ç½®äº†ç”¨æˆ·åä¸å¯†ç è®¤è¯ï¼Œé‚£ä¹ˆæœ€å¥½è¦ä½¿ç”¨Â mqttsÂ æˆ–Â wssÂ åè®®ã€‚\nå¤§å¤šæ•° MQTT æœåŠ¡å™¨é»˜è®¤ä¸ºåŒ¿åè®¤è¯ï¼ŒåŒ¿åè®¤è¯æ—¶ç”¨æˆ·åä¸å¯†ç è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²å³å¯ã€‚\nConnect Timeout è¿æ¥è¶…æ—¶æ—¶é•¿ï¼Œæ”¶åˆ°æœåŠ¡å™¨è¿æ¥ç¡®è®¤å‰çš„ç­‰å¾…æ—¶é—´ï¼Œç­‰å¾…æ—¶é—´å†…æœªæ”¶åˆ°è¿æ¥ç¡®è®¤åˆ™ä¸ºè¿æ¥å¤±è´¥ã€‚\nKeep Alive ä¿æ´»å‘¨æœŸï¼Œæ˜¯ä¸€ä¸ªä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´é—´éš”ã€‚å®¢æˆ·ç«¯åœ¨æ— æŠ¥æ–‡å‘é€æ—¶ï¼Œå°†æŒ‰ Keep Alive è®¾å®šçš„å€¼å®šæ—¶å‘æœåŠ¡ç«¯å‘é€å¿ƒè·³æŠ¥æ–‡ï¼Œç¡®ä¿è¿æ¥ä¸è¢«æœåŠ¡ç«¯æ–­å¼€ã€‚\nåœ¨è¿æ¥å»ºç«‹æˆåŠŸåï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨ Keep Alive çš„ 1.5 å€æ—¶é—´å†…æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„ä»»ä½•åŒ…ï¼Œåˆ™ä¼šè®¤ä¸ºå’Œå®¢æˆ·ç«¯ä¹‹é—´çš„è¿æ¥å‡ºç°äº†é—®é¢˜ï¼Œæ­¤æ—¶æœåŠ¡å™¨ä¾¿ä¼šæ–­å¼€å’Œå®¢æˆ·ç«¯çš„è¿æ¥ã€‚\nClean Session Clean Session ä¸ºÂ falseÂ æ—¶è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªæŒä¹…ä¼šè¯ï¼Œåœ¨å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šè¯ä»ç„¶ä¿æŒå¹¶ä¿å­˜ç¦»çº¿æ¶ˆæ¯ï¼Œç›´åˆ°ä¼šè¯è¶…æ—¶æ³¨é”€ï¼›ä¸ºÂ trueÂ æ—¶è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸´æ—¶ä¼šè¯ï¼Œåœ¨å®¢æˆ·ç«¯æ–­å¼€æ—¶ï¼Œä¼šè¯è‡ªåŠ¨é”€æ¯ã€‚\næŒä¹…ä¼šè¯é¿å…äº†å®¢æˆ·ç«¯æ‰çº¿é‡è¿åæ¶ˆæ¯ä¸¢å¤±ï¼Œä¹Ÿé¿å…äº†å®¢æˆ·ç«¯è¿æ¥åé‡å¤çš„è®¢é˜…å¼€é”€ã€‚è¿™ä¸€åŠŸèƒ½åœ¨å¸¦å®½å°ï¼Œç½‘ç»œä¸ç¨³å®šçš„ç‰©è”ç½‘åœºæ™¯ä¸­éå¸¸å®ç”¨ã€‚\næœåŠ¡å™¨ä¸ºæŒä¹…ä¼šè¯ä¿å­˜çš„æ¶ˆæ¯æ•°é‡å–å†³äºæœåŠ¡å™¨çš„é…ç½®ã€‚\næ³¨æ„ï¼šÂ æŒä¹…ä¼šè¯æ¢å¤çš„å‰ææ˜¯å®¢æˆ·ç«¯ä½¿ç”¨å›ºå®šçš„ Client ID å†æ¬¡è¿æ¥ï¼Œå¦‚æœ Client ID æ˜¯åŠ¨æ€çš„ï¼Œé‚£ä¹ˆè¿æ¥æˆåŠŸåå°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æŒä¹…ä¼šè¯ã€‚\nLast Will é—å˜±æ¶ˆæ¯æ˜¯ MQTT ä¸ºé‚£äº›å¯èƒ½å‡ºç°æ„å¤–æ–­çº¿çš„è®¾å¤‡æä¾›çš„å°†é—å˜±ä¼˜é›…åœ°å‘é€ç»™å…¶ä»–å®¢æˆ·ç«¯çš„èƒ½åŠ›ã€‚è®¾ç½®äº†é—å˜±æ¶ˆæ¯æ¶ˆæ¯çš„ MQTT å®¢æˆ·ç«¯å¼‚å¸¸ä¸‹çº¿æ—¶ï¼ŒMQTT æœåŠ¡å™¨ä¼šå‘å¸ƒè¯¥å®¢æˆ·ç«¯è®¾ç½®çš„é—å˜±æ¶ˆæ¯ã€‚\næ„å¤–æ–­çº¿åŒ…æ‹¬ï¼šå› ç½‘ç»œæ•…éšœï¼Œè¿æ¥è¢«æœåŠ¡ç«¯å…³é—­ï¼›è®¾å¤‡æ„å¤–æ‰ç”µï¼›è®¾å¤‡å°è¯•è¿›è¡Œä¸è¢«å…è®¸çš„æ“ä½œè€Œè¢«æœåŠ¡ç«¯å…³é—­è¿æ¥ç­‰ã€‚\né—å˜±æ¶ˆæ¯å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ MQTT æ¶ˆæ¯ï¼Œå®ƒä¹ŸåŒ…å« Topicã€Payloadã€QoSã€Retain ç­‰ä¿¡æ¯ã€‚\nå½“è®¾å¤‡æ„å¤–æ–­çº¿æ—¶ï¼Œé—å˜±æ¶ˆæ¯å°†è¢«å‘é€è‡³é—å˜± Topicï¼› é—å˜± Payload æ˜¯å¾…å‘é€çš„æ¶ˆæ¯å†…å®¹ï¼› é—å˜± QoS ä¸æ™®é€š MQTT æ¶ˆæ¯çš„ QoS ä¸€è‡´ã€‚ é—å˜± Retain ä¸ºÂ trueÂ æ—¶è¡¨æ˜é—å˜±æ¶ˆæ¯æ˜¯ä¿ç•™æ¶ˆæ¯ã€‚MQTT æœåŠ¡å™¨ä¼šä¸ºæ¯ä¸ªä¸»é¢˜å­˜å‚¨æœ€æ–°ä¸€æ¡ä¿ç•™æ¶ˆæ¯ï¼Œä»¥æ–¹ä¾¿æ¶ˆæ¯å‘å¸ƒåæ‰ä¸Šçº¿çš„å®¢æˆ·ç«¯åœ¨è®¢é˜…ä¸»é¢˜æ—¶ä»å¯ä»¥æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯ã€‚ åè®®ç‰ˆæœ¬ ä½¿ç”¨è¾ƒå¤šçš„ MQTT åè®®ç‰ˆæœ¬æœ‰ MQTT v3.1ã€MQTT v3.1.1 åŠ MQTT v5.0ã€‚\nç›®å‰ï¼ŒMQTT 5.0 å·²æˆä¸ºç»å¤§å¤šæ•°ç‰©è”ç½‘ä¼ä¸šçš„é¦–é€‰åè®®ï¼Œæˆ‘ä»¬å»ºè®®åˆæ¬¡æ¥è§¦ MQTT çš„å¼€å‘è€…ç›´æ¥ä½¿ç”¨è¯¥ç‰ˆæœ¬ã€‚ä½†æ˜¯ï¼Œpaho.mqtt.golang ç›®å‰åªæ”¯æŒv3.1.1ã€‚\nå‚è€ƒèµ„æ–™ https://www.emqx.com/zh/blog/how-to-set-parameters-when-establishing-an-mqtt-connection ","permalink":"/tech/iot/mqtt-%E8%BF%9E%E6%8E%A5%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE/","summary":"\u003ch1 id=\"mqtt-è¿æ¥è¿‡ç¨‹\"\u003eMQTT è¿æ¥è¿‡ç¨‹\u003c/h1\u003e\n\u003cp\u003eMQTT è¿æ¥ç”±å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·ã€‚\u003c/p\u003e\n\u003cp\u003eä»»ä½•è¿è¡Œäº† MQTT å®¢æˆ·ç«¯åº“çš„ç¨‹åºæˆ–è®¾å¤‡éƒ½æ˜¯ä¸€ä¸ªÂ MQTT å®¢æˆ·ç«¯ï¼Œè€ŒÂ MQTT æœåŠ¡å™¨ è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥ï¼Œå¹¶å°†å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯è½¬å‘åˆ°å¦å¤–ä¸€äº›ç¬¦åˆæ¡ä»¶çš„å®¢æˆ·ç«¯ã€‚\u003c/p\u003e","title":"MQTT è¿æ¥å‚æ•°é…ç½®"},{"content":"K8S é›†ç¾¤ä¸­ NodePort é»˜è®¤èŒƒå›´ä¸º 30000-32767ã€‚\nè‹¥è¦ä¿®æ”¹æ­¤èŒƒå›´ï¼Œä¾æ¬¡ä¿®æ”¹ Master èŠ‚ç‚¹ä¸Šçš„ /etc/kubernetes/manifests/kube-apiserver.yaml æ–‡ä»¶ã€‚\n1# å¤‡ä»½é…ç½®æ–‡ä»¶ 2cp kube-apiserver.yaml kube-apiserver.yaml.bak 3vi kube-apiserver.yaml 4..... 5 Host Port: \u0026lt;none\u0026gt; 6 Command: 7 kube-apiserver 8 - --service-cluster-ip-range=10.96.0.0/12 9# æ’å…¥ 10 - --service-node-port-range=1-65535 ç„¶å, kube-apiserver ä¼šè‡ªåŠ¨é‡å¯ç”Ÿæ•ˆã€‚\næ³¨æ„ï¼Œå¤‡ä»½ kube-apiserver.yaml æ—¶ï¼Œä¸è¦å¤‡ä»½ä¸ºkube-apiserver.yaml/bak\n","permalink":"/tech/kubernetes/k8s-%E4%BF%AE%E6%94%B9-nodeport-%E9%BB%98%E8%AE%A4%E8%8C%83%E5%9B%B4/","summary":"\u003cp\u003eK8S é›†ç¾¤ä¸­ NodePort é»˜è®¤èŒƒå›´ä¸º 30000-32767ã€‚\u003c/p\u003e\n\u003cp\u003eè‹¥è¦ä¿®æ”¹æ­¤èŒƒå›´ï¼Œä¾æ¬¡ä¿®æ”¹ Master èŠ‚ç‚¹ä¸Šçš„ \u003ccode\u003e/etc/kubernetes/manifests/kube-apiserver.yaml\u003c/code\u003e æ–‡ä»¶ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# å¤‡ä»½é…ç½®æ–‡ä»¶\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003ecp kube-apiserver.yaml kube-apiserver.yaml.bak\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003evi kube-apiserver.yaml\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e.....\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    Host Port:     \u0026lt;none\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    Command:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e      kube-apiserver\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e      - --service-cluster-ip-range\u003cspan class=\"o\"\u003e=\u003c/span\u003e10.96.0.0/12\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# æ’å…¥\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e      - --service-node-port-range\u003cspan class=\"o\"\u003e=\u003c/span\u003e1-65535\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eç„¶å, \u003ccode\u003ekube-apiserver\u003c/code\u003e ä¼šè‡ªåŠ¨é‡å¯ç”Ÿæ•ˆã€‚\u003c/p\u003e","title":"K8s ä¿®æ”¹ NodePort é»˜è®¤èŒƒå›´"},{"content":"MQTT å‘å¸ƒ/è®¢é˜…æ¨¡å¼ å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼ˆPublish-Subscribe Patternï¼‰æ˜¯ä¸€ç§æ¶ˆæ¯ä¼ é€’æ¨¡å¼ï¼Œå°†å‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼ˆå‘å¸ƒè€…ï¼‰ä¸æ¥æ”¶æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼ˆè®¢é˜…è€…ï¼‰è§£è€¦ï¼Œä½¿å¾—ä¸¤è€…ä¸éœ€è¦å»ºç«‹ç›´æ¥çš„è”ç³»ä¹Ÿä¸éœ€è¦çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚\nMQTT å‘å¸ƒ/è®¢é˜…æ¨¡å¼å…³é”®åœ¨äºä»£ç†ï¼ˆBrokerï¼‰ ï¼Œä»£ç†è´Ÿè´£æ‰€æœ‰æ¶ˆæ¯çš„è·¯ç”±å’Œåˆ†å‘å·¥ä½œï¼Œå‘å¸ƒè€…å°†å¸¦æœ‰ä¸»é¢˜çš„æ¶ˆæ¯å‘é€ç»™ä»£ç†ï¼Œè®¢é˜…è€…åˆ™å‘ä»£ç†è®¢é˜…ä¸»é¢˜æ¥æ¥æ”¶æ„Ÿå…´è¶£çš„æ¶ˆæ¯ã€‚\nåœ¨ MQTT ä¸­ï¼Œä¸»é¢˜å’Œè®¢é˜…æ— æ³•è¢«æå‰æ³¨å†Œæˆ–åˆ›å»ºï¼Œæ‰€ä»¥ä»£ç†ä¹Ÿæ— æ³•é¢„çŸ¥æŸä¸€ä¸ªä¸»é¢˜ä¹‹åæ˜¯å¦ä¼šæœ‰è®¢é˜…è€…ï¼Œä»¥åŠä¼šæœ‰å¤šå°‘è®¢é˜…è€…ï¼Œæ‰€ä»¥åªèƒ½å°†æ¶ˆæ¯è½¬å‘ç»™å½“å‰çš„è®¢é˜…è€…ï¼Œå¦‚æœå½“å‰ä¸å­˜åœ¨ä»»ä½•è®¢é˜…ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°†è¢«ç›´æ¥ä¸¢å¼ƒã€‚\nMQTT å‘å¸ƒ/è®¢é˜…æ¨¡å¼æœ‰ 4 ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†ï¼šå‘å¸ƒè€…ã€è®¢é˜…è€…ã€ä»£ç†å’Œä¸»é¢˜ã€‚\nå‘å¸ƒè€…ï¼ˆPublisherï¼‰ï¼š å‘å¸ƒè€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°ä¸»é¢˜ä¸Šï¼Œå‘å¸ƒè€…ä¸€æ¬¡åªèƒ½å‘ä¸€ä¸ªä¸»é¢˜å‘é€æ•°æ®ï¼Œå‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯æ—¶ä¸å…³å¿ƒè®¢é˜…è€…æ˜¯å¦åœ¨çº¿ã€‚\nè®¢é˜…è€…ï¼ˆSubscriberï¼‰ï¼š è®¢é˜…è€…é€šè¿‡è®¢é˜…ä¸»é¢˜æ¥æ”¶æ¶ˆæ¯ï¼Œä¸”å¯ä¸€æ¬¡è®¢é˜…å¤šä¸ªä¸»é¢˜ã€‚MQTT æ”¯æŒé€šè¿‡å…±äº«è®¢é˜…çš„æ–¹å¼åœ¨å¤šä¸ªè®¢é˜…è€…ä¹‹é—´å®ç°è´Ÿè½½å‡è¡¡ã€‚\nä»£ç†ï¼ˆBrokerï¼‰: ä»£ç†è´Ÿè´£æ¥æ”¶å‘å¸ƒè€…çš„æ¶ˆæ¯ï¼Œå¹¶å°†æ¶ˆæ¯è½¬å‘è‡³ç¬¦åˆæ¡ä»¶çš„è®¢é˜…è€…ã€‚å¦å¤–ï¼Œä»£ç†ä¹Ÿéœ€è¦è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥ã€æ–­å¼€è¿æ¥ã€è®¢é˜…ã€å–æ¶ˆè®¢é˜…ç­‰è¯·æ±‚ã€‚\nä¸»é¢˜ï¼ˆTopicï¼‰: ä¸»é¢˜æ˜¯ MQTT è¿›è¡Œæ¶ˆæ¯è·¯ç”±çš„åŸºç¡€ï¼Œå®ƒç±»ä¼¼ URL è·¯å¾„ï¼Œä½¿ç”¨æ–œæ Â /Â è¿›è¡Œåˆ†å±‚ï¼Œæ¯”å¦‚Â sensor/1/temperatureã€‚ä¸€ä¸ªä¸»é¢˜å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€…ï¼Œä»£ç†ä¼šå°†è¯¥ä¸»é¢˜ä¸‹çš„æ¶ˆæ¯è½¬å‘ç»™æ‰€æœ‰è®¢é˜…è€…ï¼›ä¸€ä¸ªä¸»é¢˜ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªå‘å¸ƒè€…ï¼Œä»£ç†å°†æŒ‰ç…§æ¶ˆæ¯åˆ°è¾¾çš„é¡ºåºè½¬å‘ã€‚MQTT è¿˜æ”¯æŒè®¢é˜…è€…ä½¿ç”¨ä¸»é¢˜é€šé…ç¬¦ä¸€æ¬¡è®¢é˜…å¤šä¸ªä¸»é¢˜ã€‚\nMQTT å‘å¸ƒ/è®¢é˜…ä¸­çš„æ¶ˆæ¯è·¯ç”± åœ¨ MQTT å‘å¸ƒ/è®¢é˜…æ¨¡å¼ä¸­ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯æ—¢å¯ä»¥æ˜¯å‘å¸ƒè€…ï¼Œä¹Ÿå¯ä»¥æ˜¯è®¢é˜…è€…ï¼Œä¹Ÿå¯ä»¥åŒæ—¶å…·å¤‡è¿™ä¸¤ä¸ªèº«ä»½ã€‚ å½“å®¢æˆ·ç«¯å‘å¸ƒä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šè¢«å‘é€åˆ°ä»£ç†ï¼Œç„¶åä»£ç†å°†æ¶ˆæ¯è·¯ç”±åˆ°è¯¥ä¸»é¢˜çš„æ‰€æœ‰è®¢é˜…è€…ã€‚ å½“å®¢æˆ·ç«¯è®¢é˜…ä¸€ä¸ªä¸»é¢˜æ—¶ï¼Œå®ƒä¼šæ”¶åˆ°ä»£ç†è½¬å‘åˆ°è¯¥ä¸»é¢˜çš„æ‰€æœ‰æ¶ˆæ¯ã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œå¤§å¤šæ•°å‘å¸ƒ/è®¢é˜…ç³»ç»Ÿä¸»è¦é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼è¿‡æ»¤å¹¶è·¯ç”±æ¶ˆæ¯ã€‚\næ ¹æ®ä¸»é¢˜ï¼š è®¢é˜…è€…å‘ä»£ç†è®¢é˜…è‡ªå·±æ„Ÿå…´è¶£çš„ä¸»é¢˜ï¼Œå‘å¸ƒè€…å‘å¸ƒçš„æ‰€æœ‰æ¶ˆæ¯ä¸­éƒ½ä¼šåŒ…å«è‡ªå·±çš„ä¸»é¢˜ï¼Œä»£ç†æ ¹æ®æ¶ˆæ¯çš„ä¸»é¢˜åˆ¤æ–­éœ€è¦å°†æ¶ˆæ¯è½¬å‘ç»™å“ªäº›è®¢é˜…è€…ã€‚\næ ¹æ®æ¶ˆæ¯å†…å®¹ï¼š è®¢é˜…è€…å®šä¹‰å…¶æ„Ÿå…´è¶£çš„æ¶ˆæ¯çš„æ¡ä»¶ï¼Œåªæœ‰å½“æ¶ˆæ¯çš„å±æ€§æˆ–å†…å®¹æ»¡è¶³è®¢é˜…è€…å®šä¹‰çš„æ¡ä»¶æ—¶ï¼Œæ¶ˆæ¯æ‰ä¼šè¢«æŠ•é€’åˆ°è¯¥è®¢é˜…è€…ã€‚\nMQTT åè®®æ˜¯åŸºäºä¸»é¢˜è¿›è¡Œæ¶ˆæ¯è·¯ç”±çš„ã€‚\nMQTT ä¸ HTTP è¯·æ±‚å“åº” åŸºäºè¯·æ±‚å“åº”çš„ HTTP åœ¨ç‰©è”ç½‘é¢†åŸŸçš„åº”ç”¨å´æœ‰ä¸€å®šçš„å±€é™æ€§ã€‚\né¦–å…ˆï¼Œåè®®å±‚é¢ HTTP æŠ¥æ–‡ç›¸è¾ƒä¸ MQTT éœ€è¦å ç”¨æ›´å¤šçš„ç½‘ç»œå¼€é”€ï¼› å…¶æ¬¡ï¼ŒHTTP æ˜¯ä¸€ç§æ— çŠ¶æ€åè®®ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨åœ¨å¤„ç†è¯·æ±‚æ—¶ä¸ä¼šè®°å½•å®¢æˆ·ç«¯çš„çŠ¶æ€ï¼Œä¹Ÿæ— æ³•å®ç°ä»è¿æ¥å¼‚å¸¸æ–­å¼€ä¸­æ¢å¤ï¼› æœ€åï¼Œè¯·æ±‚å“åº”æ¨¡å¼éœ€è¦é€šè¿‡è½®è¯¢æ‰èƒ½è·å–æ•°æ®æ›´æ–°ï¼Œè€Œ MQTT é€šè¿‡è®¢é˜…å³å¯è·å–å®æ—¶æ•°æ®æ›´æ–°ã€‚ å‘å¸ƒè®¢é˜…æ¨¡å¼çš„æ¾è€¦åˆç‰¹æ€§ï¼Œä¹Ÿç»™ MQTT å¸¦æ¥äº†ä¸€äº›å‰¯ä½œç”¨ã€‚ç”±äºå‘å¸ƒè€…å¹¶ä¸çŸ¥æ™“è®¢é˜…è€…çš„çŠ¶æ€ï¼Œå› æ­¤å‘å¸ƒè€…ä¹Ÿæ— æ³•å¾—çŸ¥è®¢é˜…è€…æ˜¯å¦æ”¶åˆ°äº†æ¶ˆæ¯ï¼Œæˆ–è€…æ˜¯å¦æ­£ç¡®å¤„ç†äº†æ¶ˆæ¯ã€‚\nMQTT 5.0 å¢åŠ äº†è¯·æ±‚å“åº”ç‰¹æ€§ï¼Œä»¥å®ç°è®¢é˜…è€…æ”¶åˆ°æ¶ˆæ¯åå‘æŸä¸ªä¸»é¢˜å‘é€åº”ç­”ï¼Œå‘å¸ƒè€…æ”¶åˆ°åº”ç­”åå†è¿›è¡Œåç»­æ“ä½œã€‚\nMQTT ä¸æ¶ˆæ¯é˜Ÿåˆ— å°½ç®¡ MQTT ä¸æ¶ˆæ¯é˜Ÿåˆ—çš„å¾ˆå¤šè¡Œä¸ºå’Œç‰¹æ€§éå¸¸æ¥è¿‘ï¼Œæ¯”å¦‚éƒ½é‡‡ç”¨å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼Œä½†æ˜¯ä»–ä»¬é¢å‘çš„åœºæ™¯å´æœ‰ç€æ˜¾è‘—çš„ä¸åŒã€‚\næ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦ç”¨äºæœåŠ¡ç«¯åº”ç”¨ä¹‹é—´çš„æ¶ˆæ¯å­˜å‚¨ä¸è½¬å‘ï¼Œè¿™ç±»åœºæ™¯å¾€å¾€æ•°æ®é‡å¤§ä½†å®¢æˆ·ç«¯æ•°é‡å°‘ã€‚\nMQTT æ˜¯ä¸€ç§æ¶ˆæ¯ä¼ è¾“åè®®ï¼Œä¸»è¦ç”¨äºç‰©è”ç½‘è®¾å¤‡ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’ï¼Œè¿™ç±»åœºæ™¯çš„ç‰¹ç‚¹æ˜¯æµ·é‡çš„è®¾å¤‡æ¥å…¥ã€ç®¡ç†ä¸æ¶ˆæ¯ä¼ è¾“ã€‚\nåœ¨ä¸€äº›å®é™…çš„åº”ç”¨åœºæ™¯ä¸­ï¼ŒMQTT ä¸æ¶ˆæ¯é˜Ÿåˆ—å¾€å¾€ä¼šè¢«ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œä»¥ä½¿ MQTT æœåŠ¡å™¨èƒ½ä¸“æ³¨äºå¤„ç†è®¾å¤‡çš„è¿æ¥ä¸è®¾å¤‡é—´çš„æ¶ˆæ¯è·¯ç”±ã€‚æ¯”å¦‚å…ˆç”± MQTT æœåŠ¡å™¨æ¥æ”¶ç‰©è”ç½‘è®¾å¤‡ä¸ŠæŠ¥çš„æ•°æ®ï¼Œç„¶åå†é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å°†è¿™äº›æ•°æ®è½¬å‘åˆ°ä¸åŒçš„ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œå¤„ç†ã€‚\nä¸åŒäºæ¶ˆæ¯é˜Ÿåˆ—ï¼ŒMQTT ä¸»é¢˜ä¸éœ€è¦æå‰åˆ›å»ºã€‚MQTT å®¢æˆ·ç«¯åœ¨è®¢é˜…æˆ–å‘å¸ƒæ—¶å³è‡ªåŠ¨çš„åˆ›å»ºäº†ä¸»é¢˜ï¼Œå¼€å‘è€…æ— éœ€å†å…³å¿ƒä¸»é¢˜çš„åˆ›å»ºï¼Œå¹¶ä¸”ä¹Ÿä¸éœ€è¦æ‰‹åŠ¨åˆ é™¤ä¸»é¢˜ã€‚\nå‚è€ƒèµ„æ–™ https://www.emqx.com/zh/blog/mqtt-5-introduction-to-publish-subscribe-model ","permalink":"/tech/iot/mqtt-%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F/","summary":"\u003ch1 id=\"mqtt-å‘å¸ƒè®¢é˜…æ¨¡å¼\"\u003eMQTT å‘å¸ƒ/è®¢é˜…æ¨¡å¼\u003c/h1\u003e\n\u003cp\u003eå‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼ˆPublish-Subscribe Patternï¼‰æ˜¯ä¸€ç§æ¶ˆæ¯ä¼ é€’æ¨¡å¼ï¼Œå°†å‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼ˆå‘å¸ƒè€…ï¼‰ä¸æ¥æ”¶æ¶ˆæ¯çš„å®¢æˆ·ç«¯ï¼ˆè®¢é˜…è€…ï¼‰è§£è€¦ï¼Œä½¿å¾—ä¸¤è€…ä¸éœ€è¦å»ºç«‹ç›´æ¥çš„è”ç³»ä¹Ÿä¸éœ€è¦çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚\u003c/p\u003e","title":"MQTT å‘å¸ƒ-è®¢é˜…æ¨¡å¼"},{"content":"ä»€ä¹ˆæ˜¯ QoS ä½¿ç”¨ MQTT åè®®çš„è®¾å¤‡ä¸€èˆ¬è¿è¡Œåœ¨ç½‘ç»œå—é™çš„ç¯å¢ƒä¸‹ï¼Œåªä¾é åº•å±‚TCP ä¼ è¾“åè®®å¹¶ä¸èƒ½å®Œå…¨ä¿è¯æ¶ˆæ¯çš„å¯é åˆ°è¾¾ã€‚\nå› æ­¤ï¼ŒMQTT æä¾›äº† QoSï¼ˆQuality ofÂ serviceï¼‰ æœºåˆ¶ï¼Œå…¶æ ¸å¿ƒæ˜¯è®¾è®¡äº†å¤šç§æ¶ˆæ¯äº¤äº’æœºåˆ¶æ¥æä¾›ä¸åŒçš„æœåŠ¡è´¨é‡ï¼Œæ¥æ»¡è¶³ç”¨æˆ·åœ¨å„ç§åœºæ™¯ä¸‹å¯¹æ¶ˆæ¯å¯é æ€§çš„è¦æ±‚ã€‚\nMQTT å®šä¹‰äº†ä¸‰ä¸ª QoS ç­‰çº§ï¼Œåˆ†åˆ«ä¸ºï¼š\nQoS 0ï¼Œæœ€å¤šäº¤ä»˜ä¸€æ¬¡ã€‚ QoS 1ï¼Œè‡³å°‘äº¤ä»˜ä¸€æ¬¡ã€‚ QoS 2ï¼Œåªäº¤ä»˜ä¸€æ¬¡ã€‚ å…¶ä¸­ï¼Œä½¿ç”¨ QoS 0 å¯èƒ½ä¸¢å¤±æ¶ˆæ¯ï¼Œä½¿ç”¨ QoS 1 å¯ä»¥ä¿è¯æ”¶åˆ°æ¶ˆæ¯ï¼Œä½†æ¶ˆæ¯å¯èƒ½é‡å¤ï¼Œä½¿ç”¨ QoS 2 å¯ä»¥ä¿è¯æ¶ˆæ¯æ—¢ä¸ä¸¢å¤±ä¹Ÿä¸é‡å¤ã€‚\nQoS ç­‰çº§ä»ä½åˆ°é«˜ï¼Œä¸ä»…æ„å‘³ç€æ¶ˆæ¯å¯é æ€§çš„æå‡ï¼Œä¹Ÿæ„å‘³ç€ä¼ è¾“å¤æ‚ç¨‹åº¦çš„æå‡ã€‚\nåœ¨ä¸€ä¸ªå®Œæ•´çš„ä»å‘å¸ƒè€…åˆ°è®¢é˜…è€…çš„æ¶ˆæ¯æŠ•é€’æµç¨‹ä¸­ï¼ŒQoS ç­‰çº§æ˜¯ç”±å‘å¸ƒè€…åœ¨ PUBLISH æŠ¥æ–‡ä¸­æŒ‡å®šï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ Broker å‘è®¢é˜…è€…è½¬å‘æ¶ˆæ¯æ—¶éƒ½ä¼šç»´æŒåŸå§‹çš„ QoS ä¸å˜ã€‚ä¸è¿‡ä¹Ÿæœ‰ä¸€äº›ä¾‹å¤–çš„æƒ…å†µï¼Œæ ¹æ®è®¢é˜…è€…çš„è®¢é˜…è¦æ±‚ï¼Œæ¶ˆæ¯çš„ QoS ç­‰çº§å¯èƒ½ä¼šåœ¨è½¬å‘çš„æ—¶å€™å‘ç”Ÿé™çº§ã€‚\nä¾‹å¦‚ï¼Œè®¢é˜…è€…åœ¨è®¢é˜…æ—¶è¦æ±‚ Broker å¯ä»¥å‘å…¶è½¬å‘çš„æ¶ˆæ¯çš„æœ€å¤§ QoS ç­‰çº§ä¸º QoS 1ï¼Œé‚£ä¹ˆåç»­æ‰€æœ‰ QoS 2 æ¶ˆæ¯éƒ½ä¼šé™çº§è‡³ QoS 1 è½¬å‘ç»™æ­¤è®¢é˜…è€…ï¼Œè€Œæ‰€æœ‰ QoS 0 å’Œ QoS 1 æ¶ˆæ¯åˆ™ä¼šä¿æŒåŸå§‹çš„ QoS ç­‰çº§è½¬å‘ã€‚\nQoS 0 - æœ€å¤šäº¤ä»˜ä¸€æ¬¡ QoS 0 æ˜¯æœ€ä½çš„ QoS ç­‰çº§ã€‚\nQoS 0 æ¶ˆæ¯å³å‘å³å¼ƒï¼Œä¸éœ€è¦ç­‰å¾…ç¡®è®¤ï¼Œä¸éœ€è¦å­˜å‚¨å’Œé‡ä¼ ï¼Œå¯¹äºæ¥æ”¶æ–¹æ¥è¯´ï¼Œä¸éœ€è¦æ‹…å¿ƒæ”¶åˆ°é‡å¤çš„æ¶ˆæ¯ã€‚\nä¸ºä»€ä¹ˆ QoS 0 æ¶ˆæ¯ä¼šä¸¢å¤±ï¼Ÿ\nä½¿ç”¨ QoS 0 ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯çš„å¯é æ€§å®Œå…¨ä¾èµ–äºåº•å±‚çš„ TCP åè®®ã€‚\nè€Œ TCP åªèƒ½ä¿è¯åœ¨è¿æ¥ç¨³å®šä¸å…³é—­çš„æƒ…å†µä¸‹æ¶ˆæ¯çš„å¯é åˆ°è¾¾ï¼Œä¸€æ—¦å‡ºç°è¿æ¥å…³é—­ã€é‡ç½®ï¼Œä»æœ‰å¯èƒ½ä¸¢å¤±å½“å‰å¤„äºç½‘ç»œé“¾è·¯æˆ–æ“ä½œç³»ç»Ÿåº•å±‚ç¼“å†²åŒºä¸­çš„æ¶ˆæ¯ã€‚è¿™ä¹Ÿæ˜¯ QoS 0 æ¶ˆæ¯æœ€ä¸»è¦çš„ä¸¢å¤±åœºæ™¯ã€‚\nQoS 1 - è‡³å°‘äº¤ä»˜ä¸€æ¬¡ ä¸ºäº†ä¿è¯æ¶ˆæ¯åˆ°è¾¾ï¼ŒQoS 1 åŠ å…¥äº†åº”ç­”ä¸é‡ä¼ æœºåˆ¶ã€‚\nå‘é€æ–¹åªæœ‰åœ¨æ”¶åˆ°æ¥æ”¶æ–¹çš„ PUBACK æŠ¥æ–‡ä»¥åï¼Œæ‰èƒ½è®¤ä¸ºæ¶ˆæ¯æŠ•é€’æˆåŠŸï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œå‘é€æ–¹éœ€è¦å­˜å‚¨è¯¥ PUBLISH æŠ¥æ–‡ä»¥ä¾¿ä¸‹æ¬¡é‡ä¼ ã€‚\nQoS 1 éœ€è¦åœ¨ PUBLISH æŠ¥æ–‡ä¸­è®¾ç½® Packet IDï¼Œè€Œä½œä¸ºå“åº”çš„ PUBACK æŠ¥æ–‡ï¼Œåˆ™ä¼šä½¿ç”¨ä¸ PUBLISH æŠ¥æ–‡ç›¸åŒçš„ Packet IDï¼Œä»¥ä¾¿å‘é€æ–¹æ”¶åˆ°ååˆ é™¤æ­£ç¡®çš„ PUBLISH æŠ¥æ–‡ç¼“å­˜ã€‚\nä¸ºä»€ä¹ˆ QoS 1 æ¶ˆæ¯ä¼šé‡å¤ï¼Ÿ\nå¯¹äºå‘é€æ–¹ï¼Œæ²¡æ”¶åˆ° PUBACK æŠ¥æ–‡åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š\nPUBLISH æœªåˆ°è¾¾æ¥æ”¶æ–¹ PUBLISH å·²ç»åˆ°è¾¾æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹çš„ PUBACK æŠ¥æ–‡è¿˜æœªåˆ°è¾¾å‘é€æ–¹ å¯¹äºCASE 1ï¼Œå‘é€æ–¹è™½ç„¶é‡ä¼ äº† PUBLISH æŠ¥æ–‡ï¼Œä½†æ˜¯å¯¹äºæ¥æ”¶æ–¹æ¥è¯´ï¼Œå®é™…ä¸Šä»ç„¶ä»…æ”¶åˆ°äº†ä¸€æ¬¡æ¶ˆæ¯ã€‚\nå¯¹äºCASE 2ï¼Œåœ¨å‘é€æ–¹é‡ä¼ æ—¶ï¼Œæ¥æ”¶æ–¹å·²ç»æ”¶åˆ°è¿‡äº†è¿™ä¸ª PUBLISH æŠ¥æ–‡ï¼Œè¿™å°±å¯¼è‡´æ¥æ”¶æ–¹å°†æ”¶åˆ°é‡å¤çš„æ¶ˆæ¯ã€‚è™½ç„¶é‡ä¼ æ—¶ PUBLISH æŠ¥æ–‡ä¸­çš„ DUP æ ‡å¿—ä¼šè¢«è®¾ç½®ä¸º 1ï¼Œç”¨ä»¥è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé‡ä¼ çš„æŠ¥æ–‡ã€‚ä½†æ˜¯æ¥æ”¶æ–¹å¹¶ä¸èƒ½å› æ­¤å‡å®šè‡ªå·±æ›¾ç»æ¥æ”¶è¿‡è¿™ä¸ªæ¶ˆæ¯ï¼Œä»ç„¶éœ€è¦å°†å…¶è§†ä½œä¸€ä¸ªå…¨æ–°çš„æ¶ˆæ¯ã€‚\nå¯¹äºæ¥æ”¶æ–¹ï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š å¯¹äºCASE 1ï¼Œå‘é€æ–¹ç”±äºæ²¡æœ‰æ”¶åˆ° PUBACK æŠ¥æ–‡è€Œé‡ä¼ äº† PUBLISH æŠ¥æ–‡ã€‚æ­¤æ—¶ï¼Œæ¥æ”¶æ–¹æ”¶åˆ°çš„å‰åä¸¤ä¸ª PUBLISH æŠ¥æ–‡ä½¿ç”¨äº†ç›¸åŒçš„ Packet IDï¼Œå¹¶ä¸”ç¬¬äºŒä¸ª PUBLISH æŠ¥æ–‡çš„ DUP æ ‡å¿—ä¸º 1ï¼Œæ­¤æ—¶å®ƒç¡®å®æ˜¯ä¸€ä¸ªé‡å¤çš„æ¶ˆæ¯ã€‚\nå¯¹äºCASE 2ï¼Œç¬¬ä¸€ä¸ª PUBLISH æŠ¥æ–‡å·²ç»å®Œæˆäº†æŠ•é€’ï¼Œ1024 è¿™ä¸ª Packet ID é‡æ–°å˜ä¸ºå¯ç”¨çŠ¶æ€ã€‚å‘é€æ–¹ä½¿ç”¨è¿™ä¸ª Packet ID å‘é€äº†ä¸€ä¸ªå…¨æ–°çš„ PUBLISH æŠ¥æ–‡ï¼Œä½†è¿™ä¸€æ¬¡æŠ¥æ–‡æœªèƒ½åˆ°è¾¾å¯¹ç«¯ï¼Œæ‰€ä»¥å‘é€æ–¹åç»­é‡ä¼ äº†è¿™ä¸ª PUBLISH æŠ¥æ–‡ã€‚è¿™å°±ä½¿å¾—è™½ç„¶æ¥æ”¶æ–¹æ”¶åˆ°çš„ç¬¬äºŒä¸ª PUBLISH æŠ¥æ–‡åŒæ ·æ˜¯ç›¸åŒçš„ Packet IDï¼Œå¹¶ä¸” DUP ä¸º 1ï¼Œä½†ç¡®å®æ˜¯ä¸€ä¸ªå…¨æ–°çš„æ¶ˆæ¯ã€‚\nç”±äºæˆ‘ä»¬æ— æ³•åŒºåˆ†è¿™ä¸¤ç§æƒ…å†µï¼Œæ‰€ä»¥åªèƒ½è®©æ¥æ”¶æ–¹å°†è¿™äº› PUBLISH æŠ¥æ–‡éƒ½å½“ä½œå…¨æ–°çš„æ¶ˆæ¯æ¥å¤„ç†ã€‚å› æ­¤å½“æˆ‘ä»¬ä½¿ç”¨ QoS 1 æ—¶ï¼Œæ¶ˆæ¯çš„é‡å¤åœ¨åè®®å±‚é¢ä¸Šæ˜¯æ— æ³•é¿å…çš„ã€‚\næç«¯æƒ…å†µä¸‹ï¼ŒBroker ä»å‘å¸ƒæ–¹æ”¶åˆ°äº†é‡å¤çš„ PUBLISH æŠ¥æ–‡ï¼Œè€Œåœ¨å°†è¿™äº›æŠ¥æ–‡è½¬å‘ç»™è®¢é˜…æ–¹çš„è¿‡ç¨‹ä¸­ï¼Œå†æ¬¡å‘ç”Ÿé‡ä¼ ï¼Œè¿™å°†å¯¼è‡´è®¢é˜…æ–¹æœ€ç»ˆæ”¶åˆ°æ›´å¤šçš„é‡å¤æ¶ˆæ¯ã€‚\nä»¥ä¸Šï¼Œå°±æ˜¯ QoS 1 ä¿è¯æ¶ˆæ¯åˆ°è¾¾ï¼Œå¯¼è‡´çš„æ¶ˆæ¯é‡å¤ã€‚\nQoS 2 - åªäº¤ä»˜ä¸€æ¬¡ QoS 2 è§£å†³äº† QoS 0ã€1 æ¶ˆæ¯å¯èƒ½ä¸¢å¤±æˆ–è€…é‡å¤çš„é—®é¢˜ï¼Œä½†ç›¸åº”åœ°ï¼Œå®ƒä¹Ÿå¸¦æ¥äº†æœ€å¤æ‚çš„äº¤äº’æµç¨‹å’Œæœ€é«˜çš„å¼€é”€ã€‚æ¯ä¸€æ¬¡çš„ QoS 2 æ¶ˆæ¯æŠ•é€’ï¼Œéƒ½è¦æ±‚å‘é€æ–¹ä¸æ¥æ”¶æ–¹è¿›è¡Œè‡³å°‘ä¸¤æ¬¡è¯·æ±‚/å“åº”æµç¨‹ã€‚\nå‘é€æ–¹å­˜å‚¨å¹¶å‘é€ QoS ä¸º 2 çš„ PUBLISH æŠ¥æ–‡å¯åŠ¨ä¸€æ¬¡ QoS 2 æ¶ˆæ¯çš„ä¼ è¾“ï¼Œå¹¶ç­‰å¾…æ¥æ”¶æ–¹å›å¤ PUBREC æŠ¥æ–‡ã€‚è¿™ä¸€éƒ¨åˆ†ä¸ QoS 1 åŸºæœ¬ä¸€è‡´ï¼Œä½†å“åº”æŠ¥æ–‡ä» PUBACK å˜æˆäº† PUBRECã€‚ å½“å‘é€æ–¹æ”¶åˆ° PUBREC æŠ¥æ–‡ï¼Œå³ç¡®è®¤æ¥æ”¶æ–¹æ”¶åˆ°äº† PUBLISH æŠ¥æ–‡ï¼Œå‘é€æ–¹å°†ä¸å†éœ€è¦é‡ä¼ è¿™ä¸ªæŠ¥æ–‡ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½å†é‡ä¼ è¿™ä¸ªæŠ¥æ–‡ã€‚æ­¤æ—¶å‘é€æ–¹åˆ é™¤æœ¬åœ°å­˜å‚¨çš„ PUBLISH æŠ¥æ–‡ï¼Œå¹¶å­˜å‚¨å¹¶å‘é€ PUBREL æŠ¥æ–‡ï¼Œé€šçŸ¥æ¥å—æ–¹æœ¬æ¬¡ä½¿ç”¨çš„ Packet ID å°†è¢«æ ‡è®°ä¸ºå¯ç”¨ã€‚ä¸ PUBLISH æŠ¥æ–‡ç›¸åŒï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦æ”¶åˆ°å“åº”æŠ¥æ–‡ä»¥ç¡®ä¿ PUBREL æŠ¥æ–‡åˆ°è¾¾å¯¹ç«¯ã€‚ å½“æ¥æ”¶æ–¹æ”¶åˆ° PUBREL æŠ¥æ–‡ï¼Œå¯ä»¥ç¡®è®¤æœ¬æ¬¡ä¼ è¾“æµç¨‹ä¸­ä¸ä¼šå†æœ‰é‡ä¼ çš„ PUBLISH æŠ¥æ–‡åˆ°è¾¾ï¼Œå› æ­¤å›å¤ PUBCOMP æŠ¥æ–‡è¡¨ç¤ºç¡®è®¤å½“å‰ Packet ID å¯ä»¥ç”¨äºæ–°çš„æ¶ˆæ¯ã€‚ å½“å‘é€æ–¹æ”¶åˆ° PUBCOMP æŠ¥æ–‡ï¼Œæœ¬æ¬¡ QoS 2 æ¶ˆæ¯ä¼ è¾“æ­£å¼å®Œæˆã€‚ä¹‹åï¼Œå‘é€æ–¹å¯ä»¥å†æ¬¡ä½¿ç”¨å½“å‰çš„ Packet ID å‘é€æ–°çš„æ¶ˆæ¯ï¼Œè€Œæ¥æ”¶æ–¹å†æ¬¡æ”¶åˆ°ä½¿ç”¨è¿™ä¸ª Packet ID çš„ PUBLISH æŠ¥æ–‡æ—¶ï¼Œä¹Ÿä¼šå°†å®ƒè§†ä¸ºä¸€ä¸ªå…¨æ–°çš„æ¶ˆæ¯ã€‚ ä¸ºä»€ä¹ˆ QoS 2 æ¶ˆæ¯ä¸ä¼šé‡å¤ï¼Ÿ\nQoS 2 ä¸ QoS 1 ç›¸åŒï¼Œé€šè¿‡å“åº”æŠ¥æ–‡ä¿è¯æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚ä¸ QoS 1 ç›¸æ¯”ï¼ŒQoS 2 æ–°å¢äº† PUBREL æŠ¥æ–‡å’Œ PUBCOMP æŠ¥æ–‡çš„æµç¨‹ï¼Œä»¥ä¿è¯æ¶ˆæ¯ä¸é‡å¤ã€‚\né¦–å…ˆå›é¡¾ä¸€ä¸‹ QoS 1 æ¶ˆæ¯æ— æ³•é¿å…é‡å¤çš„åŸå› ï¼šä½¿ç”¨ QoS 1 æ¶ˆæ¯æ—¶ï¼Œå¯¹æ¥æ”¶æ–¹æ¥è¯´ï¼Œå›å¤å®Œ PUBACK å“åº”æŠ¥æ–‡å Packet ID å°±é‡æ–°å¯ç”¨äº†ï¼Œä¹Ÿä¸ç®¡å“åº”æ˜¯å¦ç¡®å®åˆ°è¾¾äº†å‘é€æ–¹ã€‚æ‰€ä»¥æ— æ³•å¾—çŸ¥ä¹‹ååˆ°è¾¾çš„ï¼Œæºå¸¦äº†ç›¸åŒ Packet ID çš„ PUBLISH æŠ¥æ–‡æ˜¯å‘é€æ–¹æ²¡æœ‰æ”¶åˆ°å“åº”è€Œé‡ä¼ çš„ï¼Œè¿˜æ˜¯å‘é€æ–¹æ”¶åˆ°äº†å“åº”æ‰€ä»¥é‡æ–°ä½¿ç”¨äº†è¿™ä¸ª Packet ID å‘é€äº†ä¸€ä¸ªå…¨æ–°çš„æ¶ˆæ¯ã€‚\n![[https://assets.emqx.com/images/81b397e0a44a6abd3adbe411d1219272.png?x-image-process=image/resize,w_1520/format,webp]]\næ‰€ä»¥ï¼Œæ¶ˆæ¯å»é‡çš„å…³é”®å°±åœ¨äºé€šä¿¡åŒæ–¹å¦‚ä½•æ­£ç¡®åœ°åŒæ­¥é‡Šæ”¾ Packet IDï¼Œæ¢å¥è¯è¯´ï¼Œä¸ç®¡å‘é€æ–¹æ˜¯é‡ä¼ æ¶ˆæ¯è¿˜æ˜¯å‘å¸ƒæ–°æ¶ˆæ¯ï¼Œä¸€å®šæ˜¯å’Œå¯¹ç«¯è¾¾æˆå…±è¯†äº†çš„ã€‚\nQoS 2 å¢åŠ çš„ PUBREL æµç¨‹æä¾›äº†å¸®åŠ©é€šä¿¡åŒæ–¹åå•† Packet ID ä½•æ—¶å¯ä»¥é‡ç”¨çš„èƒ½åŠ›ã€‚\nQoS 2 è§„å®šï¼Œå‘é€æ–¹åªæœ‰åœ¨æ”¶åˆ° PUBREC æŠ¥æ–‡ä¹‹å‰å¯ä»¥é‡ä¼  PUBLISH æŠ¥æ–‡ã€‚ ä¸€æ—¦æ”¶åˆ° PUBREC æŠ¥æ–‡å¹¶å‘å‡º PUBREL æŠ¥æ–‡ï¼Œå‘é€æ–¹å°±è¿›å…¥äº† Packet ID é‡Šæ”¾æµç¨‹ï¼Œä¸å¯ä»¥å†ä½¿ç”¨å½“å‰ Packet ID é‡ä¼  PUBLISH æŠ¥æ–‡ã€‚åŒæ—¶ï¼Œåœ¨æ”¶åˆ°å¯¹ç«¯å›å¤çš„ PUBCOMP æŠ¥æ–‡ç¡®è®¤åŒæ–¹éƒ½å®Œæˆ Packet ID é‡Šæ”¾ä¹‹å‰ï¼Œä¹Ÿä¸å¯ä»¥ä½¿ç”¨å½“å‰ Packet ID å‘é€æ–°çš„æ¶ˆæ¯ã€‚\nå› æ­¤å¯¹äºæ¥æ”¶æ–¹æ¥è¯´ï¼Œä»¥ PUBREL æŠ¥æ–‡ä¸ºç•Œé™ï¼Œå‡¡æ˜¯åœ¨ PUBREL æŠ¥æ–‡ä¹‹å‰åˆ°è¾¾çš„ PUBLISH æŠ¥æ–‡ï¼Œéƒ½å¿…ç„¶æ˜¯é‡å¤çš„æ¶ˆæ¯ï¼›è€Œå‡¡æ˜¯åœ¨ PUBREL æŠ¥æ–‡ä¹‹ååˆ°è¾¾çš„ PUBLISH æŠ¥æ–‡ï¼Œéƒ½å¿…ç„¶æ˜¯å…¨æ–°çš„æ¶ˆæ¯ã€‚\nä¸€æ—¦æœ‰äº†è¿™ä¸ªå‰æï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿåœ¨åè®®å±‚é¢å®Œæˆ QoS 2 æ¶ˆæ¯çš„å»é‡ã€‚\nä¸åŒ QoS çš„é€‚ç”¨åœºæ™¯å’Œæ³¨æ„äº‹é¡¹ QoS 0 QoS 0 çš„ç¼ºç‚¹æ˜¯å¯èƒ½ä¼šä¸¢å¤±æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸¢å¤±çš„é¢‘ç‡ä¾èµ–äºä½ æ‰€å¤„çš„ç½‘ç»œç¯å¢ƒï¼Œå¹¶ä¸”å¯èƒ½ä½¿ä½ é”™è¿‡æ–­å¼€è¿æ¥æœŸé—´çš„æ¶ˆæ¯ï¼Œä¸è¿‡ä¼˜ç‚¹æ˜¯æŠ•é€’çš„æ•ˆç‡è¾ƒé«˜ã€‚\næ‰€ä»¥æˆ‘ä»¬é€šå¸¸é€‰æ‹©ä½¿ç”¨ QoS 0 ä¼ è¾“ä¸€äº›é«˜é¢‘ä¸”ä¸é‚£ä¹ˆé‡è¦çš„æ•°æ®ï¼Œæ¯”å¦‚ä¼ æ„Ÿå™¨æ•°æ®ï¼Œå‘¨æœŸæ€§æ›´æ–°ï¼Œå³ä½¿é—æ¼å‡ ä¸ªå‘¨æœŸçš„æ•°æ®ä¹Ÿå¯ä»¥æ¥å—ã€‚\nQoS 1 QoS 1 å¯ä»¥ä¿è¯æ¶ˆæ¯åˆ°è¾¾ï¼Œæ‰€ä»¥é€‚åˆä¼ è¾“ä¸€äº›è¾ƒä¸ºé‡è¦çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸‹è¾¾å…³é”®æŒ‡ä»¤ã€æ›´æ–°æœ‰å®æ—¶æ€§è¦æ±‚çš„çŠ¶æ€ç­‰ã€‚\nä½†å› ä¸º QoS 1 è¿˜å¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ QoS 1 æ—¶ï¼Œè¿˜éœ€è¦èƒ½å¤Ÿå¤„ç†æ¶ˆæ¯çš„é‡å¤ï¼Œæˆ–è€…èƒ½å¤Ÿå…è®¸æ¶ˆæ¯çš„é‡å¤ã€‚\nåœ¨æˆ‘ä»¬å†³å®šä½¿ç”¨ QoS 1 å¹¶ä¸”ä¸å¯¹å…¶è¿›è¡Œå»é‡å¤„ç†ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ï¼Œå…è®¸æ¶ˆæ¯çš„é‡å¤ï¼Œå¯èƒ½æ„å‘³ç€ä»€ä¹ˆã€‚\nå¦‚æœæˆ‘ä»¬ä¸å¯¹ QoS 1 è¿›è¡Œå»é‡å¤„ç†ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé­é‡è¿™ç§æƒ…å†µï¼Œå‘å¸ƒæ–¹ä»¥ 1ã€2 çš„é¡ºåºå‘å¸ƒæ¶ˆæ¯ï¼Œä½†æœ€ç»ˆè®¢é˜…æ–¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯é¡ºåºå¯èƒ½æ˜¯ 1ã€2ã€1ã€2ã€‚ å¦‚æœ 1 è¡¨ç¤ºå¼€ç¯æŒ‡ä»¤ï¼Œ2 è¡¨ç¤ºå…³ç¯æŒ‡ä»¤ï¼Œæˆ‘æƒ³å¤§éƒ¨åˆ†ç”¨æˆ·éƒ½ä¸ä¼šæ¥å—è‡ªå·±ä»…ä»…è¿›è¡Œäº†å¼€ç¯ç„¶åå…³ç¯çš„æ“ä½œï¼Œç»“æœç¯åœ¨å¼€å’Œå…³çš„çŠ¶æ€æ¥å›å˜åŒ–ã€‚\nQoS 2 QoS 2 æ—¢å¯ä»¥ä¿è¯æ¶ˆæ¯åˆ°è¾¾ï¼Œä¹Ÿå¯ä»¥ä¿è¯æ¶ˆæ¯ä¸ä¼šé‡å¤ï¼Œä½†ä¼ è¾“æˆæœ¬æœ€é«˜ã€‚\nå¦‚æœæˆ‘ä»¬ä¸æ„¿æ„è‡ªè¡Œå®ç°å»é‡æ–¹æ¡ˆï¼Œå¹¶ä¸”èƒ½å¤Ÿæ¥å— QoS 2 å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼Œé‚£ä¹ˆ QoS 2 å°†æ˜¯ä¸€ä¸ªåˆé€‚çš„é€‰æ‹©ã€‚é‡‘èã€èˆªç©ºç­‰è¡Œä¸šåœºæ™¯ä¸‹ä¼šæ›´å¤šåœ°è§åˆ° QoS 2 çš„ä½¿ç”¨ã€‚\nå‚è€ƒèµ„æ–™ https://www.emqx.com/zh/blog/introduction-to-mqtt-qos ","permalink":"/tech/iot/mqtt-qos--%E7%AE%80%E4%BB%8B/","summary":"\u003ch1 id=\"ä»€ä¹ˆæ˜¯-qos\"\u003eä»€ä¹ˆæ˜¯ QoS\u003c/h1\u003e\n\u003cp\u003eä½¿ç”¨ MQTT åè®®çš„è®¾å¤‡ä¸€èˆ¬è¿è¡Œåœ¨ç½‘ç»œå—é™çš„ç¯å¢ƒä¸‹ï¼Œåªä¾é åº•å±‚TCP ä¼ è¾“åè®®å¹¶ä¸èƒ½å®Œå…¨ä¿è¯æ¶ˆæ¯çš„å¯é åˆ°è¾¾ã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼ŒMQTT æä¾›äº† QoSï¼ˆ\u003cstrong\u003eQuality ofÂ service\u003c/strong\u003eï¼‰ æœºåˆ¶ï¼Œå…¶æ ¸å¿ƒæ˜¯è®¾è®¡äº†å¤šç§æ¶ˆæ¯äº¤äº’æœºåˆ¶æ¥æä¾›ä¸åŒçš„æœåŠ¡è´¨é‡ï¼Œæ¥æ»¡è¶³ç”¨æˆ·åœ¨å„ç§åœºæ™¯ä¸‹å¯¹æ¶ˆæ¯å¯é æ€§çš„è¦æ±‚ã€‚\u003c/p\u003e","title":"MQTT QoS ç®€ä»‹"},{"content":"åœ¨ä½¿ç”¨ K8S è¿‡ç¨‹ä¸­ï¼Œå¶å°”ä¼šé‡åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€æ®µé…ç½®ï¼š\n1securityContext: 2 capabilities: 3 drop: 4 - ALL 5 add: 6 - NET_BIND_SERVICE å®é™…ä¸Šè¿™æ˜¯é…ç½®å¯¹åº”çš„å®¹å™¨çš„Â Capabilitiesï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨Â docker runÂ çš„æ—¶å€™å¯ä»¥é€šè¿‡Â --cap-addÂ å’ŒÂ --cap-dropÂ å‘½ä»¤æ¥ç»™å®¹å™¨æ·»åŠ Â Linux Capabilitiesã€‚\nLinux Capabilities Linux ä½¿ç”¨Â CapabilitiesÂ æœºåˆ¶æ¥å¯¹ root æƒé™è¿›è¡Œäº†æ›´åŠ ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå®ç°æŒ‰éœ€è¿›è¡Œæˆæƒï¼Œå‡å°äº†ç³»ç»Ÿçš„å®‰å…¨éšæ‚£ã€‚Linux å°†ä¼ ç»Ÿä¸Šä¸è¶…çº§ç”¨æˆ· root å…³è”çš„ç‰¹æƒåˆ’åˆ†ä¸ºä¸åŒçš„ã€å¯ä»¥ç‹¬ç«‹å¯ç”¨ç¦ç”¨çš„å•å…ƒï¼Œç§°ä¸ºÂ Capabilitiesã€‚\nè¿™æ ·å½“ç³»ç»Ÿåœ¨ä½œæƒé™æ£€æŸ¥çš„æ—¶å€™å°±å˜æˆäº†ï¼šåœ¨æ‰§è¡Œç‰¹æƒæ“ä½œæ—¶ï¼Œå¦‚æœè¿›ç¨‹çš„æœ‰æ•ˆèº«ä»½ä¸æ˜¯ rootï¼Œå°±å»æ£€æŸ¥æ˜¯å¦å…·æœ‰è¯¥ç‰¹æƒæ“ä½œæ‰€å¯¹åº”çš„ Capabilitiesï¼Œå¹¶ä»¥æ­¤å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œè¯¥ç‰¹æƒæ“ä½œã€‚æ¯”å¦‚ï¼Œå¦‚æœè¦è®¾ç½®ç³»ç»Ÿæ—¶é—´ï¼Œå°±å¾—å…·æœ‰Â CAP_SYS_TIMEÂ è¿™ä¸ª Capabilitiesã€‚\nCapabilities è¯¦ç»†æè¿°å¯å‚è€ƒ capabilities man page\nä½¿ç”¨ Capabilities é€šè¿‡Â getcapÂ å’ŒÂ setcapÂ ä¸¤æ¡å‘½ä»¤æ¥åˆ†åˆ«æŸ¥çœ‹å’Œè®¾ç½®ç¨‹åºæ–‡ä»¶çš„Â capabilitiesÂ å±æ€§ã€‚\n1# æŸ¥çœ‹ cap 2root@iZwz9c8vxak6iz0pol8de3Z:~# getcap /bin/ping 3/bin/ping cap_net_raw=ep 4 5# åˆ é™¤ ping çš„ cap 6setcap cap_net_admin,cap_net_raw-p /bin/ping 7 8getcap /bin/ping 9/bin/ping = 10 11# æ¢å¤ ping çš„ cap 12setcap cap_net_admin,cap_net_raw+p /bin/ping 13 14getcap /bin/ping 15/bin/ping cap_net_admin,cap_net_raw=p Docker é…ç½® Capabilities åœ¨ Docker ä¸­ï¼Œå¯ä»¥é€šè¿‡Â --cap-addÂ å’ŒÂ --cap-dropÂ è¿™ä¸¤ä¸ªå‚æ•°æ¥åŠ¨æ€è°ƒæ•´æƒé™ï¼Œ æœ€å¤§é™åº¦åœ°ä¿è¯å®¹å™¨çš„ä½¿ç”¨å®‰å…¨ã€‚ä¸‹é¢è¡¨æ ¼ä¸­åˆ—å‡ºçš„Â CapabilitiesÂ æ˜¯ Docker é»˜è®¤ç»™å®¹å™¨æ·»åŠ çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Â --cap-dropÂ å»é™¤å…¶ä¸­ä¸€ä¸ªæˆ–è€…å¤šä¸ªï¼š\n--cap-addå’Œ--cap-dropÂ è¿™ä¸¤å‚æ•°éƒ½æ”¯æŒALLå€¼ï¼Œæ¯”å¦‚å¦‚æœä½ æƒ³è®©æŸä¸ªå®¹å™¨æ‹¥æœ‰é™¤äº†MKNODä¹‹å¤–çš„æ‰€æœ‰å†…æ ¸æƒé™ï¼Œé‚£ä¹ˆå¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼šÂ 1$ sudo docker run --cap-add=ALL --cap-drop=MKNOD ... å‡å¦‚éœ€è¦ä¿®æ”¹ç½‘ç»œæ¥å£æ•°æ®ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰æƒé™çš„ï¼Œå› ä¸ºéœ€è¦çš„Â NET_ADMINÂ è¿™ä¸ªÂ CapabilitiesÂ é»˜è®¤è¢«ç§»é™¤äº†ï¼š\n1$ docker run -it --rm busybox /bin/sh 2/ # ip link add dummy0 type dummy 3ip: RTNETLINK answers: Operation not permitted 4/ # æ‰€ä»¥åœ¨ä¸ä½¿ç”¨Â --privilegedÂ çš„æƒ…å†µä¸‹ï¼ˆä¸å»ºè®®ï¼‰æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Â --cap-add=NET_ADMINÂ å°†è¿™ä¸ªÂ CapabilitiesÂ æ·»åŠ å›æ¥ï¼š\n1$ docker run -it --rm --cap-add=NET_ADMIN busybox /bin/sh 2/ # ip link add dummy0 type dummy 3/ # K8S é…ç½® Capabilities åœ¨ Kubernetes ä¸­ä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¥å®šä¹‰ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ åˆ° Pod å®šä¹‰çš„Â spec.containers.sercurityContext.capabilitiesä¸­å³å¯ï¼Œä¹Ÿå¯ä»¥è¿›è¡ŒÂ addÂ å’ŒÂ dropÂ é…ç½®ï¼ŒåŒæ ·ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬è¦ç»™ busybox å®¹å™¨æ·»åŠ Â NET_ADMINÂ è¿™ä¸ªÂ Capabilitiesï¼Œå¯¹åº”çš„ YAML æ–‡ä»¶å¯ä»¥è¿™æ ·å®šä¹‰ï¼š\n1apiVersion: v1 2kind: Pod 3metadata: 4 name: cpb-demo 5spec: 6 containers: 7 - name: cpb 8 image: busybox 9 args: 10 - sleep 11 - \u0026#34;3600\u0026#34; 12 securityContext: 13 capabilities: 14 add: # æ·»åŠ  15 - NET_ADMIN 16 drop: # åˆ é™¤ 17 - KILL åœ¨ Kubernetes ä¸­é€šè¿‡Â sercurityContext.capabilitiesÂ è¿›è¡Œé…ç½®å®¹å™¨çš„Â Capabilitiesï¼Œå½“ç„¶æœ€ç»ˆè¿˜æ˜¯é€šè¿‡ Docker çš„Â libcontainerÂ å»å€ŸåŠ©Â Linux kernel capabilitiesÂ å®ç°çš„æƒé™ç®¡ç†ã€‚\nå‚è€ƒèµ„æ–™ï¼š\nhttps://www.qikqiak.com/post/capabilities-on-k8s/ ","permalink":"/tech/kubernetes/%E7%90%86%E8%A7%A3%E4%B8%8E%E4%BD%BF%E7%94%A8-container-capabilities/","summary":"\u003cp\u003eåœ¨ä½¿ç”¨ K8S è¿‡ç¨‹ä¸­ï¼Œå¶å°”ä¼šé‡åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€æ®µé…ç½®ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003esecurityContext\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ecapabilities\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003edrop\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e- \u003cspan class=\"l\"\u003eALL\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e- \u003cspan class=\"l\"\u003eNET_BIND_SERVICE\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå®é™…ä¸Šè¿™æ˜¯é…ç½®å¯¹åº”çš„å®¹å™¨çš„Â \u003ccode\u003eCapabilities\u003c/code\u003eï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨Â \u003ccode\u003edocker run\u003c/code\u003eÂ çš„æ—¶å€™å¯ä»¥é€šè¿‡Â \u003ccode\u003e--cap-add\u003c/code\u003eÂ å’ŒÂ \u003ccode\u003e--cap-drop\u003c/code\u003eÂ å‘½ä»¤æ¥ç»™å®¹å™¨æ·»åŠ Â \u003ccode\u003eLinux Capabilities\u003c/code\u003eã€‚\u003c/p\u003e","title":"ç†è§£ä¸ä½¿ç”¨ Container Capabilities"},{"content":"æ•°æ®å·ï¼ˆVolumeï¼‰æ˜¯ Pod ä¸å¤–éƒ¨å­˜å‚¨è®¾å¤‡è¿›è¡Œæ•°æ®ä¼ é€’çš„é€šé“ï¼Œä¹Ÿæ˜¯ Pod å†…éƒ¨å®¹å™¨é—´ã€Pod ä¸Pod é—´ã€Pod ä¸å¤–éƒ¨ç¯å¢ƒè¿›è¡Œæ•°æ®å…±äº«çš„æ–¹å¼ã€‚\nVolume å®šä¹‰äº†å¤–ç½®å­˜å‚¨çš„ç»†èŠ‚ï¼Œå¹¶å†…åµŒåˆ° Pod ä¸­ä½œä¸º Pod çš„ä¸€éƒ¨åˆ†ã€‚å…¶å®è´¨æ˜¯å¤–ç½®å­˜å‚¨åœ¨Kubernetes ç³»ç»Ÿçš„ä¸€ä¸ªèµ„æºæ˜ å°„ï¼Œå½“è´Ÿè½½éœ€è¦ä½¿ç”¨å¤–ç½®å­˜å‚¨çš„æ—¶å€™ï¼Œå¯ä»¥ä»æ•°æ®å·ï¼ˆVolumeï¼‰ä¸­æŸ¥åˆ°ç›¸å…³ä¿¡æ¯å¹¶è¿›è¡Œå­˜å‚¨æŒ‚è½½æ“ä½œã€‚\nVolume çš„ç”Ÿå‘½å‘¨æœŸå’Œ Pod ä¸€è‡´ï¼ŒPod è¢«åˆ é™¤æ—¶ï¼ŒVolumeä¹Ÿä¼šè¢«åˆ é™¤ï¼ŒVolume ä¸­çš„æ•°æ®æ˜¯å¦ä¸¢å¤±å–å†³äº Volume çš„å…·ä½“ç±»å‹ã€‚\nå¸¸ç”¨çš„Volumeç±»å‹åˆ†ç±»å¦‚ä¸‹ï¼š\nåˆ†ç±» æè¿° æœ¬åœ°å­˜å‚¨ é€‚ç”¨äºæœ¬åœ°å­˜å‚¨çš„æ•°æ®å·ï¼Œä¾‹å¦‚ HostPathã€emptyDirç­‰ã€‚æœ¬åœ°å­˜å‚¨å·çš„ç‰¹ç‚¹æ˜¯æ•°æ®ä¿å­˜åœ¨é›†ç¾¤çš„ç‰¹å®šèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”ä¸èƒ½éšç€åº”ç”¨æ¼‚ç§»ï¼ŒèŠ‚ç‚¹åœæœºæ—¶æ•°æ®å³ä¸å†å¯ç”¨ã€‚ ç½‘ç»œå­˜å‚¨ é€‚ç”¨äºç½‘ç»œå­˜å‚¨çš„æ•°æ®å·ï¼Œä¾‹å¦‚Cephã€GlusterFSã€NFSã€iSCSIç­‰ã€‚ç½‘ç»œå­˜å‚¨å·çš„ç‰¹ç‚¹æ˜¯æ•°æ®ä¸åœ¨é›†ç¾¤çš„æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œæ˜¯åœ¨è¿œç«¯çš„å­˜å‚¨æœåŠ¡ä¸Šï¼Œä½¿ç”¨å­˜å‚¨å·æ—¶éœ€è¦å°†å­˜å‚¨æœåŠ¡æŒ‚è½½åˆ°æœ¬åœ°ä½¿ç”¨ã€‚ Secretå’ŒConfigMap Secretå’ŒConfigMapæ˜¯ç‰¹æ®Šçš„æ•°æ®å·ï¼Œå…¶æ•°æ®æ˜¯é›†ç¾¤çš„ä¸€äº›å¯¹è±¡ä¿¡æ¯ï¼Œè¯¥å¯¹è±¡æ•°æ®ä»¥å·çš„å½¢å¼è¢«æŒ‚è½½åˆ°èŠ‚ç‚¹ä¸Šä¾›åº”ç”¨ä½¿ç”¨ã€‚ PVC ä¸€ç§æ•°æ®å·å®šä¹‰æ–¹å¼ï¼Œå°†æ•°æ®å·æŠ½è±¡æˆä¸€ä¸ªç‹¬ç«‹äºPodçš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®šä¹‰ï¼ˆå…³è”ï¼‰çš„å­˜å‚¨ä¿¡æ¯å³å­˜å‚¨å·å¯¹åº”çš„çœŸæ­£å­˜å‚¨ä¿¡æ¯ï¼Œä¾›Kubernetesè´Ÿè½½æŒ‚è½½ä½¿ç”¨ã€‚ Volume ä½¿ç”¨åŸåˆ™ ä¸€ä¸ª Pod å¯ä»¥æŒ‚è½½å¤šä¸ª Volume ä¸€ä¸ª Pod å¯ä»¥æŒ‚è½½å¤šç§ç±»å‹çš„ Volume æ¯ä¸ªè¢« Pod æŒ‚è½½çš„ Volumeï¼Œå¯ä»¥è¢«è¯¥ Pod å†…ä¸åŒçš„å®¹å™¨é—´å…±äº«ã€‚ K8S ç¯å¢ƒæ¨èä½¿ç”¨ PVC å’Œ PV æ–¹å¼æŒ‚è½½ Volume Volume ç±»å‹ emptyDir emptyDir ç±»å‹çš„ Volume åœ¨ Pod åˆ†é…åˆ° Node ä¸Šæ—¶è¢«åˆ›å»ºï¼ŒKubernetesä¼šåœ¨ Node ä¸Šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç›®å½•ï¼Œå› æ­¤æ— éœ€æŒ‡å®šå®¿ä¸»æœºNodeä¸Šå¯¹åº”çš„ç›®å½•æ–‡ä»¶ï¼Œè¯¥ç›®å½•çš„åˆå§‹å†…å®¹ä¸ºç©ºï¼Œå½“ Pod ä» Node ä¸Šè¢«åˆ é™¤æ—¶ï¼ŒemptyDir ä¸­çš„æ•°æ®ä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚\nç‰¹åˆ«çš„ï¼Œå®¹å™¨å´©æºƒä¸ä¼šå¯¼è‡´ Pod è¢«ä»èŠ‚ç‚¹ä¸Šç§»é™¤ï¼Œå› æ­¤å®¹å™¨å´©æºƒæœŸé—´Â emptyDirÂ å·ä¸­çš„æ•°æ®æ˜¯å®‰å…¨çš„ã€‚\nå¸¸è§ä½¿ç”¨åœºæ™¯ï¼š\nemptyDir å·é€‚åˆç”¨äº Pod ä¸­çš„å®¹å™¨å…±äº«æ–‡ä»¶ã€‚ ç¼“å­˜ç©ºé—´ï¼Œä¾‹å¦‚åŸºäºç£ç›˜çš„å½’å¹¶æ’åºç®—æ³•ã€‚ ä¸ºè€—æ—¶è¾ƒé•¿çš„è®¡ç®—ä»»åŠ¡æä¾›æ£€æŸ¥ç‚¹ï¼Œä»¥ï¥¥ä»»åŠ¡èƒ½æ–¹ï¥¥åœ°ä»å´©æºƒå‰çŠ¶æ€æ¢å¤æ‰§ï¨ˆã€‚ åœ¨ Web æœåŠ¡å™¨å®¹å™¨æœåŠ¡æ•°æ®æ—¶ï¼Œä¿å­˜å†…å®¹ç®¡ç†å™¨å®¹å™¨è·å–çš„æ–‡ä»¶ã€‚ ä¾‹å¦‚å‰åç«¯å®¹å™¨ï¼Œå‰ç«¯å®¹å™¨æ˜¯è¾…åŠ©è¿›ç¨‹ï¼Œä¸å¯¹å¤–æä¾›ä»»ä½•æœåŠ¡ï¼Œå‰ç«¯æ–‡ä»¶é€šè¿‡ emptyDir å…±äº«åˆ° Web çš„ wwwroot ç›®å½•ä¸­ã€‚ç”± Web å¯¹å¤–æä¾› 8080 ç«¯å£æœåŠ¡ï¼Œç”¨æˆ·è®¿é—® Web æ—¶ï¼Œå¯ä»¥è®¿é—®åˆ°å‰ç«¯é™æ€æ–‡ä»¶ã€‚è¿™æ ·å‰åç«¯å¯ä»¥åˆ†å¼€æ›´æ–°å’Œéƒ¨ç½²ï¼Œå­˜æ”¾å‰ç«¯æ–‡ä»¶çš„è¾…åŠ©å®¹å™¨åªè´Ÿè´£æä¾›é™æ€æ–‡ä»¶ï¼Œæœ€ç»ˆç”± Web åç«¯ç¨‹åºå¯¹å¤–æä¾›é™æ€é¡µé¢å’Œ APIã€‚\n1apiVersion: v1 2kind: Pod 3metadata: 4 name: pod-demo 5 namespace: default 6 labels: 7 app: myapp 8 tier: frontend 9spec: 10 containers: 11 - name: myapp 12 image: ikubernetes/myapp:v1 13 imagePullPolicy: IfNotPresent 14 ports: 15 - name: http 16 containerPort: 80 17 volumeMounts: #åœ¨å®¹å™¨å†…å®šä¹‰æŒ‚è½½å­˜å‚¨åç§°å’ŒæŒ‚è½½è·¯å¾„ 18 - name: html 19 mountPath: /usr/share/nginx/html/ 20 - name: busybox 21 image: busybox:latest 22 imagePullPolicy: IfNotPresent 23 volumeMounts: 24 - name: html 25 mountPath: /data/ #åœ¨å®¹å™¨å†…å®šä¹‰æŒ‚è½½å­˜å‚¨åç§°å’ŒæŒ‚è½½è·¯å¾„ 26 command: [\u0026#39;/bin/sh\u0026#39;,\u0026#39;-c\u0026#39;,\u0026#39;while true;do echo $(date) \u0026gt;\u0026gt; /data/index.html;sleep 2;done\u0026#39;] 27 volumes: #å®šä¹‰å­˜å‚¨å· 28 - name: html #å®šä¹‰å­˜å‚¨å·åç§° 29 emptyDir: {} #å®šä¹‰å­˜å‚¨å·ç±»å‹ hostPath hostPath å·å°†ä¸»æœºèŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚è½½åˆ° Pod ä¸­ï¼Œç±»ä¼¼ Docker çš„Â -vÂ æŒ‚è½½ã€‚hostPath å·ä¾èµ–äºèŠ‚ç‚¹ä¸Šçš„ç›®å½•æˆ–æ–‡ä»¶ï¼Œä¸åŒèŠ‚ç‚¹çš„ Pod æ— æ³•å…±äº«ç›¸åŒçš„æ–‡ä»¶å†…å®¹ã€‚\nå¸¸è§ä½¿ç”¨åœºæ™¯:\næŒ‚è½½å®¿ä¸»æœºçš„æ—¶åŒºæ–‡ä»¶åˆ°å®¹å™¨å†…ï¼Œä¿æŒå’Œå®¿ä¸»æœºæ—¶åŒºä¸€è‡´ã€‚ 1 volumeMounts: 2 - name: timezone # å·åç§° 3 mountPath: /etc/localtime # æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„è·¯å¾„ç›®å½• 4 volumes: 5 - name: timezone 6 hostPath: 7 path: /usr/share/zoneinfo/Asia/Shanghai configmap ConfigMap å¯ä»¥ç”¨æ¥å­˜å‚¨éæœºå¯†æ€§çš„æ•°æ®åˆ°é”®å€¼å¯¹ä¸­ï¼Œè¿™äº›ä¿¡æ¯ä¼šè¢«å­˜å‚¨åˆ° etcdï¼Œä¸ä¼šåˆ†èŠ‚ç‚¹ï¼Œä»»ä½•èŠ‚ç‚¹éƒ½å¯ä»¥ä½¿ç”¨åˆ°ã€‚ä½¿ç”¨æ—¶ï¼Œå°†å…¶ç”¨ä½œç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°æˆ–è€…å­˜å‚¨å·ä¸­çš„é…ç½®æ–‡ä»¶é€å…¥åˆ° Pod ä¸­ï¼Œä¸»è¦ç›®çš„æ˜¯è§£è€¦åº”ç”¨ç¨‹åºå’Œé…ç½®ï¼Œè¿™æ ·ä¸å¿…ç»´æŠ¤é‚£äº› .json ç­‰é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é¿å…ä¸å°å¿ƒå°†å¸¦æœ‰æœºå¯†ä¿¡æ¯çš„é…ç½®æ–‡ä»¶ä¸Šä¼ åˆ°ä»£ç ä»“åº“ä¸­ã€‚\nå‡è®¾æœ‰é…ç½®æ–‡ä»¶ c.txt å¦‚ä¸‹ï¼š\n1enemies=aliens 2lives=3 3enemies.cheat=true 4enemies.cheat.level=noGoodRotten 5secret.code.passphrase=UUDDLRLRBABAS 6secret.code.allowed=true 7secret.code.lives=30 åˆ›å»º configMapï¼š\n1# åŸºäºå•ä¸ªé…ç½®æ–‡ä»¶åˆ›å»º ConfigMap 2kubectl create configmap my-config1 --from-file=c.txt 3 4# åŸºäºå¤šä¸ªé…ç½®æ–‡ä»¶åˆ›å»º ConfigMap 5kubectl create configmap my-config --from-file=key1=/path/to/bar/file1.txt --from-file=key2=/path/to/bar/file2.txt 6 7# åŸºäºç›®å½•åˆ›å»º ConfigMapï¼š 8kubectl create configmap my-config2 --from-file=config/ åœ¨ pod ä¸­æŒ‚è½½ configMapï¼š\n1apiVersion: v1 2kind: Pod 3metadata: 4 name: configmap-pod 5spec: 6 containers: 7 - name: configmap-pod 8 image: busybox 9 command: [\u0026#34;ls\u0026#34;] 10 args: [\u0026#34;/etc/config\u0026#34;] 11 volumeMounts: 12 - name: config-vol 13 mountPath: /etc/config 14 volumes: 15 - name: config-vol 16 configMap: 17 name: my-config secret Secret å·ç”¨æ¥ç»™ Pod ä¼ é€’æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€å¯†é’¥ç­‰ã€‚Secretå·å®é™…ä¸Šä¸æ˜¯ç”¨äºå­˜å‚¨çš„ï¼ŒSecret ä¸­å­˜å‚¨çš„ä¿¡æ¯ï¼Œä¼šä»¥ç¯å¢ƒå˜é‡ã€æ–‡ä»¶ç­‰çš„å½¢å¼æ˜¾ç¤ºåœ¨ Pod ä¸­ã€‚æœ€å¸¸ç”¨çš„æƒ…å†µæ˜¯ä½¿ç”¨ Secret ä¸º Ingress å¢åŠ  TLS åŠ å¯†è®¿é—®ã€‚\nSecret ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ç±»å‹ï¼š\nå†…ç½®ç±»å‹ ç”¨æ³• Opaque ç”¨æˆ·å®šä¹‰çš„ä»»æ„æ•°æ® kubernetes.io/service-account-token æœåŠ¡è´¦å·ä»¤ç‰Œ kubernetes.io/dockercfg ~/.dockercfgÂ æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼ kubernetes.io/dockerconfigjson ~/.docker/config.jsonÂ æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼ kubernetes.io/basic-auth ç”¨äºåŸºæœ¬èº«ä»½è®¤è¯çš„å‡­æ® kubernetes.io/ssh-auth ç”¨äº SSH èº«ä»½è®¤è¯çš„å‡­æ® kubernetes.io/tls ç”¨äº TLS å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ç«¯çš„æ•°æ® bootstrap.kubernetes.io/token å¯åŠ¨å¼•å¯¼ä»¤ç‰Œæ•°æ® ä½¿ç”¨Â kubectlÂ å‘½ä»¤åˆ›å»º Secretï¼š\n1kubectl create secret {ç±»å‹} {secretåç§°} é€šè¿‡è¯ä¹¦åˆ›å»º Secretï¼š\n1kubectl create secret tls tls-secret --cert=1_k1.whuanle.cn_bundle.crt --key=2_k1.whuanle.cn.key ä½¿ç”¨ YAML è¡¨ç¤ºï¼š\n1apiVersion: v1 2data: 3 tls.crt: ... 4 tls.key: ... 5kind: Secret 6metadata: 7 name: tls-secret 8type: kubernetes.io/tls Nginx é…ç½® Https è¯ä¹¦ï¼Œä½¿ç”¨çš„ä¾¿æ˜¯ crtã€key æ–‡ä»¶ã€‚\nPV \u0026amp; PVC è¯¦ç»†éƒ¨ç½²æ–¹å¼ï¼šPV \u0026amp; PVC å£°æ˜æ ·ä¾‹\nK8S å¼•å…¥äº† PV å’Œ PVC ä¸¤ä¸ªèµ„æºå¯¹è±¡ï¼Œå°†å­˜å‚¨å®ç°çš„ç»†èŠ‚ä»å…¶å¦‚ä½•è¢«ä½¿ç”¨ä¸­æŠ½è±¡å‡ºæ¥ï¼Œå¹¶è§£è€¦å­˜å‚¨ä½¿ç”¨è€…å’Œç³»ç»Ÿç®¡ç†å‘˜çš„èŒè´£ã€‚\nPVå’ŒPVCçš„æ¦‚å¿µå¦‚ä¸‹ï¼š\nPVï¼ˆPersistentVolumeï¼‰ åœ¨ K8S ä¸­ä»£è¡¨ä¸€ä¸ªå…·ä½“å­˜å‚¨ç±»å‹çš„å·ï¼Œå…¶å¯¹è±¡ä¸­å®šä¹‰äº†å…·ä½“å­˜å‚¨ç±»å‹å’Œå·å‚æ•°ã€‚ PVCï¼ˆPersistentVolumeClaimï¼‰æ˜¯åœ¨ K8S ä¸­ä¸€ç§æŠ½è±¡çš„å­˜å‚¨å·ç±»å‹ï¼Œä»£è¡¨äº†æŸä¸ªå…·ä½“ç±»å‹å­˜å‚¨çš„æ•°æ®å·è¡¨è¾¾ã€‚ PV å±äºæ•´ä¸ª K8S é›†ç¾¤ï¼Œè€Œ PVC å±äºæŸä¸ªå‘½åç©ºé—´\nPVCä¸PVæ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œä¸èƒ½ä¸€ä¸ªPVCæŒ‚è½½å¤šä¸ªPVï¼Œä¹Ÿä¸èƒ½ä¸€ä¸ªPVæŒ‚è½½å¤šä¸ªPVCã€‚ PVCåªæœ‰ç»‘å®šäº†PVä¹‹åæ‰èƒ½è¢«Podä½¿ç”¨ï¼Œè€ŒPVCç»‘å®šPVçš„è¿‡ç¨‹å³æ˜¯æ¶ˆè´¹PVçš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æœ‰ä¸€å®šè§„åˆ™çš„ã€‚ä¸ºåº”ç”¨é…ç½®å­˜å‚¨æ—¶ï¼Œéœ€è¦å£°æ˜ä¸€ä¸ª PVCï¼Œè€Œ K8S ä¼šé€šè¿‡æœ€ä½³åŒ¹é…çš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªæ»¡è¶³PVCéœ€æ±‚çš„PVï¼Œå¹¶ä¸ä¹‹ç»‘å®šã€‚\nPV æœ‰ä¸¤ç§æä¾›æ–¹å¼ï¼š\né™æ€åˆ†é…:\né›†ç¾¤ç®¡ç†å‘˜é¢„å…ˆåˆ›å»ºä¸€äº› PVã€‚å®ƒä»¬æºå¸¦å¯ä¾›é›†ç¾¤ç”¨æˆ·ä½¿ç”¨çš„çœŸå®å­˜å‚¨çš„è¯¦ç»†ä¿¡æ¯ã€‚ å®ƒä»¬å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯ç”¨äºæ¶ˆè´¹ã€‚ ç”¨æˆ·åˆ›å»ºPVCä¸PVç»‘å®š åŠ¨æ€åˆ†é…: é€šè¿‡å­˜å‚¨ç±»è¿›è¡ŒåŠ¨æ€åˆ›å»ºå­˜å‚¨ç©ºé—´ã€‚å½“ç°æœ‰çš„ PV éƒ½ä¸åŒ¹é…ç”¨æˆ·çš„ PVC æ—¶ï¼ŒK8S åŸºäº StorageClasses åŠ¨æ€åœ°ä¸º PVC é…ç½®å·ã€‚\n","permalink":"/tech/kubernetes/volume-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","summary":"\u003cp\u003eæ•°æ®å·ï¼ˆVolumeï¼‰æ˜¯ Pod ä¸å¤–éƒ¨å­˜å‚¨è®¾å¤‡è¿›è¡Œæ•°æ®ä¼ é€’çš„é€šé“ï¼Œä¹Ÿæ˜¯ Pod å†…éƒ¨å®¹å™¨é—´ã€Pod ä¸Pod é—´ã€Pod ä¸å¤–éƒ¨ç¯å¢ƒè¿›è¡Œæ•°æ®å…±äº«çš„æ–¹å¼ã€‚\u003c/p\u003e\n\u003cp\u003eVolume å®šä¹‰äº†å¤–ç½®å­˜å‚¨çš„ç»†èŠ‚ï¼Œå¹¶å†…åµŒåˆ° Pod ä¸­ä½œä¸º Pod çš„ä¸€éƒ¨åˆ†ã€‚å…¶å®è´¨æ˜¯å¤–ç½®å­˜å‚¨åœ¨Kubernetes ç³»ç»Ÿçš„ä¸€ä¸ªèµ„æºæ˜ å°„ï¼Œå½“è´Ÿè½½éœ€è¦ä½¿ç”¨å¤–ç½®å­˜å‚¨çš„æ—¶å€™ï¼Œå¯ä»¥ä»æ•°æ®å·ï¼ˆVolumeï¼‰ä¸­æŸ¥åˆ°ç›¸å…³ä¿¡æ¯å¹¶è¿›è¡Œå­˜å‚¨æŒ‚è½½æ“ä½œã€‚\u003c/p\u003e","title":"Volume åŸºç¡€çŸ¥è¯†"},{"content":"1. WaitGroup WaitGroup ç­‰å¾…ä¸€ç»„ Goroutine å®Œæˆã€‚ä¸» Goroutine è°ƒç”¨ Add(delta) æ¥è®¾ç½®è¦ç­‰å¾…çš„ Goroutine çš„æ•°é‡ã€‚ç„¶åæ¯ä¸ª Goroutine è¿è¡Œå¹¶åœ¨å®Œæˆæ—¶è°ƒç”¨ Done()ã€‚åŒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Wait() æ¥é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰ Goroutine å®Œæˆã€‚\n1type WaitGroup struct { 2\tnoCopy noCopy 3 4\t// 64-bit value: high 32 bits are counter, low 32 bits are waiter count. 5\t// 64-bit atomic operations require 64-bit alignment, but 32-bit 6\t// compilers do not ensure it. So we allocate 12 bytes and then use 7\t// the aligned 8 bytes in them as state, and the other 4 as storage 8\t// for the sema. 9\tstate1 [3]uint32 10} wg.Add(delta int)ï¼šAdd å°† deltaï¼ˆå¯èƒ½ä¸ºè´Ÿï¼‰æ·»åŠ åˆ° WaitGroup è®¡æ•°å™¨ã€‚å¦‚æœè®¡æ•°å™¨å˜ä¸º 0ï¼Œæ‰€æœ‰åœ¨ Wait æ—¶é˜»å¡çš„ Goroutine å°†è¢«é‡Šæ”¾ã€‚å¦‚æœè®¡æ•°å™¨å˜æˆè´Ÿå€¼ï¼ŒAdd ä¼š panicã€‚ wg.Done()ï¼šå½“ WaitGroup åŒæ­¥ç­‰å¾…ç»„ä¸­çš„æŸä¸ª Goroutine æ‰§è¡Œå®Œæ¯•åï¼Œè®¾ç½®è¿™ä¸ª WaitGroup çš„ counter æ•°å€¼å‡ 1ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº† Add(-1)ã€‚ wg.Wait()ï¼šè¡¨ç¤ºè®©å½“å‰çš„ Goroutine ç­‰å¾…ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ã€‚ä¸€ç›´åˆ° WaitGroup çš„è®¡æ•°å™¨ä¸º 0ï¼Œæ‰èƒ½è§£é™¤é˜»å¡ï¼Œè¿™ä¸ª Goroutine æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚ æ€»ä¹‹ï¼ŒWaitGroup è®©æŸä¸ªåç¨‹ç­‰å¾…å…¶å®ƒè‹¥å¹²åç¨‹éƒ½å…ˆå®Œæˆå®ƒä»¬å„è‡ªçš„ä»»åŠ¡ã€‚\n1func main() { 2\tconst N = 5 3\tvar values [N]int64 4\tvar wg sync.WaitGroup 5\tfor i := 0; i \u0026lt; N; i++ { 6\ti := i 7\twg.Add(1) 8\tgo func() { 9\tvalues[i] = 50 + rand.Int63n(50) 10\tfmt.Println(\u0026#34;Done:\u0026#34;, i) 11\twg.Done() // \u0026lt;=\u0026gt; wg.Add(-1) 12\t}() 13\t} 14 15\twg.Wait() 16\t// æ‰€æœ‰çš„å…ƒç´ éƒ½ä¿è¯è¢«åˆå§‹åŒ–äº†ã€‚ 17\tfmt.Println(\u0026#34;values:\u0026#34;, values) 18} 2. Once Once æ˜¯åªæ‰§è¡Œä¸€æ¬¡çš„å¯¹è±¡ã€‚Once ä½¿ç”¨åä¸èƒ½å¤åˆ¶ã€‚\n1type Once struct { 2 // done indicates whether the action has been performed. 3 // It is first in the struct because it is used in the hot path. 4 // The hot path is inlined at every call site. 5 // Placing done first allows more compact instructions on some architectures (amd64/386), 6 // and fewer instructions (to calculate offset) on other architectures. 7 done uint32 8 m Mutex 9} Once åªæœ‰ä¸€ä¸ª Do(f func()) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åªæœ‰ä¸€ä¸ªç±»å‹ä¸ºfunc()çš„å‚æ•°ã€‚\n1func (o *Once) Do(f func()) { 2\tif atomic.LoadUint32(\u0026amp;o.done) == 0 { 3\t// Outlined slow-path to allow inlining of the fast-path. 4\to.doSlow(f) 5\t} 6} å¯¹ä¸€ä¸ªå¯å¯»å€çš„sync.Onceå€¼ oï¼Œo.Do() æ–¹æ³•è°ƒç”¨å¯ä»¥åœ¨å¤šä¸ªåç¨‹ä¸­è¢«å¤šæ¬¡å¹¶å‘åœ°æ‰§è¡Œï¼Œæ–¹æ³•è°ƒç”¨çš„å®å‚åº”è¯¥ä¸ºåŒä¸€ä¸ªå‡½æ•°å€¼ã€‚æœ€ç»ˆï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªè°ƒç”¨çš„å®å‚å‡½æ•°è¢«è°ƒç”¨ã€‚è¢«è°ƒç”¨çš„å®å‚å‡½æ•°å†…çš„ä»£ç å°†åœ¨ä»»ä½•o.Do()æ–¹æ³•è¿”å›è°ƒç”¨ä¹‹å‰è¢«æ‰§è¡Œã€‚\nç®€å•æ¥è¯´ï¼Œsync.Onceè¢«ç”¨æ¥ç¡®ä¿ä¸€æ®µä»£ç åœ¨ä¸€ä¸ªå¹¶å‘ç¨‹åºä¸­è¢«æ‰§è¡Œä¸”ä»…è¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå¸¸ç”¨äºå•ä¾‹æ¨¡å¼ã€‚\n1func main() { 2\tvar once sync.Once 3\tonceBody := func() { 4\tfmt.Println(\u0026#34;Only Once\u0026#34;) 5\t} 6\tdoneChan := make(chan bool) 7\tfor i := 0; i \u0026lt; 10; i++ { 8\tgo func() { 9\tonce.Do(onceBody) 10\tdoneChan \u0026lt;- true 11\t}() 12\t} 13 14\tfor i := 0; i \u0026lt; 10; i++ { 15\t\u0026lt;- doneChan 16\t} 17} 18 19// Only Once 3. Mutex Go è¯­è¨€åŒ…ä¸­çš„ sync åŒ…æä¾›äº†ä¸¤ç§é”ç±»å‹ï¼šsync.Mutex å’Œ sync.RWMutexã€‚\nMutex æ˜¯æœ€ç®€å•çš„ä¸€ç§é”ç±»å‹ â€”â€”Â äº’æ–¥é”ï¼ŒåŒæ—¶ä¹Ÿæ¯”è¾ƒæš´åŠ›ï¼Œå½“ä¸€ä¸ª Goroutine è·å¾—äº† Mutex åï¼Œå…¶ä»– Goroutine å°±åªèƒ½ç­‰åˆ°è¯¥ Goroutine é‡Šæ”¾ Mutexã€‚\näº’æ–¥é”æ˜¯ä¼ ç»Ÿå¹¶å‘ç¼–ç¨‹å¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®æ§åˆ¶çš„ä¸»è¦æ‰‹æ®µï¼Œå®ƒç”±æ ‡å‡†åº“ sync ä¸­çš„ Mutex ç»“æ„ä½“ç±»å‹è¡¨ç¤ºã€‚sync.Mutex ç±»å‹åªæœ‰ä¸¤ä¸ªå…¬å¼€çš„æŒ‡é’ˆæ–¹æ³•ï¼šLock å’Œ Unlockã€‚\nLock é”å®šå½“å‰çš„å…±äº«èµ„æº Unlock è¿›è¡Œè§£é” 1// A Mutex is a mutual exclusion lock. 2// The zero value for a Mutex is an unlocked mutex. 3// 4// A Mutex must not be copied after first use. 5type Mutex struct { 6 state int32 7 sema uint32 8} 9 10// Lock locks m. 11// If the lock is already in use, the calling goroutine 12// blocks until the mutex is available. 13func (m *Mutex) Lock() { 14\t// Fast path: grab unlocked mutex. 15\tif atomic.CompareAndSwapInt32(\u0026amp;m.state, 0, mutexLocked) { 16\tif race.Enabled { 17\trace.Acquire(unsafe.Pointer(m)) 18\t} 19\treturn 20\t} 21\t// Slow path (outlined so that the fast path can be inlined) 22\tm.lockSlow() 23} 24 25// Unlock unlocks m. 26// It is a run-time error if m is not locked on entry to Unlock. 27// 28// A locked Mutex is not associated with a particular goroutine. 29// It is allowed for one goroutine to lock a Mutex and then 30// arrange for another goroutine to unlock it. 31func (m *Mutex) Unlock() { 32\tif race.Enabled { 33\t_ = m.state 34\trace.Release(unsafe.Pointer(m)) 35\t} 36 37\t// Fast path: drop lock bit. 38\tnew := atomic.AddInt32(\u0026amp;m.state, -mutexLocked) 39\tif new != 0 { 40\t// Outlined slow path to allow inlining the fast path. 41\t// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock. 42\tm.unlockSlow(new) 43\t} 44} 3.1 RWMutex RWMutex æ˜¯è¯»å†™é”ï¼Œè¯¥é”å¯ä»¥ç”±ä»»æ„æ•°é‡çš„è¯»è€…æˆ–å•ä¸ªå†™è€…æŒæœ‰ã€‚RWMutex çš„é›¶å€¼æ˜¯æœªé”å®šçš„äº’æ–¥é”ã€‚RWMutex è¢«ç¬¬ä¸€æ¬¡ä½¿ç”¨åä¸å¾—å¤åˆ¶ã€‚\nå¦‚æœä¸€ä¸ª Goroutine æŒæœ‰ä¸€ä¸ª RWMutex çš„è¯»é”å¹¶ä¸”å¦ä¸€ä¸ª Goroutine å¯èƒ½ä¼šè°ƒç”¨ Lockï¼Œé‚£ä¹ˆåœ¨å‰é¢çš„è¯»é”è¢«é‡Šæ”¾ä¹‹å‰ï¼Œä»»ä½• Goroutine éƒ½ä¸åº”è¯¥æœŸæœ›èƒ½å¤Ÿè·å–è¯»é”ã€‚\nç‰¹åˆ«çš„ï¼Œç¦æ­¢é€’å½’å æœ‰è¯»é”ï¼Œè¿™æ˜¯ä¸ºäº†ç¡®ä¿é”æœ€ç»ˆä¼šè¢«é‡Šæ”¾ï¼›è¢«é˜»å¡çš„ Lock è°ƒç”¨ä¼šå°†æ–°çš„è¯»è€…æ’é™¤åœ¨è·å–é”ä¹‹å¤–ã€‚\nrwm.RLock()ï¼šä¸Šè¯»é” rwm.RUnlock()ï¼šè§£è¯»é” rwm.Lock()ï¼šä¸Šé” rwm.Unlock()ï¼šè§£é” æ€»ç»“ä¸ºå¦‚ä¸‹ä¸‰æ¡ï¼š\nåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ª Goroutine èƒ½å¤Ÿè·å¾—å†™é” åŒæ—¶å¯ä»¥æœ‰ä»»æ„å¤šä¸ª Gorouinte è·å¾—è¯»é” åŒæ—¶åªèƒ½å­˜åœ¨å†™é”æˆ–è¯»é”ï¼ˆè¯»å’Œå†™äº’æ–¥ï¼‰ å› æ­¤ï¼ŒRWMutex ç»å¸¸ç”¨äºè¯»è¿œè¿œå¤šäºå†™çš„åœºæ™¯ã€‚\n4. Map sync.Map å¯¹äºå¤šä¸ª Goroutine å¹¶å‘ä½¿ç”¨æ˜¯å®‰å…¨çš„ï¼Œæ— éœ€é¢å¤–çš„é”å®šæˆ–åè°ƒã€‚Loadã€Store å’Œ Delete åœ¨åˆ†æ‘Šå¸¸æ•°æ—¶é—´å†…è¿è¡Œã€‚\nsync.Map é’ˆå¯¹ä¸¤ç§å¸¸è§ç”¨ä¾‹è¿›è¡Œäº†ä¼˜åŒ–ï¼š\nå½“ç»™å®š key çš„æ¡ç›®åªå†™å…¥ä¸€æ¬¡ä½†è¯»å–å¤šæ¬¡ å½“å¤šä¸ª Goroutine è¯»å–ã€å†™å…¥å’Œè¦†ç›–ä¸ç›¸äº¤çš„ key é›†çš„æ¡ç›® åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä¸ä½¿ç”¨å•ç‹¬çš„ Mutex æˆ– RWMutex é…å¯¹çš„ Go map ç›¸æ¯”ï¼Œä½¿ç”¨ Map å¯ä»¥æ˜¾ç€å‡å°‘é”çš„ç«äº‰ã€‚\n1type Map struct { 2\tmu Mutex 3\tread atomic.Value // readOnly 4\tdirty map[interface{}]*entry 5\tmisses int 6} m.Load(k) (v, ok)ï¼šå¹¶å‘å®‰å…¨çš„ getã€‚ m.Store(k, v)ï¼šå¹¶å‘å®‰å…¨çš„ putã€‚ m.Delete(k)ï¼šå¹¶å‘å®‰å…¨çš„ deleteã€‚ m.LoadAndDelete(k) (v, loaded)ï¼šLoadAndDelete åˆ é™¤é”®çš„å€¼ï¼Œå¦‚æœä¹‹å‰æœ‰å€¼ï¼Œåˆ™è¿”å›ä¹‹å‰çš„å€¼ï¼Œloaded è¡¨ç¤ºæ˜¯å¦æœ‰ä¹‹å‰çš„å€¼ã€‚ m.LoadAndStore(k, v) (actual, loaded)ï¼šLoadOrStore è¿”å›é”®çš„ç°æœ‰å€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚å¦åˆ™ï¼Œå®ƒå­˜å‚¨å¹¶è¿”å›ç»™å®šçš„å€¼ã€‚loaded ä¸º true è¡¨ç¤ºè¿”å›ç°æœ‰å€¼ï¼Œloaded ä¸º false è¡¨ç¤ºå­˜å‚¨ç»™å®šå€¼ã€‚ m.Range(func(k, v) bool)ï¼šæŒ‰ç…§ä¼ å…¥çš„ func è§„åˆ™éå† Mapã€‚ 1func main() { 2\tm := sync.Map{} 3\tgo func() { 4\tm.Store(1,2) 5\tfmt.Println(m.Load(1)) 6\t}() 7\tgo func() { 8\tm.Store(1,2) 9\tfmt.Println(m.Load(1)) 10\t}() 11\tfmt.Println(m.Load(1)) 12\ttime.Sleep(5 * time.Second) 13} å‚è€ƒèµ„æ–™ https://hedon954.github.io/noteSite/backend/golang/standard_packages/sync.html ","permalink":"/tech/golang/golang-%E6%A0%87%E5%87%86%E5%BA%93-sync/","summary":"\u003ch1 id=\"1-waitgroup\"\u003e1. WaitGroup\u003c/h1\u003e\n\u003cp\u003eWaitGroup ç­‰å¾…ä¸€ç»„ Goroutine å®Œæˆã€‚ä¸» Goroutine è°ƒç”¨ Add(delta) æ¥è®¾ç½®è¦ç­‰å¾…çš„ Goroutine çš„æ•°é‡ã€‚ç„¶åæ¯ä¸ª Goroutine è¿è¡Œå¹¶åœ¨å®Œæˆæ—¶è°ƒç”¨ Done()ã€‚åŒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Wait() æ¥é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰ Goroutine å®Œæˆã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e \u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"c1\"\u003e// 64-bit value: high 32 bits are counter, low 32 bits are waiter count.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"c1\"\u003e// 64-bit atomic operations require 64-bit alignment, but 32-bit\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"c1\"\u003e// compilers do not ensure it. So we allocate 12 bytes and then use\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"c1\"\u003e// the aligned 8 bytes in them as state, and the other 4 as storage\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"c1\"\u003e// for the sema.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003estate1\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003ewg.Add(delta int)\u003c/strong\u003eï¼šAdd å°† deltaï¼ˆå¯èƒ½ä¸ºè´Ÿï¼‰æ·»åŠ åˆ° WaitGroup è®¡æ•°å™¨ã€‚å¦‚æœè®¡æ•°å™¨å˜ä¸º 0ï¼Œæ‰€æœ‰åœ¨ Wait æ—¶é˜»å¡çš„ Goroutine å°†è¢«é‡Šæ”¾ã€‚å¦‚æœè®¡æ•°å™¨å˜æˆè´Ÿå€¼ï¼ŒAdd ä¼š panicã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ewg.Done()\u003c/strong\u003eï¼šå½“ WaitGroup åŒæ­¥ç­‰å¾…ç»„ä¸­çš„æŸä¸ª Goroutine æ‰§è¡Œå®Œæ¯•åï¼Œè®¾ç½®è¿™ä¸ª WaitGroup çš„ counter æ•°å€¼å‡ 1ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº† Add(-1)ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ewg.Wait()\u003c/strong\u003eï¼šè¡¨ç¤ºè®©å½“å‰çš„ Goroutine ç­‰å¾…ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ã€‚ä¸€ç›´åˆ° WaitGroup çš„è®¡æ•°å™¨ä¸º 0ï¼Œæ‰èƒ½è§£é™¤é˜»å¡ï¼Œè¿™ä¸ª Goroutine æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæ€»ä¹‹ï¼Œ\u003cstrong\u003eWaitGroup è®©æŸä¸ªåç¨‹ç­‰å¾…å…¶å®ƒè‹¥å¹²åç¨‹éƒ½å…ˆå®Œæˆå®ƒä»¬å„è‡ªçš„ä»»åŠ¡\u003c/strong\u003eã€‚\u003c/p\u003e","title":"Golang æ ‡å‡†åº“ä¸¨sync"},{"content":"1. åŸºç¡€ç‰¹æ€§ 1.1 å…ˆè¿›åå‡º å¯¹äºå¤šä¸ªdeferè¯­å¥ï¼Œç±»ä¼¼æ ˆï¼ŒæŒ‰å…ˆè¿›åå‡ºçš„é¡ºåºæ‰§è¡Œã€‚\n1func main() { 2 var whatever [5]struct{} 3 for i := range whatever { 4 defer fmt.Print(i) 5 } 6} 7 8// 43210 1.2 å®æ—¶è§£æå‡½æ•°å‚æ•° 1package main 2 3import \u0026#34;fmt\u0026#34; 4 5func test(a int) {//æ— è¿”å›å€¼å‡½æ•° 6\tdefer fmt.Println(\u0026#34;1ã€a =\u0026#34;, a) //æ–¹æ³• 7\tdefer func(v int) { fmt.Println(\u0026#34;2ã€a =\u0026#34;, v)} (a) //æœ‰å‚å‡½æ•° 8\tdefer func() { fmt.Println(\u0026#34;3ã€a =\u0026#34;, a)} () //æ— å‚å‡½æ•° 9\ta++ 10} 11func main() { 12\ttest(1) 13} 14 15// 3ã€a = 2 16// 2ã€a = 1 17// 1ã€a = 1 1.3 return è¿”å›æœºåˆ¶ deferã€returnã€è¿”å›å€¼ä¸‰è€…çš„æ‰§è¡Œé€»è¾‘åº”è¯¥æ˜¯ï¼š\né¦–å…ˆï¼Œreturn æœ€å…ˆæ‰§è¡Œï¼Œreturnå°†ç»“æœå†™å…¥è¿”å›å€¼ä¸­ï¼› æ¥ç€ï¼Œdefer æ‰§è¡Œæ”¶å°¾å·¥ä½œï¼› æœ€åï¼Œå‡½æ•°æºå¸¦å½“å‰è¿”å›å€¼ï¼ˆå¯èƒ½å’Œæœ€åˆçš„è¿”å›å€¼ä¸ç›¸åŒï¼‰é€€å‡ºã€‚ defer åœ¨ return å deferæ”¾åœ¨returnåé¢æ—¶ï¼Œä¸ä¼šè¢«æ‰§è¡Œã€‚\n1func f(i int) int{ 2\treturn i 3\tdefer fmt.Print(\u0026#34;i =\u0026#34;, i) 4\treturn i+1 5} 6 7func main() { 8\tf(1) 9} æ²¡æœ‰è¾“å‡ºï¼Œå› ä¸ºreturn iä¹‹åå‡½æ•°å°±å·²ç»ç»“æŸäº†ï¼Œä¸ä¼šæ‰§è¡Œdeferã€‚\næ— åè¿”å›å€¼ ğŸ“ 1func a() int { 2\tvar i int 3\tdefer func() { 4\ti++ 5\tfmt.Println(\u0026#34;defer2:\u0026#34;, i) 6\t}() 7\tdefer func() { 8\ti++ 9\tfmt.Println(\u0026#34;defer1:\u0026#34;, i) 10\t}() 11\treturn i 12} 13 14func main() { 15\tfmt.Println(\u0026#34;return:\u0026#34;, a()) 16} 1defer1: 1 2defer2: 2 3return: 0 è¿”å›å€¼ç”±å˜é‡ i èµ‹å€¼ï¼Œç›¸å½“äºè¿”å›å€¼=i=0ã€‚\nç¬¬äºŒä¸ªdeferä¸­i++ = 1ï¼Œ ç¬¬ä¸€ä¸ªdeferä¸­i++ = 2ï¼Œæ‰€ä»¥æœ€ç»ˆiçš„å€¼æ˜¯2ã€‚\nä½†è¿”å›å€¼å·²ç»è¢«èµ‹å€¼äº†ï¼Œå³ä½¿åç»­ä¿®æ”¹iä¹Ÿä¸ä¼šå½±å“è¿”å›å€¼ã€‚æœ€ç»ˆè¿”å›å€¼è¿”å›ï¼Œæ‰€ä»¥mainä¸­æ‰“å°0ã€‚\næœ‰åè¿”å›å€¼ ğŸ“ 1func b() (i int) { 2\tdefer func() { 3\ti++ 4\tfmt.Println(\u0026#34;defer2:\u0026#34;, i) 5\t}() 6\tdefer func() { 7\ti++ 8\tfmt.Println(\u0026#34;defer1:\u0026#34;, i) 9\t}() 10\treturn i //æˆ–è€…ç›´æ¥å†™æˆreturn 11} 12 13func main() { 14\tfmt.Println(\u0026#34;return:\u0026#34;, b()) 15} 1defer1: 1 2defer2: 2 3return: 2 æ­¤å¤„æŒ‡æ˜äº†è¿”å›å€¼å°±æ˜¯iï¼Œæ‰€ä»¥åç»­å¯¹ i è¿›è¡Œä¿®æ”¹éƒ½ç›¸å½“äºåœ¨ä¿®æ”¹è¿”å›å€¼ï¼Œæ‰€ä»¥æœ€ç»ˆå‡½æ•°çš„è¿”å›å€¼æ˜¯2ã€‚\nç‰¹æ®Šæƒ…å†µ\næ³¨æ„ä¸‹åˆ—ä»£ç ï¼Œè¿”å›å€¼ r ä½œä¸ºå‚æ•°ä¼ å…¥ deferï¼Œè™½ç„¶æœ‰ r = r + 5 ï¼Œä½†è¿™æ˜¯å±€éƒ¨å˜é‡ï¼Œä¸ f() ä¸­çš„è¿”å›å€¼ r æ— å…³ï¼Œå› æ­¤è¯¥å‡½æ•°ä»ç„¶è¿”å› 1\n1func f() (r int) { 2 defer func(r int) { 3 r = r + 5 4 }(r) 5 return 1 6} å‡½æ•°è¿”å›å€¼ä¸ºåœ°å€ æœ¬è´¨ä¸Šå’Œæœ‰åè¿”å›å€¼ä¸€æ ·ã€‚\n1func c() *int { 2\tvar i int 3\tdefer func() { 4\ti++ 5\tfmt.Println(\u0026#34;defer2:\u0026#34;, i) 6\t}() 7\tdefer func() { 8\ti++ 9\tfmt.Println(\u0026#34;defer1:\u0026#34;, i) 10\t}() 11\treturn \u0026amp;i 12} 13 14func main() { 15\tfmt.Println(\u0026#34;return:\u0026#34;, *(c())) 16} 1defer1: 1 2defer2: 2 3return: 2 2. Defer ä¸é—­åŒ… for ç»“æŸæ—¶ t.name=\u0026quot;c\u0026quot;ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œçš„é‚£äº›deferè¯­å¥ä¸­ç”¨åˆ°çš„t.nameçš„å€¼å‡ä¸º\u0026quot;c\u0026quot;ã€‚\n1type Test struct { 2\tname string 3} 4func (t *Test) pp() { 5\tfmt.Println(t.name) 6} 7func main() { 8\tts := []Test{{\u0026#34;a\u0026#34;}, {\u0026#34;b\u0026#34;}, {\u0026#34;c\u0026#34;}} 9\tfor _, t := range ts { 10\tdefer t.pp() 11\t} 12} 13// c 14// c 15// c ä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨æœ‰å‚å‚æ•°\ndeferè¯­å¥ä¸­çš„å‚æ•°ä¼šå®æ—¶è§£æï¼Œæ‰€ä»¥åœ¨ç¢°åˆ°deferè¯­å¥çš„æ—¶å€™å°±æŠŠè¯¥æ—¶çš„tä»£å…¥äº†ã€‚\n1type Test struct { 2\tname string 3} 4func pp(t Test) { 5\tfmt.Println(t.name) 6} 7func main() { 8\tts := []Test{{\u0026#34;a\u0026#34;}, {\u0026#34;b\u0026#34;}, {\u0026#34;c\u0026#34;}} 9\tfor _, t := range ts { 10\tdefer pp(t) 11\t} 12} 13// c 14// b 15// a ä¿®æ”¹ä»£ç ï¼Œåœ¨å¾ªç¯ä¸­å£°æ˜æ–°å˜é‡\næ¯æ¬¡éƒ½æœ‰ä¸€ä¸ªæ–°çš„å˜é‡tt:=tï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‰§è¡Œdeferè¯­å¥æ—¶ï¼Œå¯¹åº”çš„ tt ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥è¾“å‡ºçš„ç»“æœä¹Ÿä¸ç›¸åŒã€‚\n1type Test struct { 2\tname string 3} 4func (t *Test) pp() { 5\tfmt.Println(t.name) 6} 7 8func main() { 9\tts := []Test{{\u0026#34;a\u0026#34;}, {\u0026#34;b\u0026#34;}, {\u0026#34;c\u0026#34;}} 10\tfor _, t := range ts { 11\ttt := t 12\tprintln(\u0026amp;tt) 13\tdefer tt.pp() 14\t} 15} 10xc000010200 20xc000010210 30xc000010220 4c 5b 6a 3. Defer å¸¸è§ä½¿ç”¨åœºæ™¯ 3.1 å…³é—­æ–‡ä»¶ å¼€å¯æ–‡ä»¶åï¼Œä½¿ç”¨ defer å…³é—­æ–‡ä»¶ã€‚\n1func ReadFile(filename string) ([]byte, error) { 2 f, err := os.Open(filename) 3 if err != nil { 4 return nil, err 5 } 6 defer f.close() 7 return ReadAll() 8} 3.2 äº’æ–¥é” åŠ é”åï¼Œä½¿ç”¨ defer è§£é”ã€‚\n1var mu sync.Mutex 2var m = make(map[string]int) 3 4func lookup(key string) int { 5 mu.Lock() 6 defer mu.Unlock() 7 return m[key] 8} è°ƒç”¨os.Exitæ—¶deferä¸ä¼šè¢«æ‰§è¡Œ\n1func deferExit() { 2 defer func() { 3 fmt.Println(\u0026#34;defer\u0026#34;) 4 }() 5 os.Exit(0) 6} å‚è€ƒèµ„æ–™ https://blog.csdn.net/Cassie_zkq/article/details/108567205 ","permalink":"/tech/golang/golang-defer/","summary":"\u003ch1 id=\"1-åŸºç¡€ç‰¹æ€§\"\u003e1. åŸºç¡€ç‰¹æ€§\u003c/h1\u003e\n\u003ch2 id=\"11-å…ˆè¿›åå‡º\"\u003e1.1 å…ˆè¿›åå‡º\u003c/h2\u003e\n\u003cp\u003eå¯¹äºå¤šä¸ªdeferè¯­å¥ï¼Œç±»ä¼¼æ ˆï¼ŒæŒ‰\u003cstrong\u003eå…ˆè¿›åå‡º\u003c/strong\u003eçš„é¡ºåºæ‰§è¡Œã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ewhatever\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003ewhatever\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 43210\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"12-å®æ—¶è§£æå‡½æ•°å‚æ•°\"\u003e1.2 å®æ—¶è§£æå‡½æ•°å‚æ•°\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003epackage\u003c/span\u003e \u003cspan class=\"nx\"\u003emain\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;fmt\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003etest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ea\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"c1\"\u003e//æ— è¿”å›å€¼å‡½æ•°\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1ã€a =\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e//æ–¹æ³•\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ev\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;2ã€a =\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e//æœ‰å‚å‡½æ•°\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;3ã€a =\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e//æ— å‚å‡½æ•°\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003ea\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nf\"\u003etest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 3ã€a = 2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 2ã€a = 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// 1ã€a = 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"13-return-è¿”å›æœºåˆ¶\"\u003e1.3 return è¿”å›æœºåˆ¶\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003edeferã€returnã€è¿”å›å€¼ä¸‰è€…çš„æ‰§è¡Œé€»è¾‘åº”è¯¥æ˜¯ï¼š\u003c/strong\u003e\u003c/p\u003e","title":"Golang Defer"},{"content":"Pod æ˜¯ K8s é›†ç¾¤ä¸­åˆ›å»ºå’Œç®¡ç†çš„ã€æœ€å°çš„å¯éƒ¨ç½²çš„è®¡ç®—å•å…ƒã€‚K8s ä¸ä¼šç›´æ¥æ“ä½œå®¹å™¨ï¼Œè€Œæ˜¯é€šè¿‡ Pod å°è£…äº†å®¹å™¨ï¼Œé›†ç¾¤é€šè¿‡ç®¡æ§ Pod ï¼Œä¾¿å¯æ§åˆ¶å®¹å™¨çš„å­˜å‚¨ã€ç½‘ç»œç­‰èµ„æºï¼Œå®ç°èµ„æºéš”ç¦»æˆ–å…±äº«ã€‚\nK8s Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº«ä¸€ä¸ªç›¸åŒçš„ Linux å‘½åç©ºé—´(networkã€UTSã€IPC)ï¼Œè€Œä¸æ˜¯æ¯ä¸ªå®¹å™¨ä¸€ä¸ªå‘½åç©ºé—´ï¼Œè¿™ä¸€ç‚¹ä¸ Docker ä¸åŒï¼Œå› æ­¤ Pod ä¸­çš„å¤šä¸ªå®¹å™¨ä½¿ç”¨ç›¸åŒçš„ç½‘ç»œã€ä¸»æœºåç§°ï¼Œçœ‹åˆ°çš„æ˜¯åŒä¸€ä¸ª IP åœ°å€ã€‚\nä¸è¿‡è¿›ç¨‹è¿˜æ˜¯æŒ‰ç…§å®¹å™¨è¿›è¡Œéš”ç¦»ã€‚ç”±äº Mountã€User å‘½åç©ºé—´ä¸å…±äº«ï¼Œå› æ­¤åœ¨å®¹å™¨ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿå’Œç”¨æˆ·æ˜¯éš”ç¦»çš„ã€‚\nå¯åŠ¨æµç¨‹ åœ¨ Kubernetes ä¸­ï¼Œå½“åˆ›å»º Pod æ—¶ï¼Œä¼šå…ˆå¯åŠ¨ä¸€ä¸ª pause å®¹å™¨ï¼Œpause å®¹å™¨åˆ›å»ºäº†ç½‘ç»œï¼Œç„¶ååº”ç”¨å®¹å™¨ä»¥ Container æ¨¡å¼è¿æ¥åˆ°è¯¥ pause å®¹å™¨çš„ç½‘ç»œã€‚\nç”Ÿå‘½å‘¨æœŸ å½“ Pod è¢«åˆ†é…åˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œ Pod ä¼šä¸€ç›´åœ¨è¯¥èŠ‚ç‚¹è¿è¡Œï¼Œç›´åˆ°åœæ­¢æˆ–è¢«ç»ˆæ­¢ï¼ŒPod åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­åªä¼šè¢«è°ƒåº¦ä¸€æ¬¡ã€‚\nPod çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯èƒ½æœ‰å››ç§çŠ¶æ€ï¼š\nPendingï¼Œå°è¯•å¯åŠ¨å®¹å™¨ï¼Œå¦‚æœå®¹å™¨æ­£å¸¸å¯åŠ¨ï¼Œåˆ™è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µï¼› Runningï¼Œå¤„äºè¿è¡ŒçŠ¶æ€ï¼› Succeededã€Failedï¼Œæ­£å¸¸ç»“æŸæˆ–æ•…éšœç­‰å¯¼è‡´å®¹å™¨ç»“æŸï¼› Unknownï¼Œå› ä¸ºæŸäº›åŸå› æ— æ³•å–å¾— Pod çš„çŠ¶æ€ã€‚ éƒ¨ç½²æ–¹å¼ Deployment Deployment ç®¡ç†éƒ¨ç½² Podï¼Œç»´æŒ Pod çš„å‰¯æœ¬æ•°é‡ä»¥åŠ Pod ç›‘æ§å’Œç»´æŠ¤ã€‚\n1kubectl apply -f nginx.yaml kubectl applyÂ å‘½ä»¤å°†ä¼šæŠŠæ¨é€çš„ç‰ˆæœ¬ä¸ä»¥å‰çš„ç‰ˆæœ¬è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶åº”ç”¨ä½ æ‰€åšçš„æ›´æ”¹ï¼Œå¹¶ä¸”ä¸ä¼šè‡ªåŠ¨è¦†ç›–ä»»ä½•ä½ æ²¡æœ‰æŒ‡å®šæ›´æ”¹çš„å±æ€§ã€‚æ ¹æ® Kubernetes å®˜æ–¹çš„æ–‡æ¡£ï¼Œåº”å§‹ç»ˆä½¿ç”¨Â kubectl applyÂ æˆ–Â kubectl create --save-configÂ åˆ›å»ºèµ„æºã€‚\n1kubectl create deployment testnginx --image=nginx:latest --dry-run=client -o yaml --dry-runÂ å–å€¼å¿…é¡»ä¸ºnoneã€serveræˆ–clientã€‚å¦‚æœå®¢æˆ·ç«¯ç­–ç•¥ï¼Œåªæ‰“å°å°†è¦å‘é€çš„å¯¹è±¡ï¼Œè€Œä¸å‘é€å®ƒã€‚å¦‚æœæ˜¯æœåŠ¡å™¨ç­–ç•¥ï¼Œæäº¤æœåŠ¡å™¨ç«¯è¯·æ±‚è€Œä¸æŒä¹…åŒ–èµ„æºã€‚\nReplicaSet Deployment çš„ YAML æ–‡ä»¶ä¸­æœ‰ replicas å­—æ®µï¼Œè¡¨ç¤ºç»´æŒå¤šå°‘ä¸ª Pod å®ä¾‹ã€‚\n1spec: 2 progressDeadlineSeconds: 600 3 replicas: 1 åˆ›å»ºä¸€ä¸ª Deployment æ—¶ï¼ŒDeployment ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª ReplicaSet ï¼ŒReplicaSet ç®¡ç†çš„å‰¯æœ¬æ•°é‡è·Ÿ YAMLÂ æ–‡ä»¶ä¸­ replicasÂ å­—æ®µå€¼ä¸€è‡´ã€‚\nDaemonSet DaemonSet ç¡®ä¿ä¸€ä¸ªèŠ‚ç‚¹åªè¿è¡Œä¸€ä¸ª Podã€‚\nDaemonSet æ— è§†èŠ‚ç‚¹çš„æ’æ–¥æ€§ï¼Œå³èŠ‚ç‚¹å¯ä»¥æ’æ–¥è°ƒåº¦å™¨åœ¨æ­¤èŠ‚ç‚¹ä¸Šéƒ¨ç½² Podï¼ŒDaemonSet åˆ™ä¼šç»•è¿‡è°ƒåº¦å™¨ï¼Œå¼ºè¡Œéƒ¨ç½²ã€‚\nDaemonSet çš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼š\nåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹ åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†å®ˆæŠ¤è¿›ç¨‹ åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§å®ˆæŠ¤è¿›ç¨‹ StatefulSet todo æ‰©å®¹ã€ç¼©å®¹ scale ä½¿ç”¨Â kubectl scaleÂ å‘½ä»¤ç›´æ¥è®¾ç½®ï¼š\n1kubectl scale deployment nginx --replicas=10 autoscale Pod æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å¯ä»¥åŸºäº CPU åˆ©ç”¨ç‡è‡ªåŠ¨æ‰©ç¼© ReplicationControllerã€Deploymentã€ReplicaSet å’Œ StatefulSet ä¸­çš„ Pod æ•°é‡ã€‚Pod è‡ªåŠ¨æ‰©ç¼©ä¸é€‚ç”¨äºæ— æ³•æ‰©ç¼©çš„å¯¹è±¡ï¼Œæ¯”å¦‚ DaemonSetã€‚\né™¤äº† CPU åˆ©ç”¨ç‡ï¼Œä¹Ÿå¯ä»¥åŸºäºå…¶ä»–åº”ç¨‹åºæä¾›çš„è‡ªå®šä¹‰åº¦é‡æŒ‡æ ‡ æ¥æ‰§è¡Œè‡ªåŠ¨æ‰©ç¼©ã€‚\nå‚è€ƒèµ„æ–™ï¼š https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/\n1kubectl autoscale deployment nginx --min=10 --max=15 --cpu-percent=80 è¡¨ç¤ºç›®æ ‡ CPU ä½¿ç”¨ç‡ä¸ºÂ 80%(æœŸæœ›æŒ‡æ ‡)ï¼Œå‰¯æœ¬æ•°é‡é…ç½®åº”è¯¥ä¸º 10 åˆ° 15 ä¹‹é—´ï¼ŒCPU æ˜¯åŠ¨æ€ç¼©æ”¾ pod çš„æŒ‡æ ‡ï¼Œä¼šæ ¹æ®å…·ä½“çš„ CPU ä½¿ç”¨ç‡è®¡ç®—å‰¯æœ¬æ•°é‡ï¼Œå…¶è®¡ç®—å…¬å¼å¦‚ä¸‹ã€‚\n1æœŸæœ›å‰¯æœ¬æ•° = ceil[å½“å‰å‰¯æœ¬æ•° * (å½“å‰æŒ‡æ ‡ / æœŸæœ›æŒ‡æ ‡)] æŒ‰ç…§ç®—æ³•è®¡ç®—ï¼Œè‹¥å½“å‰å‰¯æœ¬æ•°é‡ä¸º 12ï¼Œä¸” CPU ä½¿ç”¨ç‡è¾¾åˆ° 90%ï¼Œåˆ™æœŸæœ›å‰¯æœ¬æ•°ä¸ºÂ 12*(90%/80%)Â = 13.5ï¼Œé‚£ä¹ˆç†è®ºä¸Šä¼šéƒ¨ç½² 14 ä¸ª Podï¼Œä½†æ˜¯ CPU å†ç»§ç»­å¢åŠ çš„è¯ï¼Œæœ€å¤š 15 ä¸ªå‰¯æœ¬æ•°é‡ã€‚å¦‚æœåœ¨æœºå™¨ç®¡å¤Ÿçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å»æ‰Â minÂ å’ŒÂ maxÂ å‚æ•°ã€‚\næ¯”ä¾‹ç¼©æ”¾ æ¯”ä¾‹ç¼©æ”¾æŒ‡çš„æ˜¯åœ¨ä¸Šçº¿ Deployment æ—¶ï¼Œä¸´æ—¶è¿è¡Œç€åº”ç”¨ç¨‹åºçš„å¤šä¸ªç‰ˆæœ¬(å…±å­˜)ï¼Œæ¯”ä¾‹ç¼©æ”¾æ˜¯æ§åˆ¶ä¸Šçº¿æ—¶å¤šä¸ª Pod æœåŠ¡å¯ç”¨æ•°é‡çš„æ–¹å¼ã€‚\næ°´å¹³ç¼©æ”¾åªå…³å¿ƒæœ€ç»ˆçš„æœŸæœ› Pod æ•°é‡ï¼Œç›´æ¥ä¿®æ”¹å‰¯æœ¬æ•°å’Œæ°´å¹³ç¼©æ”¾ï¼Œå†³å®šæœ€ç»ˆ Pod æ•°é‡æœ‰å¤šå°‘ä¸ªã€‚\nè€Œæ¯”ä¾‹ç¼©æ”¾æ˜¯æ§åˆ¶å¯¹è±¡ä¸Šçº¿è¿‡ç¨‹ä¸­ï¼Œæ–° Pod çš„åˆ›å»ºé€Ÿåº¦å’Œæ—§ Pod çš„é”€æ¯é€Ÿåº¦ã€ Pod çš„å¯ç”¨ç¨‹åº¦ï¼Œè·Ÿä¸Šçº¿è¿‡ç¨‹ä¸­æ–°æ—§ç‰ˆæœ¬çš„ Pod æ›¿æ¢æ•°é‡æœ‰å…³ã€‚\næŸ¥çœ‹ä¸Šä¸€ç« ä¸­åˆ›å»ºçš„ Deployment çš„éƒ¨åˆ† YAML å¦‚ä¸‹ï¼š\n1spec: 2 progressDeadlineSeconds: 600 3 replicas: 1 4 revisionHistoryLimit: 10 5 selector: 6 matchLabels: 7 app: nginx 8 strategy: 9 rollingUpdate: 10 maxSurge: 25% 11 maxUnavailable: 25% 12 type: RollingUpdate maxUnavailableï¼šæœ€å¤§ä¸å¯ç”¨æ•°é‡æˆ–æ¯”ä¾‹ï¼Œæ—§çš„ Pod ä¼šä»¥è¿™ä¸ªæ•°é‡æˆ–æ¯”ä¾‹é€æ¸å‡å°‘ã€‚ maxSurgeï¼šæœ€å¤§å³°å€¼ï¼Œæ–°çš„ Pod ä¼šæŒ‰ç…§è¿™ä¸ªæ•°é‡æˆ–æ¯”ä¾‹é€æ¸åˆ›å»ºã€‚ å¦‚æœæƒ³æ–°ç‰ˆæœ¬çš„ Pod ä¸Šçº¿é€Ÿåº¦æ›´å¿«ï¼Œåˆ™å¯ä»¥æŠŠÂ maxSurgeÂ æ•°é‡æˆ–æ¯”ä¾‹è®¾ç½®å¤§ä¸€äº›ï¼›ä¸ºäº†ä¿è¯ä¸Šçº¿è¿‡ç¨‹ç¨³å®šã€æœåŠ¡å¯ç”¨ç¨‹åº¦é«˜ï¼Œå¯ä»¥æŠŠÂ maxUnavailableÂ è®¾ç½®å°ä¸€äº›ã€‚\nstrategyÂ å¯ä»¥é…ç½® Pod æ˜¯æ€ä¹ˆæ›´æ–°çš„ã€‚å½“æˆ‘ä»¬è®¾ç½®.spec.strategy.type==RollingUpdateæ—¶ï¼Œä¾¿ä¼šé‡‡å–æ»šåŠ¨æ›´æ–°çš„æ–¹å¼æ›´æ–° Podsï¼Œæ­¤æ—¶å¯ä»¥æŒ‡å®šÂ maxUnavailableÂ å’ŒÂ maxSurgeÂ æ¥æ§åˆ¶æ»šåŠ¨æ›´æ–° è¿‡ç¨‹ã€‚è¿™ä¸ªæˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ï¼Œå°±æ˜¯ Deployment é»˜è®¤ä¼šä¿è¯ä¸€ç›´æœ‰ 75% çš„ podå¤„äºå¯ç”¨çŠ¶æ€ï¼Œåœ¨å®Œæˆæ›´æ–°å‰å¯èƒ½æœ‰å¤šä¸ªç‰ˆæœ¬çš„ pod å…±å­˜ã€‚\næ ‡ç­¾ä¸é€‰æ‹© label Label æ˜¯é™„åŠ åˆ° Kubernetes å¯¹è±¡ä¸Šçš„é”®å€¼å¯¹ï¼Œä¾‹å¦‚ Pod å¯é€šè¿‡Â kubectl describe podsÂ æŸ¥è¯¢ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ª Pod éƒ½å¸¦æœ‰Â Labels: app=...ã€‚\n1... ... 2Labels: app=nginx 3 pod-template-hash=85b45874d9 4... ... åˆ›å»º Deployment æ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š Pod çš„ app æ ‡ç­¾å€¼ï¼Œé‚£ä¹ˆä¸€èˆ¬è·Ÿ Deployment åç§°ä¸€è‡´ã€‚\nåœ¨ Deployment ä¸­ï¼Œselector å­—æ®µè®¾ç½®äº†å¦‚ä½•æŸ¥æ‰¾å±äºæ­¤å¯¹è±¡çš„ Podã€‚\n1 selector: 2 matchLabels: 3 app: nginx å‘½ä»¤å¼ label é€‰æ‹© æŸ¥è¯¢ Pod æ‰€æœ‰çš„ Labelï¼š\n1kubectl get pods --show-labels æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ pod\n1kubectl get pods -l app=nginx 2kubectl get pods -l app!=nginx åˆ—å‡ºä¸åŒ…å«æŸä¸ªæ ‡ç­¾çš„ Podï¼š\n1kubectl get pods -l \u0026#39;!env\u0026#39; 2kubectl get pods -l \u0026#39;!app\u0026#39; è·å–åŒæ—¶åŒ…å«ä¸¤ä¸ªæ ‡ç­¾çš„ Podï¼š\n1kubectl get pods -l app,env æ ‡ç­¾é€‰æ‹©æœ‰ç­‰å€¼å’Œé›†åˆä¸¤ç§ï¼Œå…¶ä¸­ç­‰å€¼é€‰æ‹©æœ‰Â =ã€==ã€!=Â ä¸‰ç§ç¬¦å·ï¼Œ=Â å’ŒÂ ==Â æ— ä»»ä½•åŒºåˆ«ï¼Œæ‰€ä»¥å®é™…åªæœ‰Â ç­‰äºÂ ã€ä¸ç­‰äºÂ ä¸¤ç§é€‰æ‹©æƒ…å†µã€‚\nåœ¨å¤šä¸ªéœ€æ±‚(å¤šä¸ªlabel)çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨Â \u0026amp;\u0026amp;Â è¿ç®—ç¬¦ï¼Œè¡¨ç¤ºéœ€è¦åŒæ—¶ç¬¦åˆå¤šä¸ªæ¡ä»¶ï¼Œä½†æ˜¯é€‰æ‹©å™¨ä¸å­˜åœ¨Â ||Â è¿™ç§é€»è¾‘æˆ–è¿ç®—ç¬¦ã€‚\næŸ¥çœ‹ç¬¦åˆä¸¤ä¸ªæ¡ä»¶çš„èŠ‚ç‚¹ï¼š\n1# å¤šä¸ªæ¡ä»¶ä½¿ç”¨ é€—å·\u0026#34;,\u0026#34;\u0026#34; éš”å¼€ï¼Œè€Œä¸æ˜¯ \u0026#34;\u0026amp;\u0026amp;\u0026#34;ã€‚ 2kubectl get nodes -l disktype=ssd,disksize!=big selector 1spec: 2 selector: 3 matchLabels: 4 app: nginx 5 template: 6 metadata: 7 labels: 8 app: nginx spec.templateÂ æ˜¯å®šä¹‰æ‰€æœ‰ Pod çš„æ¨¡æ¿ï¼Œtemplate.metadataÂ å¯ä»¥ä¸ºæ‰€æœ‰ Pod è®¾ç½®ä¸€äº›å…ƒæ•°æ®ï¼Œä¾‹å¦‚Â labelsã€‚\nspec.selector å®šä¹‰ Deployment å¦‚ä½•æŸ¥æ‰¾è¦ç®¡ç†çš„ Podsã€‚matchLabelsÂ ä¸­çš„æ ‡ç­¾è¡¨ç¤ºé›†åˆè¿ç®—çš„Â inï¼ŒPod åªéœ€è¦åŒ…å«è¿™äº›æ ‡ç­¾ï¼Œå°±ä¼šè¢«æ­¤ Deployment ç®¡ç†ã€‚\nè‹¥ matchLabels è¿˜å¯è¿›ä¸€æ­¥ä½¿ç”¨ matchExpressions\næ³¨è§£ Kubernetes æ³¨è§£ä¸ºå¯¹è±¡é™„åŠ ä»»æ„çš„éæ ‡è¯†çš„å…ƒæ•°æ®ï¼Œæ³¨è§£ä½¿ç”¨ annotations æ ‡è¯†ã€‚å®¢æˆ·ç«¯ç¨‹åºï¼ˆä¾‹å¦‚å·¥å…·å’Œåº“ï¼‰èƒ½å¤Ÿè·å–è¿™äº›å…ƒæ•°æ®ä¿¡æ¯ã€‚\nannotations ç”± key/value ç»„æˆï¼Œç±»ä¼¼ labelï¼Œä½†æ˜¯ annotations æ”¯æŒä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œå¯ä»¥ç”¨ä½œæ„å»ºå‘å¸ƒé•œåƒæ—¶çš„ä¿¡æ¯ã€æ—¥å¿—è®°å½•ç­‰ã€‚\n1Annotations: meta.helm.sh/release-name: kubernetes-dashboard 2 meta.helm.sh/release-namespace: kubernetes-dashboard äº²å’Œæ€§ã€åäº²å’Œæ€§ èŠ‚ç‚¹äº²å’Œæ€§ç±»ä¼¼äºÂ nodeSelectorÂ ï¼Œæ ¹æ®èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾çº¦æŸ Pod å¯ä»¥è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ã€‚\nPod äº²å’Œæ€§æœ‰ä¸¤ç§åˆ«ä¸ºï¼š\nrequiredDuringSchedulingIgnoredDuringExecutionï¼šå¿…é¡»æ»¡è¶³ preferredDuringSchedulingIgnoredDuringExecutionï¼šå°½åŠ›æ»¡è¶³ 1apiVersion: v1 2kind: Pod 3metadata: 4 name: with-node-affinity 5spec: 6 affinity: 7 nodeAffinity: 8 requiredDuringSchedulingIgnoredDuringExecution: 9 nodeSelectorTerms: 10 - matchExpressions: 11 - key: kubernetes.io/e2e-az-name 12 operator: In 13 values: 14 - e2e-az1 15 - e2e-az2 16 preferredDuringSchedulingIgnoredDuringExecution: 17 - weight: 1 18 preference: 19 matchExpressions: 20 - key: another-node-label-key 21 operator: In 22 values: 23 - another-node-label-value 24 containers: 25 - name: with-node-affinity 26 image: k8s.gcr.io/pause:2.0 å¦‚æœæˆ‘ä»¬è®¾ç½®äº†å¤šä¸ª nodeSelectorTerms ï¼š\n1requiredDuringSchedulingIgnoredDuringExecution: 2 nodeSelectorTerms: 3 ... 4 nodeSelectorTerms: åˆ™åªéœ€è¦æ»¡è¶³å…¶ä¸­ä¸€ç§è¡¨è¾¾å¼å³å¯è°ƒåº¦ Pod åˆ° èŠ‚ç‚¹ä¸Šã€‚\næˆ‘ä»¬å†å›å¿†ä¸€ä¸‹ï¼ŒèŠ‚ç‚¹é€‰æ‹©å™¨å«Â nodeSelectorï¼Œè€ŒèŠ‚ç‚¹äº²å’Œæ€§å«Â nodeAffinityï¼Œå®ƒä»¬éƒ½å¯ä»¥è®© Deployment ç­‰å¯¹è±¡éƒ¨ç½² Pod æ—¶é€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹ï¼Œå®ƒä»¬éƒ½æ˜¯ä½¿ç”¨æ ‡ç­¾(Label)æ¥å®Œæˆé€‰æ‹©å·¥ä½œã€‚\nå¦‚æœä½ åŒæ—¶æŒ‡å®šäº†Â nodeSelectorÂ å’ŒÂ nodeAffinityÂ ï¼Œåˆ™ä¸¤è€…å¿…é¡»åŒæ—¶æ»¡è¶³æ¡ä»¶ï¼Œ æ‰èƒ½å°† Pod è°ƒåº¦åˆ°å€™é€‰èŠ‚ç‚¹ä¸Šã€‚\näº²å’Œæ€§å’Œåäº²å’Œæ€§çš„ YAML å¾ˆå¤æ‚ï¼Œéœ€è¦ä½¿ç”¨æ—¶æŸ¥çœ‹æ–‡æ¡£ã€‚\nhttps://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node\næ±¡ç‚¹ã€å®¹å¿åº¦ å½“èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹åï¼Œé™¤é Pod å£°æ˜èƒ½å¤Ÿå®¹å¿è¿™ä¸ªæ±¡ç‚¹ï¼Œå¦åˆ™ Pod ä¸ä¼šè¢«è°ƒåº¦åˆ°è¿™ä¸ª èŠ‚ç‚¹ä¸Šã€‚\nå¦‚æœèŠ‚ç‚¹å­˜åœ¨æ±¡ç‚¹ï¼Œé‚£ä¹ˆ Pod å¯èƒ½ä¸ä¼šè¢«åˆ†é…åˆ°æ­¤èŠ‚ç‚¹ä¸Šï¼›å¦‚æœèŠ‚ç‚¹ä¸€å¼€å§‹æ²¡æœ‰è®¾ç½®æ±¡ç‚¹ï¼Œç„¶åéƒ¨ç½²äº† Podï¼Œåé¢èŠ‚ç‚¹è®¾ç½®äº†æ±¡ç‚¹ï¼ŒèŠ‚ç‚¹å¯èƒ½ä¼šåˆ é™¤å·²éƒ¨ç½²çš„ Podï¼Œè¿™ç§è¡Œä¸ºç§°ä¸ºé©±é€ã€‚\nèŠ‚ç‚¹æ±¡ç‚¹(taint) å¯ä»¥æ’æ–¥ä¸€ç±»ç‰¹å®šçš„ Podï¼Œè€Œ å®¹å¿åº¦(Toleration)åˆ™è¡¨ç¤ºèƒ½å¤Ÿå®¹å¿è¿™ä¸ªå¯¹è±¡çš„æ±¡ç‚¹ã€‚\nèŠ‚ç‚¹çš„æ±¡ç‚¹å¯ä»¥è®¾ç½®ä¸ºä»¥ä¸‹ä¸‰ç§æ•ˆæœï¼š\nNoScheduleï¼šä¸èƒ½å®¹å¿æ­¤æ±¡ç‚¹çš„ Pod ä¸ä¼šè¢«è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šï¼›ä¸ä¼šå½±å“å·²å­˜åœ¨çš„ podã€‚ PreferNoScheduleï¼šKubernetes ä¼šé¿å…å°†ä¸èƒ½å®¹å¿æ­¤æ±¡ç‚¹çš„ Pod å®‰æ’åˆ°èŠ‚ç‚¹ä¸Šã€‚ NoExecuteï¼šå¦‚æœ Pod å·²åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œåˆ™ä¼šå°†è¯¥ Pod ä»èŠ‚ç‚¹ä¸­é€å‡ºï¼›å¦‚æœå°šæœªåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œåˆ™ä¸ä¼šå°†å…¶è°ƒåº¦åˆ°æ­¤èŠ‚ç‚¹ä¸Šã€‚ å½“èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹åï¼Œæ— è®ºå…¶æ•ˆæœæ˜¯å“ªä¸€ç§ï¼Œåªè¦ Pod æ²¡æœ‰è®¾ç½®ç›¸å…³çš„å®¹å¿åº¦ï¼ŒPod å°±ä¸ä¼šè°ƒåº¦åˆ°æ­¤èŠ‚ç‚¹ä¸Šã€‚\nç³»ç»Ÿé»˜è®¤æ±¡ç‚¹ å°½ç®¡ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹å®Œå…¨æ’æ–¥ Podï¼Œä½†æ˜¯æŸäº›ç³»ç»Ÿåˆ›å»ºçš„ Pod å¯ä»¥å®¹å¿æ‰€æœ‰Â NoExecuteÂ å’ŒÂ NoScheduleÂ æ±¡ç‚¹ï¼Œå› æ­¤ä¸ä¼šè¢«é€å‡ºã€‚\nä¾‹å¦‚ master èŠ‚ç‚¹æ˜¯ä¸ä¼šè¢« Deployment ç­‰åˆ†é… Pod çš„ï¼Œå› ä¸º master æœ‰ä¸ªæ±¡ç‚¹ï¼Œè¡¨é¢å®ƒåªåº”è¯¥è¿è¡Œkube-systemÂ å‘½åç©ºé—´ä¸­çš„å¾ˆå¤šç³»ç»Ÿ Podï¼Œç”¨æˆ· Pod ä¼šè¢«æ’æ–¥éƒ¨ç½²åˆ° master èŠ‚ç‚¹ä¸Šã€‚\nå½“ç„¶æˆ‘ä»¬é€šè¿‡ä¿®æ”¹æ±¡ç‚¹ï¼Œå¯ä»¥è®©ç”¨æˆ·çš„ Pod éƒ¨ç½²åˆ° master èŠ‚ç‚¹ä¸­ã€‚\nmaster èŠ‚ç‚¹ä¸Šä¼šæœ‰ä¸€ä¸ªÂ node-role.kubernetes.io/master:NoScheduleÂ çš„æ±¡ç‚¹ï¼ŒKubernetes éƒ¨ç½²ç”¨æˆ·çš„ Pod æ—¶ä¼šæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨æ­¤æ±¡ç‚¹ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä¸ä¼šåœ¨æ­¤èŠ‚ç‚¹ä¸Šéƒ¨ç½² Podã€‚\né™¤äº†Â node-role.kubernetes.io/masterÂ ï¼ŒæŸäº›æƒ…å†µä¸‹èŠ‚ç‚¹æ§åˆ¶å™¨ä¼šè‡ªåŠ¨ç»™èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹ã€‚å½“å‰å†…ç½®çš„æ±¡ç‚¹åŒ…æ‹¬ï¼š\nnode.kubernetes.io/not-readyï¼šèŠ‚ç‚¹æœªå‡†å¤‡å¥½ã€‚è¿™ç›¸å½“äºèŠ‚ç‚¹çŠ¶æ€Â ReadyÂ çš„å€¼ä¸º \u0026ldquo;False\u0026quot;ã€‚ node.kubernetes.io/unreachableï¼šèŠ‚ç‚¹æ§åˆ¶å™¨è®¿é—®ä¸åˆ°èŠ‚ç‚¹. è¿™ç›¸å½“äºèŠ‚ç‚¹çŠ¶æ€Â ReadyÂ çš„å€¼ä¸º \u0026ldquo;Unknown\u0026quot;ã€‚ node.kubernetes.io/out-of-diskï¼šèŠ‚ç‚¹ç£ç›˜è€—å°½ã€‚ node.kubernetes.io/memory-pressureï¼šèŠ‚ç‚¹å­˜åœ¨å†…å­˜å‹åŠ›ã€‚ node.kubernetes.io/disk-pressureï¼šèŠ‚ç‚¹å­˜åœ¨ç£ç›˜å‹åŠ›ã€‚ node.kubernetes.io/network-unavailableï¼šèŠ‚ç‚¹ç½‘ç»œä¸å¯ç”¨ã€‚ node.kubernetes.io/unschedulable: èŠ‚ç‚¹ä¸å¯è°ƒåº¦ã€‚ node.cloudprovider.kubernetes.io/uninitializedï¼šå¦‚æœ kubelet å¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ª \u0026ldquo;å¤–éƒ¨\u0026rdquo; äº‘å¹³å°é©±åŠ¨ï¼Œ å®ƒå°†ç»™å½“å‰èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹å°†å…¶æ ‡å¿—ä¸ºä¸å¯ç”¨ã€‚åœ¨ cloud-controller-manager çš„ä¸€ä¸ªæ§åˆ¶å™¨åˆå§‹åŒ–è¿™ä¸ªèŠ‚ç‚¹åï¼Œkubelet å°†åˆ é™¤è¿™ä¸ªæ±¡ç‚¹ã€‚ å½“èŠ‚ç‚¹ä¸Šçš„èµ„æºä¸è¶³æ—¶ï¼Œä¼šæ·»åŠ ä¸€ä¸ªæ±¡ç‚¹ï¼Œæ’æ–¥åç»­ Pod åœ¨æ­¤ èŠ‚ç‚¹ä¸Šéƒ¨ç½²ï¼Œä½†ä¸ä¼šé©±é€å·²å­˜åœ¨çš„ Podã€‚å¦‚æœæˆ‘ä»¬çš„ Pod å¯¹æœºå™¨èµ„æºæœ‰è¦æ±‚ï¼Œå¯ä»¥æ’æ–¥ç›¸å…³çš„æ±¡ç‚¹ï¼Œå¦‚æœæ²¡è¦æ±‚ï¼Œåˆ™éœ€è¦å®¹å¿ç›¸å…³æ±¡ç‚¹ã€‚\nå®¹å¿åº¦ æ±¡ç‚¹å’Œå®¹å¿åº¦ç›¸äº’é…åˆï¼Œç”¨æ¥é¿å… Pod è¢«åˆ†é…åˆ°ä¸åˆé€‚çš„èŠ‚ç‚¹ä¸Šï¼›ä¹Ÿå¯ä»¥è®©çœŸæ­£åˆé€‚çš„ Pod éƒ¨ç½²åˆ°æœ‰æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šã€‚\n1// å®¹å¿å¸¦æœ‰Â key1Â æ ‡ç­¾çš„æ±¡ç‚¹ï¼Œä¸”æ— è®ºæ˜¯ä»€ä¹ˆå€¼ã€‚ 2tolerations: 3- key: \u0026#34;key1\u0026#34; 4 operator: \u0026#34;Exists\u0026#34; 5 effect: \u0026#34;NoSchedule\u0026#34; ä¹Ÿå¯ä»¥è®¾ç½®å¸¦ value çš„å®¹å¿ã€‚\n1tolerations: 2- key: \u0026#34;key1\u0026#34; 3 operator: \u0026#34;Equal\u0026#34; 4 value: \u0026#34;value1\u0026#34; 5 effect: \u0026#34;NoSchedule\u0026#34; å¦‚æœ Pod çš„å®¹å¿åº¦è®¾ç½®ä¸ºä»¥ä¸‹ YAMLï¼š\n1tolerations: 2 operator: \u0026#34;Exists\u0026#34; åˆ™è¡¨ç¤ºæ­¤ Pod èƒ½å¤Ÿå®¹å¿ä»»æ„çš„æ±¡ç‚¹ï¼Œæ— è®ºèŠ‚ç‚¹æ€ä¹ˆè®¾ç½®Â keyã€valueÂ ã€effectÂ ï¼Œæ­¤ Pod éƒ½ä¸ä¼šä»‹æ„ã€‚\nå¦‚æœè¦åœ¨ master ä¸Šä¹Ÿèƒ½éƒ¨ç½² Podï¼Œåˆ™å¯ä»¥ä¿®æ”¹ Pod çš„å®¹å¿åº¦ï¼š\n1 spec: 2 tolerations: 3 # this toleration is to have the daemonset runnable on master nodes 4 # remove it if your masters can\u0026#39;t run pods 5 - key: node-role.kubernetes.io/master 6 effect: NoSchedule å¦‚æœÂ operatorÂ æ˜¯Â Exists æ­¤æ—¶ä¸éœ€è¦å¡«å†™Â valueÂ å­—æ®µï¼›å¦‚æœå­˜åœ¨ key ä¸º key1 çš„ labelï¼Œä¸”æ±¡ç‚¹æ•ˆæœä¸ºÂ NoScheduleï¼Œæ— è®ºæ˜¯ä»€ä¹ˆå€¼éƒ½å®¹å¿ã€‚ å¦‚æœÂ operatorÂ æ˜¯Â Equal åˆ™å®ƒä»¬çš„Â valueÂ åº”è¯¥ç›¸ç­‰ï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œåˆ™å®¹å¿ï¼Œ å¦‚æœÂ effectÂ ç•™ç©º åˆ™è¡¨ç¤ºåªè¦æ˜¯ label ä¸ºÂ key1Â çš„èŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥å®¹å¿ã€‚ Jobsã€CronJobs Jobã€Cronjob å®ƒä»¬ç”¨äºåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª Podï¼Œæ¥å®ŒæˆæŸäº›ä»»åŠ¡ï¼Œå®ƒä»¬åˆ›å»ºçš„ Pod ä¸ä¼šé•¿ä¹…çš„è¿è¡Œåœ¨èŠ‚ç‚¹ä¸­ã€‚\nJob Job æ˜¯ç”¨æ¥åªè¿è¡Œä¸€æ¬¡ä»»åŠ¡çš„å¯¹è±¡ï¼ŒJob å¯¹è±¡ä»¥ä¸€ç§å¯é çš„æ–¹å¼è¿è¡ŒæŸ Pod ç›´åˆ°å®Œæˆï¼Œé€‚åˆç”¨äºæ‰¹å¤„ç†ï¼Œä¾‹å¦‚ç¼–è¯‘ç¨‹åºã€æ‰§è¡Œè¿ç®—ä»»åŠ¡ã€‚Job é€‚åˆä¸€æ¬¡å®Œæ•´çš„æµç¨‹ï¼Œå®Œæˆåå³å¯æŠ›å¼ƒçš„ä»»åŠ¡ã€‚\nå½“ Job å¯åŠ¨æ—¶ï¼ŒJob ä¼šè·Ÿè¸ªæˆåŠŸå®Œæˆçš„ Pod çš„ä¸ªæ•°ï¼Œå½“æˆåŠŸæ•°é‡è¾¾åˆ°æŸä¸ªé˜ˆå€¼æ—¶ï¼ŒJob ä¼šè¢«ç»ˆç»“ã€‚å½“ Job è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ æš‚åœ/æŒ‚èµ· Jobï¼ŒJob ä¼šåˆ é™¤æ­£åœ¨è¿è¡Œçš„ Podï¼Œä¿ç•™å·²å®Œæˆçš„ Pod æ•°é‡ï¼Œå½“æ¢å¤ Job æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„ Podï¼Œç»§ç»­å®Œæˆä»»åŠ¡ã€‚\nJob çš„ç»“æ„å¾ˆç®€å•ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œè¿™ä¸ª Job åªæœ‰ä¸€ä¸ªé•œåƒï¼Œå¯åŠ¨åæ‰§è¡ŒÂ sleep 3Â å‘½ä»¤ï¼Œå®¹å™¨ä¼šåœ¨3ç§’åè‡ªåŠ¨é€€å‡ºï¼ŒJob æ ‡è®°å…¶å·²ç»å®Œæˆã€‚\n1apiVersion: batch/v1 2kind: Job 3metadata: 4 name: busybox 5spec: 6 template: 7 spec: 8 containers: 9 - name: busybox 10 image: busybox 11 command: [\u0026#34;/bin/sleep\u0026#34;] 12 args: [\u0026#34;3\u0026#34;] 13 restartPolicy: Never å¯¹äºè¿™ç§ç®€å•çš„ Jobï¼Œç§°ä¸ºéå¹¶è¡Œçš„ï¼Œå®ƒçš„ç‰¹ç‚¹æœ‰ï¼š\nåªå¯åŠ¨ä¸€ä¸ª Podï¼Œé™¤éè¯¥ Pod å¤±è´¥ï¼› å½“ Pod æˆåŠŸç»ˆæ­¢æ—¶ï¼Œç«‹å³è§† Job ä¸ºå®ŒæˆçŠ¶æ€ï¼› å®Œæˆæ•° ä½¿ç”¨.spec.completionsÂ æ¥è®¾ç½®å®Œæˆæ•°æ—¶ï¼ŒJob æ§åˆ¶å™¨æ‰€åˆ›å»ºçš„æ¯ä¸ª Pod ä½¿ç”¨å®Œå…¨ç›¸åŒçš„Â specÂ æ¨¡æ¿ã€‚ è¿™æ„å‘³ç€ä»»åŠ¡çš„æ‰€æœ‰ Pod éƒ½æœ‰ç›¸åŒçš„å‘½ä»¤è¡Œï¼Œéƒ½ä½¿ç”¨ç›¸åŒçš„é•œåƒå’Œæ•°æ®å·ï¼Œç”šè‡³è¿ ç¯å¢ƒå˜é‡éƒ½ï¼ˆå‡ ä¹ï¼‰ç›¸åŒã€‚\næˆ‘ä»¬ç»§ç»­ä½¿ç”¨ä¸Šæ¬¡çš„ Job æ¨¡æ¿ï¼Œè¿™é‡Œå¢åŠ ä¸€ä¸ªÂ completionsÂ ï¼š\n1apiVersion: batch/v1 2kind: Job 3metadata: 4 name: busybox 5spec: 6 completions: 5 7 template: 8 spec: 9 containers: 10 - name: busybox 11 image: busybox 12 command: [\u0026#34;/bin/sleep\u0026#34;] 13 args: [\u0026#34;3\u0026#34;] 14 restartPolicy: Never æŸ¥çœ‹ Job å’Œ Podï¼š\n1root@instance-1:~# kubectl get jobs 2NAME COMPLETIONS DURATION AGE 3busybox 5/5 36s 38s 4root@instance-2:~# kubectl get pods 5NAME READY STATUS RESTARTS AGE 6busybox-rfhcj 0/1 Completed 0 9s 7busybox-stkbg 0/1 Completed 0 23s 8busybox-xk6sb 0/1 Completed 0 30s 9busybox-z6h9x 0/1 Completed 0 40s 10busybox-zqgcb 0/1 Completed 0 16s Pod çš„åˆ›å»ºæ˜¯ä¸²è¡Œçš„ï¼Œæ¯æ¬¡åªè¿è¡Œä¸€ä¸ª Podï¼Œå½“ä¸€ä¸ª Pod å¤„äº Completed çŠ¶æ€æ—¶ï¼Œåˆ›å»ºä¸‹ä¸€ä¸ª Podã€‚å½“æœ‰ 5 ä¸ª Pod å¤„äº Completed çŠ¶æ€æ—¶ï¼Œæ­¤ Job æ ‡è®°å®Œæˆã€‚\nå¹¶è¡Œ 1kubectl get job busybox -o yaml 2... ... 3spec: 4 backoffLimit: 6 5 completions: 5 6 parallelism: 1 7 selector: 8 ... ... å¯ä»¥çœ‹åˆ°Â parallelism=1ï¼Œæ˜¯æ§åˆ¶å¹¶è¡Œåº¦çš„å­—æ®µï¼Œç”±äºè¿™ä¸ªå­—æ®µé»˜è®¤ä¸º 1ï¼Œæ‰€ä»¥è¿™ä¸ª Job æ¯æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ª Podã€‚\nspec.completionsÂ å’ŒÂ spec.parallelismï¼Œè¿™ä¸¤ä¸ªå±æ€§éƒ½ä¸è®¾ç½®æ—¶ï¼Œå‡å–é»˜è®¤å€¼ 1ã€‚\nå¸¦ç±»å‹çš„ Job Job ä¸­çš„ Pod éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤å¦‚æœè¦ Job å¤„ç†ä¸åŒçš„å·¥ä½œä»»åŠ¡ï¼Œåˆ™éœ€è¦å¤–ç•Œå¸®å¿™ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œå¹³å°æ˜¯ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰è¯„è®ºã€è®¢å•ç­‰äº”ç±»æ¶ˆæ¯ï¼Œé‚£ä¹ˆåº”è¯¥è®¾è®¡äº”ç§ç¨‹åºå»å¤„ç†è¿™äº›æ¶ˆæ¯ï¼Œä½†æ˜¯ Pod åªæœ‰ä¸€ç§ã€‚æ­¤æ—¶å¯ä»¥è®¾ç½®åŸå­æ€§çš„ä»»åŠ¡é¢†å–ä¸­å¿ƒï¼ŒJob å¯åŠ¨ Pod åï¼ŒPod ä¾¿å‘ä»»åŠ¡ä¸­å¿ƒé¢†å–ä»»åŠ¡ç±»å‹ï¼Œé¢†å–åˆ°åï¼Œå¼€å§‹å·¥ä½œã€‚\né‚£ä¹ˆ Job ä¸­çš„ Pod å¯èƒ½æ˜¯è¿™æ ·å®Œæˆå·¥ä½œçš„ï¼š\n![[Pasted image 20230827163440.png]]\nåœ¨ Job åˆ›å»ºçš„ Pod ä¸­ï¼Œä¼šæœ‰ä¸ªåä¸ºÂ JOB_COMPLETION_INDEXÂ çš„ç¯å¢ƒå˜é‡ï¼Œæ­¤ç¯å¢ƒå˜é‡æ ‡è¯†äº† Pod çš„ç´¢å¼•ï¼ŒPod å¯ä»¥é€šè¿‡æ­¤ç´¢å¼•æ ‡è¯†è‡ªå·±çš„èº«ä»½ã€‚\nç¤ºä¾‹ YAML å¦‚ä¸‹ï¼š\n1apiVersion: batch/v1 2kind: Job 3metadata: 4 name: busybox 5spec: 6 parallelism: 1 7 completions: 5 8 completionMode: Indexed 9 template: 10 spec: 11 containers: 12 - name: busybox 13 image: busybox 14 command: [\u0026#34;env\u0026#34;] 15 restartPolicy: Never completionMode: IndexedÂ è¡¨æ˜å½“å‰ Pod æ˜¯å¸¦ç´¢å¼•çš„ï¼Œå¦‚æœÂ completionMode: NonIndexedÂ åˆ™ä¸å¸¦ç´¢å¼•ã€‚\nç´¢å¼•ä¼šæŒ‰ç…§ 0ï¼Œ1ï¼Œ2ï¼Œ3 è¿™æ ·é€’å¢ã€‚\næ‰§è¡ŒÂ kubectl apply -f job.yamlÂ å¯åŠ¨æ­¤ Jobï¼Œä¼šå‘ç°ï¼š\n1root@master:~# kubectl get pods 2NAME READY STATUS RESTARTS AGE 3busybox-0-j8gvz 0/1 Completed 0 29s 4busybox-1-k4kfx 0/1 Completed 0 25s 5busybox-2-zplxl 0/1 Completed 0 14s 6busybox-3-pj4jk 0/1 Completed 0 10s 7busybox-4-q5fq9 0/1 Completed 0 6s Job ç»ˆæ­¢å’Œæ¸…ç† å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ› Job è¿è¡Œå¤ªé•¿æ—¶é—´ï¼Œå¯ä»¥ä¸º Job çš„Â .spec.activeDeadlineSecondsÂ è®¾ç½®ä¸€ä¸ªç§’æ•°å€¼ã€‚ åœ¨ Job çš„æ•´ä¸ªç”Ÿå‘½æœŸï¼Œæ— è®º Job åˆ›å»ºäº†å¤šå°‘ä¸ª Podã€‚ ä¸€æ—¦ Job è¿è¡Œæ—¶é—´è¾¾åˆ°Â activeDeadlineSecondsÂ ç§’ï¼Œå…¶æ‰€æœ‰è¿è¡Œä¸­çš„ Pod éƒ½ä¼šè¢«ç»ˆæ­¢ï¼Œå¹¶ä¸” Job çš„çŠ¶æ€æ›´æ–°ä¸ºÂ type: FailedÂ åŠÂ reason: DeadlineExceededã€‚\nYAML ç¤ºä¾‹ï¼š\n1apiVersion: batch/v1 2kind: Job 3metadata: 4 name: busybox 5spec: 6 completions: 5 7 activeDeadlineSeconds: 2 8 template: 9 spec: 10 containers: 11 - name: busybox 12 image: busybox 13 command: [\u0026#34;/bin/sleep\u0026#34;] 14 args: [\u0026#34;3\u0026#34;] 15 restartPolicy: Never CronJob CronJobs å¯¹äºåˆ›å»ºå‘¨æœŸæ€§çš„ã€åå¤é‡å¤çš„ä»»åŠ¡å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚æ‰§è¡Œæ•°æ®å¤‡ä»½æˆ–è€…å‘é€é‚®ä»¶ã€‚ CronJobs ä¹Ÿå¯ä»¥ç”¨æ¥è®¡åˆ’åœ¨æŒ‡å®šæ—¶é—´æ—¶æ¥æ‰§è¡Œçš„ç‹¬ç«‹ä»»åŠ¡ï¼Œä¾‹å¦‚è®¡åˆ’å½“é›†ç¾¤çœ‹èµ·æ¥å¾ˆç©ºé—²æ—¶ æ‰§è¡ŒæŸä¸ª Jobã€‚\nå¯ä¾›å®éªŒçš„ YAML ç¤ºä¾‹å¦‚ä¸‹ï¼š\n1apiVersion: batch/v1beta1 2kind: CronJob 3metadata: 4 name: hello 5spec: 6 schedule: \u0026#34;*/1 * * * *\u0026#34; 7 jobTemplate: 8 spec: 9 template: 10 spec: 11 containers: 12 - name: hello 13 image: busybox 14 imagePullPolicy: IfNotPresent 15 command: 16 - /bin/sh 17 - -c 18 - date; echo Hello from the Kubernetes cluster 19 restartPolicy: OnFailure æ­¤ CronJob ä¼šæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚\n","permalink":"/tech/kubernetes/pod-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","summary":"\u003cp\u003ePod æ˜¯ K8s é›†ç¾¤ä¸­åˆ›å»ºå’Œç®¡ç†çš„ã€æœ€å°çš„å¯éƒ¨ç½²çš„è®¡ç®—å•å…ƒã€‚K8s ä¸ä¼šç›´æ¥æ“ä½œå®¹å™¨ï¼Œè€Œæ˜¯é€šè¿‡ Pod å°è£…äº†å®¹å™¨ï¼Œé›†ç¾¤é€šè¿‡ç®¡æ§ Pod ï¼Œä¾¿å¯æ§åˆ¶å®¹å™¨çš„å­˜å‚¨ã€ç½‘ç»œç­‰èµ„æºï¼Œå®ç°èµ„æºéš”ç¦»æˆ–å…±äº«ã€‚\u003c/p\u003e","title":"K8s Pod åŸºç¡€çŸ¥è¯†"},{"content":"å‡çº§ OpenSSH ä»é€‰æ‹©ä¸€ä¸ªæœ€æ–°çš„ç‰ˆæœ¬ https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/\n1# è·å–æœ€æ–°ç‰ˆæœ¬ openssh 2wget --no-check-certificate https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-9.7p1.tar.gz 3 4# è§£å‹ 5tar -zxvf openssh-9.7p1.tar.gz 6 7# å®‰è£…ç›¸å…³éœ€è¦ç»„ä»¶ 8yum -y install pam-devel gcc zlib-devel openssl-devel 9 10# æ£€æŸ¥é…ç½® 11./configure --prefix=/usr --sysconfdir=/etc/ssh --with-zlib --with-ssl-dir=/usr/local/ssl --with-md5-passwords --mandir=/usr/share/man --with-pam 12 13# ç¼–è¯‘å®‰è£… 14make \u0026amp;\u0026amp; make install ç¼–è¯‘å®Œæˆä¹‹åä¼šæœ‰éƒ¨åˆ†æ–‡ä»¶ä¸­çš„å‚æ•°ä¾‹å¦‚ GSSAPIAuthentication æ˜¾ç¤ºä¸æ”¯æŒï¼Œå°†å…¶åˆ æ‰å³å¯ã€‚\næœ€åï¼Œé‡å¯ ssh æœåŠ¡ã€‚\n1service sshd restart å–æ¶ˆ CBC è¿æ¥æ¨¡å¼ è¿™è¾¹çš„æœåŠ¡å™¨ç‰ˆæœ¬å¤ªæ—§äº†ï¼Œå‡çº§ OpenSSH éå¸¸éº»çƒ¦ï¼Œå¯ä»¥ç›´æ¥ä¸ä½¿ç”¨ CBCã€‚\n1vim /etc/ssh/sshd_config 2 3 4# å¦‚æœå·²ç»æœ‰ Ciphersï¼Œåˆ™å°†aes128-cbcå’Œ3des-cbcç­‰å¸¦æœ‰cbcåç¼€çš„åˆ é™¤ 5# å¦åˆ™æ·»åŠ  Ciphers 6Ciphers aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes128-gcm@openssh.com,aes128-ctr 7 8 9# é‡å¯ ssh 10systemctl restart sshd æµ‹è¯•ç”Ÿæ•ˆ\n1ssh -vv -oCiphers=aes128-cbc,3des-cbc,blowfish-cbc,cast128-cbc,aes192-cbc,aes256-cbcÂ 127.0.0.1 æ­¤æ—¶åº”è¯¥æ˜¾ç¤º 1... 2Unable to negotiate with 127.0.0.1 port 22: no matching cipher found. Their offer: aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes128-gcm@openssh.com,aes128-ctr Reference https://openfind.zendesk.com/hc/zh-tw/articles/5337454837519-%E6%9B%B4%E6%96%B0-CentOS-OpenSSH-%E7%89%88%E6%9C%AC https://www.cnblogs.com/niway/p/16808877.html ","permalink":"/tech/ops/cve-2008-5161-openssh-cbc%E6%A8%A1%E5%BC%8F%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E/","summary":"\u003ch1 id=\"å‡çº§-openssh\"\u003eå‡çº§ OpenSSH\u003c/h1\u003e\n\u003cp\u003eä»é€‰æ‹©ä¸€ä¸ªæœ€æ–°çš„ç‰ˆæœ¬\n\u003ca href=\"https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/\"\u003ehttps://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# è·å–æœ€æ–°ç‰ˆæœ¬ openssh\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003ewget --no-check-certificate https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-9.7p1.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# è§£å‹\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003etar -zxvf openssh-9.7p1.tar.gz\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# å®‰è£…ç›¸å…³éœ€è¦ç»„ä»¶\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eyum -y install pam-devel gcc zlib-devel openssl-devel\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# æ£€æŸ¥é…ç½®\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e./configure --prefix\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr --sysconfdir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/etc/ssh --with-zlib --with-ssl-dir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/local/ssl --with-md5-passwords --mandir\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/share/man --with-pam\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# ç¼–è¯‘å®‰è£…\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003emake \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e make install\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eç¼–è¯‘å®Œæˆä¹‹åä¼šæœ‰éƒ¨åˆ†æ–‡ä»¶ä¸­çš„å‚æ•°ä¾‹å¦‚ GSSAPIAuthentication æ˜¾ç¤ºä¸æ”¯æŒï¼Œå°†å…¶åˆ æ‰å³å¯ã€‚\u003c/p\u003e","title":"CVE-2008-5161 OpenSSH CBCæ¨¡å¼ä¿¡æ¯æ³„éœ²æ¼æ´"},{"content":"ä½¿ç”¨golangæ ‡å‡†åº“ä¸­çš„html/templateæ—¶ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹æ¸²æŸ“æ¨¡ç‰ˆæ—¶ä¸ºäº†å®‰å…¨ç­‰åŸå› ï¼Œä¼šå°†å­—ç¬¦ä¸²ä¸­çš„éƒ¨åˆ†ç¬¦å·è¿›è¡Œè½¬ä¹‰ã€‚\næ³¨å†Œè‡ªå®šä¹‰è½¬ä¹‰å¤„ç†å‡½æ•° 1func unescapeHTML(s string) template.HTML { 2\treturn template.HTML(s) 3} åœ¨å®šä¹‰è½¬ä¹‰å¤„ç†å‡½æ•°åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨Funcs()å°†å…¶æ³¨å†Œåˆ°æ¨¡ç‰ˆä¸­ã€‚éœ€è¦æ³¨æ„ï¼Œæ³¨å†Œè‡ªå®šä¹‰å‡½æ•°éœ€è¦åœ¨è°ƒç”¨Parse()å‰è¿›è¡Œã€‚åœ¨æ³¨å†Œæ—¶æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°æ ‡è¯†ç¬¦ï¼Œå¹¶åœ¨æ¨¡ç‰ˆæ–‡æœ¬ä¸­ä½¿ç”¨ã€‚åœ¨ä¸‹é¢ä¾‹å­ä¸­æˆ‘ä»¬ä½¿ç”¨äº†åä¸ºunescapeHTMLçš„å‡½æ•°æ ‡è¯†ç¬¦ã€‚\n1t, err := template.New(\u0026#34;wg_config\u0026#34;).Funcs(template.FuncMap{ 2\t\u0026#34;unescapeHTML\u0026#34;: unescapeHTML, 3\t}).Parse(tmplWireguardConf) 4... 5 6\tconfig := map[string]interface{}{ 7\t\u0026#34;now\u0026#34;: now, 8\t\u0026#34;wireGuardServer\u0026#34;: l.svcCtx.Config.WireGuardServer, 9\t\u0026#34;clientDataList\u0026#34;: nil, // todo ä¼ []Client 10\t} 11 12\terr = t.Execute(f, config) å¦å¤–åœ¨æ¨¡ç‰ˆæ–‡æœ¬å†…å®¹ä¸­ï¼Œå¯¹äºéœ€è¦é¿å…è½¬ä¹‰çš„éƒ¨åˆ†éœ€è¦ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„å‡½æ•°ã€‚ 1PrivateKey = {{ unescapeHTML .wireGuardServer.PrivateKey }} å‚è€ƒèµ„æ–™ï¼š\nhttps://www.ghosind.com/2022/06/28/go-template-escape-html ","permalink":"/tech/golang/golang-template-%E8%B7%B3%E8%BF%87-html-%E8%BD%AC%E4%B9%89/","summary":"\u003cp\u003eä½¿ç”¨golangæ ‡å‡†åº“ä¸­çš„\u003ccode\u003ehtml/template\u003c/code\u003eæ—¶ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹æ¸²æŸ“æ¨¡ç‰ˆæ—¶ä¸ºäº†å®‰å…¨ç­‰åŸå› ï¼Œä¼šå°†å­—ç¬¦ä¸²ä¸­çš„éƒ¨åˆ†ç¬¦å·è¿›è¡Œè½¬ä¹‰ã€‚\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæ³¨å†Œè‡ªå®šä¹‰è½¬ä¹‰å¤„ç†å‡½æ•°\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eunescapeHTML\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003es\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nx\"\u003etemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eHTML\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003etemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHTML\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨å®šä¹‰è½¬ä¹‰å¤„ç†å‡½æ•°åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨\u003ccode\u003eFuncs()\u003c/code\u003eå°†å…¶æ³¨å†Œåˆ°æ¨¡ç‰ˆä¸­ã€‚éœ€è¦æ³¨æ„ï¼Œæ³¨å†Œè‡ªå®šä¹‰å‡½æ•°éœ€è¦åœ¨è°ƒç”¨\u003ccode\u003eParse()\u003c/code\u003eå‰è¿›è¡Œã€‚åœ¨æ³¨å†Œæ—¶æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°æ ‡è¯†ç¬¦ï¼Œå¹¶åœ¨æ¨¡ç‰ˆæ–‡æœ¬ä¸­ä½¿ç”¨ã€‚åœ¨ä¸‹é¢ä¾‹å­ä¸­æˆ‘ä»¬ä½¿ç”¨äº†åä¸º\u003ccode\u003eunescapeHTML\u003c/code\u003eçš„å‡½æ•°æ ‡è¯†ç¬¦ã€‚\u003c/p\u003e","title":"Golang template è·³è¿‡ HTML è½¬ä¹‰"},{"content":" å®‰è£… Jaeger Operator 1kubectl create namespace observability 2kubectl create -f https://github.com/jaegertracing/jaeger-operator/releases/download/v1.52.0/jaeger-operator.yaml -n observability è‹¥ rbac-proxy å®‰è£…å¤±è´¥ï¼Œåˆ™ä¿®æ”¹ kube-rbac-prox é•œåƒåœ°å€ä¸º 10.101.7.108:80/open_source/kubebuilder/kube-rbac-proxy:v0.13.0\nå®‰è£… Jaeger 1apiVersion: jaegertracing.io/v1 2kind: Jaeger 3metadata: 4 name: jaeger-prod 5 namespace: observability 6spec: 7 strategy: production 8 storage: 9 type: elasticsearch 10 esIndexCleaner: 11 enabled: true # turn the cron job deployment on and off 12 numberOfDays: 7 # number of days to wait before deleting a record 13 schedule: \u0026#34;55 23 * * *\u0026#34; # cron expression for it to run 14 options: 15 es: 16 server-urls: http://elasticsearch.szhems.svc:9200 17 index-prefix: dev 18 # tls: 19 # ca: /es/certificates/ca.crt 20 # secretName: jaeger-secret 21 # volumeMounts: 22 # - name: certificates 23 # mountPath: /es/certificates/ 24 # readOnly: true 25 # volumes: 26 # - name: certificates 27 # secret: 28 # secretName: quickstart-es-http-certs-public go-zero æ¯ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶ä¸‹æ·»åŠ Telemetryé…ç½® 1Log: 2 ServiceName: platform-api 3 Level: info 4 Stat: false 5 TimeFormat: 2006-01-02 15:04:05 å‚è€ƒèµ„æ–™ï¼š\nhttps://www.jaegertracing.io/docs/1.52/operator/#installing-the-operator-on-kubernetes ","permalink":"/tech/ops/jaeger-%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BD%BF%E7%94%A8/","summary":"\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eå®‰è£… Jaeger Operator\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003ekubectl create namespace observability\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003ekubectl create -f https://github.com/jaegertracing/jaeger-operator/releases/download/v1.52.0/jaeger-operator.yaml -n observability\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003eè‹¥ rbac-proxy å®‰è£…å¤±è´¥ï¼Œåˆ™ä¿®æ”¹ kube-rbac-prox é•œåƒåœ°å€ä¸º \u003ccode\u003e10.101.7.108:80/open_source/kubebuilder/kube-rbac-proxy:v0.13.0\u003c/code\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eå®‰è£… Jaeger\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejaegertracing.io/v1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003ekind\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eJaeger\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003emetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ejaeger-prod\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003enamespace\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eobservability\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003estrategy\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eproduction\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eelasticsearch\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eesIndexCleaner\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eenabled\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e# turn the cron job deployment on and off\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003enumberOfDays\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"m\"\u003e7\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e# number of days to wait before deleting a record\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003eschedule\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;55 23 * * *\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"c\"\u003e# cron expression for it to run\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e\u003cspan class=\"nt\"\u003ees\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eserver-urls\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ehttp://elasticsearch.szhems.svc:9200\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"nt\"\u003eindex-prefix\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003edev\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#     tls:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e#       ca: /es/certificates/ca.crt\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"c\"\u003e# secretName: jaeger-secret\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e# volumeMounts:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#   - name: certificates\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#     mountPath: /es/certificates/\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#     readOnly: true\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e# volumes:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#   - name: certificates\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#     secret:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"c\"\u003e#       secretName: quickstart-es-http-certs-public\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003e\u003cstrong\u003ego-zero æ¯ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶ä¸‹æ·»åŠ Telemetryé…ç½®\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nt\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eServiceName\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003eplatform-api\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003einfo\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eStat\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003eTimeFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"ld\"\u003e2006-01-02 15:04:05\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eå‚è€ƒèµ„æ–™ï¼š\u003c/strong\u003e\u003c/p\u003e","title":"Jaeger éƒ¨ç½²ä¸ä½¿ç”¨"},{"content":"ä½¿ç”¨ç²¾ç®€çš„åŸºç¡€é•œåƒ Alpine Alpineä¸€ä¸ªåŸºäº musl libc å’Œ busyboxã€é¢å‘å®‰å…¨çš„è½»é‡çº§ Linux å‘è¡Œç‰ˆï¼Œå‹ç¼©ä½“ç§¯åªæœ‰ 3M å·¦å³ï¼Œå¾ˆå¤šæµè¡Œçš„é•œåƒéƒ½æœ‰åŸºäº alpine çš„åˆ¶ä½œçš„åŸºç¡€é•œåƒã€‚\nscratch scratch æ˜¯ä¸€ä¸ªç©ºé•œåƒï¼Œå¦‚æœæˆ‘ä»¬çš„åº”ç”¨æ˜¯ä¸€ä¸ªä¸ä¾èµ–åŠ¨æ€é“¾æ¥åº“çš„ã€åŒ…å«æ‰€æœ‰ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ scratch ä½œä¸ºåŸºç¡€é•œåƒï¼Œæ­¤æ—¶é•œåƒçš„ä½“ç§¯å·®ä¸å¤šå°±æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½“ç§¯ã€‚\nbusybox å¦‚æœå¸Œæœ›é•œåƒé‡Œå¯ä»¥åŒ…å«ä¸€äº›å¸¸ç”¨çš„ Linux å·¥å…·ï¼Œbusybox é•œåƒæ˜¯ä¸ªä¸é”™é€‰æ‹©ï¼Œå®ƒé›†æˆäº†ä¸€ç™¾å¤šä¸ªæœ€å¸¸ç”¨ Linux å‘½ä»¤å’Œå·¥å…·çš„è½¯ä»¶å·¥å…·ç®±ï¼Œé•œåƒå‹ç¼©ä½“ç§¯åªæœ‰ä¸åˆ° 1Mï¼Œéå¸¸ä¾¿äºæ„å»ºå°é•œåƒã€‚\ndistroless distroless é•œåƒä»…åŒ…å«åº”ç”¨ç¨‹åºåŠå…¶è¿è¡Œæ—¶ä¾èµ–é¡¹ã€‚ä¸åŒ…å«åŒ…ç®¡ç†å™¨ã€shellæˆ–ä»»ä½•å…¶ä»–ç¨‹åºã€‚\nä½†å› æ­¤å¦‚æœé»‘å®¢å…¥ä¾µäº†åº”ç”¨ç¨‹åºå¹¶è·å–äº†å®¹å™¨çš„è®¿é—®æƒé™ï¼Œä¹Ÿæ— æ³•é€ æˆå¤ªå¤§çš„æŸå®³ã€‚\nç”Ÿäº§ç¯å¢ƒä¸­ä¹Ÿä¸åº”è¯¥å°† Shellé™„åŠ åˆ°å®¹å™¨ä¸­è¿›è¡Œè°ƒè¯•ï¼Œè€Œåº”ä¾é æ­£ç¡®çš„æ—¥å¿—æ”¶é›†å’Œç›‘æ§ã€‚\n1FROM node:8 as build 2 3WORKDIR /app 4COPY package.json index.js ./ 5RUN npm install 6 7FROM gcr.io/distroless/nodejs 8 9COPY --from=build /app / 10EXPOSE 3000 11CMD [\u0026#34;index.js\u0026#34;] æ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜ åœ¨ Dockerfile ä¸­ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ä¾èµ–çš„è½¯ä»¶åŒ…æ—¶ï¼Œå¾€å¾€ä¼šäº§ç”Ÿä¸€äº›ç¼“å­˜æ•°æ®ï¼Œå¯ä»¥æ¸…ç†æ‰ä»¥å‡å°‘é•œåƒä½“ç§¯ã€‚\nAlpine å¦‚æœä½¿ç”¨ alpine åŸºç¡€é•œåƒï¼Œå¯ä»¥åœ¨ç”¨ apk add å®‰è£…è½¯ä»¶åŒ…æ—¶åŠ  \u0026ndash;no-cache\n1FROM alpine:latest 2 3RUN apk add --no-cache tzdata ca-certificates Ubuntu/Debian 1FROM ubuntu:latest 2 3RUN apt update -y \u0026amp;\u0026amp; apt install -y curl 4 5RUN apt-get clean autoclean \u0026amp;\u0026amp; \\ 6 apt-get autoremove --yes \u0026amp;\u0026amp; \\ 7 rm -rf /var/lib/{apt,dpkg,cache,log}/ å¤šé˜¶æ®µæ„å»º Dockerfile æ”¯æŒå¤šé˜¶æ®µæ„å»ºï¼Œå³æœ‰å¤šä¸ªÂ FROMÂ æŒ‡ä»¤ï¼Œæœ€ç»ˆæ„å»ºå‡ºçš„é•œåƒç”±ç”±æœ€åä¸€ä¸ªÂ FROMÂ ä¹‹åçš„æŒ‡ä»¤å†³å®šï¼Œé€šå¸¸å¯ä»¥æŠŠè¿™ä¹‹å‰çš„æŒ‡ä»¤ç”¨ä½œç¼–è¯‘ï¼Œä¹‹åçš„æŒ‡ä»¤ç”¨ä½œæ‰“åŒ…ï¼Œæ‰“åŒ…é˜¶æ®µå¯ä»¥å°†ç¼–è¯‘é˜¶æ®µäº§ç”Ÿçš„æ–‡ä»¶æ‹·è´è¿‡æ¥ï¼Œè¿™æ ·å¯ä»¥å®ç°åœ¨æœ€ç»ˆé•œåƒä¸­åªä¿ç•™è¿è¡Œç¨‹åºæ‰€éœ€è¦çš„å†…å®¹ã€‚\nä»¥ä¸‹ä¾‹å­ä½¿ç”¨ Golang é™æ€ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç„¶å COPY åˆ° scratch é•œåƒä¸­ã€‚\n1FROM golang:latest AS build 2WORKDIR /workspace 3COPY . . 4# é™æ€ç¼–è¯‘äºŒè¿›åˆ¶ 5RUN CGO_ENABLED=0 go build -o app -ldflags \u0026#39;-w -extldflags \u0026#34;-static\u0026#34;\u0026#39; . 6 7FROM scratch 8# æ‹·è´äºŒè¿›åˆ¶åˆ°ç©ºé•œåƒ 9COPY --from=build /workspace/app /usr/local/bin/app 10CMD [\u0026#34;app\u0026#34;] å‚è€ƒèµ„æ–™ https://mp.weixin.qq.com/s/2kZnWXQ260bpyh148Z3W_g ","permalink":"/tech/docker/docker-%E7%B2%BE%E7%AE%80%E9%95%9C%E5%83%8F%E5%AE%9E%E8%B7%B5/","summary":"\u003ch1 id=\"ä½¿ç”¨ç²¾ç®€çš„åŸºç¡€é•œåƒ\"\u003eä½¿ç”¨ç²¾ç®€çš„åŸºç¡€é•œåƒ\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAlpine\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAlpineä¸€ä¸ªåŸºäº musl libc å’Œ busyboxã€é¢å‘å®‰å…¨çš„è½»é‡çº§ Linux å‘è¡Œç‰ˆï¼Œå‹ç¼©ä½“ç§¯åªæœ‰ 3M å·¦å³ï¼Œå¾ˆå¤šæµè¡Œçš„é•œåƒéƒ½æœ‰åŸºäº alpine çš„åˆ¶ä½œçš„åŸºç¡€é•œåƒã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003escratch\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003escratch æ˜¯ä¸€ä¸ªç©ºé•œåƒï¼Œå¦‚æœæˆ‘ä»¬çš„åº”ç”¨æ˜¯ä¸€ä¸ªä¸ä¾èµ–åŠ¨æ€é“¾æ¥åº“çš„ã€åŒ…å«æ‰€æœ‰ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ scratch ä½œä¸ºåŸºç¡€é•œåƒï¼Œæ­¤æ—¶é•œåƒçš„ä½“ç§¯å·®ä¸å¤šå°±æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½“ç§¯ã€‚\u003c/p\u003e","title":"Docker ç²¾ç®€é•œåƒå®è·µ"},{"content":"æ³¢ç‰¹ç‡ Baud Rate æ³¢ç‰¹ç‡æ˜¯å‘é€æ•°æ®ä½çš„é€Ÿåº¦ã€‚\nPLC è®¾å¤‡ä¸­ä½¿ç”¨çš„æ³¢ç‰¹ç‡çš„å¸¸è§å€¼åŒ…æ‹¬ï¼š1200ã€9600ã€19200ã€38400ã€‚\næ•°æ®ä½ Data Bits æ•°æ®ä½æ˜¯æ¯å¸§ä¸­æ•°æ®çš„ä½æ•°ã€‚\nPLC è®¾å¤‡ä½¿ç”¨çš„å¸¸è§å€¼åŒ…æ‹¬ 7 æˆ– 8 ä¸ªæ•°æ®ä½ã€‚\næ‰€æœ‰äºŒè¿›åˆ¶åè®®éƒ½ä½¿ç”¨ 8 ä¸ªæ•°æ®ä½ï¼›è€ŒASCII æ•°æ®å¯ä»¥ä½¿ç”¨ 7 æˆ– 8 ä½å‘é€ï¼Œä¾‹å¦‚ Modbus ASCIIã€‚\nåœæ­¢ä½ Stop Bits åœæ­¢ä½æ˜¯ç”¨äºæ ‡è®°å¸§ç»“æŸçš„ä½æ•°ã€‚ PLC è®¾å¤‡ä½¿ç”¨çš„å¸¸è§å€¼ä¸º 1 æˆ– 2 ä¸ªåœæ­¢ä½ã€‚\nå¥‡å¶æ ¡éªŒä½ Parity å¥‡å¶æ ¡éªŒä½æä¾›é”™è¯¯æ£€æµ‹åŠŸèƒ½ã€‚\nParity Description None No parity bit is added to the data. Even The parity bit is set to space (0) if the total number of data bits in the mark (1) state is even. Odd The parity bit is set to space (0) if the total number of data bits in the mark (1) state is odd. Mark The parity bit is set to mark (1). Space The parity bit is set to space (0). å…¶ä¸­ï¼Œåªæœ‰å¥‡å¶æ ¡éªŒå…·æœ‰ä¸€å®šçš„é”™è¯¯æ£€æµ‹èƒ½åŠ›ã€‚\nç”µä¿¡å· Electrical Signals æœ‰è®¸å¤šä¸²å£ç±»å‹å®šä¹‰äº†è¡¨ç¤ºæ ‡è®° (1) ä½æˆ–ç©ºæ ¼ (0) ä½çš„ç”µä¿¡å·ï¼š\nStandard Mode Mark Space RS-232 Single Ended -3v to -15v +3v to +15v RS-422 Differential 0v to -6v 0v to +6v RS-485 Differential -0.2v to -6v +0.2v to +6v å•ç«¯æ¨¡å¼ä½¿ç”¨å•çº¿ï¼Œæµ‹é‡ç›¸å¯¹äºåœ°çš„ç”µå‹ã€‚å·®åˆ†æ¨¡å¼ä½¿ç”¨ä¸€å¯¹ç”µçº¿ï¼Œå…¶ä¸­ç”µå‹æ˜¯ä¸¤æ¡ç”µçº¿ä¹‹é—´çš„å·®å€¼ã€‚\nå•ç«¯æ¨¡å¼å¯ç”¨äºé•¿è¾¾ 15 ç±³çš„çŸ­è·ç¦»è¿è¡Œã€‚å·®åˆ†æ¨¡å¼å·¥ä½œè·ç¦»å¯è¾¾ 1500 ç±³ã€‚\nå‚è€ƒèµ„æ–™ https://www.fernhillsoftware.com/help/drivers/serial-communication/index.html#:~:text=Baud%20Rate%20%2D%20the%20speed%20that,the%20end%20of%20a%20frame ","permalink":"/tech/iot/%E5%B8%B8%E7%94%A8%E4%B8%B2%E5%8F%A3%E9%80%9A%E8%AE%AF%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90/","summary":"\u003ch1 id=\"æ³¢ç‰¹ç‡-baud-rate\"\u003eæ³¢ç‰¹ç‡ Baud Rate\u003c/h1\u003e\n\u003cp\u003eæ³¢ç‰¹ç‡æ˜¯å‘é€æ•°æ®ä½çš„é€Ÿåº¦ã€‚\u003c/p\u003e\n\u003cp\u003ePLC è®¾å¤‡ä¸­ä½¿ç”¨çš„æ³¢ç‰¹ç‡çš„å¸¸è§å€¼åŒ…æ‹¬ï¼š1200ã€9600ã€19200ã€38400ã€‚\u003c/p\u003e\n\u003ch1 id=\"æ•°æ®ä½-data-bits\"\u003eæ•°æ®ä½ Data Bits\u003c/h1\u003e\n\u003cp\u003eæ•°æ®ä½æ˜¯æ¯å¸§ä¸­æ•°æ®çš„ä½æ•°ã€‚\u003c/p\u003e\n\u003cp\u003ePLC è®¾å¤‡ä½¿ç”¨çš„å¸¸è§å€¼åŒ…æ‹¬ 7 æˆ– 8 ä¸ªæ•°æ®ä½ã€‚\u003c/p\u003e","title":"å¸¸ç”¨ä¸²å£é€šè®¯å‚æ•°è§£æ"},{"content":"é—®é¢˜æè¿° æœ‰ IP åœ°å€ä¸º 172.24.x.xx/24 çš„æœåŠ¡å™¨æ— æ³• ping é€šï¼ŒåŸå› ä¸º docker é»˜è®¤ç½‘æ®µ 172.17.0.0/16 å ç”¨äº†æœåŠ¡å™¨æ‰€åœ¨ç½‘æ®µï¼Œå¯¼è‡´å¤–éƒ¨è¯·æ±‚æ— æ³•è®¿é—®åˆ°çœŸå®æœåŠ¡å™¨ã€‚\nè§£å†³æ–¹æ¡ˆ æŸ¥çœ‹è·¯ç”±ä¿¡æ¯ 1ifconfig docker0 2 3docker0: flags=4099\u0026lt;UP,BROADCAST,MULTICAST\u0026gt; mtu 1500 4 inet 172.17.0.1 netmask 255.255.0.0 broadcast 172.17.255.255 5 ether 02:42:90:e0:c1:a0 txqueuelen 0 (Ethernet) 6 RX packets 0 bytes 0 (0.0 B) 7 RX errors 0 dropped 0 overruns 0 frame 0 8 TX packets 0 bytes 0 (0.0 B) 9 TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 å¯ä»¥çœ‹åˆ°ï¼Œdocker0 å ç”¨çš„ç½‘æ®µä¸º 172.17.0.1/16\nä¿®æ”¹ docker é»˜è®¤ç½‘æ®µ 1# åœæ­¢ docker æœåŠ¡ 2systemctl stop docker 3 4# åˆ é™¤åŸæœ‰ç½‘æ¡¥ 5ip link del docker0 down 6 7# ä¿®æ”¹ docker ç½‘æ®µ 8vim /etc/docker/daemon.json 9\u0026#34;bip\u0026#34;:\u0026#34;192.168.100.1/24\u0026#34; 10 11# é‡å¯ docker æœåŠ¡ 12systemctl restart docker æ­¤æ—¶å†æ‰§è¡Œ ifconfig docker0 å¯ä»¥çœ‹åˆ° docker çš„ç½‘æ®µå·²å˜æ›´ã€‚\nå‚è€ƒèµ„æ–™ï¼š\nhttps://cloud.tencent.com/developer/article/2242559 ","permalink":"/tech/docker/docker-%E7%BD%91%E6%AE%B5%E4%B8%8E%E4%B8%BB%E6%9C%BA%E7%BD%91%E6%AE%B5%E5%86%B2%E7%AA%81%E5%AF%BC%E8%87%B4%E7%BD%91%E7%BB%9C%E4%B8%AD%E6%96%AD/","summary":"\u003ch2 id=\"é—®é¢˜æè¿°\"\u003eé—®é¢˜æè¿°\u003c/h2\u003e\n\u003cp\u003eæœ‰ IP åœ°å€ä¸º \u003ccode\u003e172.24.x.xx/24\u003c/code\u003e çš„æœåŠ¡å™¨æ— æ³• ping é€šï¼ŒåŸå› ä¸º docker é»˜è®¤ç½‘æ®µ \u003ccode\u003e172.17.0.0/16\u003c/code\u003e å ç”¨äº†æœåŠ¡å™¨æ‰€åœ¨ç½‘æ®µï¼Œå¯¼è‡´å¤–éƒ¨è¯·æ±‚æ— æ³•è®¿é—®åˆ°çœŸå®æœåŠ¡å™¨ã€‚\u003c/p\u003e\n\u003ch2 id=\"è§£å†³æ–¹æ¡ˆ\"\u003eè§£å†³æ–¹æ¡ˆ\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæŸ¥çœ‹è·¯ç”±ä¿¡æ¯\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eifconfig docker0\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003edocker0: \u003cspan class=\"nv\"\u003eflags\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4099\u0026lt;UP,BROADCAST,MULTICAST\u0026gt;  mtu \u003cspan class=\"m\"\u003e1500\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e        ether 02:42:90:e0:c1:a0  txqueuelen \u003cspan class=\"m\"\u003e0\u003c/span\u003e  \u003cspan class=\"o\"\u003e(\u003c/span\u003eEthernet\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e        RX packets \u003cspan class=\"m\"\u003e0\u003c/span\u003e  bytes \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e0.0 B\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e        RX errors \u003cspan class=\"m\"\u003e0\u003c/span\u003e  dropped \u003cspan class=\"m\"\u003e0\u003c/span\u003e  overruns \u003cspan class=\"m\"\u003e0\u003c/span\u003e  frame \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e        TX packets \u003cspan class=\"m\"\u003e0\u003c/span\u003e  bytes \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e0.0 B\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e9\u003c/span\u003e\u003cspan class=\"cl\"\u003e        TX errors \u003cspan class=\"m\"\u003e0\u003c/span\u003e  dropped \u003cspan class=\"m\"\u003e0\u003c/span\u003e overruns \u003cspan class=\"m\"\u003e0\u003c/span\u003e  carrier \u003cspan class=\"m\"\u003e0\u003c/span\u003e  collisions \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå¯ä»¥çœ‹åˆ°ï¼Œdocker0 å ç”¨çš„ç½‘æ®µä¸º 172.17.0.1/16\u003c/p\u003e","title":"Docker ç½‘æ®µä¸ä¸»æœºç½‘æ®µå†²çªå¯¼è‡´ç½‘ç»œä¸­æ–­"},{"content":" æŸ¥çœ‹ç½‘å¡é…ç½® 1ip a ä¿®æ”¹æˆ–æ·»åŠ  DNS æœåŠ¡å™¨ 1vim /etc/sysconfig/network-scripts/ifcfg-eth0 1# æ·»åŠ è§„åˆ™ 2DNS1=114.114.114.114 3DNS2=8.8.8.8 é‡å¯ç½‘ç»œä½¿é…ç½®ç”Ÿæ•ˆ 1service network restart ","permalink":"/tech/linux/%E4%BF%AE%E6%94%B9-linux-dns-%E9%85%8D%E7%BD%AE/","summary":"\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eæŸ¥çœ‹ç½‘å¡é…ç½®\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eip a\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eä¿®æ”¹æˆ–æ·»åŠ  DNS æœåŠ¡å™¨\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003evim /etc/sysconfig/network-scripts/ifcfg-eth0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# æ·»åŠ è§„åˆ™  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDNS1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e114.114.114.114  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003eDNS2\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e8.8.8.8\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003e\u003cstrong\u003eé‡å¯ç½‘ç»œä½¿é…ç½®ç”Ÿæ•ˆ\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eservice network restart \n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"ä¿®æ”¹ Linux DNS é…ç½®"},{"content":"æ“ä½œç³»ç»Ÿç‰ˆæœ¬ AlmaLinux 9.3\nå®‰è£… dnf-utils 1sudo dnf install -y dnf-utils æ·»åŠ  Docker CE å­˜å‚¨åº“ 1sudo dnf config-manager --add-repo https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo 1yum-config-manager --add-repo https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo æ·»åŠ è¿‡åï¼Œæ‰§è¡Œåˆ—å‡º Alma Linuxä¸Šå¯ç”¨å­˜å‚¨åº“çš„åˆ—è¡¨\n1sudo dnf repolist æŠŠè½¯ä»¶ä»“åº“åœ°å€æ›¿æ¢ä¸ºé•œåƒç«™ 1sed -i \u0026#39;s+https://download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+\u0026#39; /etc/yum.repos.d/docker-ce.repo å®‰è£… Docker CE 1sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin å¯åŠ¨å¹¶å¯ç”¨ Docker 1sudo systemctl start docker 2sudo systemctl enable docker é…ç½®å›½å†…é•œåƒæº 1{ 2 \u0026#34;registry-mirrors\u0026#34;: [ 3\t\u0026#34;https://docker.1panel.live\u0026#34; 4 ] 5} 1sudo systemctl daemon-reload 2sudo systemctl restart docker ","permalink":"/tech/docker/docker-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/","summary":"\u003cp\u003eæ“ä½œç³»ç»Ÿç‰ˆæœ¬ AlmaLinux 9.3\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eå®‰è£… \u003ccode\u003ednf-utils\u003c/code\u003e\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo dnf install -y dnf-utils\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eæ·»åŠ  Docker CE å­˜å‚¨åº“\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo dnf config-manager --add-repo https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003eyum-config-manager --add-repo https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ·»åŠ è¿‡åï¼Œæ‰§è¡Œåˆ—å‡º Alma Linuxä¸Šå¯ç”¨å­˜å‚¨åº“çš„åˆ—è¡¨\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo dnf repolist\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003e\u003cstrong\u003eæŠŠè½¯ä»¶ä»“åº“åœ°å€æ›¿æ¢ä¸ºé•œåƒç«™\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esed -i \u003cspan class=\"s1\"\u003e\u0026#39;s+https://download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+\u0026#39;\u003c/span\u003e /etc/yum.repos.d/docker-ce.repo\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"4\"\u003e\n\u003cli\u003e\u003cstrong\u003eå®‰è£… Docker CE\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"5\"\u003e\n\u003cli\u003e\u003cstrong\u003eå¯åŠ¨å¹¶å¯ç”¨ Docker\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo systemctl start docker\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo systemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e docker\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"6\"\u003e\n\u003cli\u003e\u003cstrong\u003eé…ç½®å›½å†…é•œåƒæº\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"s2\"\u003e\u0026#34;registry-mirrors\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t    \u003cspan class=\"s2\"\u003e\u0026#34;https://docker.1panel.live\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo systemctl daemon-reload\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003esudo systemctl restart docker\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","title":"Docker å®‰è£…ä¸é…ç½®"},{"content":"å¹¶å‘è¿‡é«˜å¯¼è‡´ç¨‹åºå´©æºƒ 1func main() { 2\tvar wg sync.WaitGroup 3\tfor i := 0; i \u0026lt; math.MaxInt32; i++ { 4\twg.Add(1) 5\tgo func(i int) { 6\tdefer wg.Done() 7\tfmt.Println(i) 8\ttime.Sleep(time.Second) 9\t}(i) 10\t} 11\twg.Wait() 12} 1goroutine 1489841 [running]: 2internal/poll.(*fdMutex).rwlock(0xc000130060, 0x0?) 3 /usr/local/go/src/internal/poll/fd_mutex.go:147 +0x11b 4internal/poll.(*FD).writeLock(...) 5 /usr/local/go/src/internal/poll/fd_mutex.go:239 6internal/poll.(*FD).Write(0xc000130060, {0xc0ca328a90, 0x8, 0x8}) 7 /usr/local/go/src/internal/poll/fd_unix.go:370 +0x72 8os.(*File).write(...) 9 /usr/local/go/src/os/file_posix.go:48 10os.(*File).Write(0xc00012e008, {0xc0ca328a90?, 0x8, 0xc0cd90b750?}) 11 /usr/local/go/src/os/file.go:175 +0x65 12fmt.Fprintln({0x4b7ff8, 0xc00012e008}, {0xc0cd90b790, 0x1, 0x1}) 13 /usr/local/go/src/fmt/print.go:305 +0x75 14fmt.Println(...) 15 /usr/local/go/src/fmt/print.go:314 16main.main.func1(0x0?) 17 /root/zhuangqf/Blank/cmd/main.go:16 +0x8f 18created by main.main 19 /root/zhuangqf/Blank/cmd/main.go:14 +0x3c 20panic: too many concurrent operations on a single file or socket (max 1048575) 1panic: too many concurrent operations on a single file or socket (max 1048575) 1 ä¸ª file/socket çš„ä¸Šå¹¶å‘æ“ä½œä¸ªæ•°è¶…è¿‡äº†ä¸Šé™ï¼ˆ1048575ï¼‰ï¼Œç®€è€Œè¨€ä¹‹ï¼Œç³»ç»Ÿçš„èµ„æºè¢«è€—å°½äº†ã€‚0xFFFFF = 1048575\nå¦‚æœå°†Â fmt.PrintfÂ è¿™è¡Œä»£ç å»æ‰ï¼Œé‚£ç¨‹åºå¾ˆå¯èƒ½ä¼šå› ä¸ºå†…å­˜ä¸è¶³è€Œå´©æºƒã€‚æ¯ä¸ªåç¨‹è‡³å°‘éœ€è¦æ¶ˆè€— 2KB çš„ç©ºé—´ï¼Œè®¾è®¡ç®—æœºçš„å†…å­˜æ˜¯ 2GBï¼Œé‚£ä¹ˆè‡³å¤šå…è®¸ 2GB/2KB = 1M ä¸ªåç¨‹åŒæ—¶å­˜åœ¨ã€‚é‚£å¦‚æœåç¨‹ä¸­è¿˜å­˜åœ¨ç€å…¶ä»–éœ€è¦åˆ†é…å†…å­˜çš„æ“ä½œï¼Œé‚£ä¹ˆå…è®¸å¹¶å‘æ‰§è¡Œçš„åç¨‹å°†ä¼šæ•°é‡çº§åœ°å‡å°‘ã€‚\nè§£å†³æ–¹æ¡ˆ æ¨èè§£å†³æ–¹æ¡ˆï¼šä»£ç ä¸»åŠ¨é™åˆ¶å¹¶å‘çš„åç¨‹æ•°é‡ã€‚\nchannel ä½¿ç”¨ channel çš„ç¼“å†²åŒºå¤§å°ä½œä¸ºåç¨‹å¹¶å‘ä¸Šé™\n1package main 2 3import ( 4\t\u0026#34;log\u0026#34; 5\t\u0026#34;sync\u0026#34; 6\t\u0026#34;time\u0026#34; 7) 8 9func main() { 10\tvar wg sync.WaitGroup 11\tch := make(chan struct{}, 10) 12 13\tfor i := 0; i \u0026lt; 100; i++ { 14\twg.Add(1) 15\tch \u0026lt;- struct{}{} 16\tgo func(i int) { 17\tdefer wg.Done() 18\tlog.Println(i) 19\ttime.Sleep(time.Second * 2) 20\t\u0026lt;-ch 21\t}(i) 22\t} 23 24\twg.Wait() 25} å…¶ä¸­ï¼Œ\nmake(chan struct{}, 10)Â åˆ›å»ºç¼“å†²åŒºå¤§å°ä¸º 3 çš„ channelï¼Œåœ¨æ²¡æœ‰è¢«æ¥æ”¶çš„æƒ…å†µä¸‹ï¼Œè‡³å¤šå‘é€ 10 ä¸ªæ¶ˆæ¯åˆ™è¢«é˜»å¡ã€‚ å¼€å¯åç¨‹å‰ï¼Œè°ƒç”¨Â ch \u0026lt;- struct{}{}ï¼Œè‹¥ç¼“å­˜åŒºæ»¡ï¼Œåˆ™é˜»å¡ã€‚ åç¨‹ä»»åŠ¡ç»“æŸï¼Œè°ƒç”¨Â \u0026lt;-chÂ é‡Šæ”¾ç¼“å†²åŒºã€‚ sync.WaitGroupÂ å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä¾‹å¦‚ http æœåŠ¡ï¼Œæ¯ä¸ªè¯·æ±‚å¤©ç„¶æ˜¯å¹¶å‘çš„ï¼Œæ­¤æ—¶ä½¿ç”¨ channel æ§åˆ¶å¹¶å‘å¤„ç†çš„ä»»åŠ¡æ•°é‡ï¼Œå°±ä¸éœ€è¦Â sync.WaitGroupã€‚ åç¨‹æ±  https://github.com/panjf2000/ants\næ ·ä¾‹:\n1package main 2 3import ( 4\t\u0026#34;fmt\u0026#34; 5\t\u0026#34;sync\u0026#34; 6\t\u0026#34;sync/atomic\u0026#34; 7 8\t\u0026#34;github.com/panjf2000/ants/v2\u0026#34; 9) 10 11var sum int32 12 13func myFunc(i interface{}) { 14\tn := i.(int32) 15\tatomic.AddInt32(\u0026amp;sum, n) 16\tfmt.Printf(\u0026#34;run with %d\\n\u0026#34;, n) 17} 18 19func main() { 20\tdefer ants.Release() 21 22\trunTimes := 1000 23\tvar wg sync.WaitGroup 24\t25\t// Use the pool with a function, 26\t// set 10 to the capacity of goroutine pool and 1 second for expired duration. 27\tp, _ := ants.NewPoolWithFunc(10, func(i interface{}) { 28\tmyFunc(i) 29\twg.Done() 30\t}) 31\tdefer p.Release() 32\t// Submit tasks one by one. 33\tfor i := 0; i \u0026lt; runTimes; i++ { 34\twg.Add(1) 35\t_ = p.Invoke(int32(i)) 36\t} 37\twg.Wait() 38\tfmt.Printf(\u0026#34;running goroutines: %d\\n\u0026#34;, p.Running()) 39\tfmt.Printf(\u0026#34;finish all tasks, result is %d\\n\u0026#34;, sum) 40\tif sum != 499500 { 41\tpanic(\u0026#34;the final result is wrong!!!\u0026#34;) 42\t} 43 44} ä¸Šè¿°ä»£ç è‡ªå®šä¹‰äº†ä¸€ä¸ª size ä¸º 10 çš„çº¿ç¨‹æ± ï¼Œæˆ‘ä»¬åªéœ€è¦å¾€çº¿ç¨‹æ± æäº¤ä»»åŠ¡å°±å¯ä»¥äº†ã€‚\n","permalink":"/tech/golang/golang-%E6%8E%A7%E5%88%B6%E5%8D%8F%E7%A8%8B%E5%B9%B6%E5%8F%91%E6%95%B0%E9%87%8F/","summary":"\u003ch1 id=\"å¹¶å‘è¿‡é«˜å¯¼è‡´ç¨‹åºå´©æºƒ\"\u003eå¹¶å‘è¿‡é«˜å¯¼è‡´ç¨‹åºå´©æºƒ\u003c/h1\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003emath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMaxInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\t\u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSecond\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"p\"\u003e}(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003egoroutine 1489841 [running]:\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003einternal/poll.(*fdMutex).rwlock(0xc000130060, 0x0?)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /usr/local/go/src/internal/poll/fd_mutex.go:147 +0x11b\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003einternal/poll.(*FD).writeLock(...)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /usr/local/go/src/internal/poll/fd_mutex.go:239\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003einternal/poll.(*FD).Write(0xc000130060, {0xc0ca328a90, 0x8, 0x8})\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /usr/local/go/src/internal/poll/fd_unix.go:370 +0x72\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003eos.(*File).write(...)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /usr/local/go/src/os/file_posix.go:48\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003eos.(*File).Write(0xc00012e008, {0xc0ca328a90?, 0x8, 0xc0cd90b750?})\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /usr/local/go/src/os/file.go:175 +0x65\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003efmt.Fprintln({0x4b7ff8, 0xc00012e008}, {0xc0cd90b790, 0x1, 0x1})\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /usr/local/go/src/fmt/print.go:305 +0x75\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003efmt.Println(...)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /usr/local/go/src/fmt/print.go:314\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003emain.main.func1(0x0?)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /root/zhuangqf/Blank/cmd/main.go:16 +0x8f\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003ecreated by main.main\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e        /root/zhuangqf/Blank/cmd/main.go:14 +0x3c\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003epanic: too many concurrent operations on a single file or socket (max 1048575)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003epanic: too many concurrent operations on a single file or socket (max 1048575)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e1 ä¸ª file/socket çš„ä¸Šå¹¶å‘æ“ä½œä¸ªæ•°è¶…è¿‡äº†ä¸Šé™ï¼ˆ1048575ï¼‰ï¼Œç®€è€Œè¨€ä¹‹ï¼Œç³»ç»Ÿçš„èµ„æºè¢«è€—å°½äº†ã€‚0xFFFFF = 1048575\u003c/p\u003e","title":"Golang æ§åˆ¶åç¨‹å¹¶å‘æ•°é‡"},{"content":"1. future/promise 1.1 å•å‘æ¥æ”¶ Channel ä½œä¸ºå‡½æ•°è¿”å› sumSquareså‡½æ•°è°ƒç”¨çš„ä¸¤ä¸ªå®å‚è¯·æ±‚å¹¶å‘è¿›è¡Œã€‚æ¯ä¸ªé€šé“è¯»å–æ“ä½œå°†é˜»å¡åˆ°è¯·æ±‚è¿”å›ç»“æœä¸ºæ­¢ã€‚\n1func longTimeRequest() \u0026lt;-chan int64 { 2\tr := make(chan int64) 3 4\tgo func() { 5\ttime.Sleep(time.Second * 3) // æ¨¡æ‹Ÿä¸€ä¸ªå·¥ä½œè´Ÿè½½ 6\tr \u0026lt;- rand.Int63n(100) 7\t}() 8 9\treturn r 10} 11 12func sumSquares(a, b int64) int64 { 13\treturn a*a + b*b 14} 15 16func main() { 17 18\ta, b := longTimeRequest(), longTimeRequest() 19\tfmt.Println(sumSquares(\u0026lt;-a, \u0026lt;-b)) 20} 1.2 å•å‘å‘é€ Channel ä½œä¸ºå‡½æ•°å®å‚ sumSquareså‡½æ•°è°ƒç”¨çš„ä¸¤ä¸ªå®å‚çš„è¯·æ±‚ä¹Ÿæ˜¯å¹¶å‘è¿›è¡Œçš„ã€‚å’Œä¸Šä¾‹ä¸åŒçš„æ˜¯longTimeRequestå‡½æ•°æ¥æ”¶ä¸€ä¸ªå•å‘å‘é€é€šé“ç±»å‹å‚æ•°è€Œä¸æ˜¯è¿”å›ä¸€ä¸ªå•å‘æ¥æ”¶é€šé“ç»“æœã€‚\n1func longTimeRequest(r chan\u0026lt;- int64) { 2\ttime.Sleep(time.Second * 3) // æ¨¡æ‹Ÿä¸€ä¸ªå·¥ä½œè´Ÿè½½ 3\tr \u0026lt;- rand.Int63n(100) 4} 5 6func sumSquares(a, b int64) int64 { 7\treturn a*a + b*b 8} 9 10func main() { 11 12\tra, rb := make(chan int64), make(chan int64) 13\tgo longTimeRequest(ra) 14\tgo longTimeRequest(rb) 15 16\tfmt.Println(sumSquares(\u0026lt;-ra, \u0026lt;-rb)) 17} ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åªä½¿ç”¨ä¸€ä¸ªé€šé“æ¥æ¥æ”¶å›åº”ç»“æœï¼Œå› ä¸ºä¸¤ä¸ªå‚æ•°çš„ä½œç”¨æ˜¯å¯¹ç­‰çš„ã€‚\n1... 2\tresults := make(chan int32, 2) // ç¼“å†²ä¸å¦ä¸é‡è¦ 3\tgo longTimeRequest(results) 4\tgo longTimeRequest(results) 5 6\tfmt.Println(sumSquares(\u0026lt;-results, \u0026lt;-results)) 7} 1.3 é‡‡ç”¨æœ€å¿«å›åº” æœ¬ä¾‹æ˜¯ä¸Šä¾‹ä¸­åªä½¿ç”¨ä¸€ä¸ªé€šé“å˜ç§çš„å¢å¼ºã€‚\næœ‰æ—¶å€™ï¼Œä¸€ä»½æ•°æ®å¯èƒ½åŒæ—¶ä»å¤šä¸ªæ•°æ®æºè·å–ï¼Œè¿™äº›æ•°æ®æºå°†è¿”å›ç›¸åŒçš„æ•°æ®ï¼Œå› ä¸ºå„ç§å› ç´ ï¼Œè¿™äº›æ•°æ®æºçš„å›åº”é€Ÿåº¦å‚å·®ä¸ä¸€ï¼Œç”šè‡³æŸä¸ªç‰¹å®šæ•°æ®æºçš„å¤šæ¬¡å›åº”é€Ÿåº¦ä¹‹é—´ä¹Ÿå¯èƒ½ç›¸å·®å¾ˆå¤§ã€‚\nåŒæ—¶ä»å¤šä¸ªæ•°æ®æºè·å–ä¸€ä»½ç›¸åŒçš„æ•°æ®å¯ä»¥æœ‰æ•ˆä¿éšœä½å»¶è¿Ÿã€‚æˆ‘ä»¬åªéœ€é‡‡ç”¨æœ€å¿«çš„å›åº”å¹¶èˆå¼ƒå…¶å®ƒè¾ƒæ…¢å›åº”ã€‚\nè‹¥æœ‰ N ä¸ªæ•°æ®æºï¼Œä¸ºäº†é˜²æ­¢è¢«èˆå¼ƒçš„å›åº”å¯¹åº”çš„åç¨‹æ°¸ä¹…é˜»å¡ï¼Œåˆ™ä¼ è¾“æ•°æ®ç”¨çš„é€šé“å¿…é¡»ä¸ºä¸€ä¸ªå®¹é‡è‡³å°‘ä¸º N-1 çš„ç¼“å†²é€šé“ã€‚\n1func source(c chan\u0026lt;- int32) { 2\tra, rb := rand.Int31(), rand.Intn(3)+1 3\t// éšæœºç¡çœ 1-3ç§’ 4\ttime.Sleep(time.Duration(rb) * time.Second) 5\tc \u0026lt;- ra 6} 7 8func main() { 9\tstartTime := time.Now() 10\tc := make(chan int32, 5) // å¿…é¡»ç”¨ä¸€ä¸ªç¼“å†²é€šé“ 11\tfor i := 0; i \u0026lt; cap(c); i++ { 12\tgo source(c) 13\t} 14\trnd := \u0026lt;-c // åªæœ‰ç¬¬ä¸€ä¸ªå›åº”è¢«ä½¿ç”¨äº† 15\tfmt.Println(time.Since(startTime)) 16\tfmt.Println(rnd) 17\t// 1.000202388s 18\t// 839171462 19} 2. é€šçŸ¥ é€šçŸ¥ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„è¯·æ±‚/å›åº”ç”¨ä¾‹ã€‚\nåœ¨ä¸€ä¸ªé€šçŸ¥ç”¨ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸å…³å¿ƒå›åº”çš„å€¼ï¼Œæˆ‘ä»¬åªå…³å¿ƒæ˜¯å¦å›åº”ã€‚å› æ­¤ï¼Œç©ºç»“æ„ä½“ç±»å‹ struct{} å¸¸è¢«åšä¸ºé€šé“çš„å…ƒç´ ç±»å‹ï¼Œå› ä¸ºç©ºç»“æ„ä½“ç±»å‹çš„å°ºå¯¸ä¸ºé›¶ï¼Œæœ‰æ•ˆèŠ‚çœå†…å­˜ã€‚\n2.1 å•å¯¹å•é€šçŸ¥ å¦‚æœä¸€ä¸ªé€šé“ä¸­æ— å€¼å¯æ¥æ”¶ï¼Œåˆ™æ­¤é€šé“ä¸Šçš„ä¸‹ä¸€ä¸ªæ¥æ”¶æ“ä½œå°†é˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ªåç¨‹å‘é€å€¼åˆ°æ­¤é€šé“ä¸ºæ­¢ã€‚\næ‰€ä»¥ï¼Œä¸€ä¸ªåç¨‹å¯ä»¥å‘æ­¤é€šé“å‘é€ä¸€ä¸ªå€¼æ¥é€šçŸ¥å¦ä¸€ä¸ªç­‰å¾…ç€ä»æ­¤é€šé“æ¥æ”¶æ•°æ®çš„åç¨‹ã€‚\nåœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šé“doneè¢«ç”¨æ¥åšä¸ºä¸€ä¸ªä¿¡å·é€šé“æ¥å®ç°å•å¯¹å•é€šçŸ¥ã€‚\n1func main() { 2\tvalues := make([]byte, 32*1024*1024) 3\tif _, err := rand.Read(values); err != nil { 4\tfmt.Println(err) 5\tos.Exit(1) 6\t} 7 8\tdone := make(chan struct{}) // ä¹Ÿå¯ä»¥æ˜¯ç¼“å†²çš„ 9 10\t// æ’åºåç¨‹ 11\tgo func() { 12\tsort.Slice(values, func(i, j int) bool { 13\treturn values[i] \u0026lt; values[j] 14\t}) 15\tdone \u0026lt;- struct{}{} // é€šçŸ¥æ’åºå·²å®Œæˆ 16\t}() 17 18\t// å¹¶å‘åœ°åšä¸€äº›å…¶å®ƒäº‹æƒ…... 19 20\t\u0026lt;-done // ç­‰å¾…é€šçŸ¥ 21\tfmt.Println(values[0], values[len(values)-1]) 22} 2.2 å¤šå¯¹å•é€šçŸ¥ åœ¨å®è·µä¸­ï¼Œå¸¸ä½¿ç”¨ sync.WaitGroup æ¥å®ç°å¤šå¯¹å•é€šçŸ¥\n2.3 å•å¯¹å¤š/å¤šå¯¹å¤šé€šçŸ¥ ä»ä¸€ä¸ªå·²å…³é—­çš„é€šé“å¯ä»¥æ¥æ”¶åˆ°æ— ç©·ä¸ªå€¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œæ¥ä½¿ç”¨å…³é—­ä¸€ä¸ªé€šé“çš„æ–¹å¼å®ç°å•å¯¹å¤šé€šçŸ¥ç¾¤å‘é€šçŸ¥ã€‚\nä»¥ä¸‹ä»£ç å±•ç¤ºäº†å¤šå¯¹å¤šå’Œå•å¯¹å¤šçš„é€šçŸ¥ã€‚\n1 2var wg sync.WaitGroup 3 4func worker(id int, ready \u0026lt;-chan struct{}) { 5\t\u0026lt;-ready // é˜»å¡åœ¨æ­¤ï¼Œç­‰å¾…é€šçŸ¥ 6\tlog.Print(\u0026#34;Worker#\u0026#34;, id, \u0026#34;å¼€å§‹å·¥ä½œ\u0026#34;) 7\ttime.Sleep(time.Second * time.Duration(id+1)) 8\tlog.Print(\u0026#34;Worker#\u0026#34;, id, \u0026#34;å·¥ä½œå®Œæˆ\u0026#34;) 9\twg.Done() 10} 11 12func main() { 13\tlog.SetFlags(0) 14 15\tready := make(chan struct{}) 16\tfor i := 0; i \u0026lt;= 2; i++ { 17\twg.Add(1) 18\tgo worker(i, ready) 19\t} 20 21\t// æ¨¡æ‹Ÿåˆå§‹åŒ–è¿‡ç¨‹ 22\ttime.Sleep(time.Second * 3) 23 24\t// å•å¯¹å¤šé€šçŸ¥ 25\tclose(ready) 26 27\t// ç­‰å¾…è¢«å¤šå¯¹å•é€šçŸ¥ 28\twg.Wait() 29} 3. é™åˆ¶åç¨‹å¹¶å‘æ•°é‡ 1func main() { 2\tvar wg sync.WaitGroup 3\tch := make(chan struct{}, 10) 4 5\tfor i := 0; i \u0026lt; 100; i++ { 6\twg.Add(1) 7\tch \u0026lt;- struct{}{} 8\tgo func(i int) { 9\tdefer wg.Done() 10\tlog.Println(i) 11\ttime.Sleep(time.Second * 2) 12\t\u0026lt;-ch 13\t}(i) 14\t} 15 16\twg.Wait() 17} 4. ä½¿ç”¨ Channel ä¼ é€ Channel ä¸€ä¸ªé€šé“ç±»å‹çš„å…ƒç´ ç±»å‹å¯ä»¥æ˜¯å¦ä¸€ä¸ªé€šé“ç±»å‹ã€‚\nåœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œ å•å‘å‘é€é€šé“ç±»å‹chan\u0026lt;- intæ˜¯å¦ä¸€ä¸ªé€šé“ç±»å‹chan chan\u0026lt;- intçš„å…ƒç´ ç±»å‹ã€‚\n1var counter = func(n int) chan\u0026lt;- chan\u0026lt;- int { 2\trequests := make(chan chan\u0026lt;- int) 3\tgo func() { 4\tfor request := range requests { 5\tif request == nil { 6\tn++ // é€’å¢è®¡æ•° 7\t} else { 8\trequest \u0026lt;- n // è¿”å›å½“å‰è®¡æ•° 9\t} 10\t} 11\t}() 12\treturn requests // éšå¼è½¬æ¢åˆ°ç±»å‹chan\u0026lt;- (chan\u0026lt;- int) 13}(0) 14 15func main() { 16\tincrease1000 := func(done chan\u0026lt;- struct{}) { 17\tfor i := 0; i \u0026lt; 1000; i++ { 18\tcounter \u0026lt;- nil 19\t} 20\tdone \u0026lt;- struct{}{} 21\t} 22 23\tdone := make(chan struct{}) 24\tgo increase1000(done) 25\tgo increase1000(done) 26\t\u0026lt;-done 27\t\u0026lt;-done 28 29\trequest := make(chan int, 1) 30\tcounter \u0026lt;- request 31\tfmt.Println(\u0026lt;-request) // 2000 32} 5. ä½¿å½“å‰åç¨‹æ°¸ä¹…é˜»å¡ ä¸€ä¸ªæ— åˆ†æ”¯çš„ select æµç¨‹æ§åˆ¶ä»£ç å—ä½¿å½“å‰åç¨‹æ°¸ä¹…å¤„äºé˜»å¡çŠ¶æ€ã€‚è¿™æ˜¯selectæµç¨‹æ§åˆ¶çš„æœ€ç®€å•çš„åº”ç”¨ã€‚ä¸€èˆ¬ï¼Œselect{}ç”¨åœ¨ä¸»åç¨‹ä¸­ä»¥é˜²æ­¢ç¨‹åºé€€å‡ºã€‚\n1func DoSomething() { 2\tfor { 3\t// åšç‚¹ä»€ä¹ˆ... 4\tfmt.Println(rand.Int31()) 5\ttime.Sleep(time.Second) 6\truntime.Gosched() // é˜²æ­¢æœ¬åç¨‹éœ¸å CPUä¸æ”¾ 7\t} 8} 9 10func main() { 11\tgo DoSomething() 12\tgo DoSomething() 13\tselect {} 14} 6. å°è¯•å‘é€ä¸æ¥æ”¶ å«æœ‰ä¸€ä¸ªdefaultåˆ†æ”¯å’Œä¸€ä¸ªcaseåˆ†æ”¯çš„selectä»£ç å—å¯ä»¥è¢«ç”¨åšä¸€ä¸ªå°è¯•å‘é€æˆ–è€…å°è¯•æ¥æ”¶æ“ä½œï¼Œå–å†³äºcaseå…³é”®å­—åè·Ÿéšçš„æ˜¯ä¸€ä¸ªå‘é€æ“ä½œè¿˜æ˜¯ä¸€ä¸ªæ¥æ”¶æ“ä½œã€‚\nå¦‚æœcaseå…³é”®å­—åè·Ÿéšçš„æ˜¯ä¸€ä¸ªå‘é€æ“ä½œï¼Œåˆ™æ­¤selectä»£ç å—ä¸ºä¸€ä¸ªå°è¯•å‘é€æ“ä½œã€‚ å¦‚æœcaseåˆ†æ”¯çš„å‘é€æ“ä½œæ˜¯é˜»å¡çš„ï¼Œåˆ™defaultåˆ†æ”¯å°†è¢«æ‰§è¡Œï¼Œå‘é€å¤±è´¥ï¼›å¦åˆ™å‘é€æˆåŠŸï¼Œcaseåˆ†æ”¯å¾—åˆ°æ‰§è¡Œã€‚ å¦‚æœcaseå…³é”®å­—åè·Ÿéšçš„æ˜¯ä¸€ä¸ªæ¥æ”¶æ“ä½œï¼Œåˆ™æ­¤selectä»£ç å—ä¸ºä¸€ä¸ªå°è¯•æ¥æ”¶æ“ä½œã€‚ å¦‚æœcaseåˆ†æ”¯çš„æ¥æ”¶æ“ä½œæ˜¯é˜»å¡çš„ï¼Œåˆ™defaultåˆ†æ”¯å°†è¢«æ‰§è¡Œï¼Œæ¥æ”¶å¤±è´¥ï¼›å¦åˆ™æ¥æ”¶æˆåŠŸï¼Œcaseåˆ†æ”¯å¾—åˆ°æ‰§è¡Œã€‚ å°è¯•å‘é€å’Œå°è¯•æ¥æ”¶ä»£ç å—æ°¸ä¸é˜»å¡ã€‚\næ ‡å‡†ç¼–è¯‘å™¨å¯¹å°è¯•å‘é€å’Œå°è¯•æ¥æ”¶ä»£ç å—åšäº†ç‰¹åˆ«çš„ä¼˜åŒ–ï¼Œä½¿å¾—å®ƒä»¬çš„æ‰§è¡Œæ•ˆç‡æ¯”å¤šcaseåˆ†æ”¯çš„æ™®é€šselectä»£ç å—æ‰§è¡Œæ•ˆç‡é«˜å¾—å¤šã€‚\n1type Book struct { 2\tid int 3} 4 5func main() { 6 7\tbookshelf := make(chan Book, 3) 8 9\tfor i := 0; i \u0026lt; cap(bookshelf)*2; i++ { 10\tselect { 11\tcase bookshelf \u0026lt;- Book{id: i}: 12\tfmt.Println(\u0026#34;æˆåŠŸå°†ä¹¦æ”¾åœ¨ä¹¦æ¶ä¸Š\u0026#34;, i) 13\tdefault: 14\tfmt.Println(\u0026#34;ä¹¦æ¶å·²ç»è¢«å æ»¡äº†\u0026#34;) 15\t} 16\t} 17 18\tfor i := 0; i \u0026lt; cap(bookshelf)*2; i++ { 19\tselect { 20\tcase book := \u0026lt;-bookshelf: 21\tfmt.Println(\u0026#34;æˆåŠŸä»ä¹¦æ¶ä¸Šå–ä¸‹ä¸€æœ¬ä¹¦\u0026#34;, book.id) 22\tdefault: 23\tfmt.Println(\u0026#34;ä¹¦æ¶ä¸Šå·²ç»æ²¡æœ‰ä¹¦äº†\u0026#34;) 24\t} 25\t} 26 27} 7. æ— é˜»å¡åœ°æ£€æŸ¥ Channel æ˜¯å¦å·²ç»å…³é—­ å‡è®¾ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯æ²¡æœ‰ä»»ä½•åç¨‹ä¼šå‘ä¸€ä¸ªé€šé“å‘é€æ•°æ®ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥ï¼ˆå¹¶å‘å®‰å…¨åœ°ï¼‰æ£€æŸ¥æ­¤é€šé“æ˜¯å¦å·²ç»å…³é—­ï¼Œæ­¤æ£€æŸ¥ä¸ä¼šé˜»å¡å½“å‰åç¨‹ã€‚\n1func IsClosed(c chan T) bool { 2\tselect { 3\tcase \u0026lt;-c: 4\treturn true 5\tdefault: 6\t} 7\treturn false 8} æ­¤æ–¹æ³•å¸¸ç”¨æ¥æŸ¥çœ‹æŸä¸ªæœŸå¾…ä¸­çš„é€šçŸ¥æ˜¯å¦å·²ç»æ¥ä¸´ã€‚æ­¤é€šçŸ¥å°†ç”±å¦ä¸€ä¸ªåç¨‹é€šè¿‡å…³é—­ä¸€ä¸ªé€šé“æ¥å‘é€ã€‚\n8. è¶…æ—¶æœºåˆ¶ï¼ˆtimeoutï¼‰ åœ¨ä¸€äº›è¯·æ±‚/å›åº”ç”¨ä¾‹ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½å› ä¸ºç§ç§åŸå› å¯¼è‡´éœ€è¦è¶…å‡ºé¢„æœŸçš„æ—¶é•¿æ‰èƒ½å¾—åˆ°å›åº”ï¼Œæœ‰æ—¶ç”šè‡³æ°¸è¿œå¾—ä¸åˆ°å›åº”ã€‚ å¯¹äºè¿™æ ·çš„æƒ…å½¢ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè¶…æ—¶æ–¹æ¡ˆç»™è¯·æ±‚è€…è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ã€‚ä½¿ç”¨ select å¯ä»¥å¾ˆè½»æ¾åœ°å®ç°è¿™æ ·çš„ä¸€ä¸ªè¶…æ—¶æ–¹æ¡ˆã€‚\n1func requestWithTimeout(timeout time.Duration) (int, error) { 2\tc := make(chan int) 3\tgo doRequest(c) // å¯èƒ½éœ€è¦è¶…å‡ºé¢„æœŸçš„æ—¶é•¿å›åº” 4 5\tselect { 6\tcase data := \u0026lt;-c: 7\treturn data, nil 8\tcase \u0026lt;-time.After(timeout): 9\treturn 0, errors.New(\u0026#34;è¶…æ—¶äº†ï¼\u0026#34;) 10\t} 11} 8.1 é€Ÿç‡é™åˆ¶ é€Ÿç‡é™åˆ¶å¸¸ç”¨æ¥é™åˆ¶ååå’Œç¡®ä¿åœ¨ä¸€æ®µæ—¶é—´å†…çš„èµ„æºä½¿ç”¨ä¸ä¼šè¶…æ ‡ã€‚\nä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œä»»ä½•ä¸€åˆ†é’Ÿæ—¶æ®µå†…å¤„ç†çš„è¯·æ±‚æ•°ä¸ä¼šè¶…è¿‡200ã€‚\nä¹Ÿå°±æ˜¯æ¼æ¡¶ç®—æ³•ï¼Œä½†æ¼æ¡¶ç®—æ³•æ— æ³•å¤„ç†å³°å€¼æƒ…å†µã€‚\n1type Request interface{} 2 3func handle(r Request) { 4\tfmt.Println(r.(int)) 5} 6 7const RateLimitPeriod = time.Minute 8const RateLimit = 5 // ä»»ä½•ä¸€åˆ†é’Ÿå†…æœ€å¤šå¤„ç†200ä¸ªè¯·æ±‚ 9 10func handleRequests(requests \u0026lt;-chan Request) { 11\tquotas := make(chan time.Time, RateLimit) 12 13\tgo func() { 14\ttick := time.NewTicker(RateLimitPeriod / RateLimit) 15\tdefer tick.Stop() 16\tfor t := range tick.C { 17\tselect { 18\tcase quotas \u0026lt;- t: 19\tdefault: 20\t} 21\t} 22\t}() 23 24\tfor r := range requests { 25\t\u0026lt;-quotas 26\tgo handle(r) 27\t} 28} 29 30func main() { 31\trequests := make(chan Request) 32\tgo handleRequests(requests) 33\t// time.Sleep(time.Minute) 34\tfor i := 0; ; i++ { 35\trequests \u0026lt;- i 36\t} 37} ","permalink":"/tech/golang/golang-channel-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/","summary":"\u003ch1 id=\"1-futurepromise\"\u003e1. future/promise\u003c/h1\u003e\n\u003ch2 id=\"11-å•å‘æ¥æ”¶-channel-ä½œä¸ºå‡½æ•°è¿”å›\"\u003e1.1 å•å‘æ¥æ”¶ Channel ä½œä¸ºå‡½æ•°è¿”å›\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003esumSquares\u003c/code\u003eå‡½æ•°è°ƒç”¨çš„ä¸¤ä¸ªå®å‚è¯·æ±‚å¹¶å‘è¿›è¡Œã€‚æ¯ä¸ªé€šé“è¯»å–æ“ä½œå°†é˜»å¡åˆ°è¯·æ±‚è¿”å›ç»“æœä¸ºæ­¢ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003elongTimeRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"kd\"\u003echan\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003echan\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSecond\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e// æ¨¡æ‹Ÿä¸€ä¸ªå·¥ä½œè´Ÿè½½\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan class=\"nx\"\u003erand\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInt63n\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003esumSquares\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eb\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ea\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003ea\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eb\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eb\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nf\"\u003elongTimeRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"nf\"\u003elongTimeRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003esumSquares\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"nx\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"nx\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"12-å•å‘å‘é€-channel-ä½œä¸ºå‡½æ•°å®å‚\"\u003e1.2 å•å‘å‘é€ Channel ä½œä¸ºå‡½æ•°å®å‚\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003esumSquares\u003c/code\u003eå‡½æ•°è°ƒç”¨çš„ä¸¤ä¸ªå®å‚çš„è¯·æ±‚ä¹Ÿæ˜¯å¹¶å‘è¿›è¡Œçš„ã€‚å’Œä¸Šä¾‹ä¸åŒçš„æ˜¯\u003ccode\u003elongTimeRequest\u003c/code\u003eå‡½æ•°æ¥æ”¶ä¸€ä¸ªå•å‘å‘é€é€šé“ç±»å‹å‚æ•°è€Œä¸æ˜¯è¿”å›ä¸€ä¸ªå•å‘æ¥æ”¶é€šé“ç»“æœã€‚\u003c/p\u003e","title":"Golang Channel ä½¿ç”¨åœºæ™¯"},{"content":"å‚è€ƒèµ„æ–™ï¼š\nhttps://go.dev/wiki/CodeReviewComments https://go.dev/wiki/CommonMistakes Review Comments ä½¿ç”¨ gofmt æˆ–è€… goimports è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç  è®°å½•å£°æ˜çš„æ³¨é‡Šåº”è¯¥æ˜¯å®Œæ•´çš„å¥å­ï¼Œæ³¨é‡Šåº”ä»¥æ‰€æè¿°äº‹ç‰©çš„åç§°å¼€å¤´å¹¶ä»¥å¥ç‚¹ç»“æŸã€‚ 1// Request represents a request to run a command. 2type Request struct { ... 3 4// Encode writes the JSON encoding of req to w. 5func Encode(w io.Writer, req *Request) { ... context.Context ç±»å‹çš„å€¼æºå¸¦è·¨ API å’Œè¿›ç¨‹è¾¹ç•Œçš„å®‰å…¨å‡­è¯ã€è·Ÿè¸ªä¿¡æ¯ã€æˆªæ­¢æ—¥æœŸå’Œå–æ¶ˆä¿¡å·ã€‚Go ç¨‹åºæ²¿ç€ä»ä¼ å…¥ RPC å’Œ HTTP è¯·æ±‚åˆ°ä¼ å‡ºè¯·æ±‚çš„æ•´ä¸ªå‡½æ•°è°ƒç”¨é“¾æ˜¾å¼ä¼ é€’ä¸Šä¸‹æ–‡ã€‚å¤§å¤šæ•°ä½¿ç”¨ Context çš„å‡½æ•°éƒ½å°†å®ƒä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼š 1func F(ctx context.Context, /* other arguments */) {} æ³¨æ„ï¼Œä¸è¦å°† Context æˆå‘˜æ·»åŠ åˆ°ç»“æ„ç±»å‹ä¸­ï¼›è€Œæ˜¯å‘éœ€è¦ä¼ é€’è¯¥ç±»å‹çš„æ¯ä¸ªæ–¹æ³•æ·»åŠ ä¸€ä¸ª ctx å‚æ•°ã€‚\né¿å…ä½¿ç”¨ math/rand ç”Ÿæˆå¯†é’¥ã€‚é¦–å…ˆï¼Œå¦‚æœä¸åŠ ç§å­ï¼Œç§˜é’¥ç»“æœå®Œå…¨å¯ä»¥é¢„æµ‹ï¼Œå³ä½¿ä½¿ç”¨ time.Nanoseconds() ä½œä¸ºç§å­ï¼Œç”Ÿæˆçš„ç§˜é’¥ä¹Ÿåªæœ‰å‡ ä½ä¸åŒã€‚æ¨èä½¿ç”¨ crypto/rand åŒ…ä¸­çš„ Read() ç”Ÿæˆç§˜é’¥ã€‚ 1import ( 2 \u0026#34;crypto/rand\u0026#34; 3 // \u0026#34;encoding/base64\u0026#34; 4 // \u0026#34;encoding/hex\u0026#34; 5 \u0026#34;fmt\u0026#34; 6) 7 8func Key() string { 9 buf := make([]byte, 16) 10 _, err := rand.Read(buf) 11 if err != nil { 12 panic(err) // out of randomness, should never happen 13 } 14 return fmt.Sprintf(\u0026#34;%x\u0026#34;, buf) 15 // or hex.EncodeToString(buf) 16 // or base64.StdEncoding.EncodeToString(buf) 17} ä»¥ä¸‹ä¸¤ç§å£°æ˜åˆ‡ç‰‡çš„æ–¹å¼ï¼Œå‰è€…å£°æ˜äº†ä¸€ä¸ª nil åˆ‡ç‰‡ï¼Œè€Œåè€…å£°æ˜äº†ç©ºåˆ‡ç‰‡ï¼Œä¸¤è€…çš„ len() å’Œ cap() éƒ½ä¸º 0ï¼Œé€šå¸¸æƒ…å†µä¸‹ nil åˆ‡ç‰‡æ›´å¥½ï¼Œ nil åˆ‡ç‰‡åº•å±‚æŒ‡é’ˆåœ°å€ä¸º 0 ã€‚ 1var t []string 1t := []string{} 2t := make([]string, 0) ä¾‹å¤–ï¼Œåœ¨ç¼–ç  JSON å¯¹è±¡æ—¶ï¼Œæ¨èä½¿ç”¨é nil ä½†é›¶é•¿åº¦çš„åˆ‡ç‰‡ ï¼Œnil åˆ‡ç‰‡ä¼šè¢«ç¼–ç ä¸º nullï¼Œè€Œ []string{} ä¼šè¢«ç¼–ç ä¸º JSON æ•°ç»„ []ã€‚\nä¸è¦ä½¿ç”¨ panic è¿›è¡Œçš„é”™è¯¯å¤„ç†ï¼Œ è€Œæ˜¯ä½¿ç”¨ error å’Œå¤šè¿”å›å€¼ã€‚ ç”Ÿæˆåç¨‹æ—¶ï¼Œè¯·æ˜ç¡®è¯¥åç¨‹æ˜¯å¦ç»“æŸã€ä½•æ—¶ç»“æŸã€‚ Goroutine å¯èƒ½ä¼šå› é˜»å¡é€šé“å‘é€æˆ–æ¥æ”¶è€Œå‘ç”Ÿæ³„æ¼ï¼šå³ä½¿é˜»å¡çš„é€šé“æ— æ³•è®¿é—®ï¼ŒGC ä¹Ÿä¸ä¼šç»ˆæ­¢ Goroutineã€‚ é™¤éå‡ºç°é‡åæƒ…å†µï¼Œå¦åˆ™é¿å…é‡å‘½å importã€‚ å¤§éƒ¨åˆ†æƒ…å†µä¸‹çš„åŒ…åç§°ä¸éœ€è¦é‡å‘½åï¼Œå¦‚æœå‘ç”Ÿå†²çªï¼Œæœ€å¥½é‡å‘½åæœ¬åœ°æˆ–ç‰¹å®šé¡¹ç›®çš„ import ã€‚ å°½é‡ä½¿æ­£å¸¸çš„ä»£ç è·¯å¾„ä¿æŒæœ€å°çš„ç¼©è¿›ï¼Œå¹¶ç¼©è¿›é”™è¯¯å¤„ç†ã€‚ä¾‹å¦‚ï¼š ä¸æ¨èï¼š\n1if err != nil { 2 // error handling 3} else { 4 // normal code 5} æ¨èï¼š\n1if err != nil { 2 // error handling 3 return // or continue, etc. 4} 5// normal code é¦–å­—æ¯ç¼©å†™è¯ï¼Œå…·æœ‰ä¸€è‡´çš„å¤§å°å†™ã€‚ ä¾‹å¦‚ï¼Œ\u0026ldquo;URL\u0026rdquo; åº”å†™ä¸º\u0026quot;URL\u0026quot;æˆ–\u0026quot;url\u0026quot;ï¼Œè€Œä¸æ˜¯\u0026quot;Url\u0026quot;ï¼›ä½¿ç”¨ \u0026ldquo;ServeHTTP\u0026rdquo; è€Œä¸æ˜¯ \u0026ldquo;ServeHttp\u0026rdquo;ï¼›ä½¿ç”¨ \u0026ldquo;xmlHTTPRequest\u0026rdquo; æˆ–\u0026quot;XMLHTTPRequest\u0026quot;ï¼›ä½¿ç”¨ \u0026ldquo;appID\u0026rdquo; è€Œä¸æ˜¯ \u0026ldquo;appId\u0026rdquo;ã€‚ç”± protocol buffer ç”Ÿæˆçš„ä»£ç ä¸å—æ­¤è§„åˆ™çš„çº¦æŸã€‚äººç±»ç¼–å†™çš„ä»£ç æ¯”æœºå™¨ç¼–å†™çš„ä»£ç å…·æœ‰æ›´é«˜çš„æ ‡å‡†ã€‚\næ ¹æ®å®é™…æƒ…å†µç¡®å®šå‡½æ•°è¿”å›æ ¼å¼ã€‚ ä¾‹å¦‚å½“å‡½æ•°è¿”å›ç›¸åŒç±»å‹çš„ 2 ä¸ªæˆ– 3 ä¸ªå‚æ•°ï¼Œæˆ–è€…è¿”å›å€¼çš„å«ä¹‰è¾ƒéš¾åŒºåˆ†ï¼Œé‚£ä¹ˆæ¨èåœ¨å‡½æ•°è¿”å›æ ¼å¼å‰æ·»åŠ å˜é‡åç§°ã€‚\nä¸æ¨èï¼š\n1func (f *Foo) Location() (float64, float64, error) æ¨èï¼š\n1// Location returns f\u0026#39;s latitude and longitude. 2// Negative values mean south and west, respectively. 3func (f *Foo) Location() (lat, long float64, err error) é¿å…ä»…ä»…ä¸ºäº†èŠ‚çœå‡ ä¸ªå­—èŠ‚è€Œå°†æŒ‡é’ˆä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’ã€‚ å¦‚æœä¸€ä¸ªå‡½æ•°è‡ªå§‹è‡³ç»ˆï¼Œä»…å°†å…¶å‚æ•° x å¼•ç”¨ä¸º *xï¼Œé‚£è¿™ä¸ªä¼ å…¥çš„å‚æ•°ä¸åº”è¯¥æ˜¯æŒ‡é’ˆè€Œæ˜¯å€¼ã€‚å°†æŒ‡é’ˆä½œä¸ºå‚æ•°çš„æƒ…å†µä¾‹å¦‚ï¼šä¼ é€’æŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆ *string æˆ–æŒ‡å‘æ¥å£å€¼çš„æŒ‡é’ˆ *io.Readerï¼Œè¿™ä¸¤ä¸ªä¾‹å­ä¸­ï¼ŒæŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼æœ¬èº«æ˜¯å›ºå®šå¤§å°çš„ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä¼ é€’ã€‚ä½†ä¸é€‚ç”¨äºæŒ‡é’ˆæŒ‡å‘å¤§å‹ç»“æ„ä½“ï¼ŒåŒ…æ‹¬ä¸é€‚ç”¨äºå¯èƒ½å¢é•¿çš„å°å‹ç»“æ„ä½“ã€‚\næ–¹æ³•æ¥æ”¶å™¨çš„å‘½ååº”ç®€çŸ­å¹¶ä¿æŒä¸€è‡´ï¼šé€šå¸¸ç”¨ 1 åˆ° 2 ä¸ªå­—æ¯ç¼©å†™å…¶ç±»å‹ï¼ˆ\u0026ldquo;client\u0026quot;ç¼©å†™ä¸º\u0026quot;c\u0026quot;æˆ–\u0026quot;cl\u0026rdquo;ï¼‰ã€‚ä¸è¦ä½¿ç”¨é€šç”¨åç§°ï¼Œå¦‚ \u0026ldquo;me\u0026rdquo;ã€\u0026ldquo;this \u0026ldquo;æˆ– \u0026ldquo;self\u0026rdquo;ï¼Œè¿™äº›é¢å‘å¯¹è±¡è¯­è¨€çš„å…¸å‹æ ‡è¯†ç¬¦ä¼šèµ‹äºˆæ–¹æ³•ç‰¹æ®Šçš„å«ä¹‰ï¼Œè€Œåœ¨ Go ä¸­ï¼Œæ–¹æ³•çš„æ¥æ”¶å™¨åªæ˜¯å¦ä¸€ä¸ªå‚æ•°ã€‚\né€šå¸¸ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶å™¨ï¼Œå¯¹äºåŸºæœ¬ç±»å‹çš„å€¼æˆ–è€…ç¡®å®šä¸å˜çš„å°å‹ç»“æ„ä½“å¯ä»¥ä½¿ç”¨å€¼æ¥æ”¶å™¨ã€‚\nå¦‚æœæ¥æ”¶è€…æ˜¯ä¸€ä¸ªmapã€func æˆ– chanï¼Œä¸è¦ä½¿ç”¨æŒ‡å‘å®ƒä»¬çš„æŒ‡é’ˆï¼›å¦‚æœæ¥æ”¶è€…æ˜¯ä¸€ä¸ª slice å¹¶ä¸”è¯¥æ–¹æ³•ä¸ä¼šé‡æ–°åˆ‡ç‰‡æˆ–é‡æ–°åˆ†é…è¯¥ sliceï¼Œåˆ™ä¸è¦ä½¿ç”¨æŒ‡å‘å®ƒçš„æŒ‡é’ˆã€‚ å¦‚æœè¯¥æ–¹æ³•éœ€è¦æ”¹å˜æ¥æ”¶è€…ï¼Œåˆ™æ¥æ”¶è€…å¿…é¡»æ˜¯æŒ‡é’ˆã€‚ å¦‚æœæ¥æ”¶è€…æ˜¯åŒ…å«sync.Mutexæˆ–ç±»ä¼¼åŒæ­¥å­—æ®µçš„ç»“æ„ï¼Œåˆ™æ¥æ”¶è€…å¿…é¡»æ˜¯æŒ‡é’ˆï¼Œä»¥é¿å…å¤åˆ¶ã€‚ å¦‚æœæ¥æ”¶å™¨æ˜¯å¤§å‹ç»“æ„ä½“æˆ–æ•°ç»„ï¼Œåˆ™æŒ‡é’ˆæ¥æ”¶å™¨æ•ˆç‡æ›´é«˜ã€‚ ç›¸æ¯”å¼‚æ­¥å‡½æ•°ï¼Œæ¨èä½¿ç”¨åŒæ­¥å‡½æ•°ã€‚ åŒæ­¥å‡½æ•°æ›´å®¹æ˜“æ¨æ–­å‡½æ•°ä¸­åç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…æ³„æ¼å’Œæ•°æ®ç«äº‰ï¼Œä¹Ÿæ›´æ˜“äºæµ‹è¯•ï¼šè°ƒç”¨è€…å¯ä»¥ä¼ é€’è¾“å…¥å¹¶æ£€æŸ¥è¾“å‡ºï¼Œè€Œæ— éœ€è½®è¯¢æˆ–åŒæ­¥ã€‚ Common Mistakes ä½¿ç”¨å¾ªç¯å˜é‡çš„å¼•ç”¨ Goè¯­è¨€ä¸­ï¼Œå¾ªç¯å˜é‡åªæ˜¯ä¸€ä¸ªå˜é‡ï¼Œåœ¨æ¯æ¬¡å¾ªç¯è¿‡ç¨‹ä¸­è¢«èµ‹äºˆä¸åŒçš„å€¼ã€‚ä½†å¦‚æœä½¿ç”¨ä¸å½“å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚\n1func main() { 2\tvar out []*int 3\tfor i := 0; i \u0026lt; 3; i++ { 4\tout = append(out, \u0026amp;i) 5\t} 6\tfmt.Println(\u0026#34;Values:\u0026#34;, *out[0], *out[1], *out[2]) 7\tfmt.Println(\u0026#34;Addresses:\u0026#34;, out[0], out[1], out[2]) 8} è¾“å‡ºç»“æœä¸ºï¼š\n1Values: 3 3 3 2Addresses: 0xc0000a0000 0xc0000a0000 0xc0000a0000 åŸå› ï¼š æ¯æ¬¡å¾ªç¯ï¼ŒGolang å°† i çš„åœ°å€è¿½åŠ åˆ°åˆ‡ç‰‡ out ä¸­ï¼Œä½†è‡ªå§‹è‡³ç»ˆåªæœ‰ä¸€ä¸ª i ï¼Œæ‰€ä»¥å¾ªç¯ç»“æŸå i ä¸Šçš„å€¼ä¸ºæœ€åä¸€æ¬¡å¾ªç¯èµ‹ç»™ i çš„å€¼ã€‚\nè§£å†³æ–¹æ³•ï¼š å°†å¾ªç¯å˜é‡èµ‹å€¼åˆ°æ–°å˜é‡ä¸­ã€‚\n1for i := 0; i \u0026lt; 3; i++ { 2\ti := i 3\tout = append(out, \u0026amp;i) 4\t} è¾“å‡ºç»“æœä¸ºï¼š\n1Values: 0 1 2 2Addresses: 0xc00001a0b8 0xc00001a0c0 0xc00001a0c8 åŸå› ï¼š i := i å°†å¾ªç¯å˜é‡ i å¤åˆ¶åˆ°ä¸€ä¸ªæ–°å˜é‡ä¸­ï¼Œè¯¥æ–°å˜é‡çš„ä½œç”¨åŸŸä¸º for å¾ªç¯ä¸»ä½“å—ï¼Œä¹Ÿç§°ä¸º iã€‚æ¯æ¬¡å¾ªç¯è¿­ä»£ä¸­éƒ½ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªæ–°å˜é‡ã€‚\nè™½ç„¶è¿™ä¸ªä¾‹å­çœ‹èµ·æ¥æœ‰ç‚¹æ˜æ˜¾ï¼Œä½†åœ¨å…¶ä»–ä¸€äº›æƒ…å†µä¸‹ï¼ŒåŒæ ·çš„æ„å¤–è¡Œä¸ºå¯èƒ½ä¼šæ›´åŠ éšè”½ã€‚ä¾‹å¦‚ï¼Œå¾ªç¯å˜é‡å¯ä»¥æ˜¯æ•°ç»„ï¼Œè€Œå¼•ç”¨å¯ä»¥æ˜¯ç‰‡æ®µï¼š\nä¸Šè¿°æ ·ä¾‹è¾ƒä¸ºæ˜æ˜¾ï¼Œå®é™…æƒ…å†µä¸‹è¿™ç§é”™è¯¯å¯èƒ½æ›´åŠ éšè”½ï¼Œä¾‹å¦‚ï¼Œå¾ªç¯å˜é‡ä¸ºæ•°ç»„ï¼Œå…¶å¼•ç”¨ä¸ºåˆ‡ç‰‡ã€‚\n1func main() { 2\tvar out [][]int 3\tfor _, i := range [][1]int{{1}, {2}, {3}} { 4\tout = append(out, i[:]) 5\t} 6\tfmt.Println(\u0026#34;Values:\u0026#34;, out) 7} è¾“å‡ºç»“æœä¸ºï¼š\n1Values: [[3] [3] [3]] å½“åœ¨ Goroutine ä¸­ä½¿ç”¨å¾ªç¯å˜é‡æ—¶ï¼Œä¹Ÿä¼šå‡ºç°åŒæ ·çš„é—®é¢˜ï¼ˆä¸‹ä¸€èŠ‚ï¼‰ã€‚\nåœ¨å¾ªç¯å˜é‡ä¸Šä½¿ç”¨ goroutines åœ¨ Go ä¸­ä½¿ç”¨å¾ªç¯æ—¶ï¼Œæˆ‘ä»¬ä¼šå°è¯•ä½¿ç”¨ goroutine å¹¶è¡Œå¤„ç†æ•°æ®ã€‚ä¾‹å¦‚å¯ä»¥ä½¿ç”¨é—­åŒ…ï¼š\n1func main() { 2\tvalues := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10} 3\tfor _, val := range values { 4\tgo func() { 5\tfmt.Println(val) 6\t}() 7\t} 8 9\t// wait 10 second 10\ttime.Sleep(10 * time.Second) 11} ä¸Šè¿°ä»£ç ä¸ä¼šæŒ‰é¡ºåºæ‰“å°çš„æ¯ä¸ªå€¼ï¼Œå› ä¸ºæ‰€æœ‰é—­åŒ…å‡½æ•°éƒ½ç»‘å®šäº†åŒä¸€ä¸ªå˜é‡ï¼Œè¿è¡Œæ­¤ä»£ç æ—¶ï¼Œå› ä¸º goroutine å¯èƒ½è¦ç­‰åˆ°å¾ªç¯ç»“æŸåæ‰ä¼šå¼€å§‹æ‰§è¡Œï¼Œæ‰€ä»¥åªä¼šæ‰“å°æœ€åä¸€ä¸ªå…ƒç´ 10ã€‚\n1$ go run test.go 210 310 410 510 610 710 810 910 1010 1110 ç¼–å†™é—­åŒ…å¾ªç¯çš„æ­£ç¡®æ–¹å¼æ˜¯ï¼š\n1func main() { 2\tvalues := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10} 3\tfor _, val := range values { 4\tgo func(v int) { 5\tfmt.Println(v) 6\t}(val) 7\t} 8 9\t// wait for goroutines to finish 10\tvar input string 11\tfmt.Scanln(\u0026amp;input) 12 13} å°† val ä½œä¸ºå‚æ•°æ·»åŠ åˆ°é—­åŒ…ä¸­ï¼Œæ¯æ¬¡è¿­ä»£æ—¶å¯¹ val è¿›è¡Œæ±‚å€¼ï¼Œå¹¶å°†å…¶ç½®äº goroutine çš„å †æ ˆä¸­ï¼Œå› æ­¤æ¯ä¸ªåˆ‡ç‰‡å…ƒç´ åœ¨æœ€ç»ˆæ‰§è¡Œæ—¶å¯ä¾› goroutine ä½¿ç”¨ã€‚\n1$ go run test.go 24 31 42 53 67 75 86 98 109 1110 ä¸‹åˆ—ä»£ç ä½¿ç”¨å…¬å…±ç´¢å¼•å˜é‡ i åˆ›å»ºå•ç‹¬çš„ valï¼Œä¹Ÿå¯ä»¥äº§ç”Ÿæˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼š\n1func main() { 2\tvalues := []int{1, 2, 3, 4, 5, 6, 7, 8, 9, 10} 3\tfor i := range values { 4\tval := values[i] 5\tgo func() { 6\tfmt.Println(val) 7\t}() 8\t} 9 10\t// wait for goroutines to finish 11\tvar input string 12\tfmt.Scanln(\u0026amp;input) 13 14} 14 21 32 43 57 65 76 88 99 1010 æ³¨æ„ï¼Œå¦‚æœä¸å°†æ­¤é—­åŒ…ä½œä¸º goroutine æ‰§è¡Œï¼Œä»£ç å°†æŒ‰é¢„æœŸè¿è¡Œã€‚ä»¥ä¸‹ç¤ºä¾‹æ‰“å° 1 åˆ° 10 ä¹‹é—´çš„æ•´æ•°ã€‚\n1for i := 1; i \u0026lt;= 10; i++ { 2\tfunc() { 3\tfmt.Println(i) 4\t}() 5} 11 22 33 44 55 66 77 88 99 1010 å…¶ä¸­ï¼Œé—­åŒ…å‡½æ•°ä¼šåœ¨å˜é‡iæ›´æ”¹ä¹‹å‰æ‰§è¡Œå®Œæ¯•ï¼Œå› æ­¤æœ€ç»ˆæŒ‰é¡ºåºè¾“å‡º1åˆ°10ã€‚ https://go.dev/doc/faq#closures_and_goroutines\n","permalink":"/tech/golang/golang-code-review-comments/","summary":"\u003cp\u003e\u003cstrong\u003eå‚è€ƒèµ„æ–™ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://go.dev/wiki/CodeReviewComments\"\u003ehttps://go.dev/wiki/CodeReviewComments\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://go.dev/wiki/CommonMistakes\"\u003ehttps://go.dev/wiki/CommonMistakes\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch1 id=\"review-comments\"\u003eReview Comments\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003eä½¿ç”¨ \u003cstrong\u003egofmt\u003c/strong\u003e æˆ–è€… Â goimports è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç \u003c/li\u003e\n\u003cli\u003eè®°å½•å£°æ˜çš„\u003cstrong\u003eæ³¨é‡Šåº”è¯¥æ˜¯å®Œæ•´çš„å¥å­\u003c/strong\u003eï¼Œæ³¨é‡Šåº”ä»¥æ‰€æè¿°äº‹ç‰©çš„åç§°å¼€å¤´å¹¶ä»¥å¥ç‚¹ç»“æŸã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-gdscript3\" data-lang=\"gdscript3\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e//\u003c/span\u003e \u003cspan class=\"n\"\u003eRequest\u003c/span\u003e \u003cspan class=\"n\"\u003erepresents\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"n\"\u003erun\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eRequest\u003c/span\u003e \u003cspan class=\"n\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e//\u003c/span\u003e \u003cspan class=\"n\"\u003eEncode\u003c/span\u003e \u003cspan class=\"n\"\u003ewrites\u003c/span\u003e \u003cspan class=\"n\"\u003ethe\u003c/span\u003e \u003cspan class=\"n\"\u003eJSON\u003c/span\u003e \u003cspan class=\"n\"\u003eencoding\u003c/span\u003e \u003cspan class=\"n\"\u003eof\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"n\"\u003ew\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"n\"\u003eEncode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"n\"\u003eio\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003econtext.Context ç±»å‹çš„å€¼æºå¸¦è·¨ API å’Œè¿›ç¨‹è¾¹ç•Œçš„å®‰å…¨å‡­è¯ã€è·Ÿè¸ªä¿¡æ¯ã€æˆªæ­¢æ—¥æœŸå’Œå–æ¶ˆä¿¡å·ã€‚Go ç¨‹åºæ²¿ç€ä»ä¼ å…¥ RPC å’Œ HTTP è¯·æ±‚åˆ°ä¼ å‡ºè¯·æ±‚çš„æ•´ä¸ªå‡½æ•°è°ƒç”¨é“¾æ˜¾å¼ä¼ é€’ä¸Šä¸‹æ–‡ã€‚\u003cstrong\u003eå¤§å¤šæ•°ä½¿ç”¨ Context çš„å‡½æ•°éƒ½å°†å®ƒä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°\u003c/strong\u003eï¼š\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eF\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e \u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* other arguments */\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eæ³¨æ„ï¼Œä¸è¦å°† Context æˆå‘˜æ·»åŠ åˆ°ç»“æ„ç±»å‹ä¸­ï¼›è€Œæ˜¯å‘éœ€è¦ä¼ é€’è¯¥ç±»å‹çš„æ¯ä¸ªæ–¹æ³•æ·»åŠ ä¸€ä¸ª ctx å‚æ•°ã€‚\u003c/p\u003e","title":"Golang Code Review Comments"},{"content":"1. panic ä¸ error 1.1 panic panic ä¼šä¸­æ­¢ç¨‹åºæ‰§è¡Œè¿›å…¥å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œpanicå¯ä»¥åœ¨å½“å‰å‡½æ•°æˆ–è€…è°ƒç”¨é“¾å‘ä¸Šçš„ä»»ä½•ä¸€å±‚è¢«defer recover æ•è·å¤„ç†ï¼Œæ²¡è¢«æ•è·çš„panicä¼šä½¿ç¨‹åºæ‰“å°å †æ ˆåå¼‚å¸¸é€€å‡ºã€‚\npanicå¾ˆå°‘åœ¨ä»£ç ä¸­å‡ºç°ï¼Œä¸€èˆ¬ç”¨æ¥è¡¨ç¤ºé™¤0ã€å†…å­˜ä¸è¶³ã€å¼ºåˆ¶ç±»å‹è½¬æ¢å¤±è´¥ç­‰è¯­è¨€å±‚çº§çš„å¼‚å¸¸ï¼Œå¦‚æœå‡ºç°æ„å‘³ç€ç¨‹åºå‘˜æœ¬èº«çš„å®ç°é—®é¢˜ï¼Œæ‰€ä»¥ç¨‹åºå‘˜ä¸€èˆ¬ä¸ä¼šç€é‡è€ƒè™‘å’Œé˜²å¾¡å®ƒä»¬ã€‚\n1.2 error errorä¼šæ˜¾å¾—æ›´å¹³å‡¡ï¼Œæ‰€æœ‰æ»¡è¶³errorè¿™ä¸ªinterfaceçš„å€¼éƒ½å¯ä»¥å½“åšä¸€ä¸ªåˆæ³•çš„é”™è¯¯ï¼š\n1type error interface { 2 // è¾“å‡ºå¯¹è¯¥é”™è¯¯çš„æ–‡æœ¬æè¿° 3 Error() string 4} åœ¨Goè¯­è¨€ä¸­ï¼Œerroræ˜¯ä¸€ä¸ªå€¼ï¼Œè¿è¡Œæ—¶ä¸ä¼šç”¨ç‰¹æ®Šçš„é€»è¾‘å¯¹å¾…å®ƒï¼Œä¸å¤„ç†å®ƒä¸ä¼šè®©ç¨‹åºæ‰“å°å †æ ˆå¼‚å¸¸é€€å‡ºã€‚\nerrorä¼šåœ¨ä»£ç ä¸­å¤§é‡å‡ºç°ï¼Œè¡¨ç¤ºè¿æ¥è¶…æ—¶ã€JSONè§£æå¤±è´¥ã€æ–‡ä»¶ä¸å­˜åœ¨ç­‰ç”¨æˆ·å±‚çº§çš„é”™è¯¯ï¼Œå¾€å¾€å’Œä¸šåŠ¡ç›´æ¥ç›¸å…³ï¼Œç¨‹åºéœ€è¦ç€é‡è€ƒè™‘å®ƒä»¬ã€‚\n1.3 æ€»ç»“ panicï¼šä¸ç€é‡è€ƒè™‘ï¼Œæ²¡æœ‰æ˜ç¡®çš„æŠ›å‡ºä½ç½®ï¼› errorï¼šç€é‡è€ƒè™‘ï¼ŒæŠ›å‡ºä½ç½®å›ºå®šè€Œæ˜æ˜¾ï¼Œåªè¦å‡½æ•°è¿”å›å€¼å…ƒç»„ä¸­æœ€åä¸€ä¸ªæ˜¯errorç±»å‹ï¼Œç”¨æˆ·å°±éœ€è¦è€ƒè™‘é˜²å¾¡å’Œå¤„ç†ã€‚ æ¢å¥è¯è¯´ï¼ŒGoè¯­è¨€ä¸­erroræ˜¯å€¼è¿™ä¸ªç‰¹å¾åœ¨é¼“åŠ±ç”¨æˆ·è€ƒè™‘å’Œå¤„ç†æ¯ä¸ªé”™è¯¯ï¼Œå†™å‡ºé²æ£’çš„ç¨‹åºã€‚\n2. â€œå¥½â€çš„é”™è¯¯ ä¾‹å¦‚ï¼Œæœ‰ä¸ªå¤©æ°”APIæœåŠ¡ï¼Œå®ƒåœ¨æ”¶åˆ°è¯·æ±‚æ—¶ä¼šå…ˆæŸ¥è¯¢Redisä¸­æœ‰æ²¡æœ‰å¯¹åº”ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜å†è¯·æ±‚å¤–éƒ¨æœåŠ¡ï¼Œæœ€åè¿”å›ç»“æœç»™è°ƒç”¨æ–¹ã€‚\næœ‰ä¸€å¤©ï¼Œè°ƒç”¨æ–¹è¯´æ¥å£ä¸å·¥ä½œäº†ï¼Œä½ æŸ¥äº†æ—¥å¿—ï¼Œé”™è¯¯ä¿¡æ¯æ˜¯ context deadline exceededï¼Œè¿™ä¸ªé”™è¯¯æ„å‘³ç€ä»£ç é‡Œæœ‰åœ°æ–¹å‘ç”Ÿäº†è¶…æ—¶ï¼Œå¯æ˜¯åœ¨å“ªé‡Œå‘¢ï¼Ÿæ˜¯ç¼“å­˜è¿˜æ˜¯å¤–éƒ¨APIï¼Ÿ\nå¥½çš„é”™è¯¯æ˜¯æœ‰æ ¹æœ¬åŸå› å’Œè°ƒç”¨é“¾ä¸Šä¸‹æ–‡çš„é”™è¯¯ï¼Œè¿™æ ·çš„é”™è¯¯å®¹æ˜“æ’æŸ¥ï¼Œå¦‚æœä½ çœ‹åˆ°çš„é”™è¯¯ä¿¡æ¯æ˜¯è¿™æ ·çš„ï¼š\n1reading cache: redis GET: context deadline exceeded æˆ–è€…å¸¦æœ‰è°ƒç”¨å †æ ˆçš„ï¼š\n1context deadline exceeded 2goroutine 1 [running]: 3main.Example(0x19010001) 4 /Users/hello/main.go 5 temp/main.go:8 +0x64 6main.main() 7 /Users/bill/main.go 8 temp/main.go:4 +0x32 é‚£ä¹ˆæ’é”™å·¥ä½œéƒ½ä¼šå®¹æ˜“å¾—å¤šã€‚\næ¯”èµ·å †æ ˆï¼Œäººå·¥æ·»åŠ çš„æ–‡æœ¬é”™è¯¯ä¸Šä¸‹æ–‡æ›´æ˜“äºé˜…è¯»ï¼Œæœ‰ç€æ›´é«˜çš„ä¿¡æ¯å¯†åº¦ï¼Œè€Œä¸”çœ‹åˆ°çš„äººå°±ç®—æ²¡æœ‰æ¥è§¦ç›¸å…³ä»£ç ä¹Ÿæœ‰å¯èƒ½ç†è§£é”™è¯¯åŸå› ã€‚\n3. ä¸ºé”™è¯¯æä¾›æ–‡æœ¬ä¸Šä¸‹æ–‡ Go 1.13ä¸­æ–°å¢äº†fmt.Errorf()ç”¨äºä¸ºé”™è¯¯æä¾›ä¸Šä¸‹æ–‡ï¼Œerrorsæ ‡å‡†åº“æ–°å¢Is(), As(), Unwrap()ç”¨äºä¾¿åˆ©åŒ–é”™è¯¯çš„é‰´åˆ«å’Œæ¯”è¾ƒã€‚\nfmt.Errorf()çš„ç”¨æ³•å¦‚ä¸‹ï¼š\n1reading cache: redis GET: context deadline exceeded è¿™ä¸ªé”™è¯¯ä¿¡æ¯ä»å·¦åˆ°å³å±‚å±‚é€’è¿›ï¼Œæ¯å±‚fmt.Errorf()å™è¿°è‡ªå·±æƒ³è¦åšçš„äº‹æƒ…ï¼Œç„¶åç”¨:åˆ†éš”ä¸‹ä¸€å±‚ï¼Œä¸‹ä¸€å±‚ç”¨%wæŒ‡ä»£ã€‚\nä¸‹é¢è¿™æ®µä¼ªä»£ç ä¸­ï¼ŒFindWeather()è°ƒç”¨ReadCache()ï¼Œè¯·è¯•æƒ³ReadCache()æŠ¥é”™æ—¶ï¼ŒFindWeather()è°ƒç”¨è€…æ”¶åˆ°çš„é”™è¯¯ï¼š\n1func FindWeather(city string) (weather string, err error) { 2\tweather, err = ReadCache(city) 3\tif err != nil { 4\terr = fmt.Errorf(\u0026#34;reading cache: %w\u0026#34;, err) 5\treturn 6\t} 7\t8\tif weather != \u0026#34;\u0026#34; { 9\t// cache hit 10\treturn 11\t} 12\t13\t// cache missed, query for data source and update cache 14\t// ... 15} 16 17func ReadCache(city string) (weather string, err error) { 18\tcacheKey := \u0026#34;city-\u0026#34; + city 19\tweather, err = cache.Get(cacheKey) 20\tif err == redis.Nil { 21\t// cache missed 22\terr = nil 23\treturn 24\t} else if err != nil { 25\terr = fmt.Errorf(\u0026#34;redis Get: %w\u0026#34;, err) 26\treturn 27\t} 28\t29\treturn 30} Goè¯­è¨€çš„é™æ€åˆ†æå·¥å…·èƒ½æ£€æŸ¥å‡ºä»£ç ä¸­å¿˜è®°å¤„ç†çš„é”™è¯¯ï¼Œä¸è§„èŒƒçš„é”™è¯¯ä¸Šä¸‹æ–‡æ ¼å¼ç­‰ï¼ˆ%d,%f, %v, %w, %xåˆ†ä¸æ¸…ï¼‰ï¼Œä¸€èˆ¬ä½¿ç”¨å®ƒä»¬çš„åˆé›†ç‰ˆæœ¬golangci-lint.\n3.1 å…¶ä»–ä¸ºé”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡çš„æ–¹å¼ å¦‚æœæœ‰å¿…è¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ä¸ºé”™è¯¯æ·»åŠ ä¸Šä¸‹æ–‡çš„æ–¹æ¡ˆ\nä½¿ç”¨pkg/errorsä¸ºé”™è¯¯æ·»åŠ å †æ ˆï¼› å¦‚æœæ˜¯HTTPæœåŠ¡ï¼Œä½¿ç”¨panicå’Œrecoverä¸­é—´ä»¶ï¼ŒçŸ¥ä¹çš„å®ç°å°±æ˜¯ä¸ªä¾‹å­ï¼Œæˆ‘çŒœæƒ³ä¸Šä¸‹æ–‡ä¹Ÿæ˜¯ä»¥å †æ ˆçš„æ–¹å¼å‘ˆç°ã€‚ å‚è€ƒèµ„æ–™ https://nanmu.me/zh-cn/posts/2021/error-handling-in-go/ https://go.dev/blog/defer-panic-and-recover https://go.dev/blog/errors-are-values ","permalink":"/tech/golang/golang-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/","summary":"\u003ch1 id=\"1-panic-ä¸-error\"\u003e1. panic ä¸ error\u003c/h1\u003e\n\u003ch2 id=\"11-panic\"\u003e1.1 panic\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003epanic ä¼šä¸­æ­¢ç¨‹åºæ‰§è¡Œè¿›å…¥å¼‚å¸¸å¤„ç†é€»è¾‘\u003c/strong\u003eï¼Œpanicå¯ä»¥åœ¨å½“å‰å‡½æ•°æˆ–è€…è°ƒç”¨é“¾å‘ä¸Šçš„ä»»ä½•ä¸€å±‚è¢«defer recover æ•è·å¤„ç†ï¼Œæ²¡è¢«æ•è·çš„panicä¼šä½¿ç¨‹åºæ‰“å°å †æ ˆåå¼‚å¸¸é€€å‡ºã€‚\u003c/p\u003e","title":"Golang é”™è¯¯å¤„ç†"}]